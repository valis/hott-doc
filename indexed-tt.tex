\documentclass[reqno]{amsart}

\usepackage{amssymb}
\usepackage{hyperref}
\usepackage{mathtools}
\usepackage[all]{xy}
\usepackage{verbatim}
\usepackage{ifthen}
\usepackage{xargs}
\usepackage{bussproofs}
\usepackage{turnstile}
\usepackage{etex}

\hypersetup{colorlinks=true,linkcolor=blue}

\newcommand{\axlabel}[1]{(#1) \phantomsection \label{ax:#1}}
\newcommand{\axtag}[1]{\label{ax:#1} \tag{#1}}
\newcommand{\axref}[1]{(\hyperref[ax:#1]{#1})}

\newcommand{\newref}[4][]{
\ifthenelse{\equal{#1}{}}{\newtheorem{h#2}[hthm]{#4}}{\newtheorem{h#2}{#4}[#1]}
\expandafter\newcommand\csname r#2\endcsname[1]{#3~\ref{#2:##1}}
\expandafter\newcommand\csname R#2\endcsname[1]{#4~\ref{#2:##1}}
\expandafter\newcommand\csname n#2\endcsname[1]{\ref{#2:##1}}
\newenvironmentx{#2}[2][1=,2=]{
\ifthenelse{\equal{##2}{}}{\begin{h#2}}{\begin{h#2}[##2]}
\ifthenelse{\equal{##1}{}}{}{\label{#2:##1}}
}{\end{h#2}}
}

\newref[section]{thm}{Theorem}{Theorem}
\newref{lem}{Lemma}{Lemma}
\newref{prop}{Proposition}{Proposition}
\newref{cor}{Corollary}{Corollary}
\newref{cond}{Condition}{Condition}

\theoremstyle{definition}
\newref{defn}{Definition}{Definition}
\newref{example}{Example}{Example}

\theoremstyle{remark}
\newref{remark}{Remark}{Remark}

\newcommand{\type}{}
\newcommand{\ob}{}
\newcommand{\term}{1}
\newcommand{\unit}{()}

\newcommand{\fs}[1]{\mathrm{#1}}
\newcommand{\subst}{\fs{subst}}
\newcommand{\Hom}{\fs{Hom}}
\newcommand{\Id}{\fs{Id}}
\newcommand{\refl}{\fs{refl}}
\newcommand{\sym}[1]{#1^{-1}}
\newcommand{\id}{\fs{id}}
\newcommand{\pmap}{\fs{ap}}
\newcommand{\Fib}{\fs{Fib}}
\newcommand{\fib}{\ \fs{fib}}
\newcommand{\El}{\fs{El}}

\numberwithin{figure}{section}

\newcommand{\ct}{%
  \mathchoice{\mathbin{\raisebox{0.25ex}{$\displaystyle\centerdot$}}}%
             {\mathbin{\raisebox{0.25ex}{$\centerdot$}}}%
             {\mathbin{\raisebox{0.25ex}{$\scriptstyle\,\centerdot\,$}}}%
             {\mathbin{\raisebox{0.25ex}{$\scriptscriptstyle\,\centerdot\,$}}}
}

\newcommand{\pb}[1][dr]{\save*!/#1-1.2pc/#1:(-1,1)@^{|-}\restore}
\newcommand{\po}[1][dr]{\save*!/#1+1.2pc/#1:(1,-1)@^{|-}\restore}

\begin{document}

\title{Indexed type theories}

\author{Valery Isaev}

\begin{abstract}
\end{abstract}

\maketitle

\section{Introduction}

\section{Indexed unary type theories}

We can think about an indexed type theory as a syntactic representation of indexed $\infty$-categories, that is a functor $F$ from an $\infty$-category $\mathcal{B}$ to the large $\infty$-category of $\infty$-categories.
An indexed type theory consists of two levels.
The first level is just an ordinary type theory and it represents $\mathcal{B}$
Since we are mostly interested in the case when $\mathcal{B}$ is the $\infty$-category of spaces,
we can assume that the first level has all usual constructions such as identity types, $\Sigma$-types, $\Pi$-types, (univalent) universes, and (higher) inductive types.
Nevertheless, in general, we will assume that the base theory has only identity types and $\Sigma$-types; all additional assumptions will be explicitly specified.
We will often talk about functions, but this is only for notational convenience and does not assume that function types exist.
Terms of type $A \to B$ correspond to terms of type $B$ in context $x : A$, so we can talk about functions $A \to B$ as long as this type does not appear inside other types.

The second level of the theory represents $\infty$-categories $F(\Gamma)$ for various objects $\Gamma$ of $\mathcal{B}$.
In this section, we will discuss \emph{indexed unary type theories}, that is indexed type theories in which the second level consists of unary type theories.
A unary type theory is a non-dependent type theory in which contexts consist of exactly one type.
Such theories represent arbitrary 1-categories.
We do not know whether indexed unary type theories represent all indexed $\infty$-categories over a given base, but it seems that this should be true at least for locally small indexed $\infty$-categories.

Indexed unary type theories have four kinds of judgements:
\[ \Gamma \vdash A \type \qquad \Gamma \vdash a : A \qquad \Gamma \mid \cdot \vdash B \ob \qquad \Gamma \mid x : A \vdash b : B \]

In each of these judgements, $\Gamma$ is a context, that is a sequence of the form $x_1 : A_1, \ldots x_n : A_n$, where $A_1$, \ldots $A_n$ are types and $x_1$, \ldots $x_n$ are pairwise distinct variables.
Judgements $\Gamma \vdash A \type$ and $\Gamma \vdash a : A$ represent types and terms of the first level of the theory.
We will call such types and terms \emph{base types} and \emph{base terms}, respectively.
The collection of rules that involve only judgements for base types and base terms will be called the base (sub)theory.
When we say that the base theory has some construction such as $\Pi$-types or universes, this means that there are usual rules for these constructions formulated in terms of these judgements.

Judgements $\Gamma \mid \cdot \vdash A \ob$ represent types of the second level of the theory.
We will call these types \emph{indexed types} to distinguish them from base types.
In a judgement $\Gamma \mid x : A \vdash b : B$, $x$ is a variable which is distinct from the variables in $\Gamma$, $A$ and $B$ are indexed types, and $b$ is a term of the second level of the theory.
We will call such terms \emph{indexed terms}.
Indexed types represent objects indexed by $\Gamma$ and indexed an indexed term $\Gamma \mid x : A \vdash b : B$ represents a morphism between $A$ and $B$.

We have the usual rules for variables and substitutions for the base theory:
\begin{center}
\AxiomC{}
\UnaryInfC{$x_1 : A_1, \ldots x_n : A_n \vdash x_i : A_i$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \vdash C \type$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \vdash C[b_1/y_1, \ldots b_k/y_k] \type$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \vdash c : C$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \vdash c[b_1/y_1, \ldots b_k/y_k] : C[b_1/y_1, \ldots b_k/y_k]$}
\DisplayProof
\end{center}

We also have the usual equations for substitution:
\begin{align*}
y_i[b_1/y_1, \ldots b_k/y_k] & = b_i \\
c[y_1/y_1, \ldots y_k/y_k] & = c \\
d[c_1/z_1, \ldots c_n/z_n][b_1/y_1, \ldots b_k/y_k] & = d[c_1'/z_1, \ldots c_n'/z_n],
\end{align*}
where $c_i' = c_i[b_1/y_1, \ldots b_k/y_k]$.

For every construction $\sigma(\overline{z_1}.\,c_1, \ldots \overline{z_n}.\,c_n)$ in the base theory, we have the following equation whenever variables $\overline{z_1}$, \ldots $\overline{z_n}$ are not free in $b_1$, \ldots $b_k$:
\[ \sigma(\ldots, \overline{z_i}.\,c_i, \ldots)[b_1/y_1, \ldots b_k/y_k] = \sigma(\ldots, \overline{z_i}.\,c_i[b_1/y_1, \ldots b_k/y_k], \ldots) \]
We also have the weakening operation which is left implicit as usual.
This concludes the description of basic rules of the base theory.
They are the usual rules of a dependent type theory which we include here so that they can be compared to the rules of the indexed theory.

Variables of the indexed theory represent identity morphisms and substitution represents composition:
\begin{center}
\AxiomC{}
\UnaryInfC{$\Gamma \mid x : A \vdash x : A$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash b : B$}
\AxiomC{$\Gamma \mid y : B \vdash c : C$}
\BinaryInfC{$\Gamma \mid \Delta \vdash c[b/y] : C$}
\DisplayProof
\end{center}

These operations satisfy the obvious equations:
\begin{align*}
y[b/y] & = b \\
b[x/x] & = b \\
d[c/z][b/y] & = d[c[b/y]/z]
\end{align*}

We can also substitute base terms into indexed types and terms:
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \mid \cdot \vdash C \ob$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid \cdot \vdash C[b_1/y_1, \ldots b_k/y_k] \ob$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \mid z : C \vdash d : D$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid z : C[b_1/y_1, \ldots b_k/y_k] \vdash d[b_1/y_1, \ldots b_k/y_k] : D[b_1/y_1, \ldots b_k/y_k]$}
\DisplayProof
\end{center}

These operations represent reindexing along a morphism in the base category.
They satisfy the following equations:
\begin{align*}
x[b_1/y_1, \ldots b_k/y_k] & = x \\
d[c/z][b_1/y_1, \ldots b_k/y_k] & = d[b_1/y_1, \ldots b_k/y_k][c[b_1/y_1, \ldots b_k/y_k]/z] \\
c[y_1/y_1, \ldots y_k/y_k] & = c \\
d[c_1/z_1, \ldots c_n/z_n][b_1/y_1, \ldots b_k/y_k] & = d[c_1'/z_1, \ldots c_n'/z_n],
\end{align*}
where $c_i' = c_i[b_1/y_1, \ldots b_k/y_k]$.
The first two equations correspond to the fact that reindexing preserves identity morphisms and composition in the indexed theory.
The last two equations correspond to the fact that reindexing is functorial, that is it preserves identity morphisms and composition in the base theory.

For every construction $\sigma(\overline{z_1}.\,c_1, \ldots \overline{z_n}.\,c_k)$ in the indexed theory, we have the following equation whenever variables $\overline{z_1}$, \ldots $\overline{z_n}$ are not free in $b_1$, \ldots $b_k$:
\[ \sigma(\ldots, \overline{z_i}.\,c_i, \ldots)[b_1/y_1, \ldots b_k/y_k] = \sigma(\ldots, \overline{z_i}.\,c_i[b_1/y_1, \ldots b_k/y_k], \ldots) \]
We also have the weakening operation which is left implicit as usual.
This equation corresponds to the fact that all constructions in the indexed category must be stable under reindexing.

As we noted before, we assume that the base theory has identity types:
\begin{center}
\AxiomC{$\Gamma \vdash a : A$}
\AxiomC{$\Gamma \vdash a' : A$}
\BinaryInfC{$\Gamma \vdash \Id_A(a,a') \type$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \vdash a : A$}
\UnaryInfC{$\Gamma \vdash \refl(a) : \Id_A(a,a)$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash a : A$
\noLine
\UnaryInf$\fCenter \Gamma \vdash a' : A$
\noLine
\UnaryInf$\fCenter \Gamma \vdash t : \Id_A(a,a')$
\Axiom$\fCenter \Gamma, x : A, p : \Id_A(a,x), \Delta \vdash D \type$
\noLine
\UnaryInf$\fCenter \Gamma, \Delta[a/x,\refl(a)/p] \vdash d : D[a/x,\refl(a)/p]$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma, \Delta[a'/x,t/p] \vdash J(a, x p \Delta.\,D, \Delta.\,d, a', t) : D[a'/x,t/p]$}
\DisplayProof
\end{center}

\[ J(a, x p \Delta.\,D, \Delta.\,d, a, \refl(a)) = d \]

We will sometimes omit the type in the notation $\Id_A(a,a')$.
The fact that the type $\Id(a,a')$ is inhabited will be denoted by $a \sim a'$.
If $\Gamma \vdash p : \Id_A(a,a')$, $\Gamma, x : A \vdash B \type$, and $\Gamma \vdash b : B[a/x]$, then we will write $\Gamma \vdash p_*(b) : B[a'/x]$ for the usual transport operation defined in terms of $J$.
Operation $\pmap$ is defined in terms of $J$ and has the following type:
if $\Gamma \vdash B \type$, $\Gamma, x : A \vdash b : B$, and $\Gamma \vdash p : \Id_A(a,a')$, then $\Gamma \vdash \pmap(x.b, p) : \Id_B(b[a/x],b[a'/x])$.

An indexed type theory is \emph{locally small} if there is a type of its morphisms.
That is, it must contain the following rules and equations:
\begin{center}
\AxiomC{$\Gamma \mid \cdot \vdash A \ob$}
\AxiomC{$\Gamma \mid \cdot \vdash B \ob$}
\BinaryInfC{$\Gamma \vdash \Hom(A,B) \type$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid x : A \vdash b : B$}
\UnaryInfC{$\Gamma \vdash \lambda x.\,b : \Hom(A,B)$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \vdash f : \Hom(A,B)$}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\BinaryInfC{$\Gamma \mid \Delta \vdash f\,a : B$}
\DisplayProof
\end{center}

\begin{align*}
(\lambda x.\,b)\,a & = b[a/x] \\
\lambda x.\,f\,x & = f
\end{align*}

We might also use notation $A \to B$ for $\Hom(A,B)$, but we prefer the latter notation since the former may be confusing.
Indeed, $A \to B$ might also denote the indexed type of functions if the indexed theory is Cartesian closed or the base type of function if $A$ and $B$ are base types.

If the indexed theory is locally small, then indexed types must carry the structure of an $\infty$-category.
We cannot construct this structure internally due to coherence issues, but we can at least construct lower levels of this structure.
Morphisms between indexed types $A$ and $B$ are terms of type $\Hom(A,B)$.
The identity morphism $\id_A$ on an indexed type $A$ is $\lambda x.\,x : \Hom(A,A)$.
Composition of morphisms $f : \Hom(A,B)$ and $g : \Hom(B,C)$ is defined as $\lambda x.\,g\,(f\,x) : \Hom(A,C)$ and denoted by $g \circ f$.
Composition is strictly associative and identity morphisms are strictly unital.

If $f,g : \Hom(A,B)$ are morphisms, then a 2-morphism between them is a term $p : \Id_{\Hom(A,B)}(f,g)$.
Vertical composition $p \ct q$ of 2-morphisms $p$ and $q$ is defined as the usual operation of path concatenation.
The identity 2-morphism on $f : \Hom(A,B)$ is $\refl(f)$.
Vertical composition is associative, identity 2-morphisms are unital, and every 2-morphism is invertible.
These facts are true in a weak sense, that is up to a 3-morphism.
Let $f,g : \Hom(A,B)$ and $h,i : \Hom(B,C)$ be morphisms and let $p : \Id_{\Hom(A,B)}(f,g)$ and $q : \Id_{\Hom(B,C)}(h,i)$ be 2-morphisms.
The horizontal composition of $p$ and $q$ is a term $p * q$ of type $\Id_{\Hom(A,C)}(\lambda x.\,h\,(f\,x), \lambda x.\,i\,(g\,x))$.
To define $p * q$, we just need to eliminate $p$ and $q$ and then define $\refl(f) * \refl(h)$ as $\refl(\lambda x.\,h\,(f\,x))$.
It is easy to prove that usual properties of this operation hold.
Expressions $\refl(f) * q$, $p * \refl(g)$, and $\refl(f) * \refl(g)$ will be denoted by $f * q$, $p * g$, and $f * g$, respectively.

\begin{defn}
An equivalence between indexed types $A$ and $B$ is a morphism $f : \Hom(A,B)$ such that there is a morphism $g : \Hom(B,A)$ such that $g \circ f \sim \id_A$ and $f \circ g \sim \id_B$.
\end{defn}

If the indexed theory is locally small, then not only base morphisms act on indexed types and terms, but also homotopies between them.
Let $\Gamma \vdash a : A$ and $\Gamma \vdash a' : A$ be two base terms.
If $\Gamma, x : A \mid \cdot \vdash B \ob$ be an indexed type, then we have indexed types $\Gamma \mid \cdot \vdash B[a/x] \ob$ and $\Gamma \mid \cdot \vdash B[a'/x] \ob$.
Let $\Gamma \vdash h : \Id_A(a,a')$ be homotopy between $a$ and $a'$.
Then we can construct an equivalence between $B[a/x]$ and $B[a'/x]$.
A map $f : \Hom(B[a/x],B[a'/x])$ is defined as $J(a, x p.\,\Hom(B[a/x],B), \id_{B[a/x]}, a', h)$.
A map $g : \Hom(B[a'/x],B[a/x])$ is constructed similarly: $\lambda y.\,J(a, x p.\,\Hom(B,B[a/x]), \id_{B[a/x]}, a', h)$.
To prove that $g \circ f$ and $f \circ g$ are homotopic to identity morphisms, it is enough to eliminate $h$ using $J$ and then both $g \circ f$ and $f \circ g$ become identity morphisms.

\section{Equivalences}

In this section, we define types that express the property of a map $f : \Hom(A,B)$ of being an equivalence and prove that they are equivalent.
We also prove a few simple properties of equivalences.
These questions were studied in \cite[Section~4]{hottbook} for ordinary homotopy type theory.
Most of the theorems in this section also hold in the framework of indexed unary type theories, but the proofs must be modified.

\subsection{Bi-invertible maps}

Let $f : \Hom(A,B)$ be a morphism.
We will say that $f$ is \emph{bi-invertible} if the following type is inhabited:
\[ \fs{biinv}(f) = \fs{linv}(f) \times \fs{rinv}(f), \]
where $\fs{linv}(f)$ and $\fs{rinv}(f)$ are types of left and right inverses of $f$, respectively:
\begin{align*}
\fs{linv}(f) & = \sum_{g : \Hom(B,A)} \Id(g \circ f, \id_A) \\
\fs{rinv}(f) & = \sum_{g : \Hom(B,A)} \Id(f \circ g, \id_B)
\end{align*}

\begin{prop}[biinv-equiv]
A map is bi-invertible if and only if it is an equivalence.
\end{prop}
\begin{proof}
Obviously, if a map is an equivalence, then it is bi-invertible.
Let us prove the converse.
Let $g : \Hom(B,A)$, $p : \Id(g \circ f, \id_A)$ be a left inverse of $f$ and let $g' : \Hom(B,A)$, $p' : \Id(f \circ g', \id_B)$ be a right inverse of $f$.
Then $g' * p : \Id(g \circ f \circ g', g')$.
Since $f \circ g' \sim \id_B$, there is a term of type $\Id(g,g')$.
It follows that $g$ is an inverse of $f$.
\end{proof}

\begin{lem}[lrinv-contr]
If $f$ is an equivalence, then types $\fs{linv}(f)$ and $\fs{rinv}(f)$ are contractible.
\end{lem}
\begin{proof}
If $f$ is an equivalence, then precomposition with $f$ is an equivalence between types $\Hom(B,C)$ and $\Hom(A,C)$.
Similarly, postcomposition with $f$ is an equivalence between types $\Hom(C,A)$ and $\Hom(C,B)$.
Since $\fs{linv}(f)$ and $\fs{rinv}(f)$ are fibres of these maps over the identity morphisms, \cite[Theorem~4.2.3]{hottbook} and \cite[Theorem~4.2.6]{hottbook} imply that these types are contractible.
Note that the proofs of these theorems work even if we do not have $\Pi$-types.
\end{proof}

\begin{prop}
The type $\fs{biinv}(f)$ is a proposition.
\end{prop}
\begin{proof}
This follows from \rprop{biinv-equiv} and \rlem{lrinv-contr}.
\end{proof}

\subsection{Half adjoint equivalences}

Let $f : \Hom(A,B)$ be a morphism.
We will say that $f$ is a \emph{half adjoint equivalence} if the following type is inhabited:
\[ \fs{ishae}(f) = \sum_{g : \Hom(B,A)} \sum_{\eta : \Id(g \circ f, \id_A)} \sum_{\epsilon : \Id(f \circ g, \id_B)} \Id(\eta * f, f * \epsilon). \]

\begin{prop}
A map is a half adjoint equivalence if and only if it is an equivalence.
\end{prop}
\begin{proof}
Obviously, if a map is a half adjoint equivalence, then it is an equivalence.
Let us prove the converse.
Let $g : \Hom(B,A)$, $\eta : \Id(g \circ f, \id_A)$, $\epsilon : \Id(f \circ g, \id_B)$ be an inverse of $f$.
Then we define $\epsilon' : \Id(f \circ g, \id_B)$ as concatenation of paths
$g * f * \sym{\epsilon} : \Id(f \circ g, f \circ g \circ f \circ g)$, $g * \eta * f : \Id(f \circ g \circ f \circ g, f \circ g)$, and $\epsilon : \Id(f \circ g, \id_B)$.
We need to prove that $f * \epsilon' \sim \eta * f$.

First, note that $\eta * f * g \sim f * g * \eta$.
Indeed, $(\eta * f * g) \ct \eta \sim \eta * \eta \sim (f * g * \eta) \ct \eta$.
Thus, if we cancel $\eta$, this gives us a homotopy between the original paths.
Now, we can finish the proof:
\begin{align*}
f * \epsilon' & \sim \\
(f * g * f * \sym{\epsilon}) \ct (f * g * \eta * f) \ct (f * \epsilon) & \sim \\
(f * g * f * \sym{\epsilon}) \ct (\eta * f * g * f) \ct (f * \epsilon) & \sim \\
(\eta * f * \sym{\epsilon}) \ct (f * \epsilon) & \sim \\
(\eta * f) \ct (f * \sym{\epsilon}) \ct (f * \epsilon) & \sim \\
\eta * f & .
\end{align*}
\end{proof}

\begin{prop}
The type $\fs{ishae}(f)$ is a proposition.
\end{prop}
\begin{proof}
We can assume that $f$ is an equivalence and prove that $\fs{ishae}(f)$ is contractible.
By \rlem{lrinv-contr}, the type $\Sigma_{g : \Hom(B,A)} \Id(g \circ f, \id_A)$ is contractible.
Thus, we just need to prove that, for every $g : \Hom(B,A)$ and $\eta : \Id(g \circ f, \id_A)$, the type $\Sigma_{\epsilon : \Id(f \circ g, \id_B)} \Id(\eta * f, f * \epsilon)$ is also contractible.

Since $f$ is an equivalence, the function $f * -$ is also an equivalence.
It follows that the type $\Id(\eta * f, f * \epsilon)$ is equivalent to the type $\Id(h(\eta * f), \epsilon)$, where $h$ is the inverse of $f * -$.
Thus, the type $\Sigma_{\epsilon : \Id(f \circ g, \id_B)} \Id(\eta * f, f * \epsilon)$ is equivalent to the type $\Sigma_{\epsilon : \Id(f \circ g, \id_B)} \Id(h(\eta * f), \epsilon)$, which is contractible by \cite[Lemma~3.11.8]{hottbook}.
\end{proof}

\subsection{Properties of equivalences}

\begin{prop}
Equivalences satisfy the 2-out-of-6 property.
That is, if $f : \Hom(A,B)$, $g : \Hom(B,C)$, and $h : \Hom(C,D)$ are maps such that $g \circ f$ and $h \circ g$ are equivalences, then so are the maps $f$, $g$, $h$, and $h \circ g \circ f$.
\end{prop}
\begin{proof}
Let $i : \Hom(C,A)$ be an inverse of $g \circ f$ and let $k : \Hom(D,B)$ be an inverse of $h \circ g$.
Since $g \circ f \circ i \sim \id_C$ and $h \circ g \circ k \sim \id_D$, \rprop{biinv-equiv} implies that $g$ is an equivalence.
The map $i \circ g$ is an inverse of $f$.
Indeed, $i \circ g \circ f \sim \id_A$ since $i$ is an inverse of $g \circ f$.
Since $g \circ f \circ i \sim \id_C$, it follows that $g \circ f \circ i \circ g \sim g$.
Since $g$ is an equivalence, this implies that $f \circ i \circ g \sim \id_B$.
Similarly, $g \circ k$ is an inverse of $h$.
The map $h \circ g \circ f$ is an equivalence since equivalences are closed under composition.
\end{proof}

A map $f : \Hom(A,B)$ is a \emph{quasi-retract} of a map $g : \Hom(C,D)$ if there is a commutative diagram of the form
\[ \xymatrix{ A \ar[r]^i \ar[d]_f & C \ar[r]^j \ar[d]_g & A \ar[d]_f \\
              B \ar[r]_k          & D \ar[r]_m          & B
            } \]
such that $j \circ i \sim \id_A$ and $m \circ k \sim \id_B$.

\begin{prop}
Equivalences are closed under quasi-retracts.
\end{prop}
\begin{proof}
Let $f : \Hom(A,B)$ be a retract of $g : \Hom(C,D)$ and let $i,j,k,m$ be maps as in the diagram above.
Let $h : \Hom(D,C)$ be an inverse of $g$.
Then $j \circ h \circ k$ is an inverse of $f$.
Indeed, $j \circ h \circ k \circ f \sim j \circ h \circ g \circ i \sim j \circ \id_C \circ i = j \circ i \sim \id_B$ and
$f \circ j \circ h \circ k \sim m \circ g \circ h \circ k \sim m \circ \id_D \circ k = m \circ k \sim \id_B$.
\end{proof}

\section{Limits and colimits}

In this section, we will work in a locally small indexed unary type theory.
We will define specific finite (co)limits and arbitrary (co)products.

\subsection{Finite (co)limits}

An indexed type $T$ is \emph{terminal} if, for every indexed type $X$, the type $\Hom(X,T)$ is contractible.
Dually, an indexed type $T$ is \emph{initial} if, for every indexed type $X$, the type $\Hom(T,X)$ is contractible.
Terminal and initial types are unique up to unique equivalence, that is the type of equivalences between a pair of terminal or initial types is contractible.
We will say that an indexed unary type theory \emph{has terminal (resp., initial) types} if, for every context $\Gamma$, there is a terminal (resp., initial) type $\Gamma \mid \cdot \vdash T \ob$.

A \emph{binary product} of indexed types $A$ and $B$ is an indexed type $A \times B$ together with a pair of maps $\pi_1 : \Hom(A \times B, A)$ and $\pi_2 : \Hom(A \times B, B)$
such that the following function is an equivalence for every indexed type $C$:
\[ \lambda h.\,(\pi_1 \circ h, \pi_2 \circ h) : \Hom(C, A \times B) \to \Hom(C,A) \times \Hom(C,B). \]
The inverse of this function will be denoted by $\langle -, - \rangle$.
An indexed unary type theory \emph{has binary products} if a binary product exists for every pair of types in every context.
\emph{Binary coproducts} $A \amalg B$ are defined dually.

An \emph{equalizer} of a pair of maps $f,g : \Hom(A,B)$ is a map $e : \Hom(E,A)$ together with a homotopy $p : \Id(f \circ e, g \circ e)$
such that the following function is an equivalence for every indexed type $E'$:
\[ \lambda h.\,(e \circ h, h * p) : \Hom(E', E) \to \sum_{e' : \Hom(E',A)} \Id(f \circ e', g \circ e'). \]
An indexed unary type theory \emph{has equalizers} if an equalizer exists for every parallel pair of maps in every context.
\emph{Coequalizers} are defined dually.

A \emph{pullback} of a pair of maps $f : \Hom(A,C)$ and $g : \Hom(B,C)$ is a triple $\pi_1 : \Hom(A \times_C B, A)$, $\pi_2 : \Hom(A \times_C B, B)$, $\pi_3 : \Id(f \circ \pi_1, g \circ \pi_2)$
such that the following function is an equivalence for every indexed type $P'$:
\[ \lambda h.\,(\pi_1 \circ h, \pi_2 \circ h, h * \pi_3) : \Hom(P, A \times_C B) \to \Hom(P,A) \times_{\Hom(P,C)} \Hom(P,B), \]
where the pullback of types $\Hom(P,A) \times_{\Hom(P,C)} \Hom(P,B)$ is defined as usual:
\[ \sum_{\pi_1' : \Hom(P,A)} \sum_{\pi_2' : \Hom(P,B)} \Id(f \circ \pi_1', g \circ \pi_2'). \]
An indexed unary type theory \emph{has pullbacks} if a pullback exists for every pair of maps with a common codomain in every context.
\emph{Pushouts} $A \amalg_C B$ are defined dually.

\begin{remark}
Binary (co)products, (co)equalizers, pullbacks, and pushouts are unique up to unique equivalence.
\end{remark}

\begin{remark}
The function $\Hom(C,-)$ preserves binary products, equalizers, and pullbacks.
\end{remark}

We have the following standard proposition:

\begin{prop}[fin-lim]
An indexed unary type theory with terminal types has pullbacks if and only if it has equalizers and binary products.
\end{prop}
\begin{proof}
First, suppose that the theory has a terminal type $1$ and pullbacks.
Then we can define a product of types $A$ and $B$ as the pullback of unique maps $!_A : \Hom(A,1)$ and $!_B : \Hom(B,1)$.
Since $\Hom(P,1)$ is contractible, the obvious projection $\Hom(P,A) \times_{\Hom(P,1)} \Hom(P,B) \to \Hom(P,A) \times \Hom(P,B)$ is an equivalence.
This implies that $A \times_1 B$ is a product of $A$ and $B$.

An equalizer of maps $f,g : \Hom(A,B)$ can be defined as the pullback of $\langle \id_B, \id_B \rangle : \Hom(B, B \times B)$ along $\langle f, g \rangle : \Hom(A, B \times B)$:
\[ \xymatrix{ E \ar[r]^s \ar[d]_e & B \ar[d]^{\langle \id_B, \id_B \rangle} \\
              A \ar[r]_-{\langle f, g \rangle} & B \times B
            } \]
By the definition of products, the type of homotopies $\Id_{\Hom(P, B \times B)}(r,r')$ is equivalent to the type $\Id_{\Hom(P,B)}(\pi_1 \circ r, \pi_1 \circ r') \times \Id_{\Hom(P,B)}(\pi_2 \circ r, \pi_2 \circ r')$.
Thus, by the definition of pushouts, we have the following equivalence:
\begin{align*}
& \Hom(P,E) \to \sum_{a : \Hom(P,A)} \sum_{b : \Hom(P,B)} \Id(f \circ a, b) \times \Id(g \circ a, b) \\
& \lambda q.\,(e \circ q, s \circ q, q * h_1, q * h_2),
\end{align*}
where $h_1 : \Id(f \circ e, s)$ and $h_2 : \Id(g \circ e, s)$ are certain homotopies.
The codomain of this function is equivalent to $\Sigma_{a : \Hom(P,A)} \Id(f \circ a, g \circ a)$.
This implies that we have the following equivalence:
\[ \lambda q.\,(e \circ q, q * (h_1 \ct \sym{h_2})) : \Hom(P,E) \to \sum_{a : \Hom(P,A)} \Id(f \circ a, g \circ a). \]
Thus, we can define an equalizer of maps $f$ and $g$ as the triple $E$, $e$, $h_1 \ct \sym{h_2}$.

Now, suppose that the theory has binary products and equalizers.
Let $f : \Hom(A,C)$ and $g : \Hom(B,C)$ be a pair of maps.
Let $e : P \to A \times B$, $h : \Id(f \circ \pi_1 \circ e, g \circ \pi_2 \circ e)$ be the equalizer of the maps $f \circ \pi_1, g \circ \pi_2 : A \times B \to C$.
Then we can define a pullback of $f$ and $g$ as the triple $\pi_1 \circ e$, $\pi_2 \circ e$, $h$.
The universal property of equalizers implies the universal property of pullbacks.
\end{proof}

\begin{defn}[fin-lim]
An indexed unary type theory \emph{has finite limits} if equivalent conditions of \rprop{fin-lim} hold.
\end{defn}

\begin{example}
If an indexed unary type theory has a terminal type $\term$ with a point $\unit : \term$, then the \emph{loop space type} of a pointed type $Y$, $y_0 : \Hom(\term,Y)$ is the pullback of $y_0$ and $y_0$.
Equivalently, the loop space type is the equalizer of $y_0$ and $y_0$.
Thus, the loop space type is a type $\Omega(Y,y_0)$ together with a homotopy $\Id_{\Hom(\Omega(Y,y_0), Y)}(\lambda s.\,y_0\,\unit, \lambda s.\,y_0\,\unit)$ satisfying the universal property.
Since $\Hom(X,-)$ preserves terminal types and pullbacks, we have the following equivalence:
\[ \Hom(X, \Omega(Y,y_0)) \simeq \Omega(\Hom(X,Y), \lambda x.\,y_0\,\unit), \]
where the second $\Omega$ is the usual loop space base type: $\Omega(S,s_0) = \Id_S(s_0,s_0)$.
\end{example}

\begin{example}
The \emph{suspension} $\Sigma X$ of a type $X$ is the pushout of the maps $\lambda x.\,\unit, \lambda x.\,\unit : \Hom(X,\term)$.
The \emph{$0$-sphere} $S^0$ is the coproduct $\term \amalg \term$.
The \emph{$(n+1)$-sphere} $S^{n+1}$ is the suspension $\Sigma S^n$.
\end{example}

\subsection{(Co)products}
\label{sec:products}

A \emph{product} of an indexed type $\Gamma, i : I \mid \cdot \vdash B \ob$ is an indexed type $\Gamma \mid \cdot \vdash P \ob$ together with a term $\Gamma, i : I \vdash \pi : \Hom(P,B)$
such that the function $\pi \circ -$ has an inverse in the sense that there is a rule of the form
\begin{center}
\AxiomC{$\Gamma \mid \cdot \vdash P' \ob$}
\AxiomC{$\Gamma, i : I \vdash f : \Hom(P',B)$}
\BinaryInfC{$\Gamma \vdash \langle f \rangle_{i : I} : \Hom(P',P)$}
\DisplayProof
\end{center}
and the following types are inhabited:
\begin{align*}
& \Id(\pi \circ \langle f \rangle_{i : I}, f) \\
& \Id(\langle \pi \circ f \rangle_{i : I}, f).
\end{align*}

The theory of coproducts is defined dually.
A \emph{coproduct} of an indexed type $\Gamma, i : I \mid \cdot \vdash B \ob$ is an indexed type $\Gamma \mid \cdot \vdash C \ob$ together with a term $\Gamma, i : I \vdash \fs{in} : \Hom(B,C)$
such that the function $- \circ \fs{in}$ has an inverse in the sense that there is a rule of the form
\begin{center}
\AxiomC{$\Gamma \mid \cdot \vdash C' \ob$}
\AxiomC{$\Gamma, i : I \vdash f : \Hom(B,C')$}
\BinaryInfC{$\Gamma \vdash [ f ]_{i : I} : \Hom(C,C')$}
\DisplayProof
\end{center}
and the following types are inhabited:
\begin{align*}
& \Id([ f ]_{i : I} \circ \fs{in}, f) \\
& \Id([ f \circ \fs{in} ]_{i : I}, f).
\end{align*}

If the $\Pi$-type $\Pi_{i : I} \Hom(P',B)$ exists for all indexed types $\Gamma \mid \cdot \vdash P' \ob$, then a pair $P$, $\pi$ is a product of a family $B$ if and only if the following function is an equivalence for every indexed type $P'$:
\[ \lambda h.\,\lambda i.\,\pi \circ h : \Hom(P',P) \to \prod_{i : I} \Hom(P',B). \]
Dually, if the $\Pi$-type $\Pi_{i : I} \Hom(B,C')$ exists for all indexed types $\Gamma \mid \cdot \vdash C' \ob$, then a pair $C$, $\fs{in}$ is a product of a family $B$ if and only if the following function is an equivalence for every indexed type $C'$:
\[ \lambda h.\,\lambda i.\,h \circ \fs{in}(i) : \Hom(C,C') \to \prod_{i : I} \Hom(B,C'). \]

Products and coproducts are unique up to unique equivalence.
We will denote the product and the coproduct of a family $\Gamma, i : I \mid \cdot \vdash B \type$ by $\prod_{i : I} B$ and $\coprod_{i : I} B$, respectively.

We can also define the theory of \emph{strict products}:
\begin{center}
\AxiomC{$\Gamma, i : I \mid \cdot \vdash B \ob$}
\UnaryInfC{$\Gamma \mid \cdot \vdash \prod_{i : I} B \ob$}
\DisplayProof
\qquad
\AxiomC{$\Gamma, i : I \mid \Delta \vdash b : B$}
\RightLabel{, $i \notin \mathrm{FV}(\Delta)$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \lambda i.\,b : \prod_{i : I} B$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash f : \prod_{i : I} B$}
\AxiomC{$\Gamma \vdash j : I$}
\BinaryInfC{$\Gamma \mid \Delta \vdash f\,j : B[j/i]$}
\DisplayProof
\end{center}

\begin{align*}
(\lambda i.\,b)\,j & = b[j/i] \\
\lambda i.\,f\,i & = f
\end{align*}

The difference between weak and strict products is that the former requires types $\Hom(P',\prod_{i : I} B)$ and $\Pi_{i : I} \Hom(P',B)$ to be equivalent while the latter requires them to be \emph{isomorphic}.
In particular, the type $\Pi_{i : I} \Hom(P',B)$ always exists in a theory with strict products.
Of course, the theory of products can be interpreted in the theory of strict products, but not the other way around.
Nevertheless, these theories should be weakly equivalent.
We will sometimes use the notation with $\lambda$ and application for weak products since we still can define these operations for them (with the caveat that the last two equalities do not hold judgementally for weak products).

\begin{example}
If $\Gamma \vdash I \type$ is a base type and $\Gamma \mid \cdot \vdash X \type$ is an indexed type, then the \emph{power} (or \emph{cotensor}) of $X$ by $I$ is the product $\prod_{i : I} X$.
The \emph{copower} (or \emph{tensor}) of $X$ by $I$ is the coproduct $\coprod_{i : I} X$.
The power will be denoted by $X^I$ and the tensor by $I \cdot X$.
\end{example}

Let us prove a few properties of products and coproducts.
To simplify the notation, we will assume that the base theory of an indexed theory with a product $\prod_{i : I} B$ has $\Pi$-types $\Pi_{i : I} \Hom(P,B)$ for all $P$.
The following proposition shows that the (co)product of a contractible family of types is any type of this family:

\begin{prop}
Let $I$ be a contractible type and let $i_0$ be a point of $I$.
Then types $\prod_{i : I} B$, $\coprod_{i : I} B$, and $B[i_0/i]$ are equivalent.
\end{prop}
\begin{proof}
Let $p(i)$ be a path between $i_0$ and $i : I$.
Then the pair $B[i_0/i], \pi_i = \lambda x.\,p(i)_*(x)$ is a product of $B$.
We can define $\langle f \rangle_{i : I}$ as $\lambda x.\,\sym{p(i)}_*(f\,x)$.
Clearly, this is an inverse to $\pi \circ -$.
Since $B[i_0/i],\pi$ is a product and products are unique up to equivalence, it follows that $B[i_0/i]$ is equivalent to $\prod_{i : I} B$.
Similar argument shows that it is also equivalent to $\coprod_{i : I} B$.
\end{proof}

The following proposition shows how to compute products and coproducts indexed by $\Sigma$-types:

\begin{prop}
Let $\Gamma \vdash I \type$ and $\Gamma, i : I \vdash J \type$ be base types and let $\Gamma, i : I, j : J \mid \cdot \vdash B \ob$ be an indexed type.
Then types $\prod_{(p : \Sigma_{i : I} J)} B[\pi_1(p)/i, \pi_2(p)/j]$ and $\prod_{i : I} \prod_{j : J} B$ are equivalent.
Dually, types $\coprod_{(p : \Sigma_{i : I} J)} B[\pi_1(p)/i, \pi_2(p)/j]$ and $\coprod_{i : I} \coprod_{j : J} B$ are equivalent.
\end{prop}
\begin{proof}
We will prove this statement for products; the case of coproducts is dual.
To do this, it is enough to show that $\prod_{i : I} \prod_{j : J} B$ is a product of $\Gamma , p : \Sigma_{i : I} J \mid \cdot \vdash B[\pi_1(p)/i, \pi_2(p)/j] \ob$.
We define projections as follows:
\[ \lambda f.\,f\,(\pi_1(p))\,(\pi_2(p)) : \Hom(\prod_{i : I} \prod_{j : J} B, B[\pi_1(p)/i,\pi_2(p)/j]). \]
We need to show that the following map is an equivalence:
\begin{align*}
& \Hom(X, \prod_{i : I} \prod_{j : J} B) \to \prod_{p : \sum_{i : I} J} \Hom(X, B[\pi_1(p)/i,\pi_2(p)/j]) \\
& \lambda g.\,\lambda p.\,\lambda x.\,g\,x\,(\pi_1(p))\,(\pi_2(p)).
\end{align*}
Note that this map factors through the following maps:
\begin{align*}
\lambda g.\,\lambda i j.\,\lambda x.\,g\,x\,i\,j & : \Hom(X, \prod_{i : I} \prod_{j : J} B) \to \prod_{i : I} \prod_{j : J} \Hom(X,B) \\
\lambda h p.\,h\,(\pi_1(p))\,(\pi_2(p)) & : (\prod_{i : I} \prod_{j : J} \Hom(X,B)) \to \prod_{p : \sum_{i : I} J} \Hom(X, B[\pi_1(p)/i,\pi_2(p)/j]).
\end{align*}
The first map is an equivalence since $\prod_{i : I} \prod_{j : J} B$ is a product and the fact that the second map is an equivalence is an easy exercise in the ordinary type theory.
\end{proof}

The following proposition shows that the product of an empty family of types is the terminal object and the coproduct of such a family is initial:

\begin{prop}
Suppose that the base theory has the empty type $\bot$.
Let $\Gamma, i : \bot \mid \cdot \vdash B \ob$ be an indexed type.
Then $\prod_{i : \bot} B$ is terminal and $\coprod_{i : \bot} B$ is initial.
\end{prop}
\begin{proof}
Since $\Hom(P, \prod_{i : \bot} B)$ is equivalent to $\Pi_{i : \bot} \Hom(P,B)$ and $\Hom(\coprod_{i : \bot} B, P)$ is equivalent $\Pi_{i : \bot} \Hom(B,P)$,
the statement follows from the fact that $\Pi_{i : \bot} X$ is contractible for every base type $X$.
\end{proof}

The following proposition shows how to compute products and coproducts indexed by pushouts:

\begin{prop}
Suppose that the base theory has the following pushout:
\[ \xymatrix{ K \ar[r]^-g \ar[d]_-f & J \ar[d]^-{f'} \\
              I \ar[r]_-{g'}        & \po I \amalg_K J.
            } \]
Let $\Gamma, s : I \amalg_K J \mid \cdot \vdash B \ob$ be an indexed type.
Then we have the following canonical equivalences:
\begin{align*}
\prod_{s : I \amalg_K J} B & \simeq (\prod_{i : I} B[g' i/s]) \times_{(\prod_{k : K} B[g' (f k) / s])} (\prod_{j : J} B[f' j/s]) \\
\coprod_{s : I \amalg_K J} B & \simeq (\coprod_{i : I} B[g' i/s]) \amalg_{(\coprod_{k : K} B[f' (g k) / s])} (\coprod_{j : J} B[f' j/s]).
\end{align*}
\end{prop}
\begin{proof}
We will construct the first equivalence; the second is its dual.
First, let us define maps that appears in the pullback in the statement of this proposition.
The map $\Hom(\prod_{i : I} B[g' i/s], \prod_{k : K} B[g' (f k) / s])$ is defined as $\lambda p.\,\lambda k.\,p\,(f\,k)$.
One of the constructors of the pushout $I \amalg_K J$ gives us a map $h : \Pi_{k : K} \Id(f'\,(g\,k),g'\,(f\,k))$.
The map $\Hom(\prod_{j : J} B[f' j/s], \prod_{k : K} B[g' (f k) / s])$ is defined as $\lambda p.\,\lambda k.\,h(k)_*(p\,(g\,k))$.

Now, let us check that this pullback has the universal property of the product.
% TODO
\end{proof}

The following corollary shows how to compute tensoring by different type-theoretic constructions:

\begin{cor}
We have the following canonical equivalences:
\begin{align*}
\bot \cdot X & \simeq 0 \\
(I \amalg_K J) \cdot X & \simeq I \cdot X \amalg_{K \cdot X} J \cdot X \\
\top \cdot X & \simeq X \\
(\sum_{i : I} J) \cdot X & \simeq \coprod_{i : I} J \cdot X \\
(\Sigma I) \cdot 1 & \simeq \Sigma (I \cdot 1) \\
S^n \cdot 1 & \simeq S^n
\end{align*}
\end{cor}
\begin{proof}
The first four equivalences follow from previous propositions.
The equivalence for suspension follows from previous equations since suspension is defined in terms of pushouts and terminal types.
The last equivalence follows from previous since spheres are defined in terms of suspensions, coproducts, and terminal types.
\end{proof}

\begin{example}
Let $S^1$ be the pushout of $1 \amalg 1$ in the base theory, that is a higher inductive type with two point constructors $N,S : S^1$ and two path constructors $L,R : \Id_{S^1}(N,S)$.
Then the product of a family $\Gamma, x : S^1 \mid \cdot \vdash B$ is the equalizer of the maps $L_*(-),R_*(-) : B[N/x] \to B[S/x]$.
\end{example}

\section{Indexed dependent type theories}

In this section, we define the dependent version of indexed type theories.

\subsection{Basic rules}

\emph{Indexed dependent type theories} have four kinds of judgements:
\[ \Gamma \vdash A \type \qquad \Gamma \vdash a : A \qquad \Gamma \mid \Delta \vdash B \ob \qquad \Gamma \mid \Delta \vdash b : B \]

In each of these judgements, $\Delta$ is an indexed context, that is a sequence of the form $y_1 : B_1, \ldots y_k : B_k$, where $B_1$, \ldots $B_k$ are indexed types and $y_1$, \ldots $y_k$ are pairwise distinct variables.
The base theory has the same rules as the base theory in indexed unary type theories.
The indexed theory has the following rules:
\begin{center}
\AxiomC{}
\UnaryInfC{$\Gamma \mid x_1 : A_1, \ldots x_n : A_n \vdash x_i : A_i$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \mid \Delta \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \mid \Delta \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma \mid \Delta, y_1 : B_1, \ldots y_k : B_k \vdash C \type$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid \Delta \vdash C[b_1/y_1, \ldots b_k/y_k] \type$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \mid \Delta \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \mid \Delta \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma \mid \Delta, y_1 : B_1, \ldots y_k : B_k \vdash c : C$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid \Delta \vdash c[b_1/y_1, \ldots b_k/y_k] : C[b_1/y_1, \ldots b_k/y_k]$}
\DisplayProof
\end{center}

We also have the usual equations for substitution:
\begin{align*}
y_i[b_1/y_1, \ldots b_k/y_k] & = b_i \\
c[y_1/y_1, \ldots y_k/y_k] & = c \\
d[c_1/z_1, \ldots c_n/z_n][b_1/y_1, \ldots b_k/y_k] & = d[c_1'/z_1, \ldots c_n'/z_n],
\end{align*}
where $c_i' = c_i[b_1/y_1, \ldots b_k/y_k]$.

We often assume that, for every construction $\sigma(\overline{z_1}.\,c_1, \ldots \overline{z_n}.\,c_n)$ in the indexed theory, the following equation holds whenever variables $\overline{z_1}$, \ldots $\overline{z_n}$ are not free in $b_1$, \ldots $b_k$:
\[ \sigma(\ldots, \overline{z_i}.\,c_i, \ldots)[b_1/y_1, \ldots b_k/y_k] = \sigma(\ldots, \overline{z_i}.\,c_i[b_1/y_1, \ldots b_k/y_k], \ldots) \]
We also have the weakening operation which is left implicit as usual.
We will call a theory or a construction \emph{unstable} if this equation does not hold.

We can also substitute base terms into indexed types and terms:
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \mid \Delta \vdash C \ob$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid \Delta[b_1/y_1, \ldots b_k/y_k] \vdash C[b_1/y_1, \ldots b_k/y_k] \ob$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \mid \Delta \vdash c : C$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid \Delta[b_1/y_1, \ldots b_k/y_k] \vdash c[b_1/y_1, \ldots b_k/y_k] : C[b_1/y_1, \ldots b_k/y_k]$}
\DisplayProof
\end{center}

These operations satisfy the following equations for all base terms $b_1$, \ldots $b_k$ and indexed terms $c_1$, \ldots $c_n$:
\begin{align*}
x[b_1/y_1, \ldots b_k/y_k] & = x \\
d[c_1/z_1, \ldots c_n/z_n][b_1/y_1, \ldots b_k/y_k] & = d[c_1'/z_1, \ldots c_n'/z_n],
\end{align*}
where $c_i' = c_i[b_1/y_1, \ldots b_k/y_k]$.

These operations satisfy the following equations for all base terms $b_1$, \ldots $b_k$, $c_1$, \ldots $c_n$:
\begin{align*}
c[y_1/y_1, \ldots y_k/y_k] & = c \\
d[c_1/z_1, \ldots c_n/z_n][b_1/y_1, \ldots b_k/y_k] & = d[c_1'/z_1, \ldots c_n'/z_n],
\end{align*}
where $c_i' = c_i[b_1/y_1, \ldots b_k/y_k]$.

Since the second level of an indexed dependent type theory is also a dependent type theory,
we can add standard type-theoretic construction to it.
When we add such a construction, we always assume that it is defined in every base context.

Indexed dependent type theories have the same rules as indexed unary type theories.
This means that indexed unary type theories can be interpreted in indexed dependent type theories.
This implies that every model of an indexed dependent type theory is a model of corresponding unary theory
(that is, there is a forgetful functor from the category of models of an indexed dependent theory to the category of models of an indexed unary theory).
Every model of an ordinary dependent type theory (as defined in \cite{alg-tt}) is a model of an indexed dependent type theory.
This follows from the fact that indexed type theories can be interpreted in ordinary dependent type theories.

Judgements $\Gamma \mid \Delta \vdash A \ob$ and $\Gamma \mid \Delta \vdash a : A$ are interpreted as $\Gamma, \Delta \vdash A \type$ and $\Gamma, \Delta \vdash a : A$, respectively.
All the rules of indexed dependent type theories correspond to some rules of ordinary dependent type theories.
This interpretation will be called \emph{the canonical indexing of a dependent type theory over itself}.
It is analogous to the canonical indexing of a cartesian category over itself.

\subsection{Dependent $\Hom$-types}

Since every indexed dependent type theory is an indexed unary type theory, the extensions that we discussed in the context of unary theories also applies to dependent versions.
Note that these constructions apply only to closed indexed types.
Sometimes we can extend the notion, so that it applies to indexed types in a non-empty context.

For example, there is a notion of locally small indexed dependent type theory.
We can also define the following dependent version of $\Hom$-types:
\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash B \ob$}
\UnaryInfC{$\Gamma \vdash \Hom(\Delta.B) \type$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash b : B$}
\UnaryInfC{$\Gamma \vdash \lambda \Delta.\,b : \Hom(\Delta.B)$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \vdash f : \Hom(\Delta.B)$}
\AxiomC{$\Gamma \mid E \vdash a_1 : A_1\ \ldots\ \Gamma \mid E \vdash a_k : A_k[a_1/x_1, \ldots a_{k-1}/x_{k-1}]$}
\BinaryInfC{$\Gamma \mid E \vdash f\,a_1\,\ldots\,a_k : B[a_1/x_1, \ldots a_k/x_k]$}
\DisplayProof
\end{center}
where $\Delta = x_1 : A_1, \ldots x_k : A_k$.

\begin{align*}
(\lambda x_1 \ldots x_k.\,b)\,a_1\,\ldots\,a_k & = b[a_1/x_1, \ldots a_k/x_k] \\
\lambda x_1 \ldots x_k.\,f\,x_1\,\ldots\,x_k & = f
\end{align*}
If $\Delta$ is empty, then we will write $\Hom(\Delta.B)$ as $\Hom(B)$, abstraction as $\lambda(b)$, and the application operation as $f\,()$.

If we have such dependent $\Hom$-types, then we can define the following operation:
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash a : A$
\noLine
\UnaryInf$\fCenter \Gamma \vdash a' : A$
\noLine
\UnaryInf$\fCenter \Gamma \vdash t : \Id_A(a,a')$
\Axiom$\fCenter \Gamma, x : A, p : \Id_A(a,x), \Delta \mid E \vdash D \ob$
\noLine
\UnaryInf$\fCenter \Gamma, \Delta[a/x,\refl(a)/p] \mid E[a/x,\refl(a)/p] \vdash d : D[a/x,\refl(a)/p]$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma, \Delta[a'/x,t/p] \mid E[a'/x,t/p] \vdash J(a, x p \Delta E.\,D, \Delta E.\,d, a', t) : D[a'/x,t/p]$}
\DisplayProof
\end{center}

\[ J(a, x p \Delta E.\,D, \Delta E.\,d, a, \refl(a)) = d \]

Indeed, we define $J(a, x p \Delta E.\,D, \Delta E.\,d, a', t)$ as follows:
\[ J(a, x p \Delta.\,\Hom(E.D), \Delta.\,\lambda E.\,d, a', t)\,y_1\,\ldots\,y_k, \]
where $E = y_1 : B_1, \ldots y_k : B_k$.
If we do not assume dependent $\Hom$-types, then we need to add this operation explicitly.
If the indexed theory has identity types, then we can define the following operation:
\begin{center}
\AxiomC{$\Gamma \vdash p : \Id_{\Hom(A,B)}(f,g)$}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\BinaryInfC{$\Gamma \mid \Delta \vdash \fs{hap}(p,a) : \Id_B(f\,a,g\,a)$}
\DisplayProof
\end{center}
It is defined as follows:
\[ \fs{hap}(p,a) = J(f, h q.\,\Id_B(f\,a,h\,a), \refl(f\,a), g, p). \]

We will say that identity types are \emph{extensional} if $\fs{hap}$ is an equivalence.
More precisely, the theory of extensional identity types has the following constructions:
\begin{center}
\AxiomC{$\Gamma \mid x : A \vdash p : \Id_{B}(f\,x,g\,x)$}
\UnaryInfC{$\Gamma \vdash \fs{hap^{-1}}(x.\,p) : \Id_{\Hom(A,B)}(f,g)$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid x : A \vdash p : \Id_{B}(f\,x,g\,x)$}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\BinaryInfC{$\Gamma \mid \Delta \vdash \fs{hap'}(x.\,p,a) : \Id_B(\fs{hap}(\fs{hap^{-1}}(x.\,p),a),p[a/x])$}
\DisplayProof
\end{center}
\medskip
The standard argument implies that we also have the following homotopy:
\begin{center}
\AxiomC{$\Gamma \vdash p : \Id_{\Hom(A,B)}(f,g)$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \fs{hap''}(p) : \Id(\fs{hap^{-1}}(x.\,\fs{hap}(p,x)),p)$}
\DisplayProof
\end{center}
If we have dependent $\Hom$-types, then identity types are extensional if and only if the following function is an equivalence:
\[ \lambda p.\,\lambda x.\,\fs{hap}(p,x) : \Id_{\Hom(A,B)}(f,g) \to \Hom(A, x.\,\Id_B(f\,x,g\,x)). \]

\begin{example}
The canonical indexing of a dependent type theory over itself is locally small if and only if it has non-dependent function types.
It has dependent $\Hom$-types if and only if it has $\Pi$-types.
It has extensional identity types if and only if it has identity types and the functional extensionality.
\end{example}

\subsection{Weak dependent $\Hom$-types}

If the indexed theory has extensional identity types, $\Sigma$-types, and the unit type, then we can define a weak version of dependent $\Hom$-types:
\[ \Hom(\Delta.B) = \sum_{f : \Hom(\Sigma(\Delta),\Sigma_{p : \Sigma(\Delta)} B[\pi_1(p)/x_1, \ldots \pi_k(p)/x_k])} \Id(\pi_1 \circ f, \id_{\Sigma(\Delta)}), \]
where $\Delta = x_1 : A_1, \ldots x_k : A_k$ and $\Sigma(\Delta)$ is defined inductively:
\begin{align*}
\Sigma(\cdot) & = \top \\
\Sigma(x : A, \Delta) & = \sum_{x : A} \Sigma(\Delta).
\end{align*}
The abstraction is defined as follows:
\[ \lambda x_1 \ldots x_k.\,b = (\lambda p.\,(p, b[\pi_1(p)/x_1, \ldots \pi_k(p)/x_k]), \refl(\id_{\Sigma(\Delta)})). \]
The application is defined as follows:
\[ f\,a_1\,\ldots\,a_k = \fs{hap}(\pi_2(f),(a_1, \ldots a_k))_*(\pi_2(\pi_1(f)\,(a_1, \ldots a_k))). \]
The beta rule holds judgementally, but the eta rule holds only propositionally.
Indeed, $\lambda x_1 \ldots x_k.\,f\,x_1\,\ldots\,x_k$ equals to
\[ (\lambda p.\,(p,\fs{hap}(\pi_2(f),p')_*(\pi_2(\pi_1(f)\,p'))), \refl(\id_{\Sigma(\Delta)})), \]
where $p' = (\pi_1(p), \ldots \pi_k(p))$.
To prove that it is homotopic to $f$, we need to construct a homotopy of the following type:
\[ h : \Id(\pi_1(f), \lambda p.\,(p,\fs{hap}(\pi_2(f),p')_*(\pi_2(\pi_1(f)\,p')))) \]
such that $h * \pi_1$ is homotopic to $\pi_2(f)$.
To construct such a homotopy, we can use $\fs{hap^{-1}}$.
Then we need to define two homotopies for every $p : \Sigma(\Delta)$:
\begin{align*}
h_1 & : \Id(\pi_1(\pi_1(f)\,p),p) \\
h_2 & : \Id((h_1)_*(\pi_2(\pi_1(f)\,p)),\fs{hap}(\pi_2(f),p')_*(\pi_2(\pi_1(f)\,p')))
\end{align*}
The condition that $h * \pi_1$ is homotopic to $\pi_2(f)$ is satisfied if we put $h_1 = \fs{hap}(\pi_2(f),p)$.
Finally, to construct $h_2$, it is enough to note that $p'$ is homotopic to $p$.

Thus, the theory of dependent $\Hom$-types is a slightly stricter version of the theory of $\Hom$-types.
This is similar to the theory of $\Pi$-types being a strict version of the theory of non-dependent function types.

We can define a dependent version of $\fs{hap}$:
\begin{center}
\AxiomC{$\Gamma \vdash p : \Id_{\Hom(\Delta,B)}(f,g)$}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \mid E \vdash a_1 : A_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \mid E \vdash a_k : A_k[a_1/x_1, \ldots a_{k-1}/x_{k-1}]$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid E \vdash \fs{hap}(p, a_1, \ldots a_k) : \Id_{B[a_1/x_1, \ldots a_k/x_k]}(f\,a_1\,\ldots\,a_k,g\,a_1\,\ldots\,a_k)$}
\DisplayProof
\end{center}
It is defined as follows:
\[ \fs{hap}(p, a_1, \ldots a_k) = J(f, h q.\,\Id(f\,a_1\,\ldots\,a_k,h\,a_1\,\ldots\,a_k), \refl(f\,a_1\,\ldots\,a_k), g, p). \]
It is straightforward to check that if identity types are extensional, then the following function is an equivalence:
\begin{align*}
& \Id_{\Hom(x_1 \ldots x_k.B)}(f,g) \to \Hom(x_1 \ldots x_k.\,\Id_B(f\,x_1\,\ldots\,x_k,g\,x_1\,\ldots\,x_k)) \\
& \lambda p.\,\lambda x_1 \ldots x_k.\,\fs{hap}(p, x_1, \ldots x_k).
\end{align*}

\section{Limits and colimits in dependent theories}

In this section, we discuss the concepts of limits and colimits in indexed dependent type theories.

\subsection{Finite limits}

Clearly, an indexed dependent type theory has a terminal type if and only if it has a closed contractible type.
For example, this is true when it has the unit type.
If an indexed dependent type theory has extensional identity types and $\Sigma$-types, then it has pullbacks.
Indeed, we can define a pullback of maps $f : \Hom(A,C)$ and $g : \Hom(B,C)$ as $A \times_C B = \Sigma_{x : A} \Sigma_{y : B} \Id_C(f\,x,g\,y)$
with the obvious projections $\pi_1 : \Hom(A \times_C B, A)$, $\pi_2 : \Hom(A \times_C B, B)$ and the obvious homotopy between $f \circ \pi_1$ and $g \circ \pi_2$: namely, $\fs{hap^{-1}}(p.\,\pi_3(p))$.
We need to show that the following map is equivalence:
\begin{align*}
& \Hom(P, A \times_C B) \to \sum_{F : \Hom(P,A)} \sum_{G : \Hom(P,B)} \Id(f \circ F, g \circ G) \\
& \lambda s.\,(\pi_1 \circ s, \pi_2 \circ s, s * \fs{hap^{-1}}(p.\,\pi_3(p))).
\end{align*}
The inverse of this map is defined as follows:
\[ \lambda t.\,\lambda p.\,(\pi_1(t)\,p, \pi_2(t)\,p, \fs{hap}(\pi_3(t),p)). \]
It is easy to see that these functions are inverse of each other using the fact that $s * \fs{hap^{-1}}(p.\,\pi_3(p)) = \fs{hap^{-1}}(p.\,\pi_3(s\,p))$.

The following proposition shows that $\Hom(x_1 \ldots x_n.\,-)$ commutes with $\Sigma$-types and identity types:
\begin{prop}
If an indexed dependent type theory has extensional identity types and $\Sigma$-types, then it has the following canonical equivalences:
\begin{align*}
\Hom(x_1 \ldots x_n.\,\Id_A(a,a')) & \simeq \Id_{\Hom(x_1 \ldots x_n. A)}(\lambda x_1 \ldots x_n.\,a, \lambda x_1 \ldots x_n.\,a') \\
\Hom(x_1 \ldots x_n.\,\sum_{y : A} B) & \simeq \sum_{f : \Hom(x_1 \ldots x_n. A)} \Hom(x_1 \ldots x_n.\,B[f\,x_1\,\ldots\,x_n / y]).
\end{align*}
\end{prop}
\begin{proof}
The first equivalence is simply the extensionality for identity types.
The second equivalence is defined as follows:
\begin{align*}
& \lambda g.\,(\lambda x_1 \ldots x_n.\,\pi_1\,(g\,x_1\,\ldots\,x_n), \lambda x_1 \ldots x_n.\,\pi_2\,(g\,x_1\,\ldots\,x_n)) \\
& \lambda p.\,\lambda x_1 \ldots x_n.\,(\pi_1(p)\,x_1\,\ldots\,x_n, \pi_2(p)\,x_1\,\ldots\,x_n)
\end{align*}
It is easy to see that these functions are mutually inverse.
\end{proof}

\subsection{Initial types}

Finite colimits can be defined in an indexed dependent type theory as higher inductive types.
We need to be careful since the usual definition gives us finite colimits which are stable under pullbacks.
If we want a definition of general finite colimits, then we need to modify the rules for higher inductive types slightly.

\begin{prop}
Let $0$ be a type in an indexed dependent type theory has extensional identity types and $\Sigma$-types.
Then $0$ is initial if and only if the theory has the following rules:
\begin{center}
\AxiomC{$\Gamma \mid x : 0 \vdash D \type$}
\AxiomC{$\Gamma \mid \Delta \vdash a : 0$}
\BinaryInfC{$\Gamma \mid \Delta \vdash 0\text{-}\fs{elim}(x.D,a) : D[a/x]$}
\DisplayProof
\end{center}
\end{prop}
\begin{proof}
If $0$ is initial, then we can define $0\text{-}\fs{elim}(x.D,a)$ as $\fs{hap}(h,a)_*(\pi_2(f\,a))$, where $f : \Hom(0,\Sigma_{x : 0} D)$ is any map and $h$ is any homotopy between $\pi_1 \circ f$ and $\id_0$.

Conversely, suppose that the theory has the the rule $0\text{-}\fs{elim}$.
Then, for every type $D$, we can define a map $\lambda x.\,0\text{-}\fs{elim}(y.D,x) : \Hom(0,D)$.
For all maps $f,g : \Hom(0,D)$, we can define a homotopy between them as follows:
\[ \fs{hap^{-1}}(x.\,0\text{-}\fs{elim}(y.\,\Id_D(f\,y,g\,y),x)) : \Id(f,g). \]
\end{proof}

We will say that the initial type $0$ in an indexed unary type theory is \emph{stable under pullbacks} if, for every type $B$ such that the product $B \times 0$ exists, this product is initial.

\begin{prop}
Let $0$ be a type in an indexed dependent type theory with extensional identity types and $\Sigma$-types.
Then the following conditions are equivalent:
\begin{enumerate}
\item \label{it:init-first} The theory has the following rule:
\begin{center}
\AxiomC{$\Gamma \mid \Delta, x : 0, E \vdash D \type$}
\AxiomC{$\Gamma \mid \Delta \vdash a : 0$}
\BinaryInfC{$\Gamma \mid \Delta, E[a/x] \vdash 0\text{-}\fs{elim''}(x E.D,a) : D[a/x]$}
\DisplayProof
\end{center}
\item \label{it:init-second} The theory has the following rule:
\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash D \type$}
\AxiomC{$\Gamma \mid \Delta \vdash a : 0$}
\BinaryInfC{$\Gamma \mid \Delta \vdash 0\text{-}\fs{elim'}(D,a) : D$}
\DisplayProof
\end{center}
\item \label{it:init-third} For every map $f : \Hom(B,0)$, the type $B$ is initial.
\item \label{it:init-fourth} The type $0$ is a stable under pullbacks initial type.
\end{enumerate}
\end{prop}
\begin{proof}
\eqref{it:init-first} $\Rightarrow$ \eqref{it:init-second}
This is obvious since $0\text{-}\fs{elim'}$ is a special case of $0\text{-}\fs{elim''}$.

\eqref{it:init-second} $\Rightarrow$ \eqref{it:init-third}
For every type $C$, we can define a map $\lambda x.\,0\text{-}\fs{elim'}(C,f\,x) : \Hom(B,C)$.
Let $g_1,g_2 : \Hom(B,C)$ be a pair of maps.
Then we can define a homotopy between them as follows:
\[ \fs{hap^{-1}}(x.\,0\text{-}\fs{elim'}(\Id_C(g_1\,x,g_2\,x),f\,x)) : \Id(g_1,g_2). \]

\eqref{it:init-third} $\Rightarrow$ \eqref{it:init-fourth}
Since we have the map $\id_0 : \Hom(0,0)$, the type $0$ is initial.
Moreover, since we have the projection $\pi_2 : \Hom(B \times 0, 0)$, every product $B \times 0$ is also initial.

\eqref{it:init-fourth} $\Rightarrow$ \eqref{it:init-third}
It is enough to prove that $B$ is equivalent to $B \times 0$ since the latter type is initial.
We have maps $\langle \id_B, f \rangle : \Hom(B, B \times 0)$ and $\pi_1 : B \times 0 \to B$.
It is clear that $\pi_1 \circ \langle id_B, f \rangle$ is homotopic to $\id_B$.
The map $\langle \id_B, f \rangle \circ \pi_1$ is homotopic to $\id_{B \times 0}$ since $B \times 0$ is initial.

\eqref{it:init-third} $\Rightarrow$ \eqref{it:init-first}
Let $\Delta = x_1 : A_1, \ldots x_m : A_m$ and $E = y_1 : C_1, \ldots y_n : C_n$.
Let $B = \Sigma(\Delta, x : 0, E)$.
Since we have the projection $\pi_{m+1} : \Hom(B,0)$, the type $B$ is initial.
Thus, we have a map $f : \Hom(B, \Sigma_{b : B} D')$, where
\[ D' = D[\pi_1(b)/x_1, \ldots \pi_m(b)/x_m, \pi_{m+1}(b)/x, \pi_{m+2}(b)/y_1, \ldots \pi_{m+n+1}(b)/y_n]. \]
We also have a homotopy $h : \Id(\pi_1 \circ f, \id_B)$.
Now, we can define $0\text{-}\fs{elim''}(x E.D, a)$ as $\fs{hap}(h,p)_*(\pi_2(f\,p))$, where $p = (x_1, \ldots x_m, a, y_1, \ldots y_n)$.
\end{proof}

\subsection{Pushouts}

Let $f : \Hom(A,B)$ and $g : \Hom(A,C)$ be a pair of maps.
Suppose that we have the following rules:
\begin{center}
\AxiomC{}
\UnaryInfC{$\Gamma \mid \Delta \vdash B \amalg_A C \ob$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash b : B$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \fs{inl}(b) : B \amalg_A C$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash c : C$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \fs{inr}(c) : B \amalg_A C$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \fs{glue}(a) : \Id(\fs{inl}(f\,a),\fs{inr}(g\,a))$}
\DisplayProof
\end{center}
\medskip

We will say that the type $B \amalg_A C$ together with $\fs{inl}$, $\fs{inr}$, and $\fs{glue}$ is a \emph{weak dependent pushout} of $f$ and $g$ if the following rules are derivable:

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \mid z : B \amalg_A C \vdash D \ob$
\noLine
\UnaryInf$\fCenter \Gamma \mid \Delta \vdash t : A \amalg_C B$
\Axiom$\fCenter \Gamma \mid \Delta, x : B \vdash d_1 : D[\fs{inl}(x)/z]$
\noLine
\UnaryInf$\fCenter \Gamma \mid \Delta, y : C \vdash d_2 : D[\fs{inr}(y)/z]$
\noLine
\UnaryInf$\fCenter \Gamma \mid \Delta, w : A \vdash d_3 : \Id(\fs{glue}(w)_*(d_1[f\,w/x]), d_2[g\,w/y])$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid \Delta \vdash \amalg\text{-}\fs{elim}(z.D, x.d_1, y.d_2, w.d_3, t) : D[t/z]$}
\DisplayProof
\end{center}
\medskip

We will omit all of the arguments of $\amalg\text{-}\fs{elim}$ except the last one.

\begin{align*}
h_1(b) & : \Id(\amalg\text{-}\fs{elim}(\fs{inl}(b)), d_1[b/x]) \\
h_2(c) & : \Id(\amalg\text{-}\fs{elim}(\fs{inr}(c)), d_2[c/x])
\end{align*}

\[ \xymatrix{ \fs{glue}(a)_*(\amalg\text{-}\fs{elim}(\fs{inl}(f\,a))) \ar@{=}[r] \ar@{=}[d] & \fs{glue}(a)_*(d_1[f\,a/x]) \ar@{=}[d]^{d_3[a/w]} \\
              \amalg\text{-}\fs{elim}(\fs{inr}(g\,a)) \ar@{=}[r]_-{h_2(g\,a)} & d_2[g\,a/x]
            } \]
The last square must commute up to a homotopy $h_3(a)$.
The left arrow is
\[ J(\fs{inl}(f\,a), v p.\,\Id(p_*(\amalg\text{-}\fs{elim}(\fs{inl}(f\,a))), \amalg\text{-}\fs{elim}(v)), \refl, \fs{inr}(g\,a), \fs{glue}(a)). \]
The top arrow is $\pmap(x.\,\fs{glue}(a)_*(x), h_1(f\,a))$.

\begin{prop}
Suppose that we have a square
\[ \xymatrix{ A \ar[r]^-f \ar[d]_g & B \ar[d]^{\fs{inl}} \\
              C \ar[r]_-{\fs{inr}} & B \amalg_A C
            } \]
that commutes up to a homotopy $\fs{glue}$.
If the indexed dependent type theory has extensional identity types and $\Sigma$-types, then this square is a weak dependent pushout if and only if it is a pushout.
\end{prop}
\begin{proof}
% TODO
\end{proof}

% TODO: Define stable pushouts.

\subsection{Strict dependent products}

We defined strict products in subsection~\ref{sec:products}.
We can define even stricter version of products which we call \emph{strict dependent products} in indexed dependent type theories:
\begin{center}
\AxiomC{$\Gamma, i : I \mid \Delta \vdash B \ob$}
\RightLabel{, $i \notin \mathrm{FV}(\Delta)$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \prod_{i : I} B \ob$}
\DisplayProof
\qquad
\AxiomC{$\Gamma, i : I \mid \Delta \vdash b : B$}
\RightLabel{, $i \notin \mathrm{FV}(\Delta)$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \lambda i.\,b : \prod_{i : I} B$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash f : \prod_{i : I} B$}
\AxiomC{$\Gamma \vdash j : I$}
\BinaryInfC{$\Gamma \mid \Delta \vdash f\,j : B[j/i]$}
\DisplayProof
\end{center}

\begin{align*}
(\lambda i.\,b)\,j & = b[j/i] \\
\lambda i.\,f\,i & = f
\end{align*}

\begin{example}
The canonical indexing of a dependent type theory over itself has strict dependent products if and only if it has $\Pi$-types.
\end{example}

Obviously, if a theory has strict dependent products, then it also has strict products.
Conversely, if a theory has finite limits and products, then we can define a version of strict dependent products in which the last two rules hold propositionally.

% TODO: Prove this.
% TODO: Prove functional extensionality for strict dependent products.

\subsection{Dependent coproducts}

We can define coproducts in a more type-theoretic way.
The theory of \emph{dependent coproducts} has the following rules:
\begin{center}
\AxiomC{$\Gamma, i : I \mid \cdot \vdash B \ob$}
\UnaryInfC{$\Gamma \mid \cdot \vdash \coprod_{i : I} B \ob$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \vdash j : I$}
\AxiomC{$\Gamma \mid \Delta \vdash b : B[j/i]$}
\BinaryInfC{$\Gamma \mid \Delta \vdash (j,b) : \coprod_{i : I} B$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid z : \coprod_{i : I} B \vdash D \ob$}
\AxiomC{$\Gamma, i : I \mid \Delta, x : B \vdash d : D[(i,x)/z]$}
\AxiomC{$\Gamma \mid \Delta \vdash t : \coprod_{i : I} B$}
\TrinaryInfC{$\Gamma \mid \Delta \vdash \coprod\text{-}\fs{elim}(z.D, i x.d, t) : D[t/z]$}
\DisplayProof
\end{center}
\medskip

\[ \coprod\text{-}\fs{elim}(z.D, i x.d, (j,b)) = d[j/i,b/x] \]

The theory of \emph{weak dependent coproducts} has the same rules except for the last equality which holds only propositionally.

\begin{example}
The canonical indexing of a dependent type theory over itself always has dependent coproducts since we always assume that the base theory has $\Sigma$-types.
\end{example}

% TODO: Prove that weak coproducts are equivalent to coproducts in unary theories.
% TODO: Define stable coproducts.

\section{General adjoint functor theorem}

% TODO: Prove it.

\section{Locally cartesian closed indexed theories}

In this section, we will define locally cartesian closed unary type theories and discuss the relationship between them and indexed dependent type theories with $\Pi$-types.

Let $p_A : \Hom(A,\Delta)$ and $p_B : \Hom(B,\Delta)$ be a pair of maps with the same codomain.
We will write $\Hom_\Delta(A,B)$ for the type $\Sigma_{f : \Hom(A,B)} \Id(p_B \circ f, p_A)$.
If we think of maps $\Hom(A,\Delta)$ as types over $\Delta$, then $\Hom_\Delta(A,B)$ is the type of morphisms between such types.
We will identify elements of $\Hom_\Delta(A,B)$ with underlying morphisms $\Hom(A,B)$ and we will often omit the homotopy in $\Hom_\Delta(A,B)$ when constructing an element of this type.

Let $p_A : \Hom(A,\Delta)$ be a morphism in an indexed unary type theory such that its pullbacks along any map exist.
An \emph{exponential type over $\Delta$} of $p_A$ and a map $p_B : \Hom(B,\Delta)$ is a map $p : \Hom(B^A,\Delta)$ together with a map $\fs{ev} : \Hom_\Delta(B^A \times_\Delta A, B)$ such that the following function is an equivalence for every indexed type $X$:
\[ \lambda f.\, \fs{ev} \circ (f \times_\Delta A) : \Hom_\Delta(X, B^A) \to \Hom_\Delta(X \times_\Delta A, B). \]
We will say that $p_A$ is \emph{exponentiable} if an exponential type $B^A$ exists for all maps $p_B$.
We will say that the theory is \emph{locally cartesian closed} if all maps are exponentiable.

Non-dependent function types in an indexed dependent type theory are defined as usual.
If $\Gamma \mid \Delta \vdash A \ob$ and $\Gamma \mid \Delta \vdash B \ob$ is a pair of indexed types, then the \emph{function type} $\Gamma \mid \Delta \vdash A \to B \ob$ is defined as follows:
\begin{center}
\AxiomC{$\Gamma \mid \Delta, x : A \vdash b : B$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \lambda x.\,b : A \to B$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash f : A \to B$}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\BinaryInfC{$\Gamma \mid \Delta \vdash f\,a : B$}
\DisplayProof
\end{center}

\begin{align*}
(\lambda x.\,b)\,a & = b[a/x] \\
\lambda x.\,f\,x & = f
\end{align*}
The \emph{$\Pi$-type} $\Pi_{x : A} B$ of a family $\Gamma \vdash \Delta, x : A \vdash B \ob$ is defined similarly:
\begin{center}
\AxiomC{$\Gamma \mid \Delta, x : A \vdash b : B$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \lambda x.\,b : \Pi_{x : A} B$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash f : \Pi_{x : A} B$}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\BinaryInfC{$\Gamma \mid \Delta \vdash f\,a : B[a/x]$}
\DisplayProof
\end{center}

\begin{align*}
(\lambda x.\,b)\,a & = b[a/x] \\
\lambda x.\,f\,x & = f
\end{align*}

The last two equations are called $\beta$ and $\eta$ rules.
\emph{Weak function types} and \emph{weak $\Pi$-types} are defined in the same way except for the $\beta$ and $\eta$ rules which hold only propositionally.

\begin{prop}
Let $\Gamma \mid \Delta \vdash A \ob$ be a type in an indexed dependent type theory with $\Sigma$-types and extensional identity types.
Then the following conditions are equivalent:
\begin{enumerate}
\item Weak $\Pi$-types $\Pi_{x : A} B$ exist for all families $\Gamma \mid \Delta, x : A \vdash B \ob$.
\item Weak function types $A \to B$ exist for all types $\Gamma \mid \Delta \vdash B \ob$.
\item $A$ is exponentiable.
\end{enumerate}
\end{prop}
\begin{proof}
% TODO
\end{proof}

The standard argument shows that if a theory is locally cartesian closed, then the existence of $0\text{-}\fs{elim}$ implies the existence of $0\text{-}\fs{elim''}$ and the same is true for eliminators of pushouts and dependent coproducts.
Thus, initial types, pushouts, and coproducts are stable under pullbacks in a locally cartesian closed theory.

\section{Classifying morphisms}

In this section, we will define the notion of classifying morphisms, discuss its relationship to the notions of universes and factorization systems.

\subsection{Truncated maps}

Let $f : \Hom(A,B)$ be a map in an indexed unary type theory and let $n$ be an integer $\geq -2$.
We will say that $f$ is \emph{$n$-truncated} if the map $f \circ - : \Hom(X,A) \to \Hom(X,B)$ is $n$-truncated for all indexed types $X$.
This definition makes sense in models of indexed unary type theories, but the problem is that it is not algebraic since it quantifies over indexed types.
That is, we cannot define a predicate on $\Hom(A,B)$ which corresponds to the notion of $n$-truncated maps in models.
But we can fix this problem if the indexed theory has pullbacks.

First, let us prove a few technical lemmas:

\begin{lem}[trunc-pb]
In an indexed unary type theory, $n$-truncated maps are closed under pullbacks.
\end{lem}
\begin{proof}
Suppose that we have a pullback square in which the right arrow is $n$-truncated:
\[ \xymatrix{ A \ar[r] \ar[d] \pb   & C \ar[d] \\
              B \ar[r]              & D.
            } \]
Since $\Hom(X,-)$ preserves pullbacks, the following square is also pullback and the right arrow is $n$-truncated by the definition of $n$-truncated maps in indexed type theories:
\[ \xymatrix{ \Hom(X,A) \ar[r] \ar[d] \pb   & \Hom(X,C) \ar[d] \\
              \Hom(X,B) \ar[r]              & \Hom(X,D).
            } \]

Thus, we just need to prove that $n$-truncated maps are closed under pullbacks in the base theory.
Suppose that we have the following pullback square:
\[ \xymatrix{ \sum_{b : B} P(f(b)) \ar[r] \ar[d] \pb    & \sum_{d : D} P(d) \ar[d] \\
              B \ar[r]_f                                & D.
            } \]
If the right arrow is $n$-truncated, then its fibers $P(d)$ are $n$-types for all $d : D$, but this implies that fibers of the left arrow are also $n$-types; hence, it is also $n$-truncated.
\end{proof}

\begin{lem}[trunc-total]
Let $B$ and $C$ be base types over $x : A$.
Then a function $f : B \to C$ is $n$-truncated if and only if the induced function $f' : \Sigma_{x : A} B \to \Sigma_{x : A} C$ is $n$-truncated.
\end{lem}
\begin{proof}
By \cite[Theorem~4.7.6]{hottbook}, the fiber of $f'$ over a point $(x,c)$ is equivalent to the fiber of $f$ over $c$.
Thus, fibers of $f'$ are $n$-truncated if and only if fibers of $f$ are $n$-truncated.
\end{proof}

The following lemma is similar to \cite[5.5.6.15]{lurie-topos}, which is proved in the context of $\infty$-categories.

\begin{lem}[trunc-id]
A map $f : \Hom(A,B)$ is $n$-truncated if and only if the map $\langle \id_A, \id_A \rangle : \Hom(A, A \times_B A)$ is $(n-1)$-truncated.
\end{lem}
\begin{proof}
Since $\Hom(X,-)$ preserves and reflects $n$-truncatedness and pullbacks, it is enough to prove this fact for base types.
By \cite[Lemma~7.6.2]{hottbook}, a function $f : A \to B$ is $n$-truncated if and only if, for all $a,a' : A$, the function $\pmap(f,-) : \Id(a,a') \to \Id(f\,a,f\,a')$ is $(n-1)$-truncated.
By \rlem{trunc-total}, the latter function is $n$-truncated if and only if the induced function $\Sigma_{a : A} \Sigma_{a' : A} \Id(a,a') \to \Sigma_{a : A} \Sigma_{a' : A} \Id(f\,a,f\,a')$ is $(n-1)$-truncated.
The latter function is equivalent to $\lambda a.\,(a,a,\refl) : A \to \Sigma_{a : A} \Sigma_{a' : A} \Id(f\,a,f\,a')$, which is equivalent to $\langle \id_A, \id_A \rangle : \Hom(A, A \times_B A)$.
\end{proof}

The last lemma implies that if the theory has pullbacks, then we can define a predicate on maps that corresponds to the notion of $n$-truncated maps by induction on $n$.

\subsection{Fibrations}

Suppose that we have a class of families of propositions over all indexed morphisms:
\begin{center}
\AxiomC{$\Gamma \mid \cdot \vdash A \ob$}
\AxiomC{$\Gamma \mid \cdot \vdash B \ob$}
\AxiomC{$\Gamma \vdash f : \Hom(A,B)$}
\TrinaryInfC{$\Gamma \vdash \Fib(f) \type$}
\DisplayProof
\end{center}
We will call maps $f$ together with an element of $\Fib(f)$ \emph{fibrations} and denote them by $\twoheadrightarrow$.
We will assume that $\Fib$ is closed under equivalences, that is if $f : \Hom(A,B)$ is a fibration and $e_1 : \Hom(A',A)$ and $e_2 : \Hom(B,B')$ are equivalences, then $e_2 \circ f \circ e_1$ is a fibration.

Sometimes $\Fib(f)$ is not a type, but a finite number of judgements of the form $\Gamma, \Delta_i \vdash A_i \type$.
For example, we might want to define $\Fib(f)$ as $\fs{isEquiv}(C(f))$ for some morphism $C(f)$.
In general, this is not a type, but a collection of four judgements.
If the base theory has $\Pi$-types, then we can always replace such a collection of judgements with a single type.
Even if the base theory does not have $\Pi$-types, we still can work with such definitions of $\Fib(f)$;
we just need to replace judgements of the form $\Gamma \vdash b : \Fib(f)$ with a finite collection of judgements of the form $\Gamma, \Delta_i \vdash a_i : A_i$.
For notational convenience, we will always assume that $\Fib(f)$ is a single type.

We can also define the dependent version of classes of fibrations:
\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash B \ob$}
\UnaryInfC{$\Gamma \vdash \Fib(\Delta.B) \type$}
\DisplayProof
\end{center}
We will also call dependent types $B$ together with an element of $\Fib(\Delta.B)$ fibrations.
It is often more convenient to work with the dependent version of this definition.
If the indexed theory has $\Sigma$ types, then, for every class of fibrations $\Fib$, we can define its dependent version as follows:
\[ \Fib(\Delta.B) = \Fib(\pi_1 : \Hom(\sum_{p : \Sigma(\Delta)} B[\pi_1(p)/x_1, \ldots \pi_n(p)/x_n],\Sigma(\Delta))). \]
Conversely, if the indexed theory also has identity types, then, for every dependent class of fibrations $\Fib$, we can define its non-dependent version:
\[ \Fib(f : \Hom(A,B)) = \Fib((y : B).\,\sum_{x : A} \Id(f\,x,y)). \]

\begin{example}
If the indexed theory has finite limits, then we can define a class of fibrations consisting of $n$-truncated maps (or $n$-truncated indexed types) as was explained in the previous subsection.
\end{example}

For every dependent class of fibrations $\Fib$, we can add a new sort of dependent types $\Gamma \mid \Delta \vdash A \fib$ consisting of types satisfying the predicate $\Fib$:
\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash A \fib$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \El(A) \ob$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash A \fib$}
\UnaryInfC{$\Gamma \vdash \fs{fp}(\Delta.A) : \Fib(\Delta.\,\El(A))$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash A \ob$}
\AxiomC{$\Gamma \vdash p : \Fib(\Delta.A)$}
\AxiomC{$\Gamma \mid E \vdash b_i : B_i[b_1/x_1, \ldots b_{i-1}/x_{i-1}]$}
\TrinaryInfC{$\Gamma \mid E \vdash \fs{rf}(\Delta.A, p, b_1, \ldots b_k) \fib$}
\DisplayProof
\end{center}
where $\Delta = x_1 : B_1, \ldots x_k : B_k$.
\[ \El(\fs{rf}(\Delta.A, p, b_1, \ldots b_k)) = A[b_1/x_1, \ldots b_k/x_k]. \]
We define equivalences between fibrations $\Gamma \mid \Delta \vdash A \fib$ and $\Gamma \mid \Delta \vdash B \fib$ as equivalences between underlying types $\El(A)$ and $\El(B)$.
We will often omit the function symbol $\El$.

We can assume various closure conditions on the class of fibrations in the usual way.
For example, we can assume that $\Fib$ is closed under contractible types.
This is true if and only if it contains all identity morphisms.
Similarly, $\Fib$ is closed under $n$-types (as a dependent class) if and only if it contains all $n$-truncated maps (as a non-dependent class).

\begin{prop}[fib-sigma]
A class of fibrations is closed under $\Sigma$-types if and only if the corresponding non-dependent class is closed under compositions.
\end{prop}
\begin{proof}
First, suppose that $\Fib$ is closed under compositions.
If we have fibrations $\Gamma \mid \Delta \vdash A$ and $\Gamma \mid \Delta, x : A \vdash B$, then the type $\Sigma_{x : A} B$ corresponds to the following map:
\[ \Sigma(\Delta, A, B) \xrightarrow{\simeq} \sum_{p : \Sigma(\Delta, A)} B[\overline{\pi_i(p)/x_i}] \xrightarrow{\pi_1} \Sigma(\Delta, A) \xrightarrow{\simeq} \sum_{p : \Sigma(\Delta)} A[\overline{\pi_i(p)/x_i}] \xrightarrow{\pi_1} \Sigma(\Delta). \]
The first and the third maps are equivalences and the second and the fourth maps are fibrations by assumption.
Thus, the type $\Sigma_{x : A} B$ is also a fibration.

Now, suppose that $\Fib$ is closed under $\Sigma$-types.
Let $f : \Hom(A,B)$ and $g : \Hom(B,C)$ be fibrations.
These maps correspond to the types $y : B \vdash \Sigma_{x : A} \Id(f\,x,y)$ and $z : C \vdash \Sigma_{y : B} \Id(g\,y,z)$.
The first type is equivalent to the type $z : C, p : \Sigma_{y : B} \Id(g\,y,z) \vdash \Sigma_{x : A} \Id(f\,x,\pi_1(p))$.
Since fibrations are closed under $\Sigma$-types, the type $z : C \vdash \Sigma_{(p : \Sigma_{y : B} \Id(g y, z))} \sum_{x : A} \Id(f\,x,\pi_1(p))$ is a fibration.
This type corresponds to the following map:
\[ \pi_1 : \Hom(\sum_{z : C} \sum_{(p : \sum_{y : B} \Id(g y, z))} \sum_{x : A} \Id(f\,x,\pi_1(p)), C). \]
Since this map is equivalent to $g \circ f$, the composite is a fibration.
\end{proof}

\begin{prop}[fib-id]
Let $\Fib$ be a class of fibrations closed under pullbacks.
Then it is closed under identity types if and only if, for every fibration $p : \Hom(A,B)$, the map $\langle \id_A, \id_A \rangle : \Hom(A, A \times_B A)$ is also a fibration.
\end{prop}
\begin{proof}
First, suppose that $\Fib$ is closed under identity types.
Let $a_1 : A, a_2 : A, h : \Id(p\,a_1,p\,a_2)$ be an element of $A \times_B A$.
The fiber over this element is the following type:
\begin{align*}
\sum_{a : A} \sum_{h_1 : \Id(a_1,a)} \sum_{h_2 : \Id(a,a_2)} \Id(\pmap(p, h_1 \ct h_2), h) & \simeq \\
\sum_{h' : \Id(a_1,a_2)} \Id(\pmap(p,h'),h) & \simeq \\
\Id_{\sum_{a : A} \Id(p a_1, p a)}((a_1,\refl), (a_2,h)) & .
\end{align*}
Since $\Fib$ is closed under identity types, it is enough to show that $\sum_{a : A} \Id(p\,a_1,p\,a)$ is a fibration over $a_1,a_2,h$.
This follows from the fact that this type is a pullback of the type $\sum_{a : A} \Id(b,p\,a)$ over $b : B$ which is a fibration since it is the fiber of $p$ over $b$.

Now, let us prove the converse.
Let $\Gamma \mid \Delta \vdash c_1 : C$ and $\Gamma \mid \Delta \vdash c_2 : C$ be a pair of terms.
Then the following square is a pullback:
\[ \xymatrix{ \Sigma_{p : \Sigma(\Delta)} \Id(c_1',c_2') \ar[r]^-{c_1' \circ \pi_1} \ar@{->>}[d]_{\pi_1} \pb    & C' \ar@{->>}[d]^{\langle \id_{C'}, \id_{C'} \rangle} \\
              \Sigma(\Delta) \ar[r]_-{\langle c_1', c_2' \rangle}                                               & C' \times_{\Sigma(\Delta)} C'
            } \]
where $C' = \Sigma_{p : \Sigma(\Delta)} C[\overline{\pi_i(p)/x_i}]$ and $c_i' = c_i[\overline{\pi_i(p)/x_i}]$.
Since $\Gamma \mid \Delta \vdash \Id(c_1,c_2)$ is equivalent to $\Gamma \mid p : \Sigma(\Delta) \vdash \Id(c_1',c_2')$, it follows that $\Id(c_1,c_2)$ is a fibration.
\end{proof}

The following proposition shows that if the class of fibrations is closed under pullbacks and compositions, then there is another characterization of the condition that it is closed under identity types.

\begin{prop}[fib-id-comp]
Let $\Fib$ be a class of fibrations in an indexed unary type theory.
If $\Fib$ is closed under pullbacks and compositions, then the following conditions are equivalent:
\begin{enumerate}
\item \label{it:fib-pb} For every fibration $p : \Hom(A,B)$, the map $\langle \id_A, \id_A \rangle : \Hom(A, A \times_B A)$ is also a fibration.
\item \label{it:fib-over} For every commutative diagram as below in which $p$ and $q$ are fibrations, $f$ is also a fibration.
\[ \xymatrix{ A \ar[rr]^f \ar@{->>}[dr]_p &   & C \ar@{->>}[dl]^q \\
                                          & B &
            }\]
\end{enumerate}
\end{prop}
\begin{proof}
First, suppose that \eqref{it:fib-pb} holds.
Consider the following diagram:
\[ \xymatrix{ A \ar[r]^f \ar@{->>}[d]_r \pb             & C \ar@{->>}[d]^{\langle \id_C, \id_C \rangle} & \\
              A \times_B C \ar[r]^{f'} \ar@{->>}[d] \pb & C \times_B C \ar[r]^-{q'} \ar@{->>}[d] \pb    & C \ar@{->>}[d]^q \\
              A \ar[r]_f                                & C \ar[r]_q                                    & B
            } \]
The map $q' \circ f'$ is a pullback of $q \circ f = p$, so it is a fibration.
The map $r$ is a fibration since it is a pullback of $\langle \id_C, \id_C \rangle$, which is a fibration by \eqref{it:fib-pb}.
Since fibrations are closed under compositions, $q' \circ f' \circ r$ is also a fibration.
Finally, $f$ is a fibration since $f \sim q' \circ \langle \id_C, \id_C \rangle \circ f \sim q' \circ f' \circ r$.

Now, suppose that \eqref{it:fib-over} holds.
Let $f : \Hom(A,B)$ be a fibration.
Let $q$ be the composite $A \times_B A \xrightarrow{\pi_1} A \xrightarrow{f} B$.
Since fibrations are closed under pullbacks, the first map is a fibration.
Since they are closed under compositions, $q$ is also a fibration.
Since $q \circ \langle \id_A, \id_A \rangle = f$ is a fibration, $\langle \id_A, \id_A \rangle$ is also a fibration by \eqref{it:fib-over}.
\end{proof}

\begin{lem}[fib-id-idm]
Let $\Fib$ be a class of fibrations in an indexed unary type theory.
If $\Fib$ is closed under pullbacks and contains all identity morphisms, then \eqref{it:fib-over} implies \eqref{it:fib-pb}.
\end{lem}
\begin{proof}
Let $f : \Hom(A,B)$ be a fibration.
Since $\pi_1 : \Hom(A \times_B A, A)$ is a pullback of $f$, it is also a fibration.
Moreover, $\id_A$ is a fibration by assumption.
Now, the claim follows from the fact that $\pi_1 \circ \langle \id_A, \id_A \rangle \sim \id_A$.
\end{proof}

\begin{example}
The class of $n$-truncated maps is closed under compositions, pullbacks, $m$-types for $m \leq n$, $\Sigma$-types, and identity types.
This follows from \rlem{trunc-pb}, \rprop{fib-sigma}, \rprop{fib-id}, and \rlem{trunc-id}.
\end{example}

An \emph{external universe} is a base type $\mathcal{U}(\Delta)$ defined for all indexed context $\Delta$ together with an indexed type $\El(c)$ over $\Delta$ for all $c : \mathcal{U}(\Delta)$:
\begin{center}
\AxiomC{$\Gamma \vdash c : \mathcal{U}(\Delta)$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \El(c) \ob$}
\DisplayProof
\end{center}
We have a function from $\Id_{\mathcal{U}(\Delta)}(c,c')$ to the type of equivalences between $\El(c)$ and $\El(c')$ over $\Delta$ defined as the transport of the identity morphism along the homotopy $\Id_{\mathcal{U}(\Delta)}(c,c')$.
We will say that the universe $\mathcal{U}(\Delta)$ is \emph{univalent} if this function is an equivalence.
We will say that a universe \emph{classifies} fibrations $\Fib$ if it is univalent, the family $\El(c)$ satisfies $\Fib$ for all $c$, and every fibration is equivalent to a fibration of the form $\El(c)$ for some $c$.

If a universe classifying $\Fib$ exists, then it is unique up to a canonical equivalence.
Indeed, let $\mathcal{U}$ and $\mathcal{U}'$ be two universes classifying $\Fib$.
Then, for every indexed context $\Delta$ over a base context $\Gamma$, we have a fibration $\El(x)$ over $\Delta$ in the context $\Gamma, x : \mathcal{U}$.
This fibration is equivalent to a fibration of the form $\El'(c')$ for some $\Gamma, x : \mathcal{U} \vdash c' : \mathcal{U}'$.
Thus, we have a map $\lambda x.\,c' : \mathcal{U} \to \mathcal{U}'$.
Similarly, we have a map $\lambda y.\,c : \mathcal{U}' \to \mathcal{U}$.
We need to construct a homotopy $\Gamma, x : \mathcal{U} \vdash h : \Id(c[c'/y],x)$.
By univalence, it is enough to prove that $\El(c[c'/y])$ is equivalent to $\El(x)$ over $\Delta$.
By definition of $c$, we have an equivalence $\Gamma, y : \mathcal{U}' \mid \Delta \vdash e : \El(c) \simeq \El'(y)$.
It follows that we have the following equivalence: $\Gamma, x : \mathcal{U} \mid \Delta \vdash e[c'/y] : \El(c[c'/y]) \simeq \El'(c')$.
By definition of $c'$, $\El'(c')$ is equivalent to $\El(x)$ over $\Delta$.
The composition of these two equivalences gives us the required equivalence between $\El(c[c'/y])$ and $\El(x)$ over $\Delta$.
A homotopy between $c'[c/x]$ and $y$ is constructed similarly.

\begin{defn}
We will say that a class $\Fib$ is \emph{locally small} if it is classified by an external universe.
\end{defn}

\begin{example}
An indexed type theory is called \emph{well-powered} if the class of monomorphisms (that is, $(-1)$-truncated maps) is locally small.
This definition is analogous to the definition of well-powered indexed categories (see \cite[Example~B1.3.14]{elephant}).
\end{example}

\subsection{Object classifiers}

Let $p : \Hom(\widehat{\mathcal{U}},\mathcal{U})$ be a map in an indexed unary type theory such that its pullbacks along all maps exist.
Then we can define a map from $\Id_{\Hom(\Delta,\mathcal{U})}(f,g)$ to the type of equivalences over $\Delta$ between pullbacks of $p$ along $f$ and $g$ as the transport of the identity map along the homotopy between $f$ and $g$.
An \emph{object classifier} is a map $p : \Hom(\widehat{\mathcal{U}},\mathcal{U})$ such that its pullbacks exist and the map defined above is an equivalence.
We will say that an object classifier \emph{classifies} a class of fibrations if this class is closed under pullbacks, $p$ is a fibration, and every fibration is a pullback of $p$.

\begin{example}
A subobject classifier is an object classifier for monomorphisms.
\end{example}

Let $p : \Hom(\widehat{\mathcal{U}},\mathcal{U})$ be any map.
We can think of such a map as a (non-univalent) universe.
We will say that the universe $\mathcal{U}$ \emph{contains a type $A$} if there is a map $a : \Hom(1,\mathcal{U})$ and an equivalence between $A$ and the pullback of $p$ along $a$.
We will say that $\mathcal{U}$ is \emph{closed under coproducts} if, for all maps $a,b : \Hom(\Gamma,\mathcal{U})$, there is a map $a + b : \Hom(\Gamma,\mathcal{U})$
and an equivalence over $\Gamma$ between the pullback of $p$ along $a + b$ and the sum of pullbacks of $p$ along $a$ and $b$.
Similarly, we will say that $\mathcal{U}$ is \emph{closed under $\Sigma$-types} if, for every map $a : \Hom(\Gamma,\mathcal{U})$
and every map $b : \Hom(\Gamma \times_\mathcal{U} \widehat{\mathcal{U}}, \mathcal{U})$, there is a map $\Sigma(a,b) : \Hom(\Gamma,\mathcal{U})$
together with an equivalence over $\Gamma$ between the pullback of $p$ along $\Sigma(a,b)$ and the composition of pullbacks of $p$ along $b$ and $a$.
The closure under other constructions is defined similarly.

In general, being closed under different construction is not a property of a map but additional data on it.
The following proposition shows that it is a property if the map $p$ is an object classifier:

\begin{prop}
Let $p : \Hom(\widehat{\mathcal{U}},\mathcal{U})$ be an object classifier.
Then the types corresponding to the closure conditions listed above are propositions.
\end{prop}
\begin{proof}
% TODO
\end{proof}

An \emph{(internal) universe} in an indexed dependent type theory is an indexed type $\mathcal{U}$ together with an indexed type $\El(c)$ for all $c : \mathcal{U}$:
\begin{center}
\AxiomC{}
\UnaryInfC{$\Gamma \mid \Delta \vdash \mathcal{U} \ob$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash c : \mathcal{U}$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \El(c) \ob$}
\DisplayProof
\end{center}
An internal universe is \emph{univalent} if the obvious map from $\Id_{\mathcal{U}}(c,c')$ to the type of equivalences between $\El(c)$ and $\El(c')$ is an equivalence.
Internal universes in a theory with $\Sigma$-types and identity types correspond to maps $\Hom(\widehat{\mathcal{U}},\mathcal{U})$ via the construction $\pi_1 : \Hom(\Sigma_{x : \mathcal{U}} \El(x), \mathcal{U})$.
Such a map is an object classifier if and only if the corresponding universe is univalent.

Every internal universe $\mathcal{U}$ gives rise to an external one, namely $\Hom(\Delta.\mathcal{U})$.
An internal universe is univalent if and only if the corresponding external one is.
Moreover, a class of fibration is classified by an internal universe if and only if it is classified by the corresponding external one.
An internal universe classifying a given class of fibrations is also unique up to a canonical equivalence.
The proof is the same as for external universes.

A universe $\mathcal{U}$ is \emph{weakly (resp., strictly) contains a type $A$} if there is an element $a : \mathcal{U}$ such that $\El(a)$ is propositionally (resp., judgementally) equivalent to $A$. 
A universe $\mathcal{U}$ is \emph{weakly (resp., strictly) closed under coproducts} if, for all elements $a,b : \mathcal{U}$, there exists an element $a + b : \mathcal{U}$ such that $\El(a + b)$ is propositionally (resp., judgementally) equivalent to the coproduct of $\El(a)$ and $\El(b)$.
A universe $\mathcal{U}$ is \emph{weakly (resp., strictly) closed under $\Sigma$-types} if, for every element $a : \mathcal{U}$ and every function $b : \El(a) \to \mathcal{U}$, there exists an element $\Sigma(a,x.b(x)) : \mathcal{U}$ such that $\El(\Sigma(a,x.b(x)))$ is propositionally (resp., judgementally) equivalent to $\Sigma_{x : \El(a)} \El(b(x))$.

\begin{prop}
Let $\mathcal{U}$ be a universe.
Then it is weakly closed under one of the constructions listed above if and only if the map $\pi_1 : \Hom(\Sigma_{A : \mathcal{U}} \El(A), \mathcal{U})$ is closed under the corresponding construction.
\end{prop}
\begin{proof}
% TODO
\end{proof}

The following propositions discuss $n$-truncated object classifiers.

\begin{prop}
If $p : \Hom(\widehat{\mathcal{U}},\mathcal{U})$ is an $n$-truncated map which is also an object classifier, then $\mathcal{U}$ and $\widehat{\mathcal{U}}$ are $(n+1)$-truncated.
\end{prop}
\begin{proof}
First, let us prove that $\mathcal{U}$ is $(n+1)$-truncated.
This is true if and only if $\Hom(B,\mathcal{U})$ is $(n+1)$-truncated for all $B$, which is true if and only if the type $\Id(f,f')$ is $n$-truncated for all $f,f' : \Hom(B,\mathcal{U})$.
Since $p$ is an object classifier, the type $\Id(f,f')$ is equivalent to the type of equivalences over $B$ between pullbacks of $p$ along $f$ and $f'$.
By \rlem{trunc-pb}, pullbacks of $p$ are $n$-truncated.
Since the type of equivalences over $B$ is embedded into the type of maps over $B$, we just need to prove that the type of such maps between $n$-truncated maps is $n$-truncated.

Let $s : \Hom(E,B)$ and $s' : \Hom(E',B)$ be $n$-truncated maps.
The type of maps over $B$ is defined as $\Sigma_{f : \Hom(E,E')} \Id(s' \circ f, s)$.
This type is the fiber of $s' \circ -$ over $s$, which is $n$-truncated since $s' \circ -$ is $n$-truncated.

Finally, since both $p$ and $\mathcal{U}$ are $(n+1)$-truncated, $\widehat{\mathcal{U}}$ is also $(n+1)$-truncated.
\end{proof}

\begin{prop}
If $p : \Hom(\widehat{\mathcal{U}},\mathcal{U})$ is an object classifier which is also a monomorphism, then $\widehat{\mathcal{U}}$ is contractible.
\end{prop}
\begin{proof}
Since the identity morphism $\id_B$ is a monomorphism for all $B$, it is a pullback of $p$.
In particular, there is a map from $B$ to $\widehat{\mathcal{U}}$.
Thus, we just need to show that any to maps $\Hom(B,\widehat{\mathcal{U}})$ are homotopic.

First, note that any commutative square of the form
\[ \xymatrix{ B \ar[r]^s \ar[d]_{\id_B} & \widehat{\mathcal{U}} \ar[d]^p \\
              B \ar[r]_t                & \mathcal{U}
            } \]
is a pullback.
We need to prove that the canonical map
\[ r : \Hom(X,B) \to \sum_{f : \Hom(X,B)} \sum_{g : \Hom(X,\widehat{\mathcal{U}})} \Id(t \circ f, p \circ g). \]
is an equivalence for all $X$.
Since $t$ is homotopic to $p \circ s$, the type $\Id(t \circ f, p \circ g)$ is equivalent to $\Id(p \circ s \circ f, p \circ g)$.
Since $p$ is a monomorphism, it is equivalent to $\Id(s \circ f, g)$.
Since the type $\Sigma_{g : \Hom(X,\widehat{\mathcal{U}})} \Id(s \circ f, g)$ is contractible, $r$ is indeed an equivalence.

Let $f_1,f_2 : \Hom(B,\widehat{\mathcal{U}})$ be a pair of maps.
Since $p$ is a monomorphism, it is enough to construct a homotopy between $p \circ f_1$ and $p \circ f_2$.
We have two pullback squares as above with $s = f_i$ and $t = p \circ f_i$.
Since $p$ is an object classifier, we have an equivalence between $\Id(p \circ f_1, p \circ f_2)$ and the type of equivalences between pullbacks of $p$ along $p \circ f_1$ and $p \circ f_2$.
Since both pullbacks are just $\id_B$, they are equivalent; so, we have a homotopy between $p \circ f_1$ and $p \circ f_2$.
\end{proof}

Finally, let us prove another simple but useful result.
Analogous result in the context of higher categories was proved in \cite[Theorem~3.28]{rasekh-eht}.

\begin{prop}
Let $p : \Hom(\widehat{\mathcal{U}},\mathcal{U})$ be an object classifier and let $f : \Hom(\mathcal{U}',\mathcal{U})$ be any map.
Then the pullback of $p$ is an object classifier if and only if $f$ is a monomorphism.
\end{prop}
\begin{proof}
% TODO
\end{proof}

\section{Locally reflective classes of fibrations}

In this section, we discuss the notion of modalities in indexed type theories.
Several equivalent definitions of modalities were defined in \cite{modality-hott} in the context of ordinary homotopy type theory.
We define the notion of locally reflective classes of fibrations which is similar to the notion of a reflective subuniverse.
This definition makes sense in an indexed unary type theory.
We also define a dependent version of this notion which is similar to the notion of a higher modality.

\subsection{Locally reflective classes in unary theories}

Let $\Fib$ be a class of fibrations in an indexed unary type theory as defined in the previous section.
We will say that it is \emph{locally reflective} if every map $f : \Hom(A,B)$ factors through a fibration $p : \Hom(C,B)$
such that, for every factorization of $f$ through any fibration $p' : \Hom(C',B)$, the type of lifts in the following square is contractible:
\[ \xymatrix{ A \ar[r] \ar[d]                   & C' \ar@{->>}[d]^{p'} \\
              C \ar@{->>}[r]_p \ar@{-->}[ur]    & B
            } \]
The factorization $A \to C \twoheadrightarrow B$ will be called \emph{the universal factorization} of $f$.
We will say that $\Fib$ is \emph{stably} locally reflective if the universal factorization of any map is stable under pullbacks.

\begin{lem}[fib-refl]
If $A \xrightarrow{i} C \overset{p}\twoheadrightarrow B$ is the universal factorization of $f$, then the following conditions are equivalent:
\begin{enumerate}
\item $i$ is an equivalence.
\item $f$ is a fibration.
\item $i$ has a retraction over $B$.
\end{enumerate}
\end{lem}
\begin{proof}
If $i$ is an equivalence, then $f$ is a fibration since fibrations are closed under equivalences and $p$ is a firation.
If $f$ is a fibration, then the lift in the following square is a retraction of $i$ over $B$.
\[ \xymatrix{ A \ar@{=}[r] \ar[d]_i             & A \ar@{->>}[d]^{f} \\
              C \ar@{->>}[r]_p \ar@{-->}[ur]^r  & B
            } \]
Let $r$ be a retraction of $i$ over $B$.
Consider the following commutative square:
\[ \xymatrix{ A \ar[r]^i \ar[d]_i                                                           & C \ar@{->>}[d]^{p} \\
              C \ar@{->>}[r]_p \ar@{-->}@<-0.5ex>[ur]_{i \circ r} \ar@{-->}@<0.5ex>[ur]^\id & B
            } \]
It is easy to see that $\id_C$ and $i \circ r$ are lifts in this square.
Since lifts are unique up to a homotopy, these maps are homotopic.
Thus, $i$ is an equivalence.
\end{proof}

\begin{lem}[fib-idm]
Any locally reflective class of fibrations contains all identity morphisms
\end{lem}
\begin{proof}
Let $A \xrightarrow{i} B \overset{p}\twoheadrightarrow A$ be the universal factorization of $\id_A$.
Then $p$ is a retraction of $i$ over $A$.
By \rlem{fib-refl}, $\id_A$ is a fibration.
\end{proof}

\begin{lem}
Any stably locally reflective class of fibrations is closed under pullbacks.
\end{lem}
\begin{proof}
Let $f$ be a fibration and let $f = p \circ i$ be its universal factorization.
Since the class of fibrations is stably locally reflactive, the pullbacks of $p$ and $i$ constitute the universal factorization of a pullback of $f$.
By \rlem{fib-refl}, $i$ is an equivalence.
Hence, its pullback is also an equivalence.
Since the pullback of $p$ is a fibration and fibrations are closed under equivalences, the pullback of $f$ is also a fibration.
\end{proof}

\begin{lem}[pullback-lift]
Suppose that we have the following diagram, where the right square is a pullback.
\[ \xymatrix{ A \ar[r]^{c} \ar[d]_i & C \ar[r]^e \ar[d]_p \pb   & E \ar[d]^q \\
              B \ar[r]_d            & D \ar[r]_f                & F
            } \]
Then the type of lifts in the left square is equivalent to the type of lifts in the outer rectangle.
\end{lem}
\begin{proof}
Let $H_1$ and $H_2$ be the homotopies witnessing the commutativity of the left and right square, respectively.
By the universal property of pullbacks, the type of lifts in the left square is equivalent to the following type:
\begin{align*}
& \sum_{r_1 : \Hom(B,D)} \sum_{r_2 : \Hom(B,E)} \sum_{r_3 : \Id(f \circ r_1, q \circ r_2)} \sum_{h : \Id(d,r_1)} \\
& \sum_{h_1 : \Id(r_1 \circ i, p \circ c)} \sum_{h_2 : \Id(e \circ c, r_2 \circ i)} \sum_{h_3 : \Id((h_1 * f) \ct (c * H_2) \ct (h_2 * q), i * r_3)} \Id(h_1,h_*(H_1)).
\end{align*}
After reducing $r_1$, $h$, $h_1$, and the last homotopy we get the following equivalent type:
\[ \sum_{r_2 : \Hom(B,E)} \sum_{r_3 : \Id(f \circ d, q \circ r_2)} \sum_{h_2 : \Id(e \circ c, r_2 \circ i)} \Id((H_1 * f) \ct (c * H_2) \ct (h_2 * q), i * r_3). \]
This type is equivalent to the type of lifts in the outer rectangle.
\end{proof}

\begin{lem}[fib-refl-lift]
Let $\Fib$ be a locally reflective class of fibrations closed under pullbacks.
Let $A \xrightarrow{i} C \overset{p}\twoheadrightarrow B$ be the universal factorization of a map $f : \Hom(A,B)$.
Then the type of lifts in every commutative square as below is contractible if $v$ factors through $p$.
\[ \xymatrix{ A \ar[r] \ar[d]_i & D \ar@{->>}[d] \\
              C \ar[r]_v        & E
            } \]
\end{lem}
\begin{proof}
By assumption, $v$ equals to $C \overset{p}\twoheadrightarrow B \xrightarrow{u} E$ for some map $u$.
Consider the following diagram:
\[ \xymatrix{ A \ar[r] \ar[d]_i & C' \ar[r] \ar@{->>}[d] \pb    & D \ar@{->>}[d] \\
              C \ar@{->>}[r]_p  & B \ar[r]_u                    & E
            } \]
The type of lift in the left square is contractible and \rlem{pullback-lift} implies that this type is equivalent to the type of lifts in the original square.
\end{proof}

\begin{prop}[fib-refl-id]
Any locally reflective class of fibrations closed under pullbacks satisfies the equivalent conditions of \rprop{fib-id}.
\end{prop}
\begin{proof}
By \rlem{fib-id-idm} and \rlem{fib-idm}, it is enough to prove condition~\eqref{it:fib-over} of \rprop{fib-id-comp}.
Let $f : \Hom(A,D)$ be a map and let $q : \Hom(D,B)$ be a fibration such that $q \circ f$ is also a fibration.
We need to prove that $f$ is a fibration.
Let $A \xrightarrow{i} C \overset{p}\twoheadrightarrow D$ be the universal factorization of $f$.
By \rlem{fib-refl}, it is enough to show that $i$ has a retraction over $D$.
By \rlem{fib-refl-lift}, we have a lift in the following square:
\[ \xymatrix{ A \ar@{=}[r] \ar[d]_i                 & A \ar@{->>}[d]^{q \circ f} \\
              C \ar[r]_{q \circ p} \ar@{-->}[ur]^r  & B
            } \]
Both maps $p$ and $f \circ r$ are lifts in the following square:
\[ \xymatrix{ A \ar[r]^f \ar[d]_i   & D \ar@{->>}[d]^q \\
              C \ar[r]_{q \circ p}  & B
            } \]
By \rlem{fib-refl-lift}, we have a homotopy $h$ between $p$ and $f \circ r$ such that $i * h$ is homotopic to the canonical homotopy between $p \circ i$ and $f \circ r \circ i$.
This implies that $r$ is a retraction of $i$ over $D$.
\end{proof}

\subsection{Orthogonal factorization systems}

In this subsection, we defined connected maps and orthogonal factorization systems and prove that they are equivalent to locally reflective classes of fibrations.
Similar equivalence was proved in \cite{modality-hott}, but our proof is more general since it applies to any (indexed) unary theory.
Moreover, the proof in \cite{modality-hott} applies only to stable orthogonal factorization systems and stably locally reflective classes of fibrations.
The reason is that it is done in the internal language of the theory and everything must be stable in this language.
We prove a more general equivalence between (non-stable) orthogonal factorization systems and (non-stable) locally reflective classes of fibrations.

\begin{defn}
Let $\Fib$ be a locally reflective class of fibrations in an indexed unary type theory.
A map $f$ is \emph{connected} if the fibration in the universal factorization of $f$ is an equivalence.
Cofibrations will be denoted by $\hookrightarrow$.
\end{defn}

\begin{defn}
Let $f : \Hom(A,B)$ and $g : \Hom(C,D)$ be maps in an indexed unary type theory.
We will say that $f$ is \emph{left orthogonal} to $g$ and $g$ is \emph{right orthogonal} to $f$ if the type of lifts in squares of the form depicted below is contractible.
\[ \xymatrix{ A \ar[r] \ar[d]_f         & C \ar[d]^g \\
              B \ar[r] \ar@{-->}[ur]    & D
            } \]
\end{defn}

\begin{lem}[conn-orth]
Let $\Fib$ be a locally reflective class of fibrations closed under pullbacks.
Then connected maps are left orthogonal to fibrations.
\end{lem}
\begin{proof}
Let $i : \Hom(A,B)$ be a connected map and let $p : \Hom(C,D)$ be a fibration.
Consider a commutative square of the following form:
\[ \xymatrix{ A \ar@{^{(}->}[d]_i \ar[r]^f  & C \ar[d]^p \\
              B \ar[r]_g                    & D
            } \]
The type of lifts in this square is
\[ \sum_{r : \Hom(B,C)} \sum_{h_1 : \Id(f, r \circ i)} \sum_{h_2 : \Id(p \circ r, g)} \Id((h_1 * p) \ct (i * h_2), H), \]
where $H$ is the homotopy witnessing the commutativity of the square.
Let us denote this type by $L$.
We need to prove that $L$ is contractible.

Let $A \xrightarrow{i'} B' \overset{q}\twoheadrightarrow B$ be the universal factorization of $i$.
By \rlem{fib-refl-lift}, the type of lifts in the following square is contractible:
\[ \xymatrix{ A \ar[d]_{i'} \ar[rr]^f       &               & C \ar[d]^p \\
              B' \ar[r]_q \ar@{-->}[urr]    & B \ar[r]_g    & D
            } \]
The type of lifts in this square is defined as follows:
\[ \sum_{r' : \Hom(B',C)} \sum_{h_1' : \Id(f, r' \circ i')} \sum_{h_2 : \Id(p \circ r', g \circ q)} \Id((h_1' * p) \ct (i' * h_2'), H \ct (H' * g)), \]
where $H'$ is the homotopy between $i$ and $q \circ i'$.
Let us denote this type by $L'$.
It is enough to prove that $L$ and $L'$ are equivalent.

We have an obvious map $s : L \to L'$ which maps $(r,h_1,h_2,h_3)$ to $(r \circ q, h_1 \ct (H' * r), q * h_2, h_3')$, where $h_3'$ is the following homotopy:
\begin{align*}
((h_1 \ct (H' * r)) * p) \ct (i' * q * h_2) & \sim \\
((h_1 * p) \ct (H' * r * p)) \ct (i' * q * h_2) & \sim \\
(h_1 * p) \ct (H' * h_2) & \sim \\
((h_1 * p) \ct (i * h_2)) \ct (H' * g) & \sim \\
H \ct (H' * g) & ,
\end{align*}
where we use $h_3$ at the last step and other steps are usual interchange laws.

To prove that this map is an equivalence, it is enough to show that it is an equivalence on each component.
Since $i$ is connected, $q$ is an equivalence.
This implies that functions $- \circ q$ and $q * -$ are equivalences and these functions are the first and the third component of $s$, respectively.
The second component of $s$ is $- \ct (H' * r)$, which is also an equivalence.
Finally, the third component of $s$ is an equivalence since it is a function that concatenates its argument with fixed homotopies.
\end{proof}

\begin{lem}[uni-conn]
Let $\Fib$ be a locally reflective class of fibrations closed under compositions.
If $A \xrightarrow{i} B \overset{p}\twoheadrightarrow C$ is the universal factorization of some map, then $i$ is connected.
\end{lem}
\begin{proof}
Let $A \xrightarrow{j} B' \overset{q}\twoheadrightarrow B$ be the universal factorization of $i$.
We need to prove that $q$ is an equivalence.
Since fibrations are closed under compositions, $p \circ q$ is a fibration.
It follows that we have a lift in the following square:
\[ \xymatrix{ A \ar[r]^j \ar[d]_i               & B' \ar@{->>}[d]^{p \circ q} \\
              B \ar@{->>}[r]_p \ar@{-->}[ur]^k  & C
            } \]
Let $h_1 : \Id(j, k \circ i)$ and $h_2 : \Id(p \circ q \circ k, p)$ be the homotopies witnessing the commutativity of triangles in the diagram above.

Let us show that $q \circ k$ is a lift in the following square:
\[ \xymatrix{ A \ar[r]^i \ar[d]_i                   & B \ar@{->>}[d]^p \\
              B \ar@{->>}[r]_p \ar[ur]^{q \circ k}  & C
            } \]
Let $h_0$ be the homotopy between $i$ and $q \circ j$.
The homotopy between $i$ and $q \circ k \circ i$ is defined as $h_0 \ct (h_1 * q)$.
The homotopy between $p \circ q \circ k$ and $p$ is simply $h_2$.
The fact that the combination of these homotopies is homotopic to the trivial homotopy on $p \circ i$ follows from the fact that the combination of $h_1$ and $h_2$ is homotopic to $\sym{h_0} * p$.
Since both $\id_B$ and $q \circ k$ are lifts in the square above, there is a homotopy $h_3$ between them such that $i * h_3$ is homotopic to $h_0 \ct (h_1 * q)$.

Let us show that $k \circ q$ is a lift in the following square:
\[ \xymatrix{ A \ar[r]^j \ar[d]_j                   & B' \ar@{->>}[d]^q \\
              B' \ar@{->>}[r]_q \ar[ur]^{k \circ q} & B
            } \]
The homotopy between $j$ and $k \circ q \circ j$ is defined as $h_1 \ct (h_0 * k)$.
The homotopy between $q \circ k \circ q$ and $q$ is defined as $q * \sym{h_3}$.
The fact that the combination of these homotopies is homotopic to the trivial homotopy on $q \circ j$ follows from the fact that $i * h_3$ is homotopic to $h_0 \ct (h_1 * q)$.
Since both $\id_{B'}$ and $k \circ q$ are lifts in the square above, these maps are homotopic.
It follows that $q$ is an equivalence.
Hence, $i$ is connected.
\end{proof}

Let $\mathcal{L}$ and $\mathcal{R}$ be a pair of classes of maps closed under equivalences such that maps in $\mathcal{L}$ are left orthogonal to maps in $\mathcal{R}$.
Then a factorizations of a map into a map in $\mathcal{L}$ followed by a map in $\mathcal{R}$ is essentially unique.
The pair $(\mathcal{L},\mathcal{R})$ is called an \emph{orthogonal factorization system} if such a factorization exists for every map.

\begin{lem}[orth-refl]
If $(\mathcal{L},\mathcal{R})$ is an orthogonal factorization system, then $\mathcal{R}$ is a locally reflective class of maps.
Moreover, if $A \xrightarrow{i} B \twoheadrightarrow C$ is the universal factorization of some map, then $i$ belongs to $\mathcal{L}$.
\end{lem}
\begin{proof}
Obviously, any factorization of a map into a map in $\mathcal{L}$ followed by a map in $\mathcal{R}$ is a universal factorization.
The second assertion follows from the facts that universal factorizations are essentially unique and $\mathcal{L}$ is closed under equivalences.
\end{proof}

\begin{prop}
If $(\mathcal{L},\mathcal{R})$ is an orthogonal factorization system, then $\mathcal{L}$ and $\mathcal{R}$ contains all identity morphisms.
\end{prop}
\begin{proof}
By \rlem{orth-refl} and \rlem{fib-idm}, $\mathcal{R}$ contains all identity morphisms.
Since $A \xrightarrow{\id_A} A \xrightarrow{\id_A} A$ is the universal factorization of $\id_A$, \rlem{orth-refl} implies that $\id_A$ belongs to $\mathcal{L}$.
\end{proof}

\begin{prop}[orth-char]
If $(\mathcal{L},\mathcal{R})$ is an orthogonal factorization system, then
$\mathcal{R}$ is precisely the class of maps which are right orthogonal to $\mathcal{L}$ and
$\mathcal{L}$ is precisely the class of maps which are left orthogonal to $\mathcal{R}$.
\end{prop}
\begin{proof}
We prove the first assertion; the other one follows by a dual argument.
Maps in $\mathcal{R}$ are right orthogonal to $\mathcal{L}$ by definition.
Let $f : \Hom(A,C)$ be a map which is right orthogonal to $\mathcal{L}$.
We need to prove that $f$ belongs to $\mathcal{R}$.
By \rlem{orth-refl}, $\mathcal{R}$ is a locally reflective class of maps.
Let $A \xrightarrow{i} B \xrightarrow{p} C$ be the universal factorization of $f$.
By \rlem{orth-refl}, $i$ belongs to $\mathcal{L}$.
Hence, we have a lift in the following square:
\[ \xymatrix{ A \ar@{=}[r] \ar[d]_i     & A \ar[d]^f \\
              B \ar[r]_p \ar@{-->}[ur]  & C
            } \]
By \rlem{fib-refl}, $f$ belongs to $\mathcal{R}$.
\end{proof}

\begin{cor}[orth-unique]
Let $\mathcal{R}$ be a class of maps.
Then a class of maps $\mathcal{L}$ such that $(\mathcal{L},\mathcal{R})$ is an orthogonal factorization system is essentially unique.
That is, if $\mathcal{L}_1$ and $\mathcal{L}_2$ is two such classes, then a map belongs to one of them if and only if it belongs to the other.
Dually, a class of maps $\mathcal{R}$ such that $(\mathcal{L},\mathcal{R})$ is an orthogonal factorization system for a fixed $\mathcal{L}$ is essentially unique.
\end{cor}

\begin{prop}[orth-comp]
If $(\mathcal{L},\mathcal{R})$ is an orthogonal factorization system, then $\mathcal{R}$ and $\mathcal{L}$ are closed under compositions.
\end{prop}
\begin{proof}
We prove this for $\mathcal{R}$; the assertion about $\mathcal{L}$ follows by a dual argument.
Let $f : \Hom(A,B)$ and $g : \Hom(B,C)$ be maps in $\mathcal{R}$.
By \rlem{orth-refl}, there exists a universal factorization $A \xrightarrow{i} D \xrightarrow{p} C$ of $g \circ f$ such that $i \in \mathcal{L}$.
By \rlem{fib-refl}, to prove that $g \circ f$ belongs to $\mathcal{R}$, it is enough to show that $i$ has a retraction over $C$.
Since $i \in \mathcal{L}$, we have two lifts in the following diagram:
\[ \xymatrix{ A \ar@{=}[r] \ar[dd]_i                    & A \ar@{->>}[d]^f \\
                                                        & B \ar@{->>}[d]^g \\
              D \ar[r]_p \ar@{-->}[ur] \ar@{-->}[uur]^r & C
            } \]
Then $r$ is a retraction of $i$ over $C$.
\end{proof}

\begin{prop}[orth-pullback]
If $(\mathcal{L},\mathcal{R})$ is an orthogonal factorization system, then $\mathcal{R}$ is closed under pullbacks and $\mathcal{L}$ is closed under pushouts.
\end{prop}
\begin{proof}
We prove this for $\mathcal{R}$; the assertion about $\mathcal{L}$ follows by a dual argument.
Let $f$ be a pullback of a map $g \in \mathcal{R}$.
Since $g$ is right orthogonal to $\mathcal{L}$, \rlem{pullback-lift} implies that $f$ is also right orthogonal to $\mathcal{L}$.
\rprop{orth-char} implies that $f \in \mathcal{R}$.
\end{proof}

Now, we are ready to prove that orthogonal factorizations systems are equivalent to locally reflective classes of maps which are closed under compositions and pullbacks:

\begin{thm}[refl-orth]
Let $\Fib$ be a class of fibrations.
If $\Fib$ is locally reflective and closed under compositions and pullbacks, then $(\mathcal{C},\Fib)$ is an orthogonal factorization system, where $\mathcal{C}$ is the class of connected maps.
The converse is also true in the sense that if $(\mathcal{L},\Fib)$ is an orthogonal factorization system for some class of maps $\mathcal{L}$, then $\Fib$ is locally reflective and closed under compositions and pullbacks.
\end{thm}
\begin{proof}
If $\Fib$ is locally reflective and closed under compositions, then connected maps are left orthogonal to fibrations by \rlem{conn-orth} and the factorization exists by \rlem{uni-conn}.
Thus, $(\mathcal{C},\Fib)$ is an orthogonal factorization system.
Conversely, if we have an orthogonal factorization system $(\mathcal{L},\Fib)$, then $\Fib$ is locally reflective by \rlem{orth-refl} and it is closed under compositions and pullbacks by \rprop{orth-comp} and \rprop{orth-pullback}, respectively.
\end{proof}

\subsection{Locally reflective classes in dependent theories}

We can reformulate the definition of locally reflective class of fibrations in dependent theories.
Let $\Fib$ be a dependent class of fibrations.
A factorization of a map in a unary theory can be turned into a factorization of a dependent type $\Delta \vdash A \ob$, which consists of a dependent type $\Delta \vdash \| A \| \ob$ and a map $\eta_A : \Hom_\Delta(A, \| A \|)$.
Then $\Fib$ is locally reflective if and only if, for every dependent type $A$, there exists its factorization such that the following function is an equivalence for every fibrant type $\Delta \vdash B \ob$:
\[ \lambda f.\, f \circ \eta_A : \Hom_\Delta(\| A \|, B) \to \Hom_\Delta(A, B). \]
This condition holds if and only if the type of lifts in the following diagram is contractible for every fibrant type $\Delta \vdash B \ob$ and every map $\Hom_\Delta(A,B)$:
\[ \xymatrix{ A \ar[r] \ar[d]_{\eta_A} & B \\
              \| A \| \ar@{-->}[ur]
            } \]

The constructions $\| - \|$ and $\eta$ are unstable, that is they are not stable under substitutions.
If we assume the stability condition, then $\Fib$ is stably locally reflective,
but the converse does not hold since the stability under substitutions is a stricter condition, then the stability under pullbacks.
If we assume the stability under substitutions, then instead of $\eta$ we can use the following construction:
\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash A \ob$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \| A \| \fib$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\UnaryInfC{$\Gamma \mid \Delta \vdash | a | : \| A \|$}
\DisplayProof
\end{center}
\medskip
Then $\eta_A$ can be defined as $\lambda x.\,| x | : \Hom_\Delta(A, \| A \|)$.
Conversely, $| a |$ can be defined in terms of $\eta_A$ as $\eta_A\,a$.
These constructions are mutually inverse.

\begin{prop}
Let $\Fib$ be a class of fibrations closed under $\Sigma$-types and let $\| - \|$, $| - |$ be a pair of stable constructions as described above.
Then the following conditions are equivalent:
\begin{enumerate}
\item \label{it:fib-non-dep} The pair $\| - \|$, $| - |$ makes $\Fib$ into a (stably) locally reflective class.
\item \label{it:fib-dep} $\Fib$ is closed under identity types and the theory has the following stable constructions:
\begin{center}
\AxiomC{$\Gamma \mid \Delta, z : \| A \| \vdash D \fib$}
\AxiomC{$\Gamma \mid \Delta, x : A \vdash d : D[|x|/z]$}
\AxiomC{$\Gamma \mid \Delta \vdash a : \| A \|$}
\TrinaryInfC{$\Gamma \mid \Delta \vdash \| A \|\text{-}\fs{elim}(z.D, x.d, a) : D[a/z]$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid \Delta, z : \| A \| \vdash D \fib$}
\AxiomC{$\Gamma \mid \Delta, x : A \vdash d : D[|x|/z]$}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\TrinaryInfC{$\Gamma \mid \Delta \vdash \| A \|\text{-}\fs{elim_{eq}}(z.D, x.d, a) : \Id(\| A \|\text{-}\fs{elim}(z.D, x.d, |a|), d[a/x])$}
\DisplayProof
\end{center}
\end{enumerate}
\end{prop}
\begin{proof}
(\ref{it:fib-non-dep} $\Rightarrow$ \ref{it:fib-dep})
By \rprop{fib-refl-id}, a locally reflective class of fibrations is closed under identity types.
Since $\Fib$ is closed under $\Sigma$-types, the type $\Delta \vdash \Sigma_{z : \| A \|} D$ is fibrant.
If $\Delta, x : A \vdash d : D[|x|/z]$, then we have a lift in the following diagram:
\[ \xymatrix{ A \ar[r]^{\lambda x.\,(|x|,d)} \ar[d]_{|-|} & \Sigma_{z : \| A \|} D \\
              \| A \| \ar@{-->}[ur]_{d'}
            } \]
If $\Delta \vdash a : A$, then $\pi_2\,(d'\,a) : $

(\ref{it:fib-dep} $\Rightarrow$ \ref{it:fib-non-dep})
\end{proof}

$\Fib$ is closed under identity types and the theory has the following stable constructions:
\begin{center}
\AxiomC{$\Gamma \mid \Delta, z : \| A \|, E \vdash D \fib$}
\AxiomC{$\Gamma \mid \Delta, x : A, E[|x|/z] \vdash d : D[|x|/z]$}
\AxiomC{$\Gamma \mid \Delta \vdash a : \| A \|$}
\TrinaryInfC{$\Gamma \mid \Delta, E[a/z] \vdash \| A \|\text{-}\fs{elim}(z.D, x.d, a) : D[a/z]$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid \Delta, z : \| A \|, E \vdash D \fib$}
\AxiomC{$\Gamma \mid \Delta, x : A, E[|x|/z] \vdash d : D[| x | / z]$}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\TrinaryInfC{$\Gamma \mid \Delta, E[|a|/z] \vdash \| A \|\text{-}\fs{elim_{eq}}(z.D, x.d, a) : \Id(\| A \|\text{-}\fs{elim}(z.D, x.d, |a|), d[a/x])$}
\DisplayProof
\end{center}

\begin{prop}
Let $\Fib$ be a dependent class of fibrations in an indexed dependent type theory with $\Sigma$-types and identity types.
Then the following conditions are equivalent:
\begin{enumerate}
\item $\Fib$ is weakly reflective and is closed under identity types and $\Sigma$-types.
\item The non-dependent version of $\Fib$ is locally reflective and is closed under compositions.
\end{enumerate}
\end{prop}
\begin{proof}
By \rprop{fib-sigma}, $\Fib$ is closed under $\Sigma$-types if and only if it is closed under compositions.
First, suppose that $\Fib$ is locally reflective.
By \rprop{fib-refl-id}, it is closed under identity types.
% TODO
\end{proof}

\begin{example}
Since the class of $n$-truncated maps is closed under identity types, it is locally reflective if and only if we have the weak version of the $n$-truncation operation.
\end{example}

\bibliographystyle{amsplain}
\bibliography{ref}

\end{document}
