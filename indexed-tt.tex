\documentclass[reqno]{amsart}

\usepackage{amssymb}
\usepackage{hyperref}
\usepackage{mathtools}
\usepackage[all]{xy}
\usepackage{verbatim}
\usepackage{ifthen}
\usepackage{xargs}
\usepackage{bussproofs}
\usepackage{turnstile}
\usepackage{etex}

\hypersetup{colorlinks=true,linkcolor=blue}

\newcommand{\axlabel}[1]{(#1) \phantomsection \label{ax:#1}}
\newcommand{\axtag}[1]{\label{ax:#1} \tag{#1}}
\newcommand{\axref}[1]{(\hyperref[ax:#1]{#1})}

\newcommand{\newref}[4][]{
\ifthenelse{\equal{#1}{}}{\newtheorem{h#2}[hthm]{#4}}{\newtheorem{h#2}{#4}[#1]}
\expandafter\newcommand\csname r#2\endcsname[1]{#3~\ref{#2:##1}}
\expandafter\newcommand\csname R#2\endcsname[1]{#4~\ref{#2:##1}}
\expandafter\newcommand\csname n#2\endcsname[1]{\ref{#2:##1}}
\newenvironmentx{#2}[2][1=,2=]{
\ifthenelse{\equal{##2}{}}{\begin{h#2}}{\begin{h#2}[##2]}
\ifthenelse{\equal{##1}{}}{}{\label{#2:##1}}
}{\end{h#2}}
}

\newref[section]{thm}{Theorem}{Theorem}
\newref{lem}{Lemma}{Lemma}
\newref{prop}{Proposition}{Proposition}
\newref{cor}{Corollary}{Corollary}
\newref{cond}{Condition}{Condition}

\theoremstyle{definition}
\newref{defn}{Definition}{Definition}
\newref{example}{Example}{Example}

\theoremstyle{remark}
\newref{remark}{Remark}{Remark}

\newcommand{\type}{\mathrm{type}}
\newcommand{\ob}{\mathrm{type}}

\newcommand{\fs}[1]{\mathit{#1}}
\newcommand{\subst}{\fs{subst}}
\newcommand{\Hom}{\fs{Hom}}
\newcommand{\Id}{\fs{Id}}
\newcommand{\refl}{\fs{refl}}
\newcommand{\sym}{\fs{sym}}
\newcommand{\id}{\fs{id}}
\newcommand{\pmap}{\fs{ap}}

\numberwithin{figure}{section}

\newcommand{\ct}{%
  \mathchoice{\mathbin{\raisebox{0.25ex}{$\displaystyle\centerdot$}}}%
             {\mathbin{\raisebox{0.25ex}{$\centerdot$}}}%
             {\mathbin{\raisebox{0.25ex}{$\scriptstyle\,\centerdot\,$}}}%
             {\mathbin{\raisebox{0.25ex}{$\scriptscriptstyle\,\centerdot\,$}}}
}

\newcommand{\pb}[1][dr]{\save*!/#1-1.2pc/#1:(-1,1)@^{|-}\restore}
\newcommand{\po}[1][dr]{\save*!/#1+1.2pc/#1:(1,-1)@^{|-}\restore}

\begin{document}

\title{Indexed type theories}

\author{Valery Isaev}

\begin{abstract}
\end{abstract}

\maketitle

\section{Introduction}

\section{Indexed unary type theories}

We can think about an indexed type theory as a syntactic representation of indexed $\infty$-categories, that is a functor $F$ from an $\infty$-category $\mathcal{B}$ to the large $\infty$-category of $\infty$-categories.
An indexed type theory consists of two levels.
The first level is just an ordinary type theory and it represents $\mathcal{B}$
Since we are mostly interested in the case when $\mathcal{B}$ is the $\infty$-category of spaces,
we can assume that the first level has all usual constructions such as identity types, $\Sigma$-types, $\Pi$-types, (univalent) universes, and (higher) inductive types.
Nevertheless, in general, we will assume that the base theory has only identity types and $\Sigma$-types; all additional assumptions will be explicitly specified.

The second level of the theory represents $\infty$-categories $F(\Gamma)$ for various objects $\Gamma$ of $\mathcal{B}$.
In this section, we will discuss \emph{indexed unary type theories}, that is indexed type theories in which the second level consists of unary type theories.
A unary type theory is a non-dependent type theory in which contexts consist of exactly one type.
Such theories represent arbitrary 1-categories.
We do not know whether indexed unary type theories represent all indexed $\infty$-categories over a given base, but it seems that this should be true at least for locally small indexed $\infty$-categories.

Indexed unary type theories have four kinds of judgements:
\[ \Gamma \vdash A\ \type \qquad \Gamma \vdash a : A \qquad \Gamma \mid \cdot \vdash A\ \ob \qquad \Gamma \mid x : A \vdash b : B \]

In each of these judgements, $\Gamma$ is a context, that is a sequence of the form $x_1 : A_1, \ldots x_n : A_n$, where $A_1$, \ldots $A_n$ are types and $x_1$, \ldots $x_n$ are pairwise distinct variables.
Judgements $\Gamma \vdash A\ \type$ and $\Gamma \vdash a : A$ represent types and terms of the first level of the theory.
We will call such types and terms \emph{base types} and \emph{base terms}, respectively.
The collection of rules that involve only judgements for base types and base terms will be called the base (sub)theory.
When we say that the base theory has some construction such as $\Pi$-types or universes, this means that there are usual rules for these constructions formulated in terms of these judgements.

Judgements $\Gamma \mid \cdot \vdash A\ \ob$ represent types of the second level of the theory.
We will call these types \emph{indexed types} to distinguish them from base types.
In a judgement $\Gamma \mid x : A \vdash b : B$, $x$ is a variable which is distinct from the variables in $\Gamma$, $A$ and $B$ are indexed types, and $b$ is a term of the second level of the theory.
We will call such terms \emph{indexed terms}.
Indexed types represent objects indexed by $\Gamma$ and indexed an indexed term $\Gamma \mid x : A \vdash b : B$ represents a morphism between $A$ and $B$.

We have the usual rules for variables and substitutions for the indexing theory:
\begin{center}
\AxiomC{}
\UnaryInfC{$x_1 : A_1, \ldots x_n : A_n \vdash x_i : A_i$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \vdash C\ \type$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \vdash C[b_1/y_1, \ldots b_k/y_k]\ \type$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \vdash c : C$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \vdash c[b_1/y_1, \ldots b_k/y_k] : C[b_1/y_1, \ldots b_k/y_k]$}
\DisplayProof
\end{center}

We also have the usual equations for substitution:
\begin{align*}
y_i[b_1/y_1, \ldots b_k/y_k] & = b_i \\
c[y_1/y_1, \ldots y_k/y_k] & = c \\
d[c_1/z_1, \ldots c_n/z_n][b_1/y_1, \ldots b_k/y_k] & = d[c_1'/z_1, \ldots c_n'/z_n],
\end{align*}
where $c_i' = c_i[b_1/y_1, \ldots b_k/y_k]$.

For every construction $\sigma(\overline{z_1}.\,c_1, \ldots \overline{z_n}.\,c_n)$ in the indexing theory, we have the following equation whenever variables $\overline{z_1}$, \ldots $\overline{z_n}$ are not free in $b_1$, \ldots $b_k$:
\[ \sigma(\ldots, \overline{z_i}.\,c_i, \ldots)[b_1/y_1, \ldots b_k/y_k] = \sigma(\ldots, \overline{z_i}.\,c_i[b_1/y_1, \ldots b_k/y_k], \ldots) \]
We also have the weakening operation which is left implicit as usual.
This concludes the description of basic rules of the indexing theory.
They are the usual rules of a dependent type theory which we include here so that they can be compared to the rules of the indexed theory.

Variables of the indexed theory represent identity morphisms and substitution represents composition:
\begin{center}
\AxiomC{}
\UnaryInfC{$\Gamma \mid x : A \vdash x : A$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \Delta \vdash b : B$}
\AxiomC{$\Gamma \mid y : B \vdash c : C$}
\BinaryInfC{$\Gamma \mid \Delta \vdash c[b/y] : C$}
\DisplayProof
\end{center}

These operations satisfy the obvious equations:
\begin{align*}
y[b/y] & = b \\
b[x/x] & = b \\
d[c/z][b/y] & = d[c[b/y]/z]
\end{align*}

We can also substitute base terms into indexed types and terms:
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \mid \cdot \vdash C\ \ob$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid \cdot \vdash C[b_1/y_1, \ldots b_k/y_k]\ \ob$}
\DisplayProof
\end{center}

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash b_1 : B_1$
\noLine
\UnaryInf$\fCenter \ldots$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_k : B_k[b_1/y_1, \ldots b_{k-1}/y_{k-1}]$
\Axiom$\fCenter \Gamma, y_1 : B_1, \ldots y_k : B_k \mid z : C \vdash d : D$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \mid z : C[b_1/y_1, \ldots b_k/y_k] \vdash d[b_1/y_1, \ldots b_k/y_k] : D[b_1/y_1, \ldots b_k/y_k]$}
\DisplayProof
\end{center}

These operations represent reindexing along a morphism in the base category.
They satisfy the following equations:
\begin{align*}
x[b_1/y_1, \ldots b_k/y_k] & = x \\
d[c/z][b_1/y_1, \ldots b_k/y_k] & = d[b_1/y_1, \ldots b_k/y_k][c[b_1/y_1, \ldots b_k/y_k]/z] \\
c[y_1/y_1, \ldots y_k/y_k] & = c \\
d[c_1/z_1, \ldots c_n/z_n][b_1/y_1, \ldots b_k/y_k] & = d[c_1'/z_1, \ldots c_n'/z_n],
\end{align*}
where $c_i' = c_i[b_1/y_1, \ldots b_k/y_k]$.
The first two equations correspond to the fact that reindexing preserves identity morphisms and composition in the indexed theory.
The last two equations correspond to the fact that reindexing is functorial, that is it preserves identity morphisms and composition in the indexing theory.

For every construction $\sigma(\overline{z_1}.\,c_1, \ldots \overline{z_n}.\,c_k)$ in the indexed theory, we have the following equation whenever variables $\overline{z_1}$, \ldots $\overline{z_n}$ are not free in $b_1$, \ldots $b_k$:
\[ \sigma(\ldots, \overline{z_i}.\,c_i, \ldots)[b_1/y_1, \ldots b_k/y_k] = \sigma(\ldots, \overline{z_i}.\,c_i[b_1/y_1, \ldots b_k/y_k], \ldots) \]
We also have the weakening operation which is left implicit as usual.
This equation corresponds to the fact that all constructions in the indexed category must be stable under reindexing.

As we noted before, we assume that the base theory has identity types:
\begin{center}
\AxiomC{$\Gamma \vdash a : A$}
\AxiomC{$\Gamma \vdash a' : A$}
\BinaryInfC{$\Gamma \vdash \Id_A(a,a')\ \type$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \vdash a : A$}
\UnaryInfC{$\Gamma \vdash \refl(a) : \Id_A(a,a)$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash a : A$
\noLine
\UnaryInf$\fCenter \Gamma \vdash a' : A$
\noLine
\UnaryInf$\fCenter \Gamma \vdash t : \Id_A(a,a')$
\Axiom$\fCenter \Gamma, x : A, p : \Id_A(a,x), \Delta \vdash D\ \type$
\noLine
\UnaryInf$\fCenter \Gamma, \Delta[a/x,\refl(a)/p] \vdash d : D$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma, \Delta[a'/x,t/p] \vdash J(a, x p \Delta.\,D, \Delta.\,d, a', t) : D[a'/x,t/p]$}
\DisplayProof
\end{center}

\[ J(a, x p \Delta.\,D, \Delta.\,d, a, \refl(a)) = d \]

We also assume that the indexed theory has $J$ operator:

\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash a : A$
\noLine
\UnaryInf$\fCenter \Gamma \vdash a' : A$
\noLine
\UnaryInf$\fCenter \Gamma \vdash t : \Id_A(a,a')$
\Axiom$\fCenter \Gamma, x : A, p : \Id_A(a,x), \Delta \mid \cdot \vdash D\ \ob$
\noLine
\UnaryInf$\fCenter \Gamma, \Delta[a/x,\refl(a)/p] | E[a/x,\refl(a)/p] \vdash d : D$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma, \Delta[a'/x,t/p] | E[a'/x,t/p] \vdash J(a, x p \Delta.\,D, \Delta E.\,d, a', t) : D[a'/x,t/p]$}
\DisplayProof
\end{center}

\[ J(a, x p \Delta.\,D, \Delta E.\,d, a, \refl(a)) = d \]

We will sometimes omit the type in the notation $\Id_A(a,a')$.
The fact that the type $\Id(a,a')$ is inhabited will be denoted by $a \sim a'$.
If $\Gamma \vdash p : \Id_A(a,a')$, $\Gamma, x : A \vdash B\ \type$, and $\Gamma \vdash b : B[a/x]$, then we will write $\Gamma \vdash p_*(b) : B[a'/x]$ for the usual transport operation defined in terms of $J$.
Operation $\pmap$ is defined in terms of $J$ and has the following type:
if $\Gamma \vdash B\ \type$, $\Gamma, x : A \vdash b : B$, and $\Gamma \vdash p : \Id_A(a,a')$, then $\Gamma \vdash \pmap(x.b, p) : \Id_B(b[a/x],b[a'/x])$.

An indexed type theory is \emph{locally small} if there is a type of its morphisms.
That is, it must contain the following rules and equations:
\begin{center}
\AxiomC{$\Gamma \mid \cdot \vdash A\ \ob$}
\AxiomC{$\Gamma \mid \cdot \vdash B\ \ob$}
\BinaryInfC{$\Gamma \vdash \Hom(A,B)\ \type$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid x : A \vdash b : B$}
\UnaryInfC{$\Gamma \vdash \lambda x.\,b : \Hom(A,B)$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \vdash f : \Hom(A,B)$}
\AxiomC{$\Gamma \mid \Delta \vdash a : A$}
\BinaryInfC{$\Gamma \mid \Delta \vdash f\,a : B$}
\DisplayProof
\end{center}

\begin{align*}
(\lambda x.\,b)\,a & = b[a/x] \\
\lambda x.\,f\,x & = f
\end{align*}

We might also use notation $A \to B$ for $\Hom(A,B)$, but we prefer the latter notation since the former may be confusing.
Indeed, $A \to B$ might also denote the indexed type of functions if the indexed theory is Cartesian closed or the base type of function if $A$ and $B$ are base types.

If the indexed theory is locally small, then indexed types must carry the structure of an $\infty$-category.
We cannot construct this structure internally due to coherence issues, but we can at least construct lower levels of this structure.
Morphisms between indexed types $A$ and $B$ are terms of type $\Hom(A,B)$.
The identity morphism $\id_A$ on an indexed type $A$ is $\lambda x.\,x : \Hom(A,A)$.
Composition of morphisms $f : \Hom(A,B)$ and $g : \Hom(B,C)$ is defined as $\lambda x.\,g\,(f\,x) : \Hom(A,C)$ and denoted by $g \circ f$.
Composition is strictly associative and identity morphisms are strictly unital.

If $f,g : \Hom(A,B)$ are morphisms, then a 2-morphism between them is a term $p : \Id_{\Hom(A,B)}(f,g)$.
Vertical composition $p \ct q$ of 2-morphisms $p$ and $q$ is defined as the usual operation of path concatenation.
The identity 2-morphism on $f : \Hom(A,B)$ is $\refl(f)$.
Vertical composition is associative, identity 2-morphisms are unital, and every 2-morphism is invertible.
These facts are true in a weak sense, that is up to a 3-morphism.
Let $f,g : \Hom(A,B)$ and $h,i : \Hom(B,C)$ be morphisms and let $p : \Id_{\Hom(A,B)}(f,g)$ and $q : \Id_{\Hom(B,C)}(h,i)$ be 2-morphisms.
The horizontal composition of $p$ and $q$ is a term $p * q$ of type $\Id_{\Hom(A,C)}(\lambda x.\,h\,(f\,x), \lambda x.\,i\,(g\,x))$.
To define $p * q$, we just need to eliminate $p$ and $q$ and then define $\refl(f) * \refl(h)$ as $\refl(\lambda x.\,h\,(f\,x))$.
It is easy to prove that usual properties of this operation hold.

\begin{defn}
An equivalence between indexed types $A$ and $B$ is a morphism $f : \Hom(A,B)$ such that there is a morphism $g : \Hom(B,A)$ such that $g \circ f \sim \id_A$ and $f \circ g \sim \id_B$.
\end{defn}

If the indexed theory is locally small, then not only base morphisms act on indexed types and terms, but also homotopies between them.
Let $\Gamma \vdash a : A$ and $\Gamma \vdash a' : A$ be two base terms.
If $\Gamma, x : A \mid \cdot \vdash B\ \ob$ be an indexed type, then we have indexed types $\Gamma \mid \cdot \vdash B[a]\ \ob$ and $\Gamma \mid \cdot \vdash B[a']\ \ob$.
Let $\Gamma \vdash h : \Id_A(a,a')$ be homotopy between $a$ and $a'$.
Then we can construct an equivalence between $B[a]$ and $B[a']$.
A map $f$ from $B[a]$ to $B[a']$ is defined as $\lambda y.\,J(a, x p.\,B, y.\,y, a', h)$.
A map $g$ from $B[a']$ to $B[a]$ is constructed similarly: $\lambda y.\,J(a', x p.\,B, y.\,y, a, \sym(h))$.
To prove that $g \circ f$ and $f \circ g$ are homotopic to identity morphisms, it is enough to eliminate $h$ using $J$ and then both $g \circ f$ and $f \circ g$ become identity morphisms.

\section{Equivalences}

In this section, we define types that express the property of a map $f : \Hom(A,B)$ of being an equivalence and prove that they are equivalent.
We also prove a few simple properties of equivalences.
These questions were studied in \cite[Section~4]{hottbook} for ordinary homotopy type theory.
Most of the theorems in this section also hold in the framework of indexed unary type theories, but the proofs must be modified.

\subsection{Bi-invertible maps}

Let $f : \Hom(A,B)$ be a morphism.
We will say that $f$ is \emph{bi-invertible} if the following type is inhabited:
\[ \fs{biinv}(f) = \fs{linv}(f) \times \fs{rinv}(f), \]
where $\fs{linv}(f)$ and $\fs{rinv}(f)$ are types of left and right inverses of $f$, respectively:
\begin{align*}
\fs{linv}(f) & = \sum_{g : \Hom(B,A)} \Id(g \circ f, \id_A) \\
\fs{rinv}(f) & = \sum_{g : \Hom(B,A)} \Id(f \circ g, \id_B)
\end{align*}

\begin{prop}[biinv-equiv]
A map is bi-invertible if and only if it is an equivalence.
\end{prop}
\begin{proof}
Obviously, if a map is an equivalence, then it is bi-invertible.
Let us prove the converse.
Let $g : \Hom(B,A)$, $p : \Id(g \circ f, \id_A)$ be a left inverse of $f$ and let $g' : \Hom(B,A)$, $p' : \Id(f \circ g', \id_B)$ be a right inverse of $f$.
Then $\refl(g') * p : \Id(g \circ f \circ g', g')$.
Since $f \circ g' \sim \id_B$, there is a term of type $\Id(g,g')$.
It follows that $g$ is an inverse of $f$.
\end{proof}

\begin{lem}[lrinv-contr]
If $f$ is an equivalence, then types $\fs{linv}(f)$ and $\fs{rinv}(f)$ are contractible.
\end{lem}
\begin{proof}
If $f$ is an equivalence, then precomposition with $f$ is an equivalence between types $\Hom(B,C)$ and $\Hom(A,C)$.
Similarly, postcomposition with $f$ is an equivalence between types $\Hom(C,A)$ and $\Hom(C,B)$.
Since $\fs{linv}(f)$ and $\fs{rinv}(f)$ are fibres of these maps over the identity morphisms, \cite[Theorem~4.2.3]{hottbook} and \cite[Theorem~4.2.6]{hottbook} imply that these types are contractible.
Note that the proofs of these theorems work even if we do not have $\Pi$-types.
\end{proof}

\begin{prop}
The type $\fs{biinv}(f)$ is a proposition.
\end{prop}
\begin{proof}
This follows from \rprop{biinv-equiv} and \rlem{lrinv-contr}.
\end{proof}

\subsection{Half adjoint equivalences}

Let $f : \Hom(A,B)$ be a morphism.
We will say that $f$ is a \emph{half adjoint equivalnce} if the following type is inhabited:
\[ \fs{ishae}(f) = \sum_{g : \Hom(B,A)} \sum_{\eta : \Id(g \circ f, \id_A)} \sum_{\epsilon : \Id(f \circ g, \id_B)} \Id(\eta * \refl(f), \refl(f) * \epsilon). \]

\begin{prop}
A map is a half adjoint equivalence if and only if it is an equivalence.
\end{prop}
\begin{proof}
Obviously, if a map is a half adjoint equivalence, then it is an equivalence.
Let us prove the converse.
Let $g : \Hom(B,A)$, $\eta : \Id(g \circ f, \id_A)$, $\epsilon : \Id(f \circ g, \id_B)$ be an inverse of $f$.
Then we define $\epsilon' : \Id(f \circ g, \id_B)$ as concatenation of paths
$\refl(f \circ g) * \sym(\epsilon) : \Id(f \circ g, f \circ g \circ f \circ g)$, $\refl(g) * \eta * \refl(f) : \Id(f \circ g \circ f \circ g, f \circ g)$, and $\epsilon : \Id(f \circ g, \id_B)$.
We need to prove that $\refl(f) * \epsilon' \sim \eta * \refl(f)$.

First, note that $\eta * \refl(g \circ f) \sim \refl(g \circ f) * \eta$.
Indeed, $(\eta * \refl(g \circ f)) \ct \eta \sim \eta * \eta \sim (\refl(g \circ f) * \eta) \ct \eta$.
Thus, if we cancel $\eta$, this gives us a homotopy between the original paths.
Now, we can finish the proof:
\begin{align*}
\refl(f) * \epsilon' & \sim \\
(\refl(f \circ g \circ f) * \sym(\epsilon)) \ct (\refl(g \circ f) * \eta * \refl(f)) \ct (\refl(f) * \epsilon) & \sim \\
(\refl(f \circ g \circ f) * \sym(\epsilon)) \ct (\eta * \refl(f \circ g \circ f)) \ct (\refl(f) * \epsilon) & \sim \\
(\eta * \refl(f) * \sym(\epsilon)) \ct (\refl(f) * \epsilon) & \sim \\
(\eta * \refl(f)) \ct (\refl(f) * \sym(\epsilon)) \ct (\refl(f) * \epsilon) & \sim \\
\eta * \refl(f) & .
\end{align*}
\end{proof}

\begin{prop}
The type $\fs{ishae}(f)$ is a proposition.
\end{prop}
\begin{proof}
We can assume that $f$ is an equivalence and prove that $\fs{ishae}(f)$ is contractible.
By \rlem{lrinv-contr}, the type $\Sigma_{g : \Hom(B,A)} \Id(g \circ f, \id_A)$ is contractible.
Thus, we just need to prove that, for every $g : \Hom(B,A)$ and $\eta : \Id(g \circ f, \id_A)$, the type $\Sigma_{\epsilon : \Id(f \circ g, \id_B)} \Id(\eta * \refl(f), \refl(f) * \epsilon)$ is also contractible.

Since $f$ is an equivalence, the function $\refl(f) * -$ is also an equivalence.
It follows that the type $\Id(\eta * \refl(f), \refl(f) * \epsilon)$ is equivalent to the type $\Id(h(\eta * \refl(f)), \epsilon)$, where $h$ is the inverse of $\refl(f) * -$.
Thus, the type $\Sigma_{\epsilon : \Id(f \circ g, \id_B)} \Id(\eta * \refl(f), \refl(f) * \epsilon)$ is equivalent to the type $\Sigma_{\epsilon : \Id(f \circ g, \id_B)} \Id(h(\eta * \refl(f)), \epsilon)$, which is contractible by \cite[Lemma~3.11.8]{hottbook}.
\end{proof}

\subsection{Properties of equivalences}

\begin{prop}
Equivalences satisfy the 2-out-of-6 property.
That is, if $f : \Hom(A,B)$, $g : \Hom(B,C)$, and $h : \Hom(C,D)$ are maps such that $g \circ f$ and $h \circ g$ are equivalences, then so are the maps $f$, $g$, $h$, and $h \circ g \circ f$.
\end{prop}
\begin{proof}
Let $i : \Hom(C,A)$ be an inverse of $g \circ f$ and let $k : \Hom(D,B)$ be an inverse of $h \circ g$.
Since $g \circ f \circ i \sim \id_C$ and $h \circ g \circ k \sim \id_D$, \rprop{biinv-equiv} implies that $g$ is an equivalence.
The map $i \circ g$ is an inverse of $f$.
Indeed, $i \circ g \circ f \sim \id_A$ since $i$ is an inverse of $g \circ f$.
Since $g \circ f \circ i \sim \id_C$, it follows that $g \circ f \circ i \circ g \sim g$.
Since $g$ is an equivalence, this implies that $f \circ i \circ g \sim \id_B$.
Similarly, $g \circ k$ is an inverse of $h$.
The map $h \circ g \circ f$ is an equivalence since equivalences are closed under composition.
\end{proof}

A map $f : \Hom(A,B)$ is a \emph{quasi-retract} of a map $g : \Hom(C,D)$ if there is a commutative diagram of the form
\[ \xymatrix{ A \ar[r]^i \ar[d]_f & C \ar[r]^j \ar[d]_g & A \ar[d]_f \\
              B \ar[r]_k          & D \ar[r]_m          & B
            } \]
such that $j \circ i \sim \id_A$ and $m \circ k \sim \id_B$.

\begin{prop}
Equivalences are closed under quasi-retracts.
\end{prop}
\begin{proof}
Let $f : \Hom(A,B)$ be a retract of $g : \Hom(C,D)$ and let $i,j,k,m$ be maps as in the diagram above.
Let $h : \Hom(D,C)$ be an inverse of $g$.
Then $j \circ h \circ k$ is an inverse of $f$.
Indeed, $j \circ h \circ k \circ f \sim j \circ h \circ g \circ i \sim j \circ \id_C \circ i = j \circ i \sim \id_B$ and
$f \circ j \circ h \circ k \sim m \circ g \circ h \circ k \sim m \circ \id_D \circ k = m \circ k \sim \id_B$.
\end{proof}

\section{Limits and colimits}

In this section, we will work in a locally small indexed unary type theory.
We will define specific finite (co)limits and arbitrary (co)products.

\subsection{Finite (co)limits}

An indexed type $T$ is \emph{terminal} if, for every indexed type $X$, the type $\Hom(X,T)$ is contractible.
Dually, an indexed type $T$ is \emph{initial} if, for every indexed type $X$, the type $\Hom(T,X)$ is contractible.
Terminal and initial types are unique up to unique equivalence, that is the type of equivalences between a pair of terminal or initial types is contractible.
We will say that an indexed unary type theory \emph{has terminal (resp., initial) types} if, for every context $\Gamma$, there is a terminal (resp., initial) type $\Gamma \mid \cdot \vdash T\ \ob$.

A \emph{binary product} of indexed types $A$ and $B$ is an indexed type $A \times B$ together with a pair of maps $\pi_1 : \Hom(A \times B, A)$ and $\pi_2 : \Hom(A \times B, B)$
such that, for every triple $C$, $f : \Hom(C,A)$, $g : \Hom(C,B)$, the type
\[ \sum_{h : \Hom(C, A \times B)} \Id(\pi_1 \circ h, f) \times \Id(\pi_2 \circ h, g) \]
is contractible.
An indexed unary type theory \emph{has binary products} if a binary product exists for every pair of types in every context.
\emph{Binary coproducts} are defined dually.
Binary products and binary coproducts are unique up to unique equivalence.

An \emph{equalizer} of a pair of maps $f,g : \Hom(A,B)$ is a map $e : \Hom(E,A)$ together with a homotopy $p : \Id(f \circ e, g \circ e)$
such that, for all $e' : \Hom(E',A)$ and $p' : \Id(f \circ e', g \circ e')$, the following type is contractible:
\[ \sum_{h : \Hom(E',E)} \sum_{q : \Id(e', e \circ h)} \Id(q_*(p'), \pmap(x.\,x \circ h, p)). \]
An indexed unary type theory \emph{has equalizers} if an equalizer exists for every parallel pair of maps in every context.
\emph{Coequalizers} are defined dually.
Equalizers and coequalizers are unique up to unique equivalence.

A \emph{pullback} of a pair of maps $f : \Hom(A,C)$ and $g : \Hom(B,C)$ is a triple $h : \Hom(P,A)$, $k : \Hom(P,B)$, $p : \Id(f \circ h, g \circ k)$
such that, for every triple $h' : \Hom(P',A)$, $k' : \Hom(P',B)$, $p' : \Id(f \circ h', g \circ k')$, the following type is contractible:
\[ \sum_{i : \Hom(P',P)} \sum_{q : \Id(h', h \circ i)} \sum_{r : \Id(k \circ i, k')} \Id((q * \refl(f)) \ct (\refl(i) * p) \ct (r * \refl(g)), p'). \]
An indexed unary type theory \emph{has pullbacks} if a pullback exists for every pair of maps with a common codomain in every context.
\emph{Pushouts} are defined dually.
Pullbacks and pushouts are unique up to unique equivalence.

\begin{prop}[fin-lim]
An indexed unary type theory with terminal types has pullbacks if and only if it has equalizers and binary products.
\end{prop}

We omit the proof of this proposition since the basic idea is the same as in ordinary category theory, but actual details are very technical and messy.

\begin{defn}[fin-lim]
An indexed unary type theory \emph{has finite limits} if equivalent conditions of \rprop{fin-lim} hold.
\end{defn}

The theory of terminal types is defined as follows:
\begin{center}
\AxiomC{}
\UnaryInfC{$\Gamma \mid \cdot \vdash \top\ \ob$}
\DisplayProof
\qquad
\AxiomC{}
\UnaryInfC{$\Gamma \mid \Delta \vdash \fs{tt} : \top$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid x : A \vdash b : \top$}
\UnaryInfC{$\Gamma \vdash \top\text{-}\fs{uni}(A, x.\,b) : \Id(\lambda x.\,b, \lambda x.\,tt)$}
\DisplayProof
\end{center}

An indexed unary type theory has terminal types if and only if the theory of terminal types can be interpreted in it.
Theories of products, equalizers, and pullbacks are defined similarly.

\subsection{(Co)products}

In this subsection, we assume that the base theory has extensional $\Pi$-types.

A \emph{product} of an indexed type $\Gamma, i : I \mid \cdot \vdash B\ \ob$ is an indexed type $\Gamma \mid \cdot \vdash P\ \ob$ together with a term $\Gamma \vdash \pi : \Pi_{i : I} \Hom(P,B)$
such that, for all $\Gamma \mid \cdot \vdash P'\ \ob$ and $\Gamma \vdash \pi' : \Pi_{i : I} \Hom(P',B)$, the following type is contractible:
\[ \sum_{h : \Hom(P',P)} \prod_{i : I} \Id(\pi i \circ h, \pi' i). \]

If $\Gamma \mid \cdot \vdash P\ \ob$ is an indexed type and $\Gamma \vdash \pi : \Pi_{i : I} \Hom(P,B)$ is a term, then we can define the following function for every indexed type $\Gamma \mid \cdot \vdash P'$:
\[ \lambda h i.\,\pi i \circ h : \Hom(P',P) \to \prod_{i : I} \Hom(P',B). \]
Note that the type that appears in the definition of products is (equivalent to) the fiber of this function over $\pi'$.
Thus, a pair $(P,\pi)$ is a product if and only if this function is an equivalence.
This implies that $\Hom(P',-)$ preserves products.

The theory of coproducts is defined dually.
A \emph{coproduct} of an indexed type $\Gamma, i : I \mid \cdot \vdash B\ \ob$ is an indexed type $\Gamma \mid \cdot \vdash P\ \ob$ together with a term $\Gamma \vdash \fs{in} : \Pi_{i : I} \Hom(B,P)$
such that, for all $\Gamma \mid \cdot \vdash P'\ \ob$ and $\Gamma \vdash \fs{in}' : \Pi_{i : I} \Hom(B,P')$, the following type is contractible:
\[ \sum_{h : \Hom(P,P')} \prod_{i : I} \Id(h \circ \fs{in}(i), \fs{in}'(i)). \]
A pair $(P,\fs{in})$ is a coproduct if and only if the following function is an equivalence for every indexed type $P'$:
\[ \lambda h i.\,h \circ \fs{in}(i) : \Hom(P,P') \to \prod_{i : I} \Hom(B,P'). \]

Products and coproducts are unique up to unique equivalence.
We will denote the product and the coproduct of a family $\Gamma, i : I \mid \cdot \vdash B\ \type$ by $\prod_{i : I} B$ and $\coprod_{i : I} B$, respectively.

We can also define the theory of \emph{strict products}:
\begin{center}
\AxiomC{$\Gamma, i : I \mid \cdot \vdash B\ \ob$}
\UnaryInfC{$\Gamma \mid \cdot \vdash \prod_{i : I} B\ \ob$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \cdot \vdash A\ \ob$}
\AxiomC{$\Gamma, i : I \mid x : A \vdash b : B$}
\BinaryInfC{$\Gamma \mid x : A \vdash \lambda i.\,b : \prod_{i : I} B$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash f : \prod_{i : I} B$}
\AxiomC{$\Gamma \vdash j : I$}
\BinaryInfC{$\Gamma \mid \Delta \vdash f\,j : B[j/i]$}
\DisplayProof
\end{center}

\begin{align*}
(\lambda i.\,b)\,j & = b[j/i] \\
\lambda i.\,f\,i & = f
\end{align*}

The difference between weak and strict products is that the former requires types $\Hom(P',\Pi_{i : I} B)$ and $\Pi_{i : I} \Hom(P',B)$ to be equivalent while the latter requires them to be \emph{isomorphic}.
Of course, the theory of products can be interpreted in the theory of strict products, but not the other way around.
Nevertherless, these theories should be weakly equivalent.

% 3. Disjoint coproducts / эквивалентные определения extensive category.
% 4. Определить (pre)descent condition для них.
% 5. (Локальная) декартовая замкнутость.
% 6. Определить условие well-powered (B1.3:1.3.14).
% 7. Вселенная Prop, ее связь с условием well-powered и прочие вселенные.
% 8. Определить индексированные теории зависимых типов.
% 9. Определить (pre)descent для Id, юнит-типов и сигм.
% 10. Доказать, что в них есть конечные произведение и бесконечные тоже, если предположить их должны образом.
% 11. Записать про коммутирование Id и Sigma с Hom справа.
% 12. Упомянуть, что копределы могут быть и не стабильны относительно подстановок.
% 13. Сказать про связные объекты.
% 14. (Pre)descent condition и большие элиминаторы.
% 15. Сравнить внешнее и внутренее определение копределов.
% 16. Regular categories and propositional truncation?

\bibliographystyle{amsplain}
\bibliography{ref}

\end{document}
