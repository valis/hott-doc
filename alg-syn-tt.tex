\documentclass[reqno]{amsart}

\usepackage{amssymb}
\usepackage{hyperref}
\usepackage{mathtools}
\usepackage[all]{xy}
\usepackage{verbatim}
\usepackage{ifthen}
\usepackage{xargs}
\usepackage{bussproofs}
\usepackage{turnstile}
\usepackage{todonotes}
\usepackage{etex}

\hypersetup{colorlinks=true,linkcolor=blue}

\renewcommand{\turnstile}[6][s]
    {\ifthenelse{\equal{#1}{d}}
        {\sbox{\first}{$\displaystyle{#4}$}
        \sbox{\second}{$\displaystyle{#5}$}}{}
    \ifthenelse{\equal{#1}{t}}
        {\sbox{\first}{$\textstyle{#4}$}
        \sbox{\second}{$\textstyle{#5}$}}{}
    \ifthenelse{\equal{#1}{s}}
        {\sbox{\first}{$\scriptstyle{#4}$}
        \sbox{\second}{$\scriptstyle{#5}$}}{}
    \ifthenelse{\equal{#1}{ss}}
        {\sbox{\first}{$\scriptscriptstyle{#4}$}
        \sbox{\second}{$\scriptscriptstyle{#5}$}}{}
    \setlength{\dashthickness}{0.111ex}
    \setlength{\ddashthickness}{0.35ex}
    \setlength{\leasturnstilewidth}{2em}
    \setlength{\extrawidth}{0.2em}
    \ifthenelse{%
      \equal{#3}{n}}{\setlength{\tinyverdistance}{0ex}}{}
    \ifthenelse{%
      \equal{#3}{s}}{\setlength{\tinyverdistance}{0.5\dashthickness}}{}
    \ifthenelse{%
      \equal{#3}{d}}{\setlength{\tinyverdistance}{0.5\ddashthickness}
        \addtolength{\tinyverdistance}{\dashthickness}}{}
    \ifthenelse{%
      \equal{#3}{t}}{\setlength{\tinyverdistance}{1.5\dashthickness}
        \addtolength{\tinyverdistance}{\ddashthickness}}{}
        \setlength{\verdistance}{0.4ex}
        \settoheight{\lengthvar}{\usebox{\first}}
        \setlength{\raisedown}{-\lengthvar}
        \addtolength{\raisedown}{-\tinyverdistance}
        \addtolength{\raisedown}{-\verdistance}
        \settodepth{\raiseup}{\usebox{\second}}
        \addtolength{\raiseup}{\tinyverdistance}
        \addtolength{\raiseup}{\verdistance}
        \setlength{\lift}{0.8ex}
        \settowidth{\firstwidth}{\usebox{\first}}
        \settowidth{\secondwidth}{\usebox{\second}}
        \ifthenelse{\lengthtest{\firstwidth = 0ex}
            \and
            \lengthtest{\secondwidth = 0ex}}
                {\setlength{\turnstilewidth}{\leasturnstilewidth}}
                {\setlength{\turnstilewidth}{2\extrawidth}
        \ifthenelse{\lengthtest{\firstwidth < \secondwidth}}
            {\addtolength{\turnstilewidth}{\secondwidth}}
            {\addtolength{\turnstilewidth}{\firstwidth}}}
        \ifthenelse{\lengthtest{\turnstilewidth < \leasturnstilewidth}}{\setlength{\turnstilewidth}{\leasturnstilewidth}}{}
    \setlength{\turnstileheight}{1.5ex}
    \sbox{\turnstilebox}
    {\raisebox{\lift}{\ensuremath{
        \makever{#2}{\dashthickness}{\turnstileheight}{\ddashthickness}
        \makehor{#3}{\dashthickness}{\turnstilewidth}{\ddashthickness}
        \hspace{-\turnstilewidth}
        \raisebox{\raisedown}
        {\makebox[\turnstilewidth]{\usebox{\first}}}
            \hspace{-\turnstilewidth}
            \raisebox{\raiseup}
            {\makebox[\turnstilewidth]{\usebox{\second}}}
        \makever{#6}{\dashthickness}{\turnstileheight}{\ddashthickness}}}}
        \mathrel{\usebox{\turnstilebox}}}

% \providecommand\WarningsAreErrors{false}
% \ifthenelse{\equal{\WarningsAreErrors}{true}}{\renewcommand{\GenericWarning}[2]{\GenericError{#1}{#2}{}{This warning has been turned into a fatal error.}}}{}

\newcommand{\axlabel}[1]{(#1) \phantomsection \label{ax:#1}}
\newcommand{\axtag}[1]{\label{ax:#1} \tag{#1}}
\newcommand{\axref}[1]{(\hyperref[ax:#1]{#1})}

\newcommand{\newref}[4][]{
\ifthenelse{\equal{#1}{}}{\newtheorem{h#2}[hthm]{#4}}{\newtheorem{h#2}{#4}[#1]}
\expandafter\newcommand\csname r#2\endcsname[1]{#3~\ref{#2:##1}}
\expandafter\newcommand\csname R#2\endcsname[1]{#4~\ref{#2:##1}}
\expandafter\newcommand\csname n#2\endcsname[1]{\ref{#2:##1}}
\newenvironmentx{#2}[2][1=,2=]{
\ifthenelse{\equal{##2}{}}{\begin{h#2}}{\begin{h#2}[##2]}
\ifthenelse{\equal{##1}{}}{}{\label{#2:##1}}
}{\end{h#2}}
}

\newref[section]{thm}{theorem}{Theorem}
\newref{lem}{lemma}{Lemma}
\newref{prop}{proposition}{Proposition}
\newref{cor}{corollary}{Corollary}

\theoremstyle{definition}
\newref{defn}{definition}{Definition}
\newref{example}{example}{Example}

\theoremstyle{remark}
\newref{remark}{remark}{Remark}

\newcommand{\red}{\Rightarrow}
\newcommand{\deq}{\equiv}
\renewcommand{\ll}{\llbracket}
\newcommand{\rr}{\rrbracket}
\newcommand{\cat}[1]{\mathbf{#1}}
\newcommand{\C}{\cat{C}}
\newcommand{\D}{\cat{D}}
\newcommand{\Set}{\cat{Set}}
\newcommand{\ccat}{\cat{CCat}}
\newcommand{\syntt}{\cat{SynTT}}
\newcommand{\algtt}{\cat{AlgTT}}
\newcommand{\PStr}[1]{#1\text{-}\cat{PStr}}
\newcommand{\Mod}[1]{#1\text{-}\cat{Mod}}
\newcommand{\Sig}{\cat{Sig}}
\newcommand{\Th}{\cat{Th}}
\newcommand{\CTh}{\cat{CTh}}
\newcommand{\woCTh}{\cat{CTh_{wo}}}
\newcommand{\ThC}{\Th_{\mathcal{C}}}
\newcommand{\ThT}{\Th_{\mathcal{T}}}
\newcommand{\ttvdash}{\vartriangleright}

\numberwithin{figure}{section}

\newcommand{\pb}[1][dr]{\save*!/#1-1.2pc/#1:(-1,1)@^{|-}\restore}
\newcommand{\po}[1][dr]{\save*!/#1+1.2pc/#1:(1,-1)@^{|-}\restore}

\begin{document}

\title{Algebraic Presentations of Dependent Type Theories}

\author{Valery Isaev}

\begin{abstract}
In this paper, we propose an abstract definition of dependent type theories as esentially algebraic theories.
One of the main advantages of this definition is its composability: simple theories can be combined into more complex ones,
and different properties of the resulting theory may be deduced from properties of the basic ones.
We define a category of algebraic type theories which allows us not only to combine theories but also to consider equivalences between them.
We also study models of such theories in general and initial models in particular.
\end{abstract}

\maketitle

 \makeatletter
    \providecommand\@dotsep{5}
  \makeatother
  \listoftodos\relax

\section{Introduction}

Type theories with dependent types originally were defined by Per Martin-L\"{o}f, who introduced several versions of the system \cite{MLTT72,MLTT73,MLTT79}.
There were also several theories and extensions of Martin-L\"{o}f's theory proposed by different authors (\cite{CoC,luo94} to name a few).
These theories may have different inference rules, different computation rules, and different constructions.
Many of these theories have common parts and similar properties,
but the problem is that there is no general definition of a type theory such that all of these theories would be a special case of this definition,
so that their properties could be studied in general and applied to specific theory when necessary.
In this paper we propose such a definition based on the notition of esentially algebraic theories.

Another problem of the usual way of defining type theories is that they are not composable.
Some constructions in type theories are independent of each other (such as $\Pi$, $\Sigma$, and $Id$ types),
and others may dependent on other constructions (such as universes),
so we could hope that we can study these constructions independently (at least if they are of the first kind)
and deduce properties of combined theory from the properties of these basic constructions.
But this is not the way it is usually done.
For example, constructing models of dependent type theories is a difficult task because of the so called coherence problem.
There are several proposed solutions to this problems, but the question we are interested in is how to combine them.
Often only the categorical side of the question is considered,
but some authors do consider specific theories \cite{streicher,pitts},
and the problem in this case is that their work cannot be applied to other similar theories (at least formally).

When defining a type theory there are certain questions to be addressed regarding syntactic traits of the theory.
One such question is how many arguments to different construction can be omitted and how to restore them when constructing a model of the theory.
For example, we want to define application as a function of two arguments $app(f,a)$, but sometimes it is convenient to have additional arguments which allows to infer a type of $f$.
It is posible to prove that additional information in the application term may be omitted (for example, see \cite{streicher}), but it is a nontrivial task.
Another question of this sort is whether we should use a typed or an untyped equality.
Typed equality is easier to handle when defining a model of the theory, but untyped is closer to actual implementation of the language.
Algebraic approach allows us to separate these syntactic details from essential aspects of the theory.

Yet another problem is that some constructions may be defined in several different ways.
For example, $\Sigma$ types can be defined using projections (\rexample{sigma-eta}) and using an eliminator (\rexample{sigma-no-eta}).
The question then is whether these definitions are equivalent in some sense.
The difficulty of this question stems from the fact that some equivalences may hold in one definition judgementally, but in the other only propositionally;
so it may be difficult (or impossible) to construct a map from the first version of the definition to the second one.

In this paper, using the formalism of essentially algebraic theories, we introduce the notion of
\emph{algebraic type theories} which provide a possible solution the problems described above.
We define a category of algebraic type theories.
Coproducts and more generally colimits in this category allow us to combine simple theories into more complex ones.
For example, the theory with $\Sigma$, $\Pi$ and $Id$ types may be described as coproduct $T_\Sigma \amalg T_\Pi \amalg T_{Id}$
where $T_\Sigma$, $T_\Pi$ and $T_{Id}$ are theories of $\Sigma$, $\Pi$ and $Id$ types respectively.
Another example is a theory of a universe which can be defined as a certain pushout (see \rexample{universe}).

There is a natural notion of a model of an essentially algebraic theory.
Thus the algebraic approach to defining type theories automatically equips every type theory with a (locally presentable) category of its models.
We will show that models of the initial theory are precisely contextual categories,
and that models of an arbitrary theory are contextual categories with an additional structure (which depends on the theory).

Since we have a category of type theories, there is a natural notion of equivalence between them, namely the isomorphism.
In most cases this equivalence is too strong, so it is necessary to consider weaker notions of equivalence, but in some cases it might be useful.
For example, if two theories differ only by the amount of arguments to some of the constructions,
then they are isomorphic (assuming omitted arguments can be inferred from the rest).

We also define a \emph{contextual} version of algebraic type theories which generalizes the usual one.
It has more concise syntax, and hence it is more convenient to work with.
The drawback of this approach is that it is less straightforward to define a notion of a model of such theories.
Finally, we introduce a concept of a \emph{regular} theory which formalize the idea that usually in a type theory constructions are available in all contexts.

The paper is organized as follows.
\todo{Finish the introduction}

\begin{comment}
\section{Contextual categories}

Contextual categories were defined by Cartmell \cite{GAT}.
An equivalent definition was given by Voevodsky in \cite{c-systems}.
In this section we will give another equivalent definition which is just a description of models of the initial algebraic type theory as we will see later.
\end{comment}

\section{Partial Horn theories}

There are several equivalent ways of defining essentially algebraic theories (\cite{LPC}, \cite{GAT}, \cite{PHL}, \cite[D 1.3.4]{elephant}).
We will use approach introduced in \cite{PHL} under the name of partial horn theories since it seems to be the most general.
In this section we will review necessary for our development parts of the theory of partial horn theories and define a notion of morphisms between them suitable for our purposes.
We will also define algebraic type theories as certain partial horn theories.

\subsection{The category of signatures}

A signature $\Sigma = (\mathcal{S}, \mathcal{F}, \mathcal{P})$ consists of a set $\mathcal{S}$ of sorts, a set $\mathcal{F}$ of function symbols, and a set $\mathcal{P}$ of predicate symbols.
Also $\Sigma$ assigns a signature to each $\sigma \in \mathcal{F}$ which is written as $\sigma : s_1 \times \ldots \times s_n \to s$ where $s_1$, \ldots $s_n$, $s$ are sorts.
Finally $\Sigma$ assigns a signature to each $R \in \mathcal{P}$ which is written as $R : s_1 \times \ldots \times s_n$ where $s_1$, \ldots $s_n$ are sorts.
For each $V \in \Set^\mathcal{S}$ we can define a set $Term_\mathcal{F}(V)_s$ of terms of sort $s$ inductively:
\begin{itemize}
\item If $x \in V_s$, then $x \in Term_\mathcal{F}(V)_s$.
\item If $\sigma : s_1 \times \ldots \times s_n \to s$ and $t_i \in Term_\mathcal{F}(V)_{s_i}$, then $\sigma(t_1, \ldots t_n) \in Term_\mathcal{F}(V)_s$.
\end{itemize}
Then $Term_\mathcal{F}(V)$ is actually a functor $Term_\mathcal{F} : \Set^\mathcal{S} \to \Set^\mathcal{S}$.
If $t \in Term_\mathcal{F}(V)_s$ and $\rho : V \to Term_\mathcal{F}(V')$, then we will write $t[\rho] \in Term_\mathcal{F}(V')_s$
for the substitution of $\rho$ into $t$ which is defined as follows:
\begin{align*}
x[\rho] & = \rho(x) \\
\sigma(a_1, \ldots a_k)[\rho] & = \sigma(a_1[\rho], \ldots a_k[\rho])
\end{align*}

An \emph{atomic formula} over $\Sigma$ with free variables in $V$ is an expression either of the form $t_1 = t_2$, where $t_1, t_2 \in Term_\Sigma(V)_s$ for some sort $s$,
    or of the form $R(t_1, \ldots t_n)$, where $R \in \mathcal{P}$, $R : s_1 \times \ldots \times s_n$ and $t_i \in Term_\Sigma(V)_{s_i}$.
A \emph{Horn formula} over $\Sigma$ with free variables in $V$ is an expression of the form $\varphi_1 \land \ldots \land \varphi_n$ where $\varphi_i$ are atomic formulae.
The set of Horn formulae over $\Sigma$ with free variables in $V$ is denoted by $Form_\Sigma(V)$.
If $n = 0$, then we write such a formula as $\top$.
If $\varphi \in Form_\Sigma(V)$ and $\rho : V \to Term_\mathcal{F}(V')$, then we will write $\varphi[\rho]$ for a formula defined as follows:
\begin{align*}
(t = s)[\rho] & = (t[\rho] = s[\rho]) \\
R(a_1, \ldots a_k)[\rho] & = R(a_1[\rho], \ldots a_k[\rho]) \\
(\varphi_1 \land \ldots \land \varphi_n)[\rho] & = \varphi_1[\rho] \land \ldots \land \varphi_n[\rho]
\end{align*}

Now we introduce a functor $PTerm_\Sigma : \Set^\mathcal{S} \to \Set^\mathcal{S}$ of ``partial terms''.
If an ordinary term represents a function, then a partial term represents a function with its domain restricted to a subset.
We define $PTerm_\Sigma(V)_s$ as the set of expressions $t|_\varphi$ where $t \in Term_\mathcal{F}(V)_s$ and $\varphi \in Form_\Sigma(V)$.
If $\varphi = \top$, then we will write $t|_\varphi$ simply as $t$.
If $p \in PTerm_\Sigma(V)_s$, $p = t|_\varphi$ and $\psi \in Form_\Sigma(V)$, then we will write $p|_\psi$ for $t|_{\varphi \land \psi}$.

For every term, every formula and every partial term we define a sequence $fv$ of its free variables.
Note that unlike the sets $FV$ of free variables these lists are ordered and can contain duplicates.
\begin{align*}
fv(x) & = x \\
fv(\sigma(a_1, \ldots a_k)) & = fv(a_1), \ldots fv(a_k) \\
fv(t = s) & = fv(t), fv(s) \\
fv(R(a_1, \ldots a_k)) & = fv(a_1), \ldots fv(a_k) \\
fv(\varphi_1 \land \ldots \land \varphi_n) & = fv(\varphi_1), \ldots fv(\varphi_n) \\
fv(t|_\varphi) & = fv(t), fv(\varphi)
\end{align*}
If $l = (a_1, \ldots a_k)$, then we will write $\bigwedge_{a \in l} \varphi_a$ for $\varphi_{a_1} \land \ldots \land \varphi_{a_k}$.

Now we define substitution functions for partial terms.
First, for every $t|_\varphi \in PTerm_\Sigma(A)_s$, let $term(t|_\varphi) = t$ and $dom(t|_\varphi) = \varphi$.
Then, for every $\rho : A \to PTerm_\Sigma(B)$, $t \in Term_\mathcal{F}(A)_s$ and $\varphi \in Form_\Sigma(A)$
we define $t[\rho] \in PTerm_\Sigma(B)_s$, $\varphi[\rho] \in Form_\Sigma(B)$ and $t_\varphi[\rho] \in PTerm_\Sigma(B)_s$ as follows:
\begin{align*}
t[\rho] & = t[term \circ \rho]|_{\bigwedge_{a \in fv(t)} dom(\rho(a))} \\
\varphi[\rho] & = \varphi[term \circ \rho] \land \bigwedge_{a \in fv(\varphi)} dom(\rho(a)) \text{ if $\varphi$ is atomic} \\
(\varphi_1 \land \ldots \land \varphi_n)[\rho] & = \varphi_1[\rho] \land \ldots \land \varphi_n[\rho] \\
t|_\varphi[\rho] & = t[\rho]|_{\varphi[\rho]}
\end{align*}

\begin{defn}
Let $\Sigma$ and $\Sigma'$ be a pair of signatures with the same set of sorts $\mathcal{S}$.
A \emph{morphism} of these signatures is a pair $(\alpha,\beta)$ where $\alpha$ assigns to every $V \in \Set^\mathcal{S}$ a morphism $\alpha_V : PTerm_\Sigma(V) \to PTerm_{\Sigma'}(V)$
and $\beta$ assigns to every $V \in \Set^\mathcal{S}$ a morphism $\beta_V : Form_\Sigma(V) \to Form_{\Sigma'}(V)$.
These morphisms must satisfy the following conditions:
\begin{enumerate}
\item For every $t \in PTerm_\Sigma(V)_s$, $FV(\alpha_V(t)) = FV(t)$.
\label{mor-sig-a-fv}
\item For every $\varphi \in Form_\Sigma(V)$, $FV(\beta_V(\varphi)) = FV(\varphi)$.
\label{mor-sig-b-fv}
\item For every $x \in V_s$, $\alpha_V(x|_\top) = x|_\top$.
\label{mor-sig-a-var}
\item For every $t \in PTerm_\Sigma(A)_s$ and $\rho : A \to Term_\Sigma(B)$, $\alpha_B(t[\rho]) = \alpha_A(t)[x \mapsto \alpha_B(\rho(x)|_\top)]$.
\label{mor-sig-a-subst}
\item For every atomic $\varphi \in Form_\Sigma(A)$ and $\rho : A \to Term_\Sigma(B)$, $\beta_B(\varphi[\rho]) = \beta_A(\varphi)[x \mapsto \alpha_B(\rho(x)|_\top)]$.
\label{mor-sig-b-subst}
\item For every $t|_\varphi \in PTerm_\Sigma(V)$, $\alpha_V(t|_\varphi) = \alpha_V(t|_\top)|_{\beta_V(\varphi)}$.
\label{mor-sig-a-op}
\item $\beta_V(\top) = \top$, $\beta_V(\varphi \land \psi) = \beta_V(\varphi) \land \beta_V(\psi)$, and $\beta_V(t = t') = (\alpha_V(t) = \alpha_V(t'))$.
\label{mor-sig-b-op}
\end{enumerate}
The identity and the composition of morphisms are defined in the obvious way.
The category of signatures with $\mathcal{S}$ as the set of sorts is denoted by $\Sig_\mathcal{S}$.
\end{defn}

If $f = (\alpha,\beta)$ is a morphism of signatures $\Sigma$ and $\Sigma'$, $t \in PTerm_\Sigma(V)_s$ and $\varphi \in Form_\Sigma(V)$,
then we will write $f(t)$ for $\alpha_V(t)$ and $f(\varphi)$ for $\beta_V(\varphi)$.

\begin{prop}[mor-def]
To construct a morphism of signatures $\Sigma = (\mathcal{S},\mathcal{F},\mathcal{P})$ and $\Sigma'$ it is enough to specify the following data:
\begin{itemize}
\item For every $\sigma \in \mathcal{F}$, $\sigma : s_1 \times \ldots \times s_n \to s$, a partial term $\alpha(\sigma) \in PTerm_{\Sigma'}(\{ x_1 : s_1, \ldots x_n : s_n \})$ such that $FV(\alpha(\sigma)) = \{ x_1, \ldots x_n \}$.
\item For every $R \in \mathcal{P}$, $R : s_1 \times \ldots \times s_n$, a formula $\beta(R) \in Form_{\Sigma'}(\{ x_1 : s_1, \ldots x_n : s_n \})$ such that $FV(\beta(R)) = \{ x_1, \ldots x_n \}$.
\end{itemize}
Then there is a unique morphism $f$ of these signatures such that $f(\sigma(x_1, \ldots x_n)) = \alpha(\sigma)$ and $f(R(x_1, \ldots x_n)) = \beta(R)$.
\end{prop}
\begin{proof}
First, let us extend $\alpha$ to a morphism $Term_\mathcal{F}(V) \to PTerm_{\Sigma'}(V)$.
By conditions \eqref{mor-sig-a-var} and \eqref{mor-sig-a-subst} it can be done in a unique way:
\begin{align*}
\alpha_V(x) & = x \\
\alpha_V(\sigma(a_1, \ldots a_n)) & = \alpha(\sigma)[x_i \mapsto \alpha_V(a_i)]
\end{align*}
Second, we extend $\beta$ to a morphism $Form_\Sigma(V) \to Form_{\Sigma'}(V)$.
By conditions \eqref{mor-sig-b-subst} and \eqref{mor-sig-b-op} it can be done in a unique way:
\begin{align*}
\beta_V(a = b) & = \alpha_V(a) = \alpha_V(b) \\
\beta_V(R(a_1, \ldots a_n)) & = \beta(R)[x_i \mapsto \alpha_V(a_i)] \\
\beta_V(\varphi_1 \land \ldots \land \varphi_n) & = \beta_V(\varphi_1) \land \ldots \land \beta_V(\varphi_n)
\end{align*}
Now, we can extend $\alpha_V$ to a morphism $PTerm_\Sigma(V) \to PTerm_{\Sigma'}(V)$.
By condition \eqref{mor-sig-a-op} it can be done in a unique way:
\[ \alpha_V(t|_\varphi) = \alpha_V(t)|_{\beta_V(\varphi)} \]

Conditions \eqref{mor-sig-a-fv} and \eqref{mor-sig-b-fv} follows from the conditions on $FV(\alpha(\sigma))$ and $FV(\beta(R))$.
Conditions \eqref{mor-sig-a-var}, \eqref{mor-sig-a-op} and $\eqref{mor-sig-b-op}$ hold by the definitions of $\alpha_V$ and $\beta_V$.
Conditions \eqref{mor-sig-a-subst} and $\eqref{mor-sig-b-subst}$ are easy to check by induction on the term and on the formula respectively.
\end{proof}

\subsection{The category of algebraic theories}

A \emph{Horn sequent} over $\Sigma$ is an expression of the form $\varphi \sststile{}{V} \psi$, where $\varphi$ and $\psi$ are Horn formulae over $\Sigma$ with free variables in $V$.
We will often write $\varphi_1, \ldots \varphi_n \sststile{}{V} \psi_1, \ldots \psi_k$ insted of $\varphi_1 \land \ldots \land \varphi_n \sststile{}{V} \psi_1 \land \ldots \land \psi_k$.
We will use the following abbreviations:
\begin{align*}
t\!\downarrow & \text{ means } t = t \\
\varphi \sststile{}{V} t \leftrightharpoons s & \text{ means } \varphi \land t\!\downarrow \land s\!\downarrow\,\sststile{}{V} t = s \\
\varphi \sststile{}{V} t \cong s & \text{ means } \varphi \land t\!\downarrow\,\sststile{}{V} t = s \text{ and } \varphi \land s\!\downarrow\,\sststile{}{V} t = s \\
\varphi \ssststile{}{V} \psi & \text{ means } \varphi \sststile{}{V} \psi \text{ and } \psi \sststile{}{V} \varphi \\
R(t_1|_{\varphi_1}, \ldots t_n|_{\varphi_n}) & \text{ means } R(t_1, \ldots t_n) \land \varphi_1 \land \ldots \land \varphi_n \\
t|_\varphi = s|_\psi & \text{ means } t = s \land \varphi \land \psi \\
t|_\varphi\!\downarrow & \text{ means } t\!\downarrow\!\land \varphi \\
\chi \sststile{}{V} t|_\varphi \leftrightharpoons s|_\psi & \text{ means } \chi \land t|_\varphi\!\downarrow, s|_\psi\!\downarrow\,\sststile{}{V} t = s \\
\chi \sststile{}{V} t|_\varphi \cong s|_\psi & \text{ means } \chi \land t|_\varphi\!\downarrow\,\sststile{}{V} t = s \land \psi \text{ and } \chi \land s|_\psi\!\downarrow\,\sststile{}{V} t = s \land \varphi
\end{align*}

A \emph{Horn theory} in a signature $\Sigma$ is a set of Horn sequents over $\Sigma$.
The rules of \emph{Partial Horn logic} are listed below.
In these rules for every sequent $\varphi \sststile{}{V} \psi$ the set of variables $V$ is such that $FV(\varphi) \cup FV(\psi) \subseteq V$.
If $\mathcal{A}$ is a Horn theory, then a \emph{theorem} of $\mathcal{A}$ is a sequent derivable from $\mathcal{A}$ in this logic.
\begin{center}
$\varphi \sststile{}{V} \varphi$ \axlabel{b1}
\qquad
\AxiomC{$\varphi \sststile{}{V} \psi$}
\AxiomC{$\psi \sststile{}{V} \chi$}
\RightLabel{\axlabel{b2}}
\BinaryInfC{$\varphi \sststile{}{V} \chi$}
\DisplayProof
\qquad
$\varphi \sststile{}{V} \top$ \axlabel{b3}
\end{center}

\medskip
\begin{center}
$\varphi \land \psi \sststile{}{V} \varphi$ \axlabel{b4}
\qquad
$\varphi \land \psi \sststile{}{V} \psi$ \axlabel{b5}
\qquad
\AxiomC{$\varphi \sststile{}{V} \psi$}
\AxiomC{$\varphi \sststile{}{V} \chi$}
\RightLabel{\axlabel{b6}}
\BinaryInfC{$\varphi \sststile{}{V} \psi \land \chi$}
\DisplayProof
\end{center}

\medskip
\begin{center}
$\sststile{}{x} x\!\downarrow$ \axlabel{a1}
\qquad
$x = y \land \varphi \sststile{}{V} \varphi[y/x]$ \axlabel{a2}
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \psi$}
\RightLabel{, $x \in FV(\varphi)$, $t \in Term_\mathcal{F}(V')$ \axlabel{a3}}
\UnaryInfC{$\varphi[t/x] \sststile{}{V'} \psi[t/x]$}
\DisplayProof
\end{center}
\medskip
Note that this set of rules is equivalent to the one described in \cite{PHL}.
In particular, the following sequents are derivable:
\begin{align*}
R(t_1, \ldots t_k) & \sststile{}{V} t_i\!\downarrow \axtag{a4} \\
t_1 = t_2 & \sststile{}{V} t_i\!\downarrow \axtag{a4'} \\
\sigma(t_1, \ldots t_k)\!\downarrow & \sststile{}{V} t_i\!\downarrow \axtag{a5}
\end{align*}

We will need the following lemmas from \cite{PHL}:
\begin{lem}[cong-a]
For every $u_i,v_i \in Term_\mathcal{F}(V)_{s_i}$, $t \in Term_\mathcal{F}(\{ x_1 : s_1, \ldots x_n : s_n\})_s$
sequents $u_1 = v_1 \land \ldots \land u_n = v_n \sststile{}{V} t[x_i \mapsto u_i] \cong t[x_i \mapsto v_i]$ are theorems of any theory.
\end{lem}

\begin{lem}
Sequent $y = x \land \varphi[y/x] \sststile{}{V} \varphi$ is a theorem of any theory.
\end{lem}

Using the previous lemma we prove the following fact:

\begin{lem}[cong-b]
For every $u_i,v_i \in Term_\mathcal{F}(V)_{s_i}$, $\varphi \in Form_\Sigma(\{ x_1 : s_1, \ldots x_n : s_n\})$
sequent $u_1 = v_1 \land \ldots \land u_n = v_n \land \varphi[x_i \mapsto u_i] \sststile{}{V} \varphi[x_i \mapsto v_i]$ is a theorem of any theory.
\end{lem}
\begin{proof}
By the previous lemma we have $y_n = x_n \land \varphi[y_n/x_n] \sststile{}{x_1 : s_1, \ldots x_n : s_n, y_n : s_n} \varphi$ is provable.
If we take $\varphi$ to be equal to $y_n = x_n \land \varphi[y_n/x_n]$, then we get sequent
$y_{n-1} = x_{n-1} \land y_n = x_n \land \varphi[y_n/x_n,y_{n-1}/x_{n-1}] \sststile{}{x_1 : s_1, \ldots x_n : s_n, y_{n-1} : s_{n-1}, y_n : s_n} y_n = x_n \land \varphi[y_n/x_n]$.
By \axref{b2} we get sequent
\[ y_{n-1} = x_{n-1} \land y_n = x_n \land \varphi[y_n/x_n,y_{n-1}/x_{n-1}] \sststile{}{x_1 : s_1, \ldots x_n : s_n, y_{n-1} : s_{n-1}, y_n : s_n} \varphi. \]
Repeating this argument we can conclude that
\[ y_1 = x_1 \land \ldots \land y_n = x_n \land \varphi[y_1/x_1, \ldots y_n/x_n] \sststile{}{x_1 : s_1, \ldots x_n : s_n, y_1 : s_1, y_n : s_n} \varphi. \]
By \axref{a3} we conclude that the required sequent is derivable.
\end{proof}

Let $\Sigma = (\mathcal{S}, \mathcal{F}, \mathcal{P})$ and $\Sigma' = (\mathcal{S}, \mathcal{F}', \mathcal{P}')$ be a pair of signatures with the same set of sorts.
Let $f$ be a morphism of $\Sigma$ and $\Sigma'$.
Let $\mathcal{A}$ and $\mathcal{A}'$ be Horn theories in signatures $\Sigma$ and $\Sigma'$ respectively.
Then we will say that $f$ \emph{respects} a sequent $\varphi \sststile{}{V} \psi$ over $\Sigma$ if $f(\varphi) \sststile{}{V} f(\psi)$ is a theorem of $\mathcal{A}'$.
Note that if $f$ respects all axioms of $\mathcal{A}$, then it respects all of its theorems too.

Let $\mathcal{A}$ and $\mathcal{A}'$ be theories over $\Sigma$ and $\Sigma'$ respectively.
Then we will say that morphisms $f$ and $f'$ between $\Sigma$ and $\Sigma'$ are \emph{equivalent} if the following conditions hold:
\begin{enumerate}
\item For every $t \in PTerm_\Sigma(V)_s$, sequents $\sststile{}{V} f(t) \cong f'(t)$ are theorems of $\mathcal{A}'$.
\label{mor-eq-a}
\item For every $\varphi \in Form_\Sigma(V)$, sequents $f(\varphi) \ssststile{}{V} f'(\varphi)$ are theorems of $\mathcal{A}'$.
\label{mor-eq-b}
\end{enumerate}

\begin{prop}[mor-eq]
Let $\mathcal{A}$ and $\mathcal{A}'$ be theories over $\Sigma$ and $\Sigma'$ respectively.
Morphisms $f$ and $f'$ between $\Sigma$ and $\Sigma'$ are equivalent if and only if the following conditions hold:
\begin{itemize}
\item For every $\sigma \in \mathcal{F}$, $\sigma : s_1 \times \ldots \times s_n \to s$ sequents
\[ \sststile{}{x_1 : s_1, \ldots x_n : s_n} f(\sigma(x_1, \ldots x_n)) \cong f'(\sigma(x_1, \ldots x_n)) \]
are theorems of $\mathcal{A}'$.
\item For every $R \in \mathcal{P}$, $R : s_1 \times \ldots \times s_n$ sequents
\[ f(R(x_1, \ldots x_n)) \ssststile{}{x_1 : s_1, \ldots x_n : s_n} f'(R(x_1, \ldots x_n)) \]
are theorems of $\mathcal{A}'$.
\end{itemize}
\end{prop}
\begin{proof}
The ``only if'' direction is obvious.
Let us prove the converse.
First, we prove \eqref{mor-eq-a} for $t \in Term_\mathcal{F}(V)_s$ by induction on it.
If $t$ is a variable, then $f(t) = f'(t) = t$.
If $t = \sigma(t_1, \ldots t_n)$, then $\sststile{}{V} f(t_i) \cong f(t'_i)$
and $\sststile{}{x_1 : s_1, \ldots x_n : s_n} f(\sigma(x_1, \ldots x_n)) \cong f'(\sigma(x_1, \ldots x_n))$.
Since $FV(f(\sigma(x_1, \ldots x_n))) = \{ x_1, \ldots x_n\}$, by \axref{a3} we have
$f(t)\!\downarrow\,\sststile{}{V} f(t) = f'(\sigma(x_1, \ldots x_n))[x_i \mapsto \alpha_V(t_i)]$.
We also have $f(t)\!\downarrow\,\sststile{}{V} f(t_i)\!\downarrow$, hence by \rlem{cong-a}
$f(t)\!\downarrow\,\sststile{}{V} f'(\sigma(x_1, \ldots x_n))[x_i \mapsto f(t_i)] = f'(t)$.
By transitivity, we conclude that $f(t)\!\downarrow\,\sststile{}{V} f(t) = f'(t)$.
The same argument shows that $f'(t)\!\downarrow\,\sststile{}{V} f(t) = f'(t)$.

Let us prove \eqref{mor-eq-b}.
It is enough to prove it for atomic formulae $\varphi$.
If $\varphi$ equals to $t = t'$, then $f(\varphi)$ equals to $f(t) = f(t')$ and $f'(\varphi)$ equals to $f'(t) = f'(t')$.
We know that $\sststile{}{V} f(t) \cong f'(t)$ and $\sststile{}{V} f(t') \cong f'(t')$.
Thus by transitivity and symmetry we can conclude that $f(t) = f(t)' \sststile{}{V} f'(t) = f'(t')$.

If $\varphi = R(t_1, \ldots t_n)$, then $f(\varphi) = f(R(x_1, \ldots x_n))[x_i \mapsto f(t_i)]$
and $f'(\varphi) = f'(R(x_1, \ldots x_n))[x_i \mapsto f'(t_i)]$.
We know that $f(R(x_1, \ldots x_n)) \sststile{}{x_1 : s_1, \ldots x_n : s_n}$ \linebreak $f'(R(x_1, \ldots x_n))$.
Since $FV(f(R(x_1, \ldots x_n))) = \{ x_1, \ldots x_n \}$, by \axref{a3} we can conclude that $f(\varphi) \sststile{}{V} f'(R(x_1, \ldots x_n))[x_i \mapsto f(t_i)]$.
Since $f'(R(x_1, \ldots x_n))[x_i \mapsto f(t_i)] \sststile{}{V} f(t_i)\!\downarrow$, \rlem{cong-b} implies that
$f'(R(x_1, \ldots x_n))[x_i \mapsto f(t_i)] \sststile{}{V} f'(\varphi)$.
By \axref{b2} we conclude that $f(\varphi) \sststile{}{V} f'(\varphi)$.
The same argument shows that $f'(\varphi) \sststile{}{V} f(\varphi)$.

Now, we can finish the proof of \eqref{mor-eq-a}.
We need to prove that $\sststile{}{V} f(t|_\varphi) \cong f'(t|_\varphi)$.
We already saw that $f(t)\!\downarrow\,\sststile{}{V} f(t) = f'(t)$ and $f(\varphi) \sststile{}{V} f'(\varphi)$.
Hence $f(t)\!\downarrow \land f(\varphi) \sststile{}{V} f(t) = f'(t) \land f'(\varphi)$.
The same argument shows that $f'(t)\!\downarrow \land f'(\varphi) \sststile{}{V} f(t) = f'(t) \land f(\varphi)$.
\end{proof}

Let $\mathcal{S}$ be a set of sorts.
Then we define a category $\Th_\mathcal{S}$ of theories.
Its objects are pairs $(\Sigma,\mathcal{A})$ where $\Sigma$ is a signature with $\mathcal{S}$ as the set of sorts and $\mathcal{A}$ is a theory in $\Sigma$.
Morphisms of theories $(\Sigma,\mathcal{A})$ and $(\Sigma',\mathcal{A}')$
are equivalence classes of functions as described above which respect all axioms of $\mathcal{A}$.
The composition of morphisms of signatures respects the equivalence relation; hence this defines a category of theories.

\subsection{Models of theories}

The notions of a partial $\Sigma$-structure for a signature $\Sigma$ and of a model of a theory were defined in \cite{PHL}.
Here, we will prove the following proposition:

\begin{prop}[func-mod]
For every morphism of theories $f : \mathbb{T}_1 \to \mathbb{T}_2$ there is a faithful functor $f^* : \Mod{\mathbb{T}_2} \to \Mod{\mathbb{T}_1}$ such that
for every theory $\mathbb{T}$, $id_\mathbb{T}^*$ is the identity functor,
and for every $f : \mathbb{T}_1 \to \mathbb{T}_2$ and $g : \mathbb{T}_2 \to \mathbb{T}_3$, $(g \circ f)^* = f^* \circ g^*$.
\end{prop}

\begin{cor}[iso-mod]
Isomorphic theories has isomorphic categories of models.
\end{cor}

Let $\Sigma = (\mathcal{S},\mathcal{F},\mathcal{P})$ and $\Sigma' = (\mathcal{S},\mathcal{F}',\mathcal{P}')$ be a pair of signatures,
and let $f : \Sigma \to \Sigma'$ be a morphism between them.
Then we can define a functor $f^* : \PStr{\Sigma'} \to \PStr{\Sigma}$.
If $A$ is a partial $\Sigma'$-structure, then $f^*(A)$ has the same underlying $\mathcal{S}$-set (that is, object of $\Set^\mathcal{S}$).
If $R \in \mathcal{P}$, then we define $f^*(A)(R)$ as $A(f(R))$.
If $\sigma \in \mathcal{F}$, then we define $f^*(A)(\sigma)$ as $A(t)|_{A(\varphi)}$, where $t|_\varphi = f(\sigma)$.

By definition morphisms of partial $\Sigma$-structures are morphisms of the underlying $\mathcal{S}$-sets which commute with the interpretation of symbols from $\Sigma$.
If $\alpha : A \to B$ is a morphism of partial $\Sigma'$-structures, then we want to define $f^*(\alpha) : f^*(A) \to f^*(B)$ as the same morphism.
To do this we need to prove that if $\alpha$ commutes with the interpretation of symbols from $\Sigma'$, then it also commutes with the interpretation of symbols from $\Sigma$.
But the interpretation of symbols from $\Sigma$ is defined as the interpretation of terms and formulae from $\Sigma'$, and it was shown in \cite{PHL} that $\alpha$ commutes with it.

Note that $(-)^*$ is functorial, that is $id^*$ is the identity functor and $(g \circ f)^* = f^* \circ g^*$.
This is obvious for morphisms since $f^*(\alpha) = \alpha$ for all $f$.
Given a partial $\Sigma$-structure $A$ we can check that $id^*(A)(R) = A(id(R)) = A(R)$ and $id^*(A)(\sigma) = A(\sigma)$.
Thus $id^*$ is indeed the identity functor.

If $f : \Sigma \to \Sigma'$ and $g : \Sigma' \to \Sigma''$ and $A$ is a partial $\Sigma$-structure,
then $(g \circ f)^*(A)(R) = A(g(f(R)))$ and $f^*(g^*(A))(R) = g^*(A)(f(R)) = A(g(f(R)))$.
If $f(\sigma) = t|_\varphi$ and $g(t) = t'|_\psi$, then $(g \circ f)^*(A)(\sigma) = A(t')|_{A(\psi \land g(\varphi))} = A(t')|_{A(\psi) \cap A(g(\varphi))}$
and $f^*(g^*(A))(\sigma) = g^*(A)(t)|_{g^*(A)(\varphi)} = A(t')|_{A(\psi) \cap A(g(\varphi))}$.
Thus $(g \circ f)^* = f^* \circ g^*$.

If $\mathbb{T}$ is a theory over signature $\Sigma$, then category $\Mod{\mathbb{T}}$ of models of $\mathbb{T}$ is a full subcategory of $\PStr{\Sigma}$.
Let $\mathbb{T}_i$ be theories over signatures $\Sigma_i$, $i = 1,2$.
If a morphism of signatures $f : \Sigma_1 \to \Sigma_2$ preserves axioms of $\mathbb{T}_1$, then for every model $A$ of $\mathbb{T}_2$, $f^*(A)$ is a model of $\mathbb{T}_1$.
Indeed, if $\varphi \sststile{}{V} \psi$ is a sequent of $\mathbb{T}_1$, then it holds in $f^*(A)$ if $f(\varphi) \sststile{}{V} f(\psi)$ holds in $A$.
If $\varphi \sststile{}{V} \psi$ is an axiom of $\mathbb{T}_1$, then $f(\varphi) \sststile{}{V} f(\psi)$ is a theorem of $\mathbb{T}_2$, hence it holds in $A$.
Thus $f^*(A)$ is a model of $\mathbb{T}_1$ and $f^*$ restricts to a functor $\Mod{\mathbb{T}_2} \to \Mod{\mathbb{T}_1}$.

Now, let $f,g : \mathbb{T}_1 \to \mathbb{T}_2$ be morphisms of theories.
We need to prove that if $f$ and $g$ are equivalent, then $f^* = g^*$.
Again, we only need to check that the interpretations of symbols in $f^*(A)$ and $g^*(A)$ coincide.
Indeed, we have $f^*(A)(R) = A(f(R))$ and $g^*(A)(R) = A(g(R))$, and $A(f(R)) = A(g(R))$ since $A$ is a model of $\mathbb{T}_2$ and $f(R) \ssststile{}{V} g(R)$ is a theorem of $\mathbb{T}_2$.
Analogous argument shows that $f^*(A)(\sigma) = g^*(A)(\sigma)$.

Summarizing, we saw that every morphism of theories $f : \mathbb{T}_1 \to \mathbb{T}_2$ defines a functor $f^* : \Mod{\mathbb{T}_2} \to \Mod{\mathbb{T}_1}$.
On morphisms $f^*$ is just an inclusion of a subset; hence $f^*$ is faithful.
Moreover, $(-)^*$ is functorial, which proves \rprop{func-mod}.

\subsection{Properties of $\Th_\mathcal{S}$}

Now we prove a few properties of the category of theories.
We begin with a proof of the existence of colimits.

\begin{prop}
Category $\Th_\mathcal{S}$ is cocomplete.
\end{prop}
\begin{proof}
First, let $\{ \mathbb{T}_i \}_{i \in S} = \{ ((\mathcal{S},\mathcal{F}_i,\mathcal{P}_i),\mathcal{A}_i) \}_{i \in S}$ be a set of theories.
Then we can define its coproduct $\coprod\limits_{i \in S} \mathbb{T}_i$ as the theory with $\coprod\limits_{i \in S} \mathcal{F}_i$ as the set of function symbols and $\coprod\limits_{i \in S} \mathcal{A}_i$ as the set of axioms.
Morphisms $f_i : \mathbb{T}_i \to \coprod\limits_{i \in S} \mathbb{T}_i$ are defined in the obvious way.
If $g_i : \mathbb{T}_i \to X$ is a collection of morphisms, then we can extend $f_i$ to a morphism $f : \coprod\limits_{i \in S} \mathbb{T}_i \to X$
by \rprop{mor-def} as $f(\sigma) = f_i(\sigma)$ if $\sigma \in \mathcal{F}_i$ and $f(R) = f_i(R)$ if $R \in \mathcal{P}_i$.
If $f,f' : \coprod\limits_{i \in S} \mathbb{T}_i \to X$ are such that $f \circ f_i = f' \circ f_i$, then we know that for all
$\sigma \in \mathcal{F}_i$, $\sststile{}{x_1, \ldots x_n} f(\sigma(x_1, \ldots x_n)) \cong f'(\sigma(x_1, \ldots x_n))$ and for all $R \in \mathcal{P}_i$, $f(R) \ssststile{}{V} f'(R)$.
\Rprop{mor-eq} implies that $f$ and $f'$ are equivalent.

Now, let $f,g : \mathbb{T}_1 \to \mathbb{T}_2$ be a pair of morphisms of theories.
Then we can define their coequalizer $\mathbb{T}$ as the theory with the same set of function and predicate symbols as $\mathbb{T}_2$ and the set of axioms which consists of the axioms of $\mathbb{T}_2$
together with $\sststile{}{x_1, \ldots x_n} f(\sigma(x_1, \ldots x_n)) \cong g(\sigma(x_1, \ldots x_n))$ for each function symbols $\sigma$ of $\mathbb{T}_1$
and $f(R(x_1, \ldots x_n)) \ssststile{}{x_1, \ldots x_n} f'(R(x_1, \ldots x_n))$ for each predicate symbols $R$ of $\mathbb{T}_1$.
Then we can define $e : \mathbb{T}_2 \to \mathbb{T}$ as identity function on terms and formulae.
By \rprop{mor-eq}, $e \circ f = e \circ g$.
If $h : \mathbb{T}_2 \to X$ is such that $h \circ f = h \circ g$, then it extends to a morphism $\mathbb{T} \to X$ since additional axioms are preserved by the assumption on $h$.
This extension is unique since $e$ is an epimorphism.
\end{proof}

Now we give a characterization of monomorphisms.

\begin{prop}
A morphism of theories $f : \mathbb{T}_1 \to \mathbb{T}_2$ is a monomorphism if and only if for every sequent $\varphi \sststile{}{V} \psi$ of $\mathbb{T}_1$
if $f(\varphi) \sststile{}{V} f(\psi)$ is a theorem of $\mathbb{T}_2$, then $\varphi \sststile{}{V} \psi$ is a theorem of $\mathbb{T}_1$.
\end{prop}
\begin{proof}
First, let us prove the ``if'' part.
Let $g,h : \mathbb{T} \to \mathbb{T}_1$ be a pair of morphisms such that $f \circ g = f \circ h$.
If $t \in PTerm_\Sigma(V)_s$, then $\sststile{}{V} f(g(t)) \cong f(h(t))$; hence $\sststile{}{V} g(t) \cong h(t)$.
If $\varphi \in Form_\Sigma(V)$, then $f(g(\varphi)) \ssststile{}{V} f(h(\varphi))$; hence $g(\varphi) \ssststile{}{V} h(\varphi)$.
Thus $g = h$.

Now, let us prove the ``only if'' part.
Suppose that $f$ is a monomorphism.
Let $\varphi \sststile{}{V} \psi$ be a sequent of $\mathbb{T}_1$ such that $f(\varphi) \sststile{}{V} f(\psi)$ is a theorem of $\mathbb{T}_2$.
Let $\mathbb{T}$ be a theory which consists of a single predicate symbol $R : s_1 \times \ldots \times s_n \times s'_1 \times \ldots \times s'_k$
where $s_1, \ldots s_n$ are sorts of variables in $fv(\varphi)$ and $s'_1, \ldots s'_k$ are sorts of variables in $fv(\psi)$.
Let $g : \mathbb{T} \to \mathbb{T}_1$ be a morphism defined by $g(R(x_1, \ldots x_n, y_1, \ldots y_k)) = \varphi \land y_1\!\downarrow \land \ldots \land y_k\!\downarrow$ and
let $h : \mathbb{T} \to \mathbb{T}_1$ be a morphism defined by $h(R(x_1, \ldots x_n, y_1, \ldots y_k)) = \varphi \land \psi$.
By \rprop{mor-eq} $f \circ g = f \circ h$, hence $g = h$ which implies that $\varphi \sststile{}{V} \psi$.
\end{proof}

Let $\mathbb{T} = ((\mathcal{S},\mathcal{F},\mathcal{P}),\mathcal{A})$ and $\mathbb{T}' = ((\mathcal{S}',\mathcal{F}',\mathcal{P}'),\mathcal{A}')$ be a pair of theories.
Then we say that $\mathbb{T}'$ is a \emph{subtheory} of $\mathbb{T}$ if $\mathcal{S}' \subseteq \mathcal{S}$, $\mathcal{F}' \subseteq \mathcal{F}$, $\mathcal{P}' \subseteq \mathcal{P}$ and $\mathcal{A}' \subseteq \mathcal{A}$.
If $\mathbb{T}'$ is a subtheory of a theory $\mathbb{T}$, then we often need to know when a theorem of $\mathbb{T}$ is a theorem of $\mathbb{T}'$.
The lemma below gives us a simple criterion for this.
First, we need to introduce a bit of notation.
Let $t$ is a term over the signature of $\mathbb{T}$ such that there is no subterm of a sort that does not belong to $\mathcal{S}'$.
Then we define a term $T(t)$ over the signature of $\mathbb{T}'$ as follows:
\begin{align*}
T(x) & = x \\
T(\sigma(t_1, \ldots t_n)) & = \sigma(T(t_1), \ldots T(t_n)) \text{, if $\sigma \in \mathcal{F}'$} \\
T(\sigma(t_1, \ldots t_n)) & = x_s \text{, if $\sigma \notin \mathcal{F}'$ and $\sigma : s_1 \times \ldots \times s_n \to s$}
\end{align*}
where $x_s$ is a variable of sort $s$ that is not a free variable of $t$.

If $\varphi$ is an atomic formula over the signature of $\mathbb{T}$, then we define a formula $T(\varphi)$ over the signature of $\mathbb{T}'$ as follows:
\begin{align*}
T(t = t') & = (T(t) = T(t')) \text{, if $T(t)$ and $T(t')$ are defined} \\
T(R(t_1, \ldots t_n)) & = R(T(t_1), \ldots T(t_n)) \text{, if $T(t_i)$ is defined for every $i$} \\
T(\varphi) & = \top \text{, otherwise}
\end{align*}
For an arbitrary Horn formula $\varphi$ we define $T(\varphi)$ as follows:
\[ T(\varphi_1 \land \ldots \land \varphi_n) = T(\varphi_1) \land \ldots \land T(\varphi_n) \]
If $S$ is sequent $\varphi \sststile{}{V} \psi$ in the signature of $\mathbb{T}$,
then we define sequent $T(S)$ in the signature of $\mathbb{T}'$ as $T(\varphi) \sststile{}{V \cup FV(T(\varphi)) \cup FV(T(\psi))} T(\psi)$.

\begin{lem}[mono]
Let $\mathbb{T}'$ be a subtheory of $\mathbb{T}$.
Suppose that for every axiom $S$ of $\mathbb{T}$, $T(S)$ is a theorem of $\mathbb{T}'$.
Then if a sequent in the signature of $\mathbb{T}'$ is provable in $\mathbb{T}$, then it is also provable in $\mathbb{T}'$.
\end{lem}
\begin{proof}
If $S$ is a sequent in the signature of $\mathbb{T}'$, then $T(S) = S$.
Thus we only need to prove that if $S$ is a theorem of $\mathbb{T}$, then $T(S)$ is a theorem of $\mathbb{T}'$.
For axioms this is true by assumption.
We need to check that $T(-)$ preserves inference rules.
This is clearly true for rules \axref{b1}-\axref{b6} and \axref{a1}.

Let us consider rule \axref{a2}.
Let $S$ equals $x = y \land \varphi \sststile{}{x:s,y:s,V} \varphi[y/x]$.
Note that $T(\varphi[y/x])$ is defined if and only if $T(\varphi)$ is defined, and in this case $T(\varphi[y/x]) = T(\varphi)[y/x]$.
Thus $T(S)$ is either of the form $x = y \land T(\varphi) \sststile{}{x:s,y:s,V,FV(T(\varphi))} T(\varphi)[y/x]$,
or of the form $x = y \sststile{}{x:s,y:s,V} \top$, or of the form $\top \sststile{}{x:s,y:s,V} \top$.
In all of these cases $T(S)$ is a theorem of $\mathbb{T}'$.

Finally, let us consider rule \axref{a3}.
To prove that it preserves the required proerty it is enough to show that $\varphi$ is a formula of $(\mathcal{S}',\mathcal{F}',\mathcal{P}')$ if and only if $\varphi[t/x]$ is.
If $x \notin FV(\varphi)$, then $\varphi = \varphi[t/x]$.
Suppose that $x \in FV(\varphi)$ and $\varphi$ is a formula of $(\mathcal{S}',\mathcal{F}',\mathcal{P}')$.
If $x$ has sort $s$, then $s \in \mathcal{S}'$.
We need to show that a term of sort $s$ is a term of $(\mathcal{S}',\mathcal{F}',\mathcal{P}')$.
But this follows from the assumption on the set of function symbols.
\end{proof}

\label{sec:T0}
\subsection{Algebraic type theories}

Let $\mathcal{T} = \{ ty, tm \} \times \mathbb{N}$ be a set of sorts.
We will write $(ctx,n)$ for $(ty,n-1)$ if $n > 0$.
Sort $(tm,n)$ represents terms in contexts of length $n$, sort $(ty,n)$ represents types in contexts of length $n$, and sort $(ctx,n)$ represents contexts of length $n$.
Sometimes it is convinient to have a sort for contexts of length 0.
So we define $\mathcal{C} = \mathcal{T} \cup \{ (ctx,0) \}$.
Let $\mathbb{T}_{-1} \in \ThC$ be the theory with one function symbol $* : (ctx,0)$ and the following axioms:
\begin{align*}
& \sststile{}{} * \downarrow \\
& \sststile{}{A} A = *
\end{align*}

Note that there is at most one morphism from $\mathbb{T}_{-1}$ to any other theory.
Thus category $\mathbb{T}_{-1}/\ThC$ is (isomorphic to) a full subcategory of $\ThC$.

\begin{prop}
Categories $\ThT$ and $\mathbb{T}_{-1}/\ThC$ are equivalent.
\end{prop}
\begin{proof}
\todo{Finish the proof}
Every theory in $\ThT$ is a theory in $\ThC$ in the obvious way.
We define $F : \ThT \to \mathbb{T}_{-1}/\ThC$ as $F(\mathbb{T}) = \mathbb{T}_{-1} \amalg \mathbb{T}$.
First, note that $F$ is faithful.
Indeed, let $f,g : \mathbb{T}_1 \to \mathbb{T}_2$ be morphisms such that $f \amalg \mathbb{T}_{-1} = g \amalg \mathbb{T}_{-1}$.
Let $i_1 : \mathbb{T}_2 \to \mathbb{T}_2 \amalg \mathbb{T}_{-1}$ be the coproduct inclusion.
Then $i_1 \circ f = i_1 \circ g$.
By \rprop{mor-eq} we need to prove that
$\sststile{}{x_1 : s_1, \ldots x_n : s_n} f(\sigma(x_1, \ldots x_n)) \cong g(\sigma(x_1, \ldots x_n))$ and
$f(R(x_1, \ldots x_n)) \ssststile{}{x_1 : s_1, \ldots x_n : s_n} g(R(x_1, \ldots x_n))$ are provable in $\mathbb{T}_2$.
We know that they are provable in $\mathbb{T}_2 \amalg \mathbb{T}_{-1}$, and by \rlem{mono} they are provable in $\mathbb{T}_2$.

Now, let us prove that $F$ is full.
Let $f : \mathbb{T}_{-1} \amalg \mathbb{T}_1 \to \mathbb{T}_{-1} \amalg \mathbb{T}_2$ be a morphism.
Then we define $g : \mathbb{T}_1 \to \mathbb{T}_2$ as $g(t) = T(f(t))$ and $g(\varphi) = T(f(\varphi))$
where $T$ is defined as in \rlem{mono} for the inclusion $\mathbb{T}_2 \to \mathbb{T}_{-1} \amalg \mathbb{T}_2$.

Finally, let us prove that $F$ is essentially surjective.
Given a theory $\mathbb{T} \in \ThC$ and a morphism $c : \mathbb{T}_{-1} \to \mathbb{T}$ we define a theory $\mathbb{T}' \in \ThT$.
This theory contains one function symbol $\sigma$ for every function symbols $\sigma$ of $\mathbb{T}$ such that $\sigma : s_1 \times \ldots \times s_n \to s$ and $s \in \mathcal{T}$.
We let $\sigma : s_{i_1} \times \ldots \times s_{i_k} \to s$ where $\{ i_1, \ldots i_k \} \subset \{ 1, \ldots n \}$ consists of those $i$ for which $s_i \in \mathcal{T}$.
For every $V$ and $s \in \mathcal{T}$ we define function $\alpha : Term_\mathbb{T}(V)_s \to Term_{\mathbb{T}'}(V)_s$ as follows:
\begin{align*}
\alpha(x) & = x \text{ if } x \in V \\
\alpha(\sigma(a_1, \ldots a_n)) & = \sigma(\alpha(a_{i_1}), \ldots \alpha(a_{i_k}))
\end{align*}
If $\varphi$ is a formula $t = s$ of $\mathbb{T}$, then we define formula $\alpha(\varphi)$ of $\mathbb{T}'$ as $\alpha(t) = \alpha(s)$
if terms $t$ and $s$ have a sort in $\mathcal{T}$ and as $\top$ otherwise.
Axioms of $\mathbb{T}'$ are sequents $\alpha(\varphi_1) \land \ldots \land \alpha(\varphi_n) \sststile{}{V} \alpha(\psi_1) \land \ldots \land \alpha(\psi_k)$
for every axiom $\varphi_1 \land \ldots \land \varphi_n \sststile{}{V} \psi_1 \land \ldots \land \psi_k$ of $\mathbb{T}$.

Now, $F(\mathbb{T}')$ and $\mathbb{T}$ are isomorphic.
Indeed, we can extend $\alpha$ to a morphism $\alpha : \mathbb{T} \to \mathbb{T}_{-1} \amalg \mathbb{T}'$
by defining $\alpha(\sigma(a_1, \ldots a_n)) = *$ if $\sigma : s_1 \times \ldots \times s_n \to (ctx,0)$.
Let $\beta : \mathbb{T}' \to \mathbb{T}$ be the following morphism:
\[ \beta(\sigma(x_{i_1}, \ldots x_{i_k})) = \sigma(b_1, \ldots b_n) \]
where $b_j = x_{i_t}$ if $j = i_t$ and $b_j = *$ otherwise.
Then $[c,\beta] : \mathbb{T}_{-1} \amalg \mathbb{T}' \to \mathbb{T}$ is the inverse of $\alpha$.
Thus $F$ is essentially surjective.
\end{proof}

We define $\mathbb{T}_0 \in \ThT$ as the theory with the set of function symbols $\{ ft_n : (ctx,n+1) \to (ctx,n)\ |\ n > 0 \} \cup \{ ty_n : (tm,n) \to (ty,n)\ |\ n \in \mathbb{N} \}$ and the following axioms:
\begin{align*}
& \sststile{}{A} ft_n(A) \downarrow \\
& \sststile{}{a} ty_n(a) \downarrow
\end{align*}
Let $ft^i_n : (ctx,n+i) \to (ctx,n)$ be the following derived operation:
\begin{align*}
& ft^0_n(A) = A \\
& ft^{i+1}_n(A) = ft^i_n(ft_{n+i}(A))
\end{align*}

Now, we can define the notion of algebraic type theories.

\begin{defn}
An \emph{algebraic type theory} is a theory $\mathbb{T} \in \ThT$ together with a morphism $\mathbb{T}_0 \to \mathbb{T}$.
The category of algebraic type theories is the under category $\mathbb{T}_0/\ThT$.
\end{defn}

\section{Contextual theories}

In this section we give an alternative presentation of theories under $\mathbb{T}_0$ which we call \emph{contextual}.
The problem with the algebraic definition is that its terms carry a lot of surplus information.
So it is inconvenient to work with it in practice.
Contextual theories allow us to reduce the amount of the information in terms,
but the drawback of this approach is that it is less straightforward to define a notion of a model of such theories.

\subsection{Contextual Horn theories}

Let $\mathcal{F}$ be a set of function symbols with $\mathcal{T}$ as the set of sorts.
A \emph{context} of length $n$ is a sequence of terms of sorts $(ty,0)$, \ldots $(ty,n-1)$.
Contexts are usually denoted by greek letters $\Gamma$ and $\Delta$.
The set of contexts of length $n$ with free variables in $V$ will be denoted by $Ctx^n_\mathcal{F}(V)$.

Let $\Sigma = (\mathcal{T}, \mathcal{F}, \mathcal{P})$ be a signature, $V \in \Set^\mathcal{T}$, and $s \in \mathcal{T}$.
First, if $(p,n) \in \mathcal{T}$, then let $d(p,n) = n$ if $p = ty$ and $d(p,n) = n+1$ if $p = tm$.
A \emph{contextual term} of sort $s$ with free variables in $V$ is a pair $(\Gamma,t)$ where $\Gamma$ is a context of length $d(s)$ and $t$ is a term of sort $s$.
The set of such terms will be denoted by $CTerm_\mathcal{F}(V)_s$.

A \emph{contextual atomic formula} over $\Sigma$ with free variables in $V$ is an expression either of the form $t = t'$, where $t,t' \in CTerm_\mathcal{F}(V)_s$,
    or of the form $R(t_1, \ldots t_n)$, where $R \in \mathcal{P}$, $R : s_1 \times \ldots \times s_n$, and $t_i \in CTerm_\mathcal{F}(V)_{s_i}$.
Contextual Horn formulae are defined as before.
The set of contextual Horn formulae with free varibles in $V$ will be denoted by $CForm_\Sigma(V)$.

A \emph{contextual Horn sequent} over $\Sigma$ is an expression of the form $\varphi \sststile{}{V} \psi$,
    where $\varphi$ and $\psi$ are Horn formulae over $\Sigma$ with free variables in $\mathbb{T}_0(V)$.
Here $\mathbb{T}_0(V)$ is the underlying $\mathcal{T}$-set of the free $\mathbb{T}_0$ model on $V$.
A \emph{partial contextual term} of sort $s$ with free variables in $V$ is an expression of the form $t|_\varphi$,
where $t \in CTerm_\mathcal{F}(V)_s$ and $\varphi \in CForm_\Sigma(V)$.
The set of such terms will be denoted by $PCTerm_\Sigma(V)_s$.

In order to define substituion operations on contextual terms and formulae, we need to introduce an additional structure on the set of function symbols.
For each $\sigma \in \mathcal{F}$, $\sigma : s_1 \times \ldots \times s_k \to s$ and each $1 \leq i \leq k$,
    let $D_i(\sigma)$ be a context of length $d(s_i)$ with free variables $\{\ x_j : (ty,j)\ |\ 1 \leq j \leq d(s)\ \} \cup \{\ y_j : s_j\ |\ 1 \leq j \leq k\ \}$.
We will denote such context as $D_i(x_1, \ldots x_{d(s)}, \sigma(y_1, \ldots y_k))$.
The idea is that $D_i(\sigma)$ should be a context in which $y_i$ is typeable if $\sigma(y_1, \ldots y_k)$ is typeable in context $x_1, \ldots x_{d(s)}$.

We will need two kinds of substitution, the first of which is a substitution of ordinary terms.
If \todo{Replace with PTerm?} $\rho : V \to Term_\Sigma(V')$ is a function, then
\begin{align*}
(A_1, \ldots A_n, t)[\rho] & = (A_1[\rho], \ldots A_n[\rho], t[\rho]) \\
R(t_1, \ldots t_k)[\rho] & = R(t_1[\rho], \ldots t_k[\rho]) \\
(\varphi_1 \land \ldots \land \varphi_k)[\rho] & = \varphi_1[\rho] \land \ldots \land \varphi_k[\rho] \\
(\Gamma,t)|_\varphi[\rho] & = (\Gamma,t)[\rho]|_{\varphi[\rho]}
\end{align*}

Let $\sigma$ be a function symbol such that $\sigma : s_1 \times \ldots \times s_k \to s$.
Let $\Gamma = A_1, \ldots A_{d(s)}$ be a context with free variables in $V$, and let $t_i$ be terms of sorts $s_i$ with free variables in $V$ for each $1 \leq i \leq k$.
Then we write $D_i(\Gamma, \sigma(t_1, \ldots t_k))$ for a context of length $d(s_i)$ with free variables in $V$ defined as follows:
\[ D_i(\Gamma, \sigma(t_1, \ldots t_k)) = D_i(x_1, \ldots x_{d(s)}, \sigma(y_1, \ldots y_k))[x_i \mapsto A_i, y_j \mapsto t_j] \]

For each variable $x \in V_s$, we define context $D(x)$ of length $d(s)$ with free variables in $\mathbb{T}_0(V)$:
\[ D(x) = 
  \begin{cases}
      ft^n(x), \ldots ft(x) & \text{if } s = (ty,n) \\
      ft^n(ty(x)), \ldots ft(ty(x)), ty(x) & \text{if } s = (tm,n)
  \end{cases}
\]

Let $V$ be a $\mathcal{T}$-set
Then for every term $t$ of sort $s$ and context $\Gamma$ of length $d(s)$ with free variables in $\mathbb{T}_0(V)$,
    we define the set $FCV_1(\Gamma,t)$ of \emph{free contextual variables} of $t$ in context $\Gamma$.
This set consist of pairs $(\Gamma,x)$, where $x \in V_{s'}$ for some $s'$, and $\Gamma$ is a context of length $d(s')$.
\begin{align*}
FCV_1(\Gamma,x) & =
    \begin{cases}
        \{ (\Gamma,x) \} & \text{if } x \in V \text{ and } \Gamma \neq D(x) \\
        \varnothing & \text{otherwise}
    \end{cases} \\
FCV_1(\Gamma, \sigma(t_1, \ldots t_k)) & = \bigcup_{1 \leq i \leq k} FCV_1(D_i(\Gamma,\sigma(t_1, \ldots t_k)), t_i)
\end{align*}

For every $\mathcal{T}$-set $V$, contextual term $t$, contextual formula $\varphi$ and partial contextual term $t|_\varphi$ with free variables in $\mathbb{T}_0(V)$,
    we define their sets of free contextual variables $FCV(t)$, $FCV(\varphi)$ and $FCV(t|_\varphi)$:
\begin{align*}
FCV(A_1, \ldots A_n, t) & = \bigcup_{1 \leq i \leq n} FCV_1(A_1, \ldots A_i) \cup FCV_1(A_1, \ldots A_n, t) \\
FCV(\varphi_1 \land \ldots \land \varphi_k) & = \bigcup_{1 \leq i \leq k} FCV(\varphi_i) \\
FCV(R(t_1, \ldots t_k)) & = \bigcup_{1 \leq i \leq k} FCV(t_i) \\
FCV(t = t') & = FCV(t) \cup FCV(t') \\
FCV(t|_\varphi) & = FCV(t) \cup FCV(\varphi)
\end{align*}
Sometimes we will consider $FCV(a)$ as a finite sequence (rather than a set) of contextual variables.
In this case the definition is the same as above, where $\cup$ is considered as concatenation of sequences.
If $x$ is a variable, then let $FCV_x(a)$ be the set of contexts $\Gamma$ such that $(\Gamma,x) \in FCV(a)$,
where $a$ is either a contextual term, a contextual formula, or a partial contextual term.

Now, we can define the second kind of substitution.
Let $\rho : V \to PCTerm_\Sigma(V')$ be a partial function, $\rho(x) = (\Gamma_x,t_x)|_{\varphi_x}$.
Then we let $a[\rho] = a[\rho']|_\psi$ if $a$ is a (partial) term, and $a[\rho] = a[\rho'] \land \psi$ if $a$ is a formula,
    where $\rho'(x) = t_x|_{\varphi_x}$ and $\psi = \bigwedge\limits_{(\Gamma,x) \in FCV(a), \rho(x) \text{ is defined}} \Gamma[\rho'] = \Gamma_x$
    (here $FCV(a)$ is considered as a sequence).

A \emph{contextual Horn theory} in a signature $\Sigma = (\mathcal{T}, \mathcal{F}, \mathcal{P})$ is a set of contextual Horn sequents over $\Sigma$.
Now we describe the rules of the logic for these theories.
It has the rules \axref{b1}-\axref{b6} as in partial Horn logic.
Analogs of axioms \axref{a1}-\axref{a2} are listed below.
Note that since \axref{c1} is much weaker than \axref{a1} we need additional axioms \axref{c4} and \axref{c5}.
\begin{align*}
& \sststile{}{A} E^0_{ty}(A,A) \axtag{c1} \\
R(t_1, \ldots t_k) & \sststile{}{V} E^{n_i}_{p_i}(D_i(R(t_1, \ldots t_k)), t_i, t_i) \axtag{c4} \\
E^n_p(\Gamma, \sigma(t_1, \ldots t_k), \sigma(t_1, \ldots t_k)) & \sststile{}{V} E^{n_i}_{p_i}(D_i(\Gamma, \sigma(t_1, \ldots t_k)), t_i, t_i) \axtag{c5} \\
E^n_p(\Gamma, x, y) \land \varphi & \sststile{}{V} \varphi[y/x] \axtag{c2}
\end{align*}
An analog of \axref{a3} looks like this:
\begin{equation}
\AxiomC{$\varphi \sststile{}{V} \psi$}
\RightLabel{, if $x \in FV(\varphi)$, $t \in CTerm_\mathcal{F}(V')$}
\UnaryInfC{$\varphi[t/x] \sststile{}{V'} \psi[t/x]$}
\DisplayProof
\axtag{c3}
\end{equation}
The final axiom looks like this:
\begin{equation}
E^n_p(\Gamma,x,x) \land E^n_p(\Delta,x,x) \sststile{}{V} \Gamma = \Delta \text{, if $x \in V_{(p,n)}$}
\axtag{c6}
\end{equation}

Now, let us establish a few derivable rules of this logic.
If we let $R = E^n_p$, then \axref{c4} implies that for every $\Gamma \in Ctx^n_\mathcal{F}(V)$, $a,a' \in Term_\mathcal{F}(V)_{(tm,n)}$ and $A,A' \in Term_\mathcal{F}(V)_{(ty,n)}$ the following sequents are derivable:
\begin{align*}
\Gamma \vdash a \equiv a' : A & \sststile{}{V} (\Gamma \vdash a : A) \land (\Gamma \vdash a' : A) \land (\Gamma \vdash A) \\
\Gamma \vdash A \equiv A' & \sststile{}{V} (\Gamma \vdash A) \land (\Gamma \vdash A') \land (\Gamma \vdash) \\
\Gamma \vdash A & \ssststile{}{V} \Gamma, A \vdash
\end{align*}
More generally, the following sequent is derivable for every $R$ and $1 \leq i \leq k$:
\[ R(t_1, \ldots t_k) \sststile{}{V} D_i(R(t_1, \ldots t_k)) \vdash \]

If we let $\varphi = E^n_{tm}(\Gamma, A, a, a')$, then \axref{c2} implies the following well-known inference rule of type theory:
\[ (\Gamma \vdash a \equiv a' : A) \land (\Gamma \vdash A \equiv A') \sststile{}{\Gamma, a, a', A, A'} \Gamma \vdash a \equiv a' : A' \]
More generally, the following sequent is derivable for every $1 \leq i \leq d(p,n)$:
\begin{align*}
E^n_p(A_1, \ldots A_{d(p,n)}, a, a') \land E^{i-1}_{ty}(A_1, \ldots A_{i-1}, A_i, A_i') & \sststile{}{A_1, \ldots A_{d(p,n)}, A_i', a, a'} \\
E^n_p(A_1, \ldots A_{i-1}, A_i', A_{i+1}, \ldots A_{d(p,n)}, a, a') &
\end{align*}

\begin{lem}[form-subst]
If $\varphi \in CForm_\Sigma(V \amalg \{ x : (p,n) \})$ and $t \in Term_\mathcal{F}(V)_{(p,n)}$,
then for every $\Gamma \in FCV_x(\varphi)$ the following sequent is derivable:
\[ \varphi[t/x] \sststile{}{V} E^n_p(\Gamma[t/x],t,t) \]
\end{lem}
\begin{proof}
The proof is by induction on $\varphi$.
If $\varphi = \varphi_1 \land \ldots \land \varphi_n$, then $(\Gamma,x) \in FCV(\varphi_i)$ for some $1 \leq i \leq n$.
Then $\varphi[t/x] \sststile{}{V} \varphi_i[t/x]$ and $\varphi_i[t/x] \sststile{}{V} E^n_p(\Gamma[t/x],t,t)$; hence $\varphi[t/x] \sststile{}{V} E^n_p(\Gamma[t/x],t,t)$.
If $\varphi = R(t_1, \ldots t_k)$, then $(\Gamma,x) \in FCV(D_i(R(t_1, \ldots t_k)), t_i)$ for some $1 \leq i \leq k$.
Since $\varphi[t/x] = R(t_1[t/x], \ldots t_k[t/x])$, by \axref{c4} we have $\varphi[t/x] \sststile{}{V} E^{n_i}_{p_i}(D_i(R(t_1[t/x], \ldots t_k[t/x])), t_i[t/x], t_i[t/x])$.

Since $D_i(R(t_1[t/x], \ldots t_k[t/x])) = D_i(R(t_1, \ldots t_k))[t/x]$, it is enough to show that for every $(\Delta,t') \in CTerm_\mathcal{F}(V \amalg \{ x : (p,n) \})_{(p',n')}$
and for every $\Gamma \in FCV_x(\Delta,t')$, sequent $E^{n'}_{p'}(\Delta[t/x], t'[t/x], t'[t/x]) \sststile{}{V} E^n_p(\Gamma[t/x],t,t)$ is derivable.
We do this by induction on $t'$.
If $t'$ is a variable, then $t' = x$, $\Gamma = \Delta$, and the statement holds.
If $t' = \sigma(t_1, \ldots t_k)$, then $(\Gamma,x) \in FCV(D_i(\Delta,t'), t_i)$ for some $1 \leq i \leq k$.
Then
\[ E^{n'}_{p'}(\Delta[t/x], t'[t/x], t'[t/x]) \sststile{}{V} E^{n_i}_{p_i}(D_i(\Delta[t/x], t'[t/x]), t_i[t/x], t_i[t/x]) \]
by \axref{c5}, and by induction hypothesis we have
\[ E^{n_i}_{p_i}(D_i(\Delta[t/x], t'[t/x]), t_i[t/x], t_i[t/x]) \sststile{}{V} E^n_p(\Gamma[t/x],t,t), \]
which gives us the required sequent by \axref{b2}.
\end{proof}

In practice, it is more convenient to work with substitution of terms rather than contextual terms.
Now, we prove an analog of \axref{c3} for such substitution.

\begin{prop}
If $FCV_x(\varphi)$ consists of a single context, then the following rule is derivable for every $t \in Term_\mathcal{F}(V')$.
\begin{equation}
\AxiomC{$\varphi \sststile{}{V} \psi$}
\UnaryInfC{$\varphi[t/x] \sststile{}{V'} \psi[t/x]$}
\DisplayProof
\axtag{c3'}
\end{equation}
\end{prop}
\begin{proof}
Suppose that $\varphi \sststile{}{V} \psi$ and $FCV_x(\varphi) = \{ \Gamma \}$.
Then \[ \varphi[(\Gamma[t/x],t)/x] = \varphi[t/x] \land \bigwedge\limits_{(\Delta,x) \in FCV(\varphi)} \Delta[t/x] = \Gamma[t/x]. \]
By assumption, each $\Delta$ in the formula above equals to $\Gamma$.
By the previous lemma and remarks before it, $\varphi[t/x] \sststile{}{V'} \Gamma[t/x] = \Gamma[t/x]$.
Thus $\varphi[t/x] \sststile{}{V'} \varphi[(\Gamma[t/x],t)/x]$.
By \axref{c3}, $\varphi[(\Gamma[t/x],t)/x] \sststile{}{V'} \psi[(\Gamma[t/x],t)/x]$.
By definition of the substitution, $\psi[(\Gamma[t/x],t)/x] \sststile{}{V'} \psi[t/x]$.
Thus $\varphi[t/x] \sststile{}{V'} \psi[t/x]$.
\end{proof}

\begin{prop}[sym-trans]
The following sequents are derivable:
\begin{align*}
\Gamma = \Gamma' \land E^n_p(\Gamma, x, y) & \sststile{}{\Gamma, \Gamma', x, y} E^n_p(\Gamma', x, y) \\
\Gamma = \Gamma' & \sststile{}{\Gamma, \Gamma', x, y} (\Gamma,x) \cong (\Gamma',y) \\
\Gamma = \Gamma' & \sststile{}{\Gamma, \Gamma'} \Gamma' = \Gamma \\
(\Gamma,x) = (\Gamma',x') & \sststile{}{\Gamma, \Gamma', x, x'} (\Gamma',x') = (\Gamma,x) \\
\Gamma = \Gamma' \land \Gamma' = \Gamma'' & \sststile{}{\Gamma, \Gamma', \Gamma''} \Gamma = \Gamma'' \\
(\Gamma,x) = (\Gamma',x') \land (\Gamma',x') = (\Gamma'',x'') & \sststile{}{\Gamma, \Gamma', \Gamma'', x, x', x''} (\Gamma,x) = (\Gamma'',x'')
\end{align*}
\end{prop}
\begin{proof}
This easily follows from \axref{c2} and \axref{c3'}.
\end{proof}

\subsection{The category of contextual Horn theories}

Here we will define morphisms of contextual Horn theories.
To do this we need to define the notion of premorphisms.

\begin{defn}
Let $\mathbb{T}$ and $\mathbb{T}'$ be well-ordered contextual Horn theories over signatures $\Sigma$ and $\Sigma'$ respectively.
A \emph{premorphism} of these theories is a pair $(\alpha,\beta)$ where $\alpha$ assigns to every $V \in \Set^\mathcal{T}$
a morphism $\alpha_V : PCTerm_\Sigma(F(V)) \to PCTerm_{\Sigma'}(F(V))$
and $\beta$ assigns to every $V \in \Set^\mathcal{T}$ a morphism $\beta_V : CForm_\Sigma(F(V)) \to CForm_{\Sigma'}(F(V))$.
These morphisms must satisfy the following conditions:
\begin{enumerate}
\item \label{con-mor-sig-a-fv}
For every $t \in PCTerm_\Sigma(V)_s$, $FV(\alpha_V(t)) = FV(t)$.
\item \label{con-mor-sig-b-fv}
For every $\varphi \in CForm_\Sigma(V)$, $FV(\beta_V(\varphi)) = FV(\varphi)$.
\item \label{con-mor-sig-a-var}
For every $x \in V_s$, $\alpha_V((\Gamma,x)|_\top) = (\Gamma',x)|_\varphi$,
    where $\Gamma'$ is the empty context and $\varphi = \top$ if $\Gamma$ is empty, and $\Gamma'|_\varphi = \alpha_V(\Gamma|_\top)$ otherwise.
\item \label{con-mor-sig-a-subst}
For every $\rho : A \to CTerm_\Sigma(B)$ and $t \in PCTerm_\Sigma(A)_s$,
    sequents $\sststile{}{B} \alpha_B(t[\rho]) \cong \alpha_A(t)[x \mapsto \alpha_B(\rho(x)|_\top)]$ are theorems of $\mathbb{T}'$.
\item \label{con-mor-sig-b-subst}
For every $\rho : A \to CTerm_\Sigma(B)$ and $\varphi \in CForm_\Sigma(A)_s$,
    sequents $\beta_B(\varphi[\rho]) \allowbreak \ssststile{}{B} \beta_A(\varphi)[x \mapsto \alpha_B(\rho(x)|_\top)]$ are theorems of $\mathbb{T}'$.
\item \label{con-mor-sig-a-op}
For every $(\Gamma,t)|_\varphi \in PCTerm_\Sigma(V)$, if $\alpha_V((\Gamma,t)|_\top) = (\Gamma',t')|_{\varphi'}$ and $\alpha_V(\Gamma|_\top) \allowbreak = \Gamma''|_{\varphi''}$,
    then $\alpha_V((\Gamma,t)|_\varphi) = (\Gamma',t')|_{\varphi' \land \beta_V(\varphi)}$ and $\Gamma' = \Gamma''$.
\item \label{con-mor-sig-b-op}
$\beta_V(\top) = \top$, $\beta_V(\varphi \land \psi) = \beta_V(\varphi) \land \beta_V(\psi)$,
    and $\beta_V(E^n_p(A_1, \ldots A_n, a_1, a_2)) = E^n_p(A_1', \ldots A_n', a_1', a_2') \land \varphi_1 \land \ldots \land \varphi_n \land \psi_1 \land \psi_2$,
    where $\alpha_V(A_1, \ldots A_i) = (\Gamma_i, A_i')|_{\varphi_i}$ and $\alpha_V(A_1, \ldots A_n, \allowbreak a_i) = (\Gamma_i', a_i')|_{\psi_i}$.
\end{enumerate}
\end{defn}

If $f = (\alpha,\beta)$ is a premorphism of theories, $t \in PTerm_\Sigma(V)_s$ and $\varphi \in Form_\Sigma(V)$,
then we will write $f(t)$ for $\alpha_V(t)$ and $f(\varphi)$ for $\beta_V(\varphi)$.

Now we define an equivalence relation on the set of premorphisms of theories $\mathbb{T}$ and $\mathbb{T}'$.
We will say that premorphisms $f$ and $f'$ are equivalent if the following conditions hold:
\begin{enumerate}
\item For every $t \in PCTerm_\Sigma(V)_s$, sequents $\sststile{}{V} f(t) \cong f'(t)$ are theorems of $\mathbb{T}'$.
\label{con-mor-eq-a}
\item For every $\varphi \in CForm_\Sigma(V)$, sequents $f(\varphi) \ssststile{}{V} f'(\varphi)$ are theorems of $\mathcal{T}'$.
\label{con-mor-eq-b}
\end{enumerate}

We will say that a premorphism $f$ of theories $\mathbb{T}$ and $\mathbb{T}'$ \emph{respects} a sequent $\varphi \sststile{}{V} \psi$
if $f(\varphi) \sststile{}{V} f(\psi)$ is a theorem of $\mathbb{T}'$.
A \emph{morphism} of theories $\mathbb{T}$ and $\mathbb{T}'$ is an equivalence class of premorphisms which respect axioms of $\mathbb{T}$.

\begin{prop}
If a premorphism respects all axioms of a theory, then it respects all of its theorems too.
\end{prop}
\begin{proof}
We need to check that application of a premorphism $f$ to sequents respects inference rules.
This is clearly so for rules \axref{b1}-\axref{b6} and \axref{c1}.

Let us prove this for \axref{c2}.
We need to prove that $E^n_p(\Gamma',x,y) \land \psi \land f(\varphi) \sststile{}{V} f(\varphi[y/x])$, where $f(\Gamma) = \Gamma'|_\psi$.
First, note that $f(\varphi[(\Gamma,y)|_\top/x]) \sststile{}{V} f(\varphi[y/x])$, $f(\varphi)[f(\Gamma,y)/x] \sststile{}{V} f(\varphi[(\Gamma,y)|_\top/x])$ by \eqref{con-mor-sig-b-subst},
    and $f(\varphi)[f(\Gamma,y)/x] = f(\varphi)[y/x] \land \psi' \land \bigwedge\limits_{\Gamma'' \in FCV_x(f(\varphi))} \Gamma''[y/x] = \Gamma'$,
    where $\psi'$ equals to either $\psi$ or $\top$.
By \axref{c2}, $E^n_p(\Gamma',x,y) \land f(\varphi) \sststile{}{V} f(\varphi)[y/x]$, and obviously $\psi \sststile{}{V} \psi'$.
Thus we only need to show that $E^n_p(\Gamma',x,y) \land f(\varphi) \sststile{}{V} \Gamma''[y/x] = \Gamma'$ for every $\Gamma'' \in FCV_x(f(\varphi))$.
This follows from \axref{c6} since $E^n_p(\Gamma',x,y) \sststile{}{V} E^n_p(\Gamma',y,y)$, and \rlem{form-subst} implies that $f(\varphi)[y/x] \sststile{}{V} E^n_p(\Gamma''[y/x],y,y)$.

Now, let us consider \axref{c3}.
First, note that \axref{c3} holds for every $t|_\chi \in PCTerm_\Sigma(V')$.
Indeed, $\varphi[t|_\chi/x]$ is equivalent to $\varphi[t/x] \land \chi$, and $\psi[t|_\chi/x]$ is equivalent to either $\psi[t/x]$ or $\psi[t/x] \land \chi$.
In both cases $\varphi[t|_\chi/x] \sststile{}{V'} \psi[t|_\chi/x]$.
Now, if $f(\varphi) \sststile{}{V} f(\psi)$, then $f(\varphi[t/x]) \sststile{}{V'} \varphi[f(t|_\top)/x]$ by \eqref{con-mor-sig-b-subst},
    $\varphi[f(t|_\top)/x] \sststile{}{V'} \psi[f(t|_\top)/x]$ by \axref{c3}, and $\psi[f(t|_\top)/x] \sststile{}{V'} f(\psi[t/x])$ by \eqref{con-mor-sig-b-subst}.

Axioms \axref{c4} and \axref{c5} follows from \rlem{form-subst} if we take $\varphi$ to be equal to either $R(t_1, \ldots x_i, \ldots t_k)$
    or $E^n_p(\Gamma, \sigma(t_1, \ldots x_i, \ldots t_k), \sigma(t_1, \ldots x_i, \ldots t_k))$ respectively.
Finally, \axref{c6} easily follows from \rprop{sym-trans}.
\end{proof}

It is easy to see that premorphisms are closed under composition.
The previous proposition implies that if $f : \mathbb{T}_1 \to \mathbb{T}_2$ and $g : \mathbb{T}_2 \to \mathbb{T}_3$ preserve axioms of $\mathbb{T}_1$ and $\mathbb{T}_2$ respectively,
then $g \circ f$ preserves axioms of $\mathbb{T}_1$.
It is easy to see that composition of premorphisms respects the equivalence relation.
Hence this defines a category of contextual Horn theories which we denote by $\CTh$.

\begin{prop}[con-mor-def]
Suppose that there is a function $|-|$ that to each $\sigma \in \mathcal{F}$ assigns an ordinal $|\sigma|$ such that if some $\tau$ appears in $D_i(\sigma)$, then $|\tau| < |\sigma|$.
Moreover, suppose that for every $\sigma \in \mathcal{F}$, $FV(D_i(A_1, \ldots A_n, \sigma(x_1, \ldots x_k))) \subseteq \{ A_1, \ldots A_n, x_1, \ldots x_{i-1} \}$.
Then to construct a premorphism of theories $\mathbb{T}$ and $\mathbb{T}'$ it is enough to specify the following data:
\begin{itemize}
\item For every $\sigma \in \mathcal{F}$, $\sigma : s_1 \times \ldots \times s_k \to s$,
    a partial contextual term $\alpha(\sigma) \in PCTerm_{\Sigma'}(\{ A_1 : (ty,0), \ldots A_{d(s)} : (ty,d(s)-1), x_1 : s_1, \ldots x_k : s_k \})$
    such that $FV(\alpha(\sigma)) = \{ A_1, \ldots A_{d(s)}, x_1, \ldots x_k \}$.
\item For every $R \in \mathcal{P}$, $R : s_1 \times \ldots \times s_k$,
    a contextual formula $\beta(R) \in CForm_{\Sigma'}(\{ x_1 : s_1, \ldots x_k : s_k \})$ such that $FV(\beta(R)) = \{ x_1, \ldots x_k \}$.
\end{itemize}
Then there is a premorphism $f$ of these theories such that
$\alpha(\sigma) = f(A_1, \ldots A_{d(s)}, \allowbreak \sigma(x_1, \ldots x_k))$ and $\beta(R) = f(R(x_1, \ldots x_k))$.
\end{prop}
\begin{proof}
Let us define a function $|-|$ on the set of contextual terms.
We let $|(\Gamma,t)|$ to be equal to supremum of the set of ordinals $|\sigma|$ for each $\sigma$ that appears in $(\Gamma,t)$.
We construct $f(\Gamma,t)$ by induction on $|(\Gamma,t)|$.
First, we define a function $f'(\Gamma,t)$ for $(\Gamma,t)$ such that $|\Gamma| < |t|$.
We construct $f'(\Gamma,t)$ by induction on $t$.
If $t$ is a variable and $f'(\Gamma) = \Gamma'|_\varphi$, then let $f'(\Gamma,t) = (\Gamma',t)|_\varphi$.
If $t = \sigma(t_1, \ldots t_k)$, then let \todo{Replace $a_j'$ with $(\Gamma_j,a_j')|_{\varphi_j}$?} $f'(\Gamma,t) = \alpha(\sigma)[A_i \mapsto B_i, x_j \mapsto a_j']$,
    where $\Gamma = B_1, \ldots B_n$ and $f(D_i(\Gamma,\sigma(x_1, \ldots x_n)),a_i)[x_1 \mapsto a_1', \ldots x_{i-1} \mapsto a_{i-1}'] = (\Gamma_i,a_i')|_{\varphi_i}$.
Now, we can define $f(\Gamma,t)$ by induction on the length of $\Gamma$ as follows: $f(\Gamma,t) = f'(x_1, \ldots x_n, t)[x_i \mapsto f(A_1, \ldots A_i)]$.

First, let us extend $\alpha$ to a morphism $CTerm_\mathcal{F}(V) \to PCTerm_{\Sigma'}(V)$.
By conditions \eqref{mor-sig-a-var} and \eqref{mor-sig-a-subst} it can be done in a unique way:
\begin{align*}
\alpha_V(x) & = x \\
\alpha_V(\sigma(a_1, \ldots a_n)) & = \alpha(\sigma)[x_i \mapsto \alpha_V(a_i)]
\end{align*}
Second, we extend $\beta$ to a morphism $Form_\Sigma(V) \to Form_{\Sigma'}(V)$.
By conditions \eqref{mor-sig-b-subst} and \eqref{mor-sig-b-op} it can be done in a unique way:
\begin{align*}
\beta_V(a = b) & = \alpha_V(a) = \alpha_V(b) \\
\beta_V(R(a_1, \ldots a_n)) & = \beta(R)[x_i \mapsto \alpha_V(a_i)] \\
\beta_V(\varphi_1 \land \ldots \land \varphi_n) & = \beta_V(\varphi_1) \land \ldots \land \beta_V(\varphi_n)
\end{align*}
Now, we can extend $\alpha_V$ to a morphism $PTerm_\Sigma(V) \to PTerm_{\Sigma'}(V)$.
By condition \eqref{mor-sig-a-op} it can be done in a unique way:
\[ \alpha_V(t|_\varphi) = \alpha_V(t)|_{\beta_V(\varphi)} \]

Conditions \eqref{mor-sig-a-fv} and \eqref{mor-sig-b-fv} follows from the conditions on $FV(\alpha(\sigma))$ and $FV(\beta(R))$.
Conditions \eqref{mor-sig-a-var}, \eqref{mor-sig-a-op} and $\eqref{mor-sig-b-op}$ hold by the definitions of $\alpha_V$ and $\beta_V$.
Conditions \eqref{mor-sig-a-subst} and $\eqref{mor-sig-b-subst}$ are easy to check by induction on the term and on the formula respectively.
\end{proof}

\begin{prop}[con-mor-eq]
Let $\mathbb{T}$ and $\mathbb{T}'$ be theories over $\Sigma$ and $\Sigma'$ respectively.
Morphisms $f$ and $f'$ between $\mathbb{T}$ and $\mathbb{T}'$ are equivalent if and only if the following conditions hold:
\begin{itemize}
\item For every $\sigma \in \mathcal{F}$, $\sigma : s_1 \times \ldots \times s_k \to s$ sequents
\[ \sststile{}{\Gamma, x_1, \ldots x_k} f(\Gamma, \sigma(x_1, \ldots x_k)) \cong f'(\Gamma, \sigma(x_1, \ldots x_k)) \]
are theorems of $\mathbb{T}'$.
\item For every $R \in \mathcal{P}$, $R \neq E^n_p$, $R : s_1 \times \ldots \times s_k$ sequents
\[ f(R(x_1, \ldots x_k)) \ssststile{}{x_1, \ldots x_k} f'(R(x_1, \ldots x_k)) \]
are theorems of $\mathbb{T}'$.
\end{itemize}
\end{prop}
\begin{proof}
The ``only if'' direction is obvious.
Let us prove the converse.
First, we prove \eqref{con-mor-eq-a} for $(\Gamma,t) \in CTerm_\mathcal{F}(V)_s$ by induction on $t$.
If $t$ is a variable, then $f(t) = f'(t) = t$.
If $t = \sigma(t_1, \ldots t_n)$, then $\sststile{}{V} f(t_i) \cong f(t'_i)$
and $\sststile{}{x_1 : s_1, \ldots x_n : s_n} f(\sigma(x_1, \ldots x_n)) \cong f'(\sigma(x_1, \ldots x_n))$.
Since $FV(f(\sigma(x_1, \ldots x_n))) = \{ x_1, \ldots x_n\}$, by \axref{a3} we have
$f(t)\!\downarrow\,\sststile{}{V} f(t) = f'(\sigma(x_1, \ldots x_n))[x_i \mapsto \alpha_V(t_i)]$.
We also have $f(t)\!\downarrow\,\sststile{}{V} f(t_i)\!\downarrow$, hence by \rlem{cong-a}
$f(t)\!\downarrow\,\sststile{}{V} f'(\sigma(x_1, \ldots x_n))[x_i \mapsto f(t_i)] = f'(t)$.
By transitivity, we conclude that $f(t)\!\downarrow\,\sststile{}{V} f(t) = f'(t)$.
The same argument shows that $f'(t)\!\downarrow\,\sststile{}{V} f(t) = f'(t)$.

Let us prove \eqref{mor-eq-b}.
It is enough to prove it for atomic formulae $\varphi$.
If $\varphi$ equals to $t = t'$, then $f(\varphi)$ equals to $f(t) = f(t')$ and $f'(\varphi)$ equals to $f'(t) = f'(t')$.
We know that $\sststile{}{V} f(t) \cong f'(t)$ and $\sststile{}{V} f(t') \cong f'(t')$.
Thus by transitivity and symmetry we can conclude that $f(t) = f(t)' \sststile{}{V} f'(t) = f'(t')$.

If $\varphi = R(t_1, \ldots t_n)$, then $f(\varphi) = f(R(x_1, \ldots x_n))[x_i \mapsto f(t_i)]$
and $f'(\varphi) = f'(R(x_1, \ldots x_n))[x_i \mapsto f'(t_i)]$.
We know that $f(R(x_1, \ldots x_n)) \sststile{}{x_1 : s_1, \ldots x_n : s_n}$ \linebreak $f'(R(x_1, \ldots x_n))$.
Since $FV(f(R(x_1, \ldots x_n))) = \{ x_1, \ldots x_n \}$, by \axref{a3} we can conclude that $f(\varphi) \sststile{}{V} f'(R(x_1, \ldots x_n))[x_i \mapsto f(t_i)]$.
Since $f'(R(x_1, \ldots x_n))[x_i \mapsto f(t_i)] \sststile{}{V} f(t_i)\!\downarrow$, \rlem{cong-b} implies that
$f'(R(x_1, \ldots x_n))[x_i \mapsto f(t_i)] \sststile{}{V} f'(\varphi)$.
By \axref{b2} we conclude that $f(\varphi) \sststile{}{V} f'(\varphi)$.
The same argument shows that $f'(\varphi) \sststile{}{V} f(\varphi)$.

Now, we can finish the proof of \eqref{mor-eq-a}.
We need to prove that $\sststile{}{V} f(t|_\varphi) \cong f'(t|_\varphi)$.
We already saw that $f(t)\!\downarrow\,\sststile{}{V} f(t) = f'(t)$ and $f(\varphi) \sststile{}{V} f'(\varphi)$.
Hence $f(t)\!\downarrow \land f(\varphi) \sststile{}{V} f(t) = f'(t) \land f'(\varphi)$.
The same argument shows that $f'(t)\!\downarrow \land f'(\varphi) \sststile{}{V} f(t) = f'(t) \land f(\varphi)$.
\end{proof}

\section{Functors between algebraic and contextual theories}

In this section we construct a fully faithful functor $F : \woCTh \to \mathbb{T}_0/\ThT$
    from a full subcategory of the category of contextual Horn theories to the category of algebraic type theories.

\subsection{From contextual to algebraic theories}

We will need an additional assumption on contextual theories.
We assume that there is a function $|-|$ that to each $\sigma \in \mathcal{F}$ assigns an ordinal $|\sigma|$ such that if some $\tau$ appears in $D_i(\sigma)$, then $|\tau| < |\sigma|$.
Moreover, we suppose that for every $\sigma \in \mathcal{F}$, $FV(D_i(A_1, \ldots A_n, \sigma(x_1, \ldots x_k))) \subseteq \{ A_1, \ldots A_n, x_1, \ldots x_{i-1} \}$.
A \emph{well-ordered contextual theory} is a contextual Horn theory with such function satisfying these assumptions.
For every well-ordered contextual theory we can define a function $|-|$ on the set of contextual terms of this theory.
We let $|(\Gamma,t)|$ to be equal to the supremum of the set of ordinals $|\sigma|$ for each $\sigma$ that appears in $(\Gamma,t)$.
A contextual theory is \emph{well-orderable} if there exists such function.
The full subcategory of $\CTh$ on well-orderable theories is denoted by $\woCTh$.

For every well-ordered contextual theory $\mathbb{T} = ((\mathcal{T},\mathcal{F},\mathcal{P}),\mathcal{A})$ we define algebraic type theory $F(\mathbb{T})$.
For every function symbols $\sigma \in \mathcal{F}$, $\sigma : s_1 \times \ldots \times s_k \to s$,
    theory $F(\mathbb{T})$ has function symbol $\sigma : e(s) \times s_1 \times \ldots \times s_k \to s$,
    where $e(tm,n) = (ctx,n+1)$ and $e(ty,n) = (ctx,n)$.
Also $F(\mathbb{T})$ has function symbols of $\mathbb{T}_0$.
The set of predicate symbols of $F(\mathbb{T})$ equals to $\mathcal{P}$ without symbols $E^n_p$.

For every (partial) contextual term $w$ of $\mathbb{T}$ we define a partial term $F(w)$ of $F(\mathbb{T})$ of the same sort as $w$.
We construct $F(w)$ by induction on $|w|$.
First, we define a function $F'(\Gamma,t)$ for $(\Gamma,t)$ such that either $|\Gamma| < |w|$ and $|t| \leq |w|$ or $|(\Gamma,t)| = 0$.
If $|(\Gamma,t)| = 0$, then $(\Gamma,t)$ consists only of variables, and we let $F'(x_1, \ldots x_n) = x_n|_{e(x_1) = * \land \ldots \land e(x_n) = x_{n-1}}$.
If $|(\Gamma,t)| > 0$, then we construct $F'(\Gamma,t)$ by induction on $t$.
If $t$ is a variable and $F(\Gamma) = \Gamma'|_\varphi$, then let $F'(\Gamma,t) = t|_{\varphi \land e(t) = \Gamma'}$.
If $t = \sigma(t_1, \ldots t_k)$, then let $F'(\Gamma,t) = \sigma(\Gamma', t_1', \ldots t_k')|_{\varphi \land \varphi_1 \land \ldots \land \varphi_k}$,
    where $F(\Gamma) = \Gamma'|_\varphi$ and $F'(D_i(\Gamma,\sigma(x_1, \ldots x_k)), t_i)[x_1 \mapsto t_1', \ldots x_{i-1} \mapsto t_{i-1}'] = t_i'|_{\varphi_i}$.
Now, we can define $F(\Gamma,t)$ as follows: $F(A_1, \ldots A_n, t) = F'(x_1, \ldots x_n, t)[x_n \mapsto F'(x_1, \ldots x_{n-1}, A_n)] \ldots \allowbreak [x_1 \mapsto F'(A_1)]$.
If $\Gamma = \Gamma',t$, then let $F(\Gamma) = F(\Gamma',t)$, and if $\Gamma$ is the empty context, then let $F(\Gamma) = *$.

Let $\varphi$ be a formula of $\mathbb{T}$, then we define a formula $F(\varphi)$ of $F(\mathbb{T})$ as follows:
\begin{align*}
F(\varphi_1 \land \ldots \land \varphi_k) & = F(\varphi_1) \land \ldots \land F(\varphi_k) \\
F(E^n_p(\Gamma, a, a')) & = (F(\Gamma, a) = F(\Gamma, a')) \\
F(R(t_1, \ldots t_k)) & = R(t_1', \ldots t_k') \text{, where $t_i' = F(D_i(R(t_1, \ldots t_k)), t_i)$}
\end{align*}
For every partial contextual term $t|_\varphi$, we let $F(t|_\varphi)$ to be equal to $F(t)|_{F(\varphi)}$.

Axioms of $F(\mathbb{T})$ are axioms of $\mathbb{T}_0$, sequents of the form $F(\varphi) \sststile{}{V} F(\psi)$
    for every axiom $\varphi \sststile{}{V} \psi$ of $\mathbb{T}$, and the following sequents:
\begin{align*}
\sigma(\Gamma, x_1, \ldots x_k)\!\downarrow & \sststile{}{\Gamma, x_1, \ldots x_k} e(\sigma(\Gamma, x_1, \ldots x_k)) = \Gamma \axtag{f1} \\
\sigma(\Gamma, x_1, \ldots x_k)\!\downarrow & \sststile{}{\Gamma, x_1, \ldots x_k} e(x_i) = F(D_i(\Delta, \sigma(x_1, \ldots x_k)))[\rho] \axtag{f2} \\
R(x_1, \ldots x_k) & \sststile{}{x_1, \ldots x_k} e(x_i) = F(D_i(R(x_1, \ldots x_k))) \axtag{f3}
\end{align*}
where $\Delta = y_1, \ldots y_n$ for some fresh variables $y_1, \ldots y_n$, and $\rho(y_i) = ft^{n-i}(\Gamma)$.
Here, if $t$ has sort $(tm,n)$, then $e(t) = ty(t)$, and if $t$ has sort $(ctx,n+1)$, then $e(t) = ft(t)$.

To show that $F$ is a functor we need to establish a few technical lemmas.

\begin{lem}[F-basic]
The following is true:
\begin{enumerate}
\item \label{F-FV}
For every $t \in CTerm_\Sigma(V)$, $FV(F(t)) = FV(t)$.
\item \label{F-F'}
For every $(A_1, \ldots A_n, t) \in CTerm_\Sigma(V)$, $F(A_1, \ldots A_n, t) = F'(x_1, \ldots x_n, t) \allowbreak [x_1 \mapsto F(A_1), \ldots x_n \mapsto F(A_1, \ldots A_n)]$.
\end{enumerate}
\end{lem}
\begin{proof}
This follows immediately from the definition of $F$.
\end{proof}

\begin{lem}[F-e]
For every $(\Gamma,t) \in CTerm_\Sigma(V)$, sequent $F(\Gamma,t)\!\downarrow\ \sststile{}{V} e(F(\Gamma,t)) = F(\Gamma)$ is a theorem of $F(\mathbb{T})$.
\end{lem}
\begin{proof}
It is enough to prove that sequent $F'(x_1, \ldots x_n, t)\!\downarrow\ \sststile{}{V} e(F'(x_1, \ldots x_n, t)) = x_n$ is derivable.
Indeed, the claim then follows from \rlem{F-basic}~\eqref{F-FV}, \axref{a3}, and \rlem{F-basic}~\eqref{F-F'}.

If $t$ is a variable, then the claim follows from the definition of $F'$.
If $t = \sigma(t_1, \ldots t_k)$, then $F'(x_1, \ldots x_n, \sigma(t_1, \ldots t_k)) = \sigma(F(x_1, \ldots x_n), t_1', \ldots t_k')$.
By \axref{f1}, $F'(x_1, \ldots x_n, t)\!\downarrow\ \sststile{}{V} e(F'(x_1, \ldots x_n, t)) = F(x_1, \ldots x_n)$.
By the definition of $F$, $F(x_1, \ldots x_n)\!\downarrow\ \sststile{}{V} F(x_1, \ldots x_n) = x_n$.
The claim follows by transitivity.
\end{proof}

The following propositions show that $F$ preserves substitution and inference rules.

\begin{prop}[F-subst]
For every $(\Gamma,t) \in CTerm_\Sigma(U)$ and every partial function $\rho : U \to CTerm_\Sigma(V)$,
    sequents $\sststile{}{V} F(\Gamma,t)[x \mapsto F(\rho(x))] \cong F((\Gamma,t)[\rho])$ are theorems of $F(\mathbb{T})$.
\end{prop}
\begin{proof}
The proof is by induction on $|t|$.
Let us write $\rho'$ for the following partial function: $\rho'(x) = F(\rho(x))$
First, let us prove that for every $(\Gamma,t)$ such that $F'(\Gamma,t)$ is defined,
    sequents $\sststile{}{V} F'(\Gamma,t)[\rho'] \cong F((\Gamma,t)[\rho])$ are derivable.

If $t$ is a varaible, then $F'(\Gamma,t) = t|_{e(t) = F(\Gamma)}$.
By \rlem{F-basic}~\eqref{F-F'} and \rlem{F-e}, $\sststile{}{V} F(\Gamma,t) \cong F'(x_1, \ldots x_n, t)[x_i \mapsto ft^{n-i}(F(\Gamma))]$ is derivable for every $t$.
It follows that $\sststile{}{V} F(\Gamma,t) \cong t|_{e(t) = F(\Gamma)}$ is derivable if $t$ is a variable.
If $\rho(t)$ is not defined, then $F'(\Gamma,t)[\rho'] = t|_{e(t) = F(\Gamma)[\rho']}$ and $\sststile{}{V} F((\Gamma,t)[\rho]) \cong t|_{e(t) = F(\Gamma[\rho])}$.
Thus the assertion holds by induction hypothesis.

If $\rho(t) = (\Gamma',t')$, then on the one hand
\[ F((\Gamma,t)[\rho]) = F((\Gamma[\rho],t')|_{\Gamma[\rho] = \Gamma'}) = F(\Gamma[\rho],t')|_{F(\Gamma[\rho] = \Gamma')}. \]
On the other hand,
\[ F'(\Gamma,t)[\rho'] = F(\Gamma',t')|_{e(F(\Gamma',t')) = F(\Gamma)[\rho']}. \]
Hence $\sststile{}{V} F'(\Gamma,t)[\rho'] \cong F(\Gamma',t')|_{F(\Gamma') = F(\Gamma)[\rho']}$.
By induction hypothesis $\sststile{}{V} F'(\Gamma,t)[\rho'] \cong F(\Gamma',t')|_{F(\Gamma[\rho]) = F(\Gamma')}$.
To prove that partial terms $F(\Gamma[\rho],t')|_{F(\Gamma[\rho] = \Gamma')}$ and $F(\Gamma',t')|_{F(\Gamma[\rho]) = F(\Gamma')}$ are equivalent,
    we need to show that $F(\Gamma[\rho] = \Gamma')$ and $F(\Gamma[\rho]) = F(\Gamma')$ are equivalent and that
    $F(\Gamma[\rho],t')\!\downarrow \land\ F(\Gamma[\rho]) = F(\Gamma') \sststile{}{V} F(\Gamma[\rho],t') = F(\Gamma',t')$.
First, note that by \rlem{F-e}, $F(A_1, \ldots A_n) = F(A_1', \ldots A_n') \allowbreak \sststile{}{V} F(A_1, \ldots A_i) = F(A_1', \ldots A_i')$ for every $i \leq n$.
The second assertion now follows from \rlem{F-basic}~\eqref{F-F'}.
The first assertion follows from the second one.

Now, let us consider the case $t = \sigma(t_1, \ldots t_k)$.
On the one hand,
\[ F'(\Gamma,t)[\rho'] = \sigma(F(\Gamma)[\rho'], t_1', \ldots t_k'), \]
    where $t_i' = F'(D_i(\Gamma, \sigma(y_1, \ldots y_k)), t_i)[\rho'][y_1 \mapsto t_1', \ldots y_{i-1} \mapsto t_{i-1}']$.
On the other hand, by \rlem{F-basic}~\eqref{F-F'}, \rlem{F-e} and induction hypothesis,
\[ \sststile{}{V} F((\Gamma,t)[\rho]) \cong \sigma(F(\Gamma[\rho]), t_1'', \ldots t_k''), \]
    where $t_i'' = F'(D_i(\Gamma[\rho], \sigma(y_1, \ldots y_k)), t_i[\rho])[y_1 \mapsto t_1'', \ldots y_{i-1} \mapsto t_{i-1}'']$.
By induction hypothesis, sequents $\sststile{}{V} t_i' \cong t_i''$ are derivable.
Thus we proved that sequents $\sststile{}{V} F'(\Gamma,t)[\rho'] \cong F((\Gamma,t)[\rho])$ are derivable.

Now, we can finish the proof of the proposition.
We do this by induction on the length of $\Gamma$.
By \rlem{F-basic}~\eqref{F-F'} and induction hypothesis, we have
$\sststile{}{V} F(A_1, \ldots A_n, t)[\rho'] \cong F(x_1, \ldots x_n, t[\rho])[x_1 \mapsto F(A_1[\rho]), \ldots x_n \mapsto F(A_1[\rho], \ldots A_n[\rho])]$.
For every $x_1$, \ldots $x_n$ and $t$, we have
\[ \sststile{}{V} F(x_1, \ldots x_n, t) \cong F'(x_1, \ldots x_n, t)|_{ty(x_n) = x_{n-1} \land \ldots \land ty(x_2) = x_1}. \]
Thus $\sststile{}{V} F(A_1, \ldots A_n, t)[\rho'] \cong F(A_1[\rho], \ldots A_n[\rho], t[\rho])|_{\varphi_{n-1} \land \ldots \land \varphi_1}$,
    where $\varphi_i$ equals to $ty(F(A_1[\rho], \ldots A_{i+1}[\rho])) = F(A_1[\rho], \ldots A_i[\rho])$.
By \rlem{F-e}, $F(A_1[\rho], \ldots A_n[\rho], \allowbreak t[\rho]) \sststile{}{V} \varphi_i$ for every $1 \leq i \leq n-1$.
Hence sequent $\sststile{}{V} F(A_1, \ldots A_n, t)[\rho'] \cong F((A_1, \ldots A_n, t)[\rho])$ is derivable.
\end{proof}

\begin{prop}[F-ax]
If $\varphi \sststile{}{V} \psi$ is a theorem of $\mathbb{T}$, then $F(\varphi) \sststile{}{V} F(\psi)$ is a theorem of $F(\mathbb{T})$.
\end{prop}
\begin{proof}
We need to prove that $F(-)$ preserves inference rules.
This is clearly true for rules \axref{b1}-\axref{b6} and \axref{c1}.
Axiom \axref{c3} follows from \rlem{F-basic}~\eqref{F-FV} and \rprop{F-subst}.

If $R \neq E^n_p$, then \axref{c4} follows from \axref{a4}.
If $R = E^n_p(t_1, \ldots t_n, t_{n+1}, t_{n+2})$ and either $i = n+1$ or $i = n+2$, then \axref{c4} follows from \axref{a4'}.
If $i < n+1$, then \rlem{F-basic} \eqref{F-FV} and \eqref{F-F'} imply that $F(t_1, \ldots t_n, t')\!\downarrow\ \sststile{}{V} F(t_1, \ldots t_i)\!\downarrow$ is derivable.

Let us consider \axref{c5}.
By \rlem{F-basic}~\eqref{F-F'}, $F(A_1, \ldots A_n, \sigma(t_1, \ldots t_k)) = \sigma(\Gamma', t_1', \ldots t_k')$, where
    $t_i'|_{\varphi_i} = F(D_i(x_1, \ldots x_n, \sigma(y_1, \ldots y_k)), t_i)[y_1 \mapsto t_1', \ldots y_{i-1} \mapsto t_{i-1}'][x_1 \mapsto F(A_1), \ldots x_n \mapsto F(A_1, \ldots A_n)]$.
By \axref{a5}, $F(A_1, \ldots A_n, \sigma(t_1, \ldots t_k))\!\downarrow\ \sststile{}{V} t_i'|_{\varphi_i}\!\downarrow$.
By \rprop{F-subst}, $t_i'|_{\varphi_i}\!\downarrow\ \sststile{}{V} F(D_i(A_1, \ldots A_n, \sigma(t_1, \ldots t_k)), t_i)$.

By \rlem{F-basic}~\eqref{F-F'} and \rlem{F-e},
\[ F(A_1, \ldots A_n, x) = x|_{ft(F(A_1)) = * \land \ldots \land ft(F(A_1, \ldots A_n)) = F(A_1, \ldots A_{n-1}) \land e(x) = F(A_1, \ldots A_n)}. \]
In particular, $F(\Gamma,x)\!\downarrow\ \sststile{}{V} e(x) = F(\Gamma)$.
Axiom \axref{c6} follows by transitivity.
To prove that \axref{c2} holds, note that $F(\Gamma,x) = F(\Gamma,y) \sststile{}{V} x = y$ and $F(\varphi[y/x]) = F(\varphi)[y/x]$.
Then \axref{c2} follows from \axref{a2}.
\end{proof}

Now, we can show how $F$ is defined on morphisms.
If $f : \mathbb{T} \to \mathbb{T}'$ is a premorphism of contextual theories, then we define a morphism $F(f)$ of theories $F(\mathbb{T})$ and $F(\mathbb{T}')$.
By \rprop{mor-def}, the following equalities uniquely define a morphism of signatures:
\begin{align*}
F(f)(*) & = * \\
F(f)(ty(x)) & = ty(x) \\
F(f)(ft(x)) & = ft(x) \\
F(f)(\sigma(\Gamma, y_1, \ldots y_k)) & = F(f(x_1, \ldots x_n, \sigma(y_1, \ldots y_k)))|_{\Gamma\downarrow}[x_i \mapsto ft^{n-i}(\Gamma)] \\
F(f)(R(x_1, \ldots x_k)) & = F(f(R(x_1, \ldots x_k)))
\end{align*}
Propositions \nprop{mor-eq} and \nprop{F-ax} imply that if $f$ and $f'$ are equivalent, then $F(f)$ and $F(f')$ are also equivalent.
Thus $F$ is well-defined on morphisms of contextual theories.

\begin{lem}
For every partial contextual term $t$, every contextual formula $\varphi$, and every premorphism of theories $f$,
    sequents $\sststile{}{V} F(f)(F(t)) \cong F(f(t))$ and $F(f)(F(\varphi)) \ssststile{}{V} F(f(\varphi))$ are derivable.
\end{lem}
\begin{proof}
First, let us prove that for every contextual term $(\Gamma,t)$, sequents $\sststile{}{V} F(f)(F(\Gamma,t)) \cong F(f(\Gamma,t))$ are derivable.
We do this by induction on $|(\Gamma,t)|$.
\end{proof}

\begin{lem}
$F$ is a functor.
\end{lem}
\begin{proof}
TODO: We need to check that $F(f)$ preserves axioms and that $F$ preserves identity and composition.
\end{proof}

\subsection{From algebraic to contextual theories}

To prove that $F$ is fully faithful, we need to describe a construction of contextual terms and formulae from algebraic ones.
For every algebraic type theory $\mathbb{T} = ((\mathcal{T},\mathcal{F},\mathcal{P}),\mathcal{A})$ we define contextual theory $C(\mathbb{T})$.
Theory $C(\mathbb{T})$ has the same function symbols and predicate symbols as $\mathbb{T}$ together with predicate symbols $E^n_p$.
For every term $t$ of $\mathbb{T}$ we define a contextual term $C(t)$ of $C(\mathbb{T})$ as follows:
\[ C(t) =
  \begin{cases}
      (ft^n(t), \ldots ft(t), t) & \text{if } t : (ty,n) \\
      (ft^n(ty(t)), \ldots ft(ty(t)), ty(t), t) & \text{if } t : (tm,n)
  \end{cases}
\]
For every formula $\varphi$ of $\mathbb{T}$ we define a contextual formula $C(\varphi)$ of $C(\mathbb{T})$ as follows:
\begin{align*}
C(R(t_1, \ldots t_k)) & = R(t_1, \ldots t_k) \\
C(t = t') & = (C(t) = C(t'))
\end{align*}

For every $\sigma \in \mathcal{F}$ and $R \in \mathcal{P}$, contexts $D_i(A_1, \ldots A_n, \sigma(x_1, \ldots x_k))$ and $D_i(R(x_1, \ldots x_k))$ are defined as the context of $C(x_i)$.
Axioms of $C(\mathbb{T})$ are sequents of the form $C(\varphi) \sststile{}{V} C(\psi)$ for every axiom $\varphi \sststile{}{V} \psi$ of $\mathbb{T}$
    together with sequent $\sststile{}{x} C(x) = C(x)$.

\begin{lem}
If $\varphi \sststile{}{V} \psi$ is a theorem of $\mathbb{T}$, then $C(\varphi) \sststile{}{V} C(\psi)$ is a theorem of $C(\mathbb{T})$.
\end{lem}
\begin{proof}
To prove tihs we need to show that $C(-)$ preserves inference rules.
This is clearly true for rules \axref{b1}-\axref{b6}.
This is true for \axref{a1} since we added corresponding axiom to $C(\mathbb{T})$.

Note that $C(-)$ preserves substitution, that is $C(t[\rho]) = C(t)[\rho]$ and $C(\varphi[\rho]) = C(\varphi)[\rho]$ for every term $t$ and every formula $\varphi$.
It follows that $C(-)$ preserves \axref{a2} by \axref{c2}.
Note that for every every formula $\varphi$ of $C(\mathbb{T})$ and every variable $x$ the set $FCV_x(\varphi)$ consists of a single context.
It follows that $C(-)$ preserves \axref{a3} by \axref{c3'}.
\end{proof}

\label{sec:T1}
\section{Theory $\mathbb{T}_1$}

\todo{Add a reference to B-systems}

In this section we will describe a quasi-equational theory $\mathbb{T}_1$ and prove that the category of models of $\mathbb{T}_1$ is equivalent to the category of contextual categories.
Later we will use this theory to define algebraic type theories.

The set of function symbols of $\mathbb{T}_1$ consists of the symbols of $\mathbb{T}_0$ and the following symbols:
\begin{align*}
v_{n,i}       & : (ctx,n) \to (tm,n) \text{, } 0 \leq i < n \\
subst_{p,n,k} & : (ctx,n) \times (p,k) \times (tm,n)^k \to (p,n) \text{, } p \in \{ tm, ty \}
\end{align*}

Auxiliary predicates $Hom_{n,k} : (ctx,n) \times (ctx,k) \times (tm,n)^k$ are defined as follows: $Hom_{n,k}(B, A, a_1, \ldots a_k)$ holds if and only if
\[ ty_n(a_i) = subst_{ty,n,i-1}(B, ft^{k-i}_i(A), a_1, \ldots a_{i-1}) \text{ for each } 1 \leq i \leq k \]
The idea is that a tuple of terms should represent a morphism in a contextual category.
So $Hom_{n,k}(B, A, a_1, \ldots a_k)$ holds if and only if $(a_1, \ldots a_k)$ is a morphism with domain $A$ and codomain $B$.
Note that if $Hom_{n,k}(B, A, a_1, \ldots a_k)$, then $ft_n(ty_n(a_i)) = B$.

The set of axioms of $\mathbb{T}_1$ consists of the axioms of $\mathbb{T}_0$ and the axioms we list below.
The following axioms describe when functions are defined:
\begin{align}
\label{ax:def-var}
                                             & \sststile{}{A}           v_{n,i}(A) \downarrow \\
\label{ax:def-Subst}
Hom_{n,k}(B, ft_k(A), a_1, \ldots a_k)       & \ssststile{}{B, A, a_i}  subst_{ty,n,k}(B, A, a_1, \ldots a_k) \downarrow \\
\label{ax:def-subst}
Hom_{n,k}(B, ft_k(ty_k(a)), a_1, \ldots a_k) & \ssststile{}{B, a, a_i}  subst_{tm,n,k}(B, a, a_1, \ldots a_k) \downarrow
\end{align}

The following axioms describe the ``typization'' of the constructions we have:
\begin{align}
\label{ax:type-var}
& \sststile{}{A}         ty_n(v_{n,i}(A)) = Subst_{n,n-i-1}(A, ft^i_{n-i}(A), v_{n,n-1}(A), \ldots v_{n,i+1}(A)) \\
\label{ax:type-Subst}
& \sststile{}{B, A, a_i} ft_n(Subst_{n,k}(B, A, a_1, \ldots a_k)) \leftrightharpoons B \\
\label{ax:type-subst}
& \sststile{}{B, a, a_i} ty_n(subst_{n,k}(B, a, a_1, \ldots a_k)) \leftrightharpoons Subst_{n,k}(B, ty_k(a), a_1, \ldots a_k)
\end{align}

The following axioms prescribe how substitution ($Subst_{n,k}$ and $subst_{n,k}$) must be defined on indices ($v_{n,i}$):
\begin{align}
\label{ax:Subst-var}
& \sststile{}{A}         Subst_{n,n}(ft_n(A), A, v_{n,n-1}(ft_n(A)), \ldots v_{n,0}(ft_n(A))) = A \\
\label{ax:subst-var}
& \sststile{}{a}         subst_{n,n}(ft_n(ty_n(a)), a, v_{n,n-1}(ft_n(ty_n(a))), \ldots v_{n,0}(ft_n(ty_n(a)))) = a \\
\label{ax:var-subst}
& Hom_{n,k}(B, A, a_1, \ldots a_k) \sststile{}{B, a_i, A} subst_{n,k}(B, v_{k,i}(A), a_1, \ldots a_k) = a_{k-i}
\end{align}

The following axioms say that substitution must be ``associative'':
\begin{align}
\label{ax:Subst-Subst}
& Hom_{n,k}(C, B, b_1, \ldots b_k) \land Hom_{k,m}(B, ft_m(A), a_1, \ldots a_m) \sststile{}{C, b_i, B, a_i, A} \\ \notag
& Subst_{n,k}(C, Subst_{k,m}(B, A, a_1, \ldots a_m), b_1, \ldots b_k) = \\ \notag
& Subst_{n,m}(C, A, subst_{n,k}(C, a_1, b_1, \ldots b_k), \ldots subst_{n,k}(C, a_m, b_1, \ldots b_k)) \\
\label{ax:subst-subst}
& Hom_{n,k}(C, B, b_1, \ldots b_k) \land Hom_{k,m}(B, ft_m(ty_m(a)), a_1, \ldots a_m) \sststile{}{C, b_i, B, a_i, a} \\ \notag
& subst_{n,k}(C, subst_{k,m}(B, a, a_1, \ldots a_m), b_1, \ldots b_k) = \\ \notag
& subst_{n,m}(C, a, subst_{n,k}(C, a_1, b_1, \ldots b_k), \ldots subst_{n,k}(C, a_m, b_1, \ldots b_k))
\end{align}

Now, we want to show that the category of models of $\mathbb{T}_1$ is equivalent to the category of contextual categories.
First, we construct a functor $F : \Mod{\mathbb{T}_1} \to \ccat$.
Let $M$ be a model of $\mathbb{T}_1$.
Then the set of objects of level $n$ of $F(M)$ is $M(Ctx_n)$.
For each $A \in M(Ctx_n)$, $B \in M(Ctx_k)$ morphisms from $A$ to $B$ are tuples $(a_1, \ldots a_k)$ such that $a_i \in M(Tm_n)$ and $Hom_{n,k}(A, B, a_1, \ldots a_k)$.

For each $0 \leq i \leq n$ axiom~\eqref{ax:type-var} implies
\[ \sststile{}{A} Hom_{n,n-i}(A, ft^i_{n-i}(A), v_{n,n-1}(A), \ldots v_{n,i}(A)). \]
For each $A \in M(Ctx_n)$ we define $id_A : A \to A$ as tuple
\[ (v_{n,n-1}(A), \ldots v_{n,0}(A)) \]
and $p_A : A \to ft(A)$ as tuple
\[ (v_{n,n-1}(A), \ldots v_{n,1}(A)). \]

Now, we introduce some notation.
If $B \in M(Ctx_n)$, $A \in M(Ctx_{k+1})$, and $f = (a_1, \ldots a_k) : B \to ft_k(A)$ is a morphism, then we define $A[f] \in M(Ctx_{n+1})$ as $Subst_{n,k}(B, A, a_1, \ldots a_k)$.
If $a \in M(Tm_k)$ and $ty_k(a) = A$, then we define $a[f] \in M(Tm_n)$ as $subst_{n,k}(B, a, a_1, \ldots a_k)$.
By axioms \eqref{ax:def-Subst} and \eqref{ax:def-subst} these constructions are total.

If $A \in M(Ctx_n)$, $B \in M(Ctx_k)$, $C \in M(Ctx_m)$, $f : A \to B$, and $(c_1, \ldots c_m) : B \to C$, then we define composition $(c_1, \ldots c_m) \circ f$ as $(c_1[f], \ldots c_m[f])$.
The following sequence of equations shows that $(c_1, \ldots c_m) \circ f : A \to C$.
\begin{align*}
ty_n(c_i[f]) & = \text{(by axiom~\eqref{ax:type-subst})} \\
ty_k(c_i)[f] & = \text{(since $Hom_{k,m}(c_1, \ldots c_m)$)} \\
ft^{m-i}_i(C)[c_1, \ldots c_{i-1}][f] & = \text{(by axiom~\eqref{ax:Subst-Subst})} \\
ft^{m-i}_i(C)[c_1[f], \ldots c_{i-1}[f]] &
\end{align*}

With these notations we can rewrite axioms \eqref{ax:type-subst}, \eqref{ax:Subst-var}, \eqref{ax:subst-var}, \eqref{ax:Subst-Subst}, \eqref{ax:subst-subst} as follows:
\todo{Fix align}
\begin{comment}
\begin{align}
\setcounter{equation}{\ref{ax:type-subst}}
\addtocounter{equation}{-1}
ty_n(a[f]) & = A[f] \\ \notag
\text{ for each } f : B \to ft_k(A) & \text{ where } A = ty_k(a) \\
A[id_{ft_n(A)}] & = A \\
a[id_{ft_n(ty_n(a))}] & = a \\
\setcounter{equation}{\ref{ax:Subst-Subst}}
\addtocounter{equation}{-1}
A[g][f] & = A[g \circ f] \\ \notag
\text{ for each } f : C \to B \text{ and } & g : B \to ft_m(A) \\
a[g][f] & = a[g \circ f] \\ \notag
\text{ for each } f : C \to B \text{ and } & g : B \to ft_m(ty_m(a))
\end{align}
\end{comment}

Associativity of the composition follows from axiom~\eqref{ax:subst-subst}, and the fact that $id$ is identity for it follows from axioms \eqref{ax:subst-var} and \eqref{ax:var-subst}.

For every $A \in M(Ctx_{k+1})$ there is a bijection $\varphi$ between the set of $a \in M(Tm_k)$ such that $ty_k(a) = A$ and the set of morphisms $f : ft_k(A) \to A$ such that $p_A \circ f = id_{ft_k(A)}$.
For every such $a \in M(Tm_k)$ we define $\varphi(a)$ as
\[ (v_{k,k-1}(ft_k(A)), \ldots v_{k,0}(ft_k(A)), a). \]
Note that if $(a_1, \ldots a_{k+1}) : B \to A$ is a morphism, then axiom~\eqref{ax:var-subst} implies that $p_A \circ (a_1, \ldots a_{k+1})$ equals to $(a_1, \ldots a_k)$.
Thus $\varphi(a)$ is a section of $p_A$.
Clearly, $\varphi$ is injective.
Let $f : ft_k(A) \to A$ be a section of $p_A$; then first $k$ components of $f$ must be identity on $ft_k(A)$.
So if $a$ is the last component of $f$, then $\varphi(a)$ equals to $f$.
Hence $\varphi$ is bijective.

If $A \in M(Ctx_{k+1})$, $B \in M(Ctx_n)$, and $f = (a_1, \ldots a_k) : B \to ft_k(A)$, then we define $f^*(A)$ as $A[f] = Subst_{n,k}(B, A, a_1, \ldots a_k)$.
Map $q(f,B)$ defined as the tuple with $i$-th component equals to
\[ \left\{
  \begin{array}{lr}
    a_i[v_{n+1,n}(A[f]), \ldots v_{n+1,1}(A[f])] & \text{ if } 1 \leq i \leq k \\
    v_{n+1,0}(A[f])                              & \text{ if } i = k+1
  \end{array}
\right. \]
Now we have the following commutative square:
\[ \xymatrix{ A[f] \ar[r]^-{q(f,A)} \ar[d]_{p_{A[f]}} & A \ar[d]^{p_A} \\
              B \ar[r]_-f                             & ft_k(A)
            } \]
We need to prove that this square is cartesian.
By proposition~2.3 of \cite{c-systems} it is enough to construct a section $s_{f'} : B \to A[f]$ of $p_{A[f]}$ for each $f' = (a_1, \ldots a_k, a_{k+1}) : B \to A$ and prove a few properties of $s_{f'}$.
We define $s_{f'}$ to be equal to $\varphi(a_{k+1})$.
Axioms \eqref{ax:var-subst} and \eqref{ax:subst-subst} implies that $q(f, B) \circ s_{f'} = f$.
To complete the proof that the square above is cartesian we need for every $g : ft_k(A) \to ft_m(C)$ and $A = C[g]$ prove that $s_{f'} = s_{q(g,C) \circ f'}$.
The last component of $q(g,C) \circ f'$ equals to $v_{n+1,0}(C[g])[f'] = a_{k+1}$.
Thus the last components of $q(g,C) \circ f'$ and $f'$ coincide, hence $s_{f'} = s_{q(g,C) \circ f'}$.

We are left to prove that operations $A[f]$ and $q(f,A)$ are functorial.
Equations $A[id_{ft_k(A)}] = A$ and $A[f \circ g] = A[f][g]$ are precisely axioms \eqref{ax:Subst-var} and \eqref{ax:Subst-Subst}.
The fact that $q(id_{ft_k(A)}, A) = id_A$ follows from axiom~\ref{ax:var-subst}.
Now let $g : C \to B$ and $f : B \to ft_k(A)$ be morphisms; we need to show that $q(f \circ g, A) = q(f,A) \circ q(g,A[f])$.
The last component of $q(f,A) \circ q(g,A[f])$ equals to $v_{n+1,0}(A[f])[q(g,A[f])] = v_{m+1,0}(A[f][g])$ which equals to the last component of $q(f \circ g, A)$, namely $v_{m+1,0}(A[f \circ g])$.
If $1 \leq i \leq k$, then $i$-th component of $q(f,A) \circ q(g,A[f])$ equals to
\[ a_i[v_{n+1,n}(A[f]), \ldots v_{n+1,1}(A[f])][q(g,A[f])] = \]
\[ a_i[b_1[v_{m+1,m}(A[f][g]), \ldots v_{m+1,1}(A[f][g])], \ldots b_n[v_{m+1,m}(A[f][g]), \ldots v_{m+1,1}(A[f][g])]] \]
where $a_i$ is $i$-th component of $f$ and $b_i$ is $i$-th component of $g$.
$i$-th component of $q(f \circ g, A)$ equals to
\[ a_i[g][v_{m+1,m}(A[f \circ g]), \ldots v_{m+1,1}(A[f \circ g])] = \]
\[ a_i[b_1[v_{m+1,m}(A[f \circ g]), \ldots v_{m+1,1}(A[f \circ g])], \ldots b_n[v_{m+1,m}(A[f \circ g]), \ldots v_{m+1,1}(A[f \circ g])]]. \]
Thus $q(f \circ g, A) = q(f,A) \circ q(g,A[f])$.
This completes the construction of contextual category $F(M)$.

\begin{prop}
Mapping $F$ is functorial, and functor $F : \Mod{\mathbb{T}_1} \to \ccat$ is an equivalence of categories.
\end{prop}
\begin{proof}
Given a map of $\mathbb{T}_1$ models $\alpha : M \to N$, we define a map of contextual categories $F(\alpha) : F(M) \to F(N)$.
$F(\alpha)$ is already defined on objects.
Let $f = (a_1, \ldots a_k) \in Hom_{n,k}(B,A)$.
We define $F(\alpha)(f)$ as $(\alpha(a_1), \ldots \alpha(a_k)) \in Hom_{n,k}(\alpha(B), \alpha(A))$.
$F(\alpha)$ preserves identity morphisms, compositions, $f^*(A)$, and $q(f,A)$ since all of these operations are defined in terms of $\mathbb{T}_1$ operations.
Clearly, $F$ preserves identity maps and compositions of maps of $\mathbb{T}_1$ models.
Thus $F$ is a functor.

First, note that if $a \in M(Tm_k)$ and $\alpha : M \to N$, then $F(\alpha)(\varphi(a)) = \varphi(\alpha(a))$.
Indeed, consider the following sequence of equations:
\begin{align*}
F(\alpha)(\varphi(a)) & = \\
F(\alpha)(v_{k,k-1}(ft_k(ty_k(a))), \ldots v_{k,0}(ft_k(ty_k(a))), a) & = \\
(v_{k,k-1}(ft_k(ty_k(\alpha(a)))), \ldots v_{k,0}(ft_k(ty_k(\alpha(a)))), \alpha(a)) & = \\
\varphi(\alpha(a)) & .
\end{align*}

Now, we prove that $F$ is faithful.
Let $\alpha,\beta : M \to N$ be a pair of maps of $\mathbb{T}_1$ models such that $F(\alpha) = F(\beta)$.
Then $\alpha$ and $\beta$ coincide on contexts.
Given $a \in M(Tm_n)$ we have the following equation: $\alpha(a) = \varphi^{-1}(F(\alpha)(\varphi(a))) = \varphi^{-1}(F(\beta)(\varphi(a))) = \beta(a)$.

Now, we prove that $F$ is full.
Let $\alpha : F(M) \to F(N)$ be a map of contextual categories.
Then we need to define $\beta : M \to N$ such that $F(\beta) = \alpha$.
If $A \in M(Ctx_n)$, then we let $\beta(A) = \alpha(A)$.
Note that if $f : ft_n(A) \to A$ is a section of $p_A$, then $\alpha(f)$ is a section of $\alpha(A)$.
If $a \in M(Tm_n)$, then we let $\beta(a) = \varphi^{-1}(\alpha(\varphi(a)))$.

Maps $F(\beta)$ and $\alpha$ agree on contexts.
We prove by induction on $k$ that they coincide on morphisms $f = (a_1, \ldots a_k) \in M(Hom_{n,k})(B,A)$.
If $k = 0$, then $F(A)$ is terminal objects, hence $F(\beta) = \alpha$.
Suppose $k > 0$ and consider the following equation: $f = q((a_1, \ldots a_{k-1}), A) \circ \varphi(a_k)$.
By induction hypothesis we know that $F(\beta)(q((a_1, \ldots a_{k-1}), A)) = \alpha(q((a_1, \ldots a_{k-1}), A))$.
Thus we only need to prove that $F(\beta)(\varphi(a_k)) = \alpha(\varphi(a_k))$.
But $F(\beta)(\varphi(a_k)) = \varphi(\beta(a_k)) = \varphi(\varphi^{-1}(\alpha(\varphi(a_k)))) = \alpha(\varphi(a_k))$.

Finally, we prove that $F$ is essentially surjective on objects.
Given contextual category $C$ we define $\mathbb{T}_1$ model $M$.
Let $M(Ctx_n)$ be equal to $Ob_n(C)$ and $M(Tm_n)$ be the set of pairs of objects $A \in Ob_{n+1}(C)$ and sections of $p_A : A \to ft_n(A)$.
Let $ty_n$ be the obvious projection.
We will usually identify $a \in M(Tm_n)$ with the section $ft_n(ty_n(a)) \to ty_n(a)$.

For each $n,k \in \mathbb{N}$ we define partial function
\[ Subst_{n,k} : M(Ctx_n) \times M(Ctx_{k+1}) \times M(Tm_n)^k \to M(Ctx_{n+1}) \]
such that $ft_n(Subst_{n,k}(B, A, a_1, \ldots a_k)) = B$.
We also define morphism
\[ q_{n,k} \in Hom_{n+1,k}(Subst_{n,k}(B, A, a_1, \ldots a_k), A) \]
whenever $Subst_{n,k}(B, A, a_1, \ldots a_k)$ is defined.
We define $Subst_{n,k}$ and $q_{n,k}$ by induction on $k$.
Let $Subst_{n,0}(B,A) = !_B^*(A)$ and $q_{n,0} = q(!_B,A)$ where $!_B : B \to Ob_0(C)$ is the unique morphism.
\[ \xymatrix{ Subst_{n,0}(B,A) \ar[r]^-{q_{n,0}} \ar[d] \pb & A \ar[d]^{p_A} \\
              B \ar[r]_{!_B} & 1
            } \]
Let $Subst_{n,k+1}(B, A, a_1, \ldots a_{k+1})$ be defined whenever $Subst_{n,k}(B, ft_k(A), a_1, \ldots a_k)$ is defined and $ty_n(a_{k+1}) = Subst_{n,k}(B, ft_k(A), a_1, \ldots a_k)$.
In this case we let $Subst_{n,k+1}(B, A, a_1, \ldots a_{k+1}) = f^*(A)$ and $q_{n,k+1} = q(f,A)$ where $f$ is the composition of $a_{k+1}$ and $q_{n,k}$.
\[ \xymatrix{ Subst_{n,k+1}(B, A, a_1, \ldots a_{k+1}) \ar[rr]^-{q_{n,k+1}} \ar[d] \pb & & A \ar[d]^{p_A} \\
              B \ar[r]_-{a_{k+1}} & Subst_{n,k}(B, ft_k(A), a_1, \ldots a_k) \ar[r]_-{q_{n,k}} & ft_k(A)
            } \]
It is easy to see by induction on $k$ that axiom~\eqref{ax:def-Subst} holds.
Axiom~\eqref{ax:type-Subst} holds by definition of $Subst_{n,k}$.

The definition of predicates $Hom_{n,k}$ makes sense in $M$ now.
Thus we can define as before the set $Hom^M_{n,k}(B,A)$ of morphisms in $M$ as the set of tuples $(a_1, \ldots a_k)$ such that $Hom_{n,k}(B, A, a_1, \ldots a_k)$.
There is a bijection $\alpha : Hom^M_{n,k}(B,A) \to Hom_{n,k}(B,A)$ such that $Subst_{n,k}(B, A, a_1, \ldots a_k) = \alpha(a_1, \ldots a_k)^*(A)$ and $q_{n,k} = q(\alpha(a_1, \ldots a_k), A)$.
We define $\alpha$ by induction on $k$.
Both $Hom^M_{n,0}(B,A)$ and $Hom_{n,0}(B,A)$ are singletons, so there is a unique bijection between them.
If $(a_1, \ldots a_k) \in Hom^M_{n,k}(B,ft_k(A))$, then there is a bijection between $f \in Hom_{n,k+1}(B,A)$ such that $p_A \circ f = \alpha(a_1, \ldots a_k)$ and sections of $p_{\alpha(a_1, \ldots a_k)^*(A)}$.
By induction hypothesis these sections are just sections of $p_{Subst_{n,k}(B, A, a_1, \ldots a_k)}$.
This gives us a bijection between $Hom^M_{n,k+1}(B,A)$ and $Hom_{n,k+1}(B,A)$, namely $\alpha(a_1, \ldots a_{k+1}) = q(\alpha(a_1, \ldots a_k), A) \circ a_{k+1}$.
Then equations $Subst_{n,k+1}(B, A, a_1, \ldots a_{k+1}) = \alpha(a_1, \ldots a_{k+1})^*(A)$ and $q_{n,k+1} = q(\alpha(a_1, \ldots a_k), A)$ hold by definition.

Now we define total functions $v_{n,i} : M(Ctx_n) \to M(Tm_n)$.
Let $v_{n,i}(A) = (p^{i+1}(A)^*(ft^i_{n-i}(A)), s_{p^i_A})$.
\[ \xymatrix{ p^{i+1}(A)^*(ft^i_{n-i}(A)) \ar[r] \ar[d] \pb & ft^i_{n-i}(A) \ar[d]^{p_{ft^i_{n-i}(A)}} \\
              A \ar[r]_{p^{i+1}(A)} \ar@/^1pc/[u]^{s_{p^i_A}} \ar[ur]_{p^i_A} & ft^{i+1}_{n-i-1}(A)
            } \]
Axiom~\eqref{ax:def-var} holds by definition.
By induction on $n - i$ it is easy to see that $\alpha(v_{n,n-1}(A), \ldots v_{n,i}(A))$ equals to $p_A^i : A \to ft^i_{n-i}(A)$.
Axiom~\eqref{ax:type-var} follows from the following sequence of equations:
\begin{align*}
Subst_{n,n-i-1}(A, ft^i_{n-i}(A), v_{n,n-1}(A), \ldots v_{n,i+1}(A)) & = \\
\alpha(v_{n,n-1}(A), \ldots v_{n,i+1}(A))^*(ft^i_{n-i}(A)) & = \\
p^{i+1}(A)^*(ft^i_{n-i}(A)) & = \\
ty_n(v_{n,i}(A)) & .
\end{align*}
Axiom~\eqref{ax:Subst-var} follows from the facts that $\alpha(v_{n,n-1}(ft_n(A)), \ldots v_{n,0}(ft_n(A))) = id_{ft_n(A)}$ and $id_{ft_n(A)}^*(A) = A$.

Now we define partial functions $subst_{n,k} : M(Ctx_n) \times M(Tm_k) \times M(Tm_n)^k \to M(Tm_n)$.
$subst_{n,k}(B, a, a_1, \ldots a_k)$ is defined whenever \todo{Fix margins} $Hom_{n,k}(B, ft_k(ty_k(a)), a_1, \ldots a_k)$ holds.
In this case we let $subst_{n,k}(B, a, a_1, \ldots a_k) = a[\alpha(a_1, \ldots a_k)]$ where $a[f] = s_{a \circ f}$.
Axioms \eqref{ax:def-subst} and \eqref{ax:type-subst} hold by definition.
Axiom~\eqref{ax:subst-var} follows from the fact that $id_{ft_n(ty_n(a))}^*(a) = a$.

To prove axiom~\eqref{ax:var-subst} note that $p_A \circ \alpha(a_1, \ldots a_{k+1}) = \alpha(a_1, \ldots a_k)$ by definition of $\alpha$.
Hence $p^i(A) \circ \alpha(a_1, \ldots a_k) = \alpha(a_1, \ldots a_{k-i})$.
Also note that $s_{\alpha(a_1, \ldots a_k)} = a_k$.
Now the axiom follows from the following equations:
\begin{align*}
subst_{n,k}(B, v_{k,i}(A), a_1, \ldots a_k) & = \\
s_{v_{k,i}(A) \circ \alpha(a_1, \ldots a_k)} & = \\
s_{q(p^{i+1}(A), ft^i_{n-i}(A)) \circ v_{k,i}(A) \circ \alpha(a_1, \ldots a_k)} & = \\
s_{p^i(A) \circ \alpha(a_1, \ldots a_k)} & = \\
s_{\alpha(a_1, \ldots a_{k-i})} & = \\
a_{k-i} & .
\end{align*}

Now we prove that $\alpha$ preserves compositions.
To do this we need to show that $\alpha(a_1, \ldots a_k) \circ f = \alpha(a_1[f], \ldots a_k[f])$.
We do this by induction on $k$.
For $k = 0$ it is trivial and for $k > 0$ we have the following sequence of equations:
\begin{align*}
\alpha(a_1, \ldots a_k) \circ f & = \\
q(\alpha(a_1, \ldots a_{k-1}), A) \circ a_k \circ f & = \\
q(\alpha(a_1, \ldots a_{k-1}), A) \circ q(f, B[\alpha(a_1, \ldots a_k)]) \circ a_k[f] & = \\
q(\alpha(a_1, \ldots a_{k-1}) \circ f, A) \circ a_k[f] & = \\
q(\alpha(a_1[f], \ldots a_{k-1}[f]), A) \circ a_k[f] & = \\
\alpha(a_1[f], \ldots a_k[f]) & .
\end{align*}

Now axioms \eqref{ax:Subst-Subst} and \eqref{ax:subst-subst} follow from the facts that $\alpha$ preserves compositions and $(f \circ g)^*(A) = f^*(g^*(A))$.
This completes the construction of $\mathbb{T}_1$ model $M$ from a contextual category $C$.
To finish the proof we need to show that $F(M)$ is isomorphic to $C$.
The isomorphism is given by bijection $\alpha$.
We already saw that $\alpha$ preserves the structure of contextual categories.
Thus $\alpha$ is a morphism of contextual categories, and it is easy to see that $\alpha^{-1}$ also preserves the structure.
Hence $\alpha$ is isomorphism and $F$ is an equivalence.
\end{proof}

\section{Algebraic presentations of type theories}

In this section we will describe an algebraic approach to defining type theories.
We will consider a particular kind of algebraic type theories which we call \emph{regular}.
Finally, we will define categories $\algtt$ and $\algtt_{reg}$ of algebraic and regular algebraic type theories.

\begin{defn}
An \emph{algebraic type theory} is a quasi-equational theory in a signature with the set of sorts $\mathcal{C}$ together with a map from $\mathbb{T}_1$.
Category $\algtt$ of algebraic type theories is the under category $\mathbb{T}_1 / \cat{Th}_\mathcal{C}$.
\end{defn}

Usually in type theories all of the function symbols are available in every context.
We call such theories \emph{regular}.
Let $\mathcal{F}$ be a set of function symbols such that every $\sigma \in \mathcal{F}$ has a signature of the form $(p_1,q_1) \times \ldots \times (p_n,q_n) \to (p,0)$.
Then we define $reg(\mathcal{F})$ as the set of symbols of $\mathbb{T}_1$ together with $\{ \sigma_k : (ctx, k) \times (p_1, q_1 + k) \times \ldots \times (p_n, q_n + k) \to (p, k) \ |\ \sigma \in \mathcal{F}, \sigma : (p_1,q_1) \times \ldots \times (p_n,q_n) \to (p,0), k \in \mathbb{N} \}$.
We will use term $\sigma(a_1, \ldots a_n)$ as a synonym for $\sigma_0(*, a_1, \ldots a_n)$.

Now, for every set of variables $V$ we define a set $L^n(V)$ which contains a variable $x$ of sort $(p,q+n)$ for every variable $x$ of sort $(p,q)$ in $V$.
For every $t \in Term_{reg(\mathcal{F})}(V)_{(p,q)}$, $m \in \mathbb{N}$, and variable $\Gamma$ we define a term $L^m(\Gamma, t) \in Term_{reg(\mathcal{F})}(L^m(V \amalg \{ \Gamma : (ctx,0) \}))_{(p,q+m)}$ by induction on $t$:
\begin{align*}
& L^m(\Gamma, *) = \Gamma \\
& L^m(\Gamma, x_i) = x_i \\
& L^m(\Gamma, ft_n(A)) = ft_{n+m}(L^m(\Gamma, A)) \\
& L^m(\Gamma, ty_n(a)) = ty_{n+m}(L^m(\Gamma, a)) \\
& L^m(\Gamma, v_{n,i}(A)) = v_{n+m,i}(L^m(\Gamma, A)) \\
& L^m(\Gamma, subst_{p,n,k}(B, A, a_1, \ldots a_k)) = \\
& \qquad subst_{p,n+m,k+m}(L^m(\Gamma, B), L^m(\Gamma, A), b_1, \ldots b_m, a_1', \ldots a_k') \\
& \qquad \text{where $b_i = v_{n+m,n+m-i}(L^m(\Gamma, B))$ and $a_i' = L^m(\Gamma, a_i)$ } \\
& L^m(\Gamma, \sigma_n(A, a_1, \ldots a_k)) = \sigma_{n+m}(L^m(\Gamma, A), L^m(\Gamma, a_1), \ldots L^m(\Gamma, a_k))
\end{align*}
For every formula $\varphi$ we define $L(\varphi)$ as the formula which is obtained from $\varphi$ by applying $L$ to every term in it.
We will say that theory $\mathbb{T}$ in signature $(\mathcal{C}, reg(\mathcal{F}), \varnothing)$ is \emph{stable}
if for every axiom (and hence for every theorem) $\varphi \sststile{}{V} \psi$ of $\mathbb{T}$ sequent $L(\varphi) \sststile{}{V \amalg \{ \Gamma : (ctx,1) \}} L(\psi)$ is a theorem of $\mathbb{T}$.
Given a theory $\mathbb{T}$ there is the smallest stable theory containing $\mathbb{T}$.
We call this theory the stabilization of $\mathbb{T}$ and denote by $st(\mathbb{T})$.

We define auxiliary derived operations in the signature of $\mathbb{T}_1$.
For every $m \in \mathbb{N}$ we define $wk^m_n : Ctx_{n+m} \times Tm_n \to Tm_{n+m}$ as follows:
\[ wk^m_n(B,a) = subst_{n+m,n}(B, a, v_{n+m-1}(B), \ldots v_m(B)) \]
For every $m \in \mathbb{N}$ we define $subst^{m+1}_{p,n,k} : Ctx_n \times (p,k+m) \times Tm^k_n \to (p,k+m)$.
First, let $subst^0_{ty,n,k}(B, A, a_1, \ldots a_k) = B$.
Then let $subst^{m+1}_{p,n,k}(B, a, a_1, \ldots a_k)$ be equal to
\[ subst_{p,n+m+1,k+m+1}(B', a, wk^{m+1}_n(B', a_1), \ldots wk^{m+1}_n(B', a_k), v_m(B'), \ldots v_0(B')) \]
where $B' = subst^m_{ty,n,k}(B, ft(A), a_1, \ldots a_k)$.

\begin{defn}
A \emph{regular algebraic type theory} is a set $\mathcal{F}$ together with a stable theory over $(\mathcal{C}, reg(\mathcal{F}), \varnothing)$
such that axioms of $\mathbb{T}_1$ are derivable and for every $\sigma \in \mathcal{F}$, $\sigma : (p_1,q_1) \times \ldots \times (p_m,q_m) \to (p,0)$ the following sequents are derivable:
\[ \sststile{}{B, b_1, \ldots b_m} ft_k(\sigma_k(B, b_1, \ldots b_m)) = B \text{ if $p = ty$,} \]
\[ \sststile{}{B, b_1, \ldots b_m} ft_k(ty_k(\sigma_k(B, b_1, \ldots b_m))) = B \text{ if $p = tm$, and} \]
\[ \sststile{}{B', B, b_1, \ldots b_m, a_1, \ldots a_k} subst_{p,n,k}(B', \sigma_k(B, b_1, \ldots b_m), a_1, \ldots a_k) = \sigma_n(B', b_1', \ldots b_m') \]
where $b_i' = subst_{p_i,n,k}^{q_i+1}(B', b_i, a_1, \ldots a_k)$.
\end{defn}

Let $(\mathcal{F},\mathbb{T})$ and $(\mathcal{F}',\mathbb{T}')$ be regular algebraic type theories.
Then we say that a morphism $F$ of theories $\mathbb{T}$ and $\mathbb{T}'$ is \emph{regular} if for every $\sigma \in \mathcal{F}$ the following sequent is a theorem of $\mathbb{T}'$.
\[ \sststile{}{\Gamma, a_1, \ldots a_n} F(\sigma_m(\Gamma, a_1, \ldots a_n)) = L^m(\Gamma, F(\sigma_0(*, a_1, \ldots a_n))) \]
Note that term $L^m(\Gamma, F(\sigma_0(*, a_1, \ldots a_n)))$ does not depend on the choice of a representative of the equivalence class.
Indeed, if $\sststile{}{V} t \cong s$, then $\sststile{}{\Gamma,V} L^m(\Gamma,t) \cong L^m(\Gamma,s)$ since $\mathbb{T}'$ is stable.

Category $\algtt_{reg}$ of regular algebraic type theories has regular algebraic type theories as objects and regular morphisms of the underlying theories as morphisms.
To construct a morphism of regular theories $(\mathcal{F},\mathbb{T})$ and $(\mathcal{F}',\mathbb{T}')$ it is enough to give a function $F$ that to each $\sigma \in \mathcal{F}$ assigns a term in $\mathcal{F}'$ of the corresponding signature.
Then we can extend $F$ as follows:
\[ F(\sigma_m(\Gamma, a_1, \ldots a_n)) = L^m(\Gamma, F(\sigma(a_1, \ldots a_n))) \]
If this $F$ respects axioms of $\mathbb{T}$, then it uniquely extends to a regular morphism.

\section{Syntactic presentations of type theories}

In this section we will describe a syntactic approach to defining type theories.
We will define category $\syntt$ of syntactically presented type theories.
Finally, we will give a few examples of such theories.

We will consider theories with total function symbols and without equality.
Terms, atomic formulas and Horn sequents are defined in the same way as before.
If $FV(J_1) \cup \ldots \cup FV(J_n) \subseteq FV(J)$, then a sequent $J_1, \ldots J_n \sststile{}{FV(J)} J$ will be written as
\begin{center}
\AxiomC{$J_1 \quad \ldots \quad J_n$}
\UnaryInfC{$J$}
\DisplayProof
\end{center}
A \emph{(total) Horn theory} in a signature $\Sigma$ is a set of Horn sequents over $\Sigma$.
We will use a standard set of inference rules of Horn logic as presented in \cite[D 1.3]{elephant}.
If $\mathbb{T}$ is a Horn theory, then a \emph{theorem} of $\mathbb{T}$ is a sequent derivable from $\mathbb{T}$ in this logic.

Let $\mathcal{K} = \{ tm, ty \}$ and let $\mathcal{D} = \mathcal{K} \times \mathbb{N}$ be a set of sorts.
Let $\mathcal{P} = \{ D^n_p, E^n_p\ |\ n \in \mathbb{N}, p \in \mathcal{K} \}$ be a set of predicate symbols with the following signatures:
\begin{align*}
D^n_{ty} & : (ty,0) \times \ldots \times (ty,n-1) \times (ty,n) \\
D^n_{tm} & : (ty,0) \times \ldots \times (ty,n-1) \times (tm,n) \times (ty,n) \\
E^n_{ty} & : (ty,0) \times \ldots \times (ty,n-1) \times (ty,n) \times (ty,n) \\
E^n_{tm} & : (ty,0) \times \ldots \times (ty,n-1) \times (tm,n) \times (tm,n)
\end{align*}
We define derived predicates $D^n_{ctx} : (ty,0) \times \ldots \times (ty,n)$ as follows:
\begin{align*}
D^0_{ctx} & = \top \\
D^{n+1}_{ctx}(A_1, \ldots A_{n+1}) & = D^n_{ty}(A_1, \ldots A_{n+1})
\end{align*}
We will use the following standard notations:
\begin{align*}
A_1, \ldots A_n & \vdash \text{ means } D^n_{ctx}(A_1, \ldots A_n), \\
A_1, \ldots A_n & \vdash A \text{ means } D^n_{ty}(A_1, \ldots A_n, A), \\
A_1, \ldots A_n & \vdash a : A \text{ means } D^n_{tm}(A_1, \ldots A_n, a, A), \\
A_1, \ldots A_n & \vdash A \deq B \text{ means } E^n_{ty}(A_1, \ldots A_n, A, B), \\
A_1, \ldots A_n & \vdash a \deq b \text{ means } E^n_{tm}(A_1, \ldots A_n, a, b).
\end{align*}

We do not have equality, instead of it we have equality in context $E^n_{ty}$ and $E^n_{tm}$.
So we need a few axioms for it which are analogous to the usual axioms for equality.
% We will assume that all theories contain the following axioms:
% \begin{center}
% \AxiomC{$\Gamma \vdash A \deq B$}
% \UnaryInfC{$\Gamma \vdash A$}
% \end{center}

Let $F$ be a morphism of signatures $\Sigma = (\mathcal{D}, \mathcal{F}, \mathcal{P})$ and $\Sigma' = (\mathcal{D}, \mathcal{F}', \mathcal{P})$.
Let $\mathbb{T}$ and $\mathbb{T}'$ be total Horn theories in signatures $\Sigma$ and $\Sigma'$ respectively.
Then we will say that $F$ \emph{respects} a sequent $\varphi \sststile{}{V} \psi$ if $F(\varphi) \sststile{}{V} F(\psi)$ is a theorem of $\mathbb{T}'$.
Note that if $F$ respects all axioms of $\mathbb{T}$, then it respects all of its theorems too.
We will say that morphisms $F$ and $G$ are \emph{equivalent} if for all $\sigma \in \mathcal{F}_\Sigma$, $\sigma : s_1 \times \ldots \times s_n \to s$ the following sequents are theorems of $\mathbb{T}'$:
\begin{center}
\AxiomC{$\Gamma \vdash F(\sigma(x_1, \ldots x_n))$}
\UnaryInfC{$\Gamma \vdash G(\sigma(x_1, \ldots x_n))$}
\DisplayProof
\quad
\AxiomC{$\Gamma \vdash G(\sigma(x_1, \ldots x_n))$}
\UnaryInfC{$\Gamma \vdash F(\sigma(x_1, \ldots x_n))$}
\DisplayProof
\end{center}
\begin{center}
\AxiomC{$\Gamma \vdash F(\sigma(x_1, \ldots x_n))$}
\UnaryInfC{$\Gamma \vdash F(\sigma(x_1, \ldots x_n)) \deq G(\sigma(x_1, \ldots x_n))$}
\DisplayProof
\end{center}
if $s = (ty,k)$, and
\begin{center}
\AxiomC{$\Gamma \vdash F(\sigma(x_1, \ldots x_n)) : A$}
\UnaryInfC{$\Gamma \vdash G(\sigma(x_1, \ldots x_n)) : A$}
\DisplayProof
\quad
\AxiomC{$\Gamma \vdash G(\sigma(x_1, \ldots x_n)) : A$}
\UnaryInfC{$\Gamma \vdash F(\sigma(x_1, \ldots x_n)) : A$}
\DisplayProof
\end{center}
\begin{center}
\AxiomC{$\Gamma \vdash F(\sigma(x_1, \ldots x_n)) : A$}
\UnaryInfC{$\Gamma \vdash F(\sigma(x_1, \ldots x_n)) \deq G(\sigma(x_1, \ldots x_n))$}
\DisplayProof
\end{center}
if $s = (tm,k)$.

Now, we define a category of theories.
Its objects are pairs $(\mathcal{F},\mathbb{T})$ where $\mathcal{F}$ is a set of function symbols and $\mathbb{T}$ is a theory in $(\mathcal{S},\mathcal{F},\mathcal{P})$.
Morphisms of theories $(\mathcal{F},\mathbb{T})$ and $(\mathcal{F}',\mathbb{T}')$ are equivalence classes of morphisms of signatures $(\mathcal{S},\mathcal{F},\mathcal{P})$ and $(\mathcal{S},\mathcal{F}',\mathcal{P})$ which respect all axioms of $\mathbb{T}$.
The composition of morphisms of signatures respects the equivalence relation; hence this defines a category of theories which will be denoted by $\Th_{\mathcal{S},\mathcal{P}}$.
Note that $\Sig_{\mathcal{S},\mathcal{P}}$ is a full subcategory of $\Th_{\mathcal{S},\mathcal{P}}$; indeed, every signature can be considered as a theory with an empty set of axioms.

First, let us define a syntactic analog of algebraic theory $\mathbb{T}_1$ which we also call $\mathbb{T}_1$.
Its function symbols are the following:
\begin{align*}
v_{n,i} & : (tm,n) \text{, } 0 \leq i < n \\
subst_{p,n,k} & : (p,k) \times (tm,n)^k \to (p,n)
\end{align*}

Theory $\mathbb{T}_1$ has the following axioms:
\medskip
\begin{center}
\AxiomC{$\Gamma \vdash a : A$}
\AxiomC{$\Gamma \vdash A \deq B$}
\BinaryInfC{$\Gamma \vdash a : B$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$A_1, \ldots A_n \vdash$}
\UnaryInfC{$A_1, \ldots A_n \vdash v_{n,i} : A_{n-i}\!\uparrow^{i+1}$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\Gamma \vdash$}
\AxiomC{$A_1, \ldots A_k \vdash A$}
\AxiomC{$\Gamma \vdash a_i : subst_{ty,n,i-1}(A_i, a_1, \ldots a_{i-1})$}
\TrinaryInfC{$\Gamma \vdash subst_{ty,n,k}(A, a_1, \ldots a_k)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\Gamma \vdash$}
\AxiomC{$A_1, \ldots A_k \vdash a : A$}
\AxiomC{$\Gamma \vdash a_i : subst_{ty,n,i-1}(A_i, a_1, \ldots a_{i-1})$}
\TrinaryInfC{$\Gamma \vdash subst_{tm,n,k}(a, a_1, \ldots a_k) : subst_{ty,n,k}(A, a_1, \ldots a_k)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\Gamma \vdash$}
\AxiomC{$A_1, \ldots A_k \vdash$}
\AxiomC{$\Gamma \vdash a_i : subst_{ty,n,i-1}(A_i, a_1, \ldots a_{i-1})$}
\TrinaryInfC{$\Gamma \vdash subst_{tm,n,k}(v_{k,i}, a_1, \ldots a_k) \deq a_{k-i}$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\Gamma \vdash A$}
\UnaryInfC{$\Gamma \vdash subst_{ty,n,n}(A, v_{n,n-1}, \ldots v_{n,0}) \deq A$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\Gamma \vdash a : A$}
\UnaryInfC{$\Gamma \vdash subst_{ty,n,n}(a, v_{n,n-1}, \ldots v_{n,0}) \deq a$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_i : subst_{ty,n,i-1}(B_i, b_1, \ldots b_{i-1})$
\Axiom$\fCenter A_1, \ldots A_m \vdash A$
\noLine
\UnaryInf$\fCenter B_1, \ldots B_k \vdash$
\noLine
\UnaryInf$\fCenter B_1, \ldots B_k \vdash a_i : subst_{ty,k,i-1}(A_i, a_1, \ldots a_{i-1})$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \vdash subst_{ty,n,k}(subst_{ty,k,m}(A, a_1, \ldots a_m), b_1, \ldots b_k) \deq subst_{ty,n,m}(A, a_1', \ldots a_m')$}
\DisplayProof
\end{center}
where $a_i' = subst_{tm,n,k}(a_i, b_1, \ldots b_k)$

\medskip
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \Gamma \vdash$
\noLine
\UnaryInf$\fCenter \Gamma \vdash b_i : subst_{ty,n,i-1}(B_i, b_1, \ldots b_{i-1})$
\Axiom$\fCenter A_1, \ldots A_m \vdash a : A$
\noLine
\UnaryInf$\fCenter B_1, \ldots B_k \vdash$
\noLine
\UnaryInf$\fCenter B_1, \ldots B_k \vdash a_i : subst_{ty,k,i-1}(A_i, a_1, \ldots a_{i-1})$
\def\extraVskip{2pt}
\BinaryInfC{$\Gamma \vdash subst_{tm,n,k}(subst_{tm,k,m}(a, a_1, \ldots a_m), b_1, \ldots b_k) \deq subst_{tm,n,m}(a, a_1', \ldots a_m')$}
\DisplayProof
\end{center}
where $a_i' = subst_{tm,n,k}(a_i, b_1, \ldots b_k)$

\begin{defn}
A \emph{syntactic type theory} is a theory in a signature with the set of sorts $\mathcal{D}$ together with a map from $\mathbb{T}_1$.
Category $\syntt$ of syntactic type theories is the under category $\mathbb{T}_1 / \cat{Th}_\mathcal{D}$.
\end{defn}

Let $\mathcal{F}$ be a set of function symbols together with a signature, that is expressions of the form
\[ \sigma : s_1 \times \ldots \times s_n \to s \]
where $s_1, \ldots s_n, s \in \mathcal{S}$.
Then let $\overline{\Sigma}$ be the following set of function symbols:
\[ \{ \sigma_k\ |\ \sigma \in \Sigma, k \in \mathbb{N} \} \cup \{ v_{n,i}\ |\ n,i \in \mathbb{N}, 0 \leq i < n \} \cup \{ subst_{p,n,k}\ |\ p \in \mathcal{K}, n,k \in \mathbb{N} \}. \]
Signatures of these symbols are defined as follows:
\begin{align*}
v_{n,i} & : (tm,n) \\
subst_{p,n,k} & : (p,k) \times (tm,n)^k \to (p,n) \\
\sigma_k\ & : (p_1,q_1+k) \times \ldots \times (p_n,q_n+k) \to (p,q+k)
\end{align*}
where $\sigma : (p_1,q_1) \times \ldots \times (p_n,q_n) \to (p,q)$.
We will omit subscripts $k$ in $\sigma_k$ and $n$ in $v_{n,i}$ if it is clear from the context.
If $V$ is a set, then let $Term_\Sigma(V)$ be the set of terms in signature $\overline{\Sigma}$.

Let $\mathbb{T}_\Sigma$ be the algebraic theory in signature $\overline{\Sigma}$ with the following set of axioms:
\begin{align*}
subst_{p,n,n}(a, v_{n,n-1}, \ldots v_{n,0}) & = a \\
subst_{tm,n,k}(v_{k,i}, a_1, \ldots a_k) & = a_{k-i} \\
subst_{p,m,n}(subst_{p,n,k}(a, b_1, \ldots b_k), c_1, \ldots c_n) & = subst_{p,m,k}(a, b_1', \ldots b_k')
\end{align*}
where $b_i' = subst_{tm,m,n}(b_i, c_1, \ldots c_n)$, and
\[ subst_{p,n,k}(\sigma_k(a_1, \ldots a_m), b_1, \ldots b_k) = \sigma_n(a_1', \ldots a_m') \]
for each $\sigma : (p_1,q_1) \times \ldots \times (p_n,q_n) \to (p,0)$ and $b_j : (tm,n)$ where
\[ a_i' = subst_{p_i,n+q_i,k+q_i}(a_i, b_{i,1}', \ldots b_{i,k}', v_{n+q_i,q_i-1}, \ldots v_{n+q_i,0}) \text{, and} \]
\[ b_{i,j}' = subst_{tm,n+q_i,n}(b_j, v_{n+q_i,n+q_i-1}, \ldots v_{n+q_i,q_i}). \]
Let $\mathbb{T}_\Sigma : \Set^\mathcal{S} \to \Set^\mathcal{S}$ be a monad corresponding to the theory $\mathbb{T}_\Sigma$.
Explicitly, $\mathbb{T}_{\Sigma}(V)_s = Term_{\Sigma}(V)_s/\sim$ where $\sim$ is the congruence generated by the axioms above.
Elements of $\mathbb{T}_{\Sigma}(V)_s$ we will call terms of sort $s$ with free variables in $V$.
A morphism of signatures $\Sigma$ and $\Sigma'$ is a function that to each $(\sigma : s_1 \times \ldots s_k \to s) \in \Sigma$ assigns
a term of sort $s$ in signature $\Sigma'$ with free variables $x_1$, \ldots $x_k$ of sorts $s_1$, \ldots $s_k$ respectively.
Such a function $F$ extends to functions $\overline{F} : \mathbb{T}_\Sigma(V)_s \to \mathbb{T}_{\Sigma'}(V)_s$ in the obvious way.
Compositions of morphisms $F : \Sigma \to \Sigma'$ and $G : \Sigma' \to \Sigma''$ is defined as follows: $(G \circ F)(\sigma) = \overline{G}(F(\sigma))$.
An identity morphism assigns to each $\sigma$ the term $\sigma(x_1, \ldots x_k)$.

If $V \in \Set^{\mathcal{S}}$, then a \emph{context} of length $n$ with free varibles in $V$ is a sequence $A_0$, \ldots $A_{n-1}$ where $A_i \in Term_\Sigma(V)_(ty,i)$.
A \emph{judgement} with free variables in $V$ is simply a predicate of a certain form.
We will consider judgements of the forms $\Gamma \vdash$, $\Gamma \vdash A$, $A \deq A'$, $\Gamma \vdash a : A$, and $a \deq a'$
where $\Gamma$ is context of length $n$ (for some $n \in \mathbb{N}$), $A, A' \in Term_\Sigma(V)_{(ty,n)}$, and $a, a' \in Term_\Sigma(V)_{(tm,n)}$.
An inference rule with free variables in $V$ consists of a finite set of judgements $J_1$, \ldots $J_n$ (with free variables in $V$) called premises and a judgement $J$ (with free variables in $V$) called conclusion.
An inference rule is usually written as
\begin{center}
\AxiomC{$J_1 \quad \ldots \quad J_n$}
\UnaryInfC{$J$}
\DisplayProof
\end{center}
If $\mathcal{I}$ is a set of inference rules, then the set $D(\mathcal{I})$ of derived rules is defined in the usual way.

\begin{defn}
A \emph{syntactic type theory} consists of a set $\Sigma$ of function symbols and a set $\mathcal{I}$ of inference rules.
\end{defn}
Let $F$ be a morphisms of signatures $\Sigma$ and $\Sigma'$.
If $J$ is a judgement of $\Sigma$, then we can define a judgement $\overline{F}(J)$ of $\Sigma'$ by applying $\overline{F}$ to every term in $J$.
If $R$ is an inference rule of $\Sigma$, then we can define an inference rule $\overline{F}(R)$ of $\Sigma'$ by applying $\overline{F}$ to every judgement in $R$.
A morphism of theories $\mathbb{T} = (\Sigma_\mathbb{T}, \mathcal{I}_\mathbb{T})$ and $S = (\Sigma_S, \mathcal{I}_S)$ is a morphism $F$ of signatures $\Sigma$ and $\Sigma'$
such that $\overline{F}(R)$ is a derived inference rules of $S$ for every $R \in \mathcal{I}_\mathbb{T}$.
This defines a cateogry $\syntt$ of syntactic type theories.

Now we introduce a few auxiliary constructions.
If $b$ is a term of sort $(p,n+k)$ and $a_1$, \ldots $a_k$ are terms of sort $(tm,n)$, then we write $b[a_1, \ldots a_k]$ for
\[ subst_{p,n,n+k}(b, v_{n,n-1}, \ldots v_{n,0}, a_1, \ldots a_k). \]
If $b$ is a term of sort $(p,n)$, then we write $b\!\uparrow$ for
\[ subst_{p,n+1,n}(b, v_{n+1,n}, \ldots v_{n+1,1}). \]

We will use the following notation:
\begin{align*}
A_1, \ldots A_n \vdash A \deq A' & \text{ means } E^n_{ty}(A_1, \ldots A_n, A, A') \\
A_1, \ldots A_n \vdash a \deq a' : A & \text{ means } E^n_{tm}(A_1, \ldots A_n, A, a, a') \\
\Gamma \vdash A & \text{ means } \Gamma \vdash A \deq A \\
\Gamma \vdash a : A & \text{ means } \Gamma \vdash a \deq a : A \\
(A_1, \ldots A_n) = (B_1, \ldots B_n) & \text{ means } \bigwedge\limits_{1 \leq i \leq n} A_1, \ldots A_{i-1} \vdash A_i \equiv B_i \\
\Gamma \vdash & \text{ means } \Gamma = \Gamma
\end{align*}

\begin{example}
The theory of unit types with eta rules has function symbols $\top : (ty,0)$ and $unit : (tm,0)$ and the following inference rules:
\medskip
\begin{center}
\AxiomC{}
\UnaryInfC{$\vdash \top$}
\DisplayProof
\quad
\AxiomC{}
\UnaryInfC{$\vdash unit : \top$}
\DisplayProof
\quad
\AxiomC{$\vdash t : \top$}
\UnaryInfC{$t \deq unit$}
\DisplayProof
\end{center}
\end{example}

\begin{example}
The theory of unit types without eta rules has function symbols $\top : (ty,0)$, $unit : (tm,0)$ and $\top\text{-}elim : (ty,1) \times (tm,0) \times (tm,0) \to (tm,0)$
and the following inference rules:
\medskip
\begin{center}
\AxiomC{}
\UnaryInfC{$\vdash \top$}
\DisplayProof
\quad
\AxiomC{}
\UnaryInfC{$\vdash unit : \top$}
\DisplayProof
\quad
\AxiomC{$\top \vdash D$}
\AxiomC{$\vdash d : D[unit]$}
\AxiomC{$\vdash t : \top$}
\TrinaryInfC{$\vdash \top\text{-}elim(D, d, t) : D[t]$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\top \vdash D$}
\AxiomC{$\vdash d : D[unit]$}
\BinaryInfC{$\top\text{-}elim(D, d, unit) \deq d$}
\DisplayProof
\end{center}
\end{example}

\begin{example}[sigma-eta]
The theory of $\Sigma$ types with eta rules has function symbols
$\Sigma : (ty,0) \times (ty,1) \to (ty,0)$, $pair : (ty,0) \times (ty,1) \times (tm,0) \times (tm,0) \to (tm,0)$,
$proj_1 : (ty,0) \times (ty,1) \times (tm,0) \to (tm,0)$ and $proj_2 : (ty,0) \times (ty,1) \times (tm,0) \to (tm,0)$
and the following inference rules:
\medskip
\begin{center}
\AxiomC{$A \vdash B$}
\UnaryInfC{$\vdash \Sigma(A, B)$}
\DisplayProof
\quad
\AxiomC{$A \vdash B$}
\AxiomC{$\vdash a : A$}
\AxiomC{$\vdash b : B[a]$}
\TrinaryInfC{$\vdash pair(A, B, a, b)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\vdash p : \Sigma(A, B)$}
\UnaryInfC{$\vdash proj_1(A, B, p) : A$}
\DisplayProof
\quad
\AxiomC{$\vdash p : \Sigma(A, B)$}
\UnaryInfC{$\vdash proj_2(A, B, p) : B[proj_1(A, B, p)]$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$A \vdash B$}
\AxiomC{$\vdash a : A$}
\AxiomC{$\vdash b : B[a]$}
\TrinaryInfC{$proj_1(A, B, pair(A, B, a, b)) \deq a$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$A \vdash B$}
\AxiomC{$\vdash a : A$}
\AxiomC{$\vdash b : B[a]$}
\TrinaryInfC{$proj_2(A, B, pair(A, B, a, b)) \deq b$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\vdash p : \Sigma(A, B)$}
\UnaryInfC{$pair(A, B, proj_1(A, B, p), proj_2(A, B, p)) \deq p$}
\DisplayProof
\end{center}
\end{example}

\begin{example}[sigma-no-eta]
The theory of $\Sigma$ types without eta rules.
\end{example}

\begin{example}[pi-eta]
The theory of $\Pi$ types with eta rules.
\end{example}

\begin{example}[pi-no-eta]
The theory of $\Pi$ types without eta rules.
\end{example}

\begin{example}[Id]
The theory of identity types has function symbols $Id : (ty,0) \times (tm,0) \times (tm,0) \to (ty,0)$,
$refl : (ty,0) \times (tm,0) \to (tm,0)$ and $J : (ty,0) \times (ty,3) \times (tm,1) \times (tm,0) \times (tm,0) \times (tm,0) \to (tm,0)$
and the following inference rules:
\medskip
\begin{center}
\AxiomC{$\vdash a : A$}
\AxiomC{$\vdash a' : A$}
\BinaryInfC{$\vdash Id(A, a, a')$}
\DisplayProof
\quad
\AxiomC{$\vdash a : A$}
\UnaryInfC{$\vdash refl(A, a) : Id(A, a, a)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$A, A\!\uparrow, Id(A\!\uparrow\uparrow, v_1, v_0) \vdash D$}
\AxiomC{$A \vdash d : D[v_0, v_0, refl(A\!\uparrow, v_0)]$}
\AxiomC{$\vdash p : Id(A, a, a')$}
\TrinaryInfC{$\vdash J(A, D, d, a, a', p) : D[a, a', p]$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$A, A\!\uparrow, Id(A\!\uparrow\uparrow, v_1, v_0) \vdash D$}
\AxiomC{$A \vdash d : D[v_0, v_0, refl(A\!\uparrow, v_0)]$}
\AxiomC{$\vdash a : A$}
\TrinaryInfC{$J(A, D, d, a, a, refl(A, a)) \deq d[a]$}
\DisplayProof
\end{center}
\end{example}

\begin{example}[universe]
The theory a universe has function symbols $Type : (ty,0)$ and $El : (tm,0) \to (ty,0)$ and the following inference rules:
\medskip
\begin{center}
\AxiomC{}
\UnaryInfC{$\vdash Type$}
\DisplayProof
\quad
\AxiomC{$\vdash A : Type$}
\UnaryInfC{$\vdash El(A)$}
\DisplayProof
\end{center}
\end{example}

% Now, usually universes are assumed to be closed under different type constructions.

\section{Syntactic type theories}

In general, we cannot construct an algebraic type theory from a syntactic one.
So we consider a full subcategory of syntactic type theories for which we can do that.
We call such theories \emph{regular}.

We say that a function symbol $\sigma \in \Sigma$ is \emph{closed} if it has signature $s_1 \times \ldots \times s_n \to (p,0)$ for some $s_1$, \ldots $s_n$, and $p$.
We say that a theory is \emph{closed} if every its function symbol is closed.

We say that a judgement defines variable $x$ if it is either of the form $\Gamma \vdash x$ or of the form $\Gamma \vdash x : A$.
We say that a judgement defines symbol $(\sigma : s_1 \times \ldots s_n \to (p,q)) \in \Sigma$ if it is either
of the form $\Gamma \vdash \sigma(x_1, \ldots x_n)$ or of the form $\Gamma \vdash \sigma(x_1, \ldots x_n) : A$ where $x_i$ are variables.
We say that an inference rule defines symbol $\sigma$ if its conclusion defines it.
We say that such inference rule is \emph{regular} if the length of $\Gamma$ is $q$ and
if all variables in the list $x_1$, \ldots $x_n$ are distinct, this list contains all free variables of the rule,
and every $x_i$ defined by a single premise with free variables in $x_1$, \ldots $x_{i-1}$.
A syntactic type theory $\mathbb{T} = (\Sigma, \mathcal{I})$ is \emph{regular} if the following conditions hold:
\begin{itemize}
\item $\mathbb{T}$ is closed.
\item Every function symbol in $\Sigma$ is defined by a single regular inference rule in $\mathcal{I}$,
\item There is a well-ordering on $\Sigma$ such that the rule that defines $\sigma$ uses in premises only symbols that are less then $\sigma$.
\item Every inference rule in $\mathcal{I}$ is either defines some function symbol or has conclusion of the form $a \deq b$.
\end{itemize}

Now for each regular syntactic type theory $\mathbb{T} = (\Sigma, \mathcal{I})$ we define an algebraic type theory $E(\mathbb{T})$.
There is a function from the set of sorts of syntactic theories to the set of sorts of algebraic theories.
Sort $(tm,n)$ is mapped to $Tm_n$ and $(ty,n)$ is mapped to $Ctx_{n+1}$.
We will usually omit this function and use sorts $(tm,n)$ and $(ty,n)$ directly.
The signature $E(\Sigma)$ of $E(\mathbb{T})$ consists of symbols $v_{n,i}$, $subst_{n,k}$, $Subst_{n,k}$ (with the signatures as in $\mathbb{T}_1$), and
$\sigma_k : Ctx_k \times (p_1,q_1+k) \times \ldots \times (p_n,q_n+k) \to (p,k)$
for each $k \in \mathbb{N}$ and $(\sigma : (p_1,q_1) \times \ldots \times (p_n,q_n) \to (p,0)) \in \Sigma$.

Now we define functions
\[ \alpha_{U,V,p,n,k} : Term_{E(\Sigma)}(V)_{Ctx_{n+k}} \times Term_{\Sigma}(U)_{(p,k)} \times Env_{U,V,p,n} \to Term_{E(\Sigma)}(V)_{(p,n+k)} \]
and
\[ \beta_{U,V,n,k} : Term_{E(\Sigma)}(V)_{Ctx_n} \times Ctx_\Sigma(U)_k \times Env_{U,V,ty,n} \to Term_{E(\Sigma)}(V)_{Ctx_{n+k}} \]
where $Ctx_\Sigma(U)_k$ is the set of contexts of length $k$ and $Env_{U,V,p,n}$ is the set of functions $U_{(p,m)} \to Term_{E(\Sigma)}(V)_{(p,n+m)}$ for all $m \in \mathbb{N}$.
\begin{itemize}
\item $\beta_{U,V,n,0}(\Gamma, (), \rho) = \Gamma$.
\item $\beta_{U,V,n,k+1}(\Gamma, (\Delta,A), \rho) = \alpha_{U,V,ty,n,k}(\beta_{U,V,n,k}(\Gamma, \Delta, \rho), A, \rho)$.
\item $\alpha_{U,V,p,n,k}(\Gamma, v_{k,i}, \rho) = v_{n+k,i}(\Gamma)$.
\item $\alpha_{U,V,p,n,k}(\Gamma, x, \rho) = \rho(x)$ where $x$ is a variable.
\item $\alpha_{U,V,p,n,k}(\Gamma, subst_{ty,k,m}(x, a_1, \ldots a_m)) = Subst_{n+k,n+m}(\Gamma, \rho(x), a_1', \ldots a_{n+m}')$
    where $a_i' = v_{n+k,n+k-i}(\Gamma)$ if $i \leq n$ and $a_i' = \alpha_{U,V,tm,n,k}(\Gamma, a_{i-n}, \rho)$ if $i > n$.
\item $\alpha_{U,V,p,n,k}(\Gamma, subst_{tm,k,m}(x, a_1, \ldots a_m)) = subst_{n+k,n+m}(\Gamma, \rho(x), a_1', \ldots a_{n+m}')$
    where $a_i' = v_{n+k,n+k-i}(\Gamma)$ if $i \leq n$ and $a_i' = \alpha_{U,V,tm,n,k}(\Gamma, a_{i-n}, \rho)$ if $i > n$.
\item $\alpha_{U,V,p,n,k}(\Gamma, \sigma_k(a_1, \ldots a_m)) = \sigma_{n+k}(\Gamma, a_1', \ldots a_m'))$
    where $\sigma : (p_1,q_1) \times \ldots \times (p_m,q_m) \to (p,0)$,
    $\sigma(x_1, \ldots x_m)$ is defined by a rule $R$ in which $x_i$ is defined by a judgement with context $\Delta_i$, and
    \[ a_i' = \alpha_{U,V,p_i,n,k+q_i}(\beta_{\{ x_1, \ldots x_{i-1} \},V,n+k,q_i}(\Gamma, \Delta_i, [x_j \mapsto a_j']), a_i, \rho). \]
\end{itemize}
Conditions in the definition of regularity guarantee that these functions are well-defined.

Let $n \in \mathbb{N}$ and $\Delta \in V_{Ctx_n}$.
Let $i : V_{(p,m)} \to V_{(p,n+m)}$ be any injective function and $\rho : V_{(p,m)} \to Term_{E(\Sigma)}(V)_{(p,n+m)}$ be the function such that $\rho(x) = i(x)$ for each $x$.
Then for each judgement $J$ of the form $\Gamma \vdash A$ we define an equation $A(J)$:
\[ ft(\alpha_{V,V,ty,n,k}(\beta_{V,V,n,k}(\Delta, \Gamma, \rho), A, \rho)) = \beta_{V,V,n,k}(\Delta, \Gamma, \rho). \]
For each judgement $J$ of the form $\Gamma \vdash a : A$ we define an equation $A(J)$:
\[ ty(\alpha_{V,V,tm,n,k}(\beta_{V,V,n,k}(\Delta, \Gamma, \rho), a, \rho)) = \alpha_{V,V,ty,n,k}(\beta_{V,V,n,k}(\Delta, \Gamma, \rho), A, \rho). \]
For each judgement $J$ of the form $a \deq a'$ we define an equation $A(J)$:
\[ \alpha_{V,V,p,n,0}(\Delta, a, \rho) = \alpha_{V,V,p,n,0}(\Delta, a', \rho). \]

For each inference rule $R$ with premises $J_1$, \ldots $J_m$ and conclusion $J$ we define an axiom $A(R)$:
\[ A(J_1), \ldots A(J_m) \sststile{}{FV(A(J_1)) \cup \ldots \cup FV(A(J_m)) \cup FV(A(J))} A(J) \]
For each function symbol $\sigma(x_1, \ldots x_k)$ which is defined by a rule with premises $J_1$, \ldots $J_m$ we define an axiom $D(\sigma)$:
\[ A(J_1), \ldots A(J_m) \ssststile{}{i(x_1), \ldots i(x_k)} \sigma(\rho(x_1), \ldots \rho(x_k)) \downarrow \]
For each function symbol $\sigma : (p_1,q_1) \times \ldots \times (p_m,q_m) \to (p,0)$ such that $\sigma(x_1, \ldots x_m)$ is defined by a rule with premises $J_1$, \ldots $J_m$ we define an axiom $S(\sigma)$:
\[ \sststile{}{\Gamma, \Delta, a_1, \ldots a_m, b_1, \ldots b_k} subst_{p,n,k}(\Delta, \sigma_k(\Gamma, a_1, \ldots a_m), b_1, \ldots b_k) \leftrightharpoons \sigma_n(\Delta, a_1', \ldots a_m') \]
where
\[ a_i' = subst_{p_i,n+q_i,k+q_i}(\Delta_i', a_i, b_{i,1}', \ldots b_{i,k}', v_{n+q_i,q_i-1}(\Delta_i'), \ldots v_{n+q_i,0}(\Delta_i')), \]
\[ b_{i,j}' = subst_{tm,n+q_i,n}(\Delta_i', b_j, v_{n+q_i,n+q_i-1}(\Delta_i'), \ldots v_{n+q_i,q_i}(\Delta')), \]
\[ \Delta_i' = \beta_{\{ x_1, \ldots x_{i-1} \},V,n,q_i}(\Delta, \Delta_i, [x_j \mapsto a_j']) \text{, and} \]
$x_i$ is defined by a judgement with context $\Delta_i$.

Axioms of $E(\Sigma, \mathcal{I})$ are the axioms of $\mathbb{T}_1$, $D(\sigma)$ and $S(\sigma)$ for each $\sigma \in \Sigma$, and $A(R)$ for each $R \in \mathcal{I}$.

\section{Initial models of syntactic type theories}

Results of section~\ref{sec:T1} show that models of algebraic type theories can be described as contextual categories with additional structure.
Initial models are of particular interest.
In this section we show that initial models of those theories that come from (regular) syntactic theories can be constructed from fully annotated lambda terms.
Then we show that in some cases we can drop annotations on lambda terms.

\bibliographystyle{amsplain}
\bibliography{ref}

\end{document}
