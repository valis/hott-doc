\documentclass[reqno]{amsart}

\usepackage{amssymb}
\usepackage{hyperref}
\usepackage{mathtools}
\usepackage[all]{xy}
\usepackage{verbatim}
\usepackage{ifthen}
\usepackage{xargs}
\usepackage{bussproofs}
\usepackage{turnstile}
\usepackage{etex}

\hypersetup{colorlinks=true,linkcolor=blue}

\renewcommand{\turnstile}[6][s]
    {\ifthenelse{\equal{#1}{d}}
        {\sbox{\first}{$\displaystyle{#4}$}
        \sbox{\second}{$\displaystyle{#5}$}}{}
    \ifthenelse{\equal{#1}{t}}
        {\sbox{\first}{$\textstyle{#4}$}
        \sbox{\second}{$\textstyle{#5}$}}{}
    \ifthenelse{\equal{#1}{s}}
        {\sbox{\first}{$\scriptstyle{#4}$}
        \sbox{\second}{$\scriptstyle{#5}$}}{}
    \ifthenelse{\equal{#1}{ss}}
        {\sbox{\first}{$\scriptscriptstyle{#4}$}
        \sbox{\second}{$\scriptscriptstyle{#5}$}}{}
    \setlength{\dashthickness}{0.111ex}
    \setlength{\ddashthickness}{0.35ex}
    \setlength{\leasturnstilewidth}{2em}
    \setlength{\extrawidth}{0.2em}
    \ifthenelse{%
      \equal{#3}{n}}{\setlength{\tinyverdistance}{0ex}}{}
    \ifthenelse{%
      \equal{#3}{s}}{\setlength{\tinyverdistance}{0.5\dashthickness}}{}
    \ifthenelse{%
      \equal{#3}{d}}{\setlength{\tinyverdistance}{0.5\ddashthickness}
        \addtolength{\tinyverdistance}{\dashthickness}}{}
    \ifthenelse{%
      \equal{#3}{t}}{\setlength{\tinyverdistance}{1.5\dashthickness}
        \addtolength{\tinyverdistance}{\ddashthickness}}{}
        \setlength{\verdistance}{0.4ex}
        \settoheight{\lengthvar}{\usebox{\first}}
        \setlength{\raisedown}{-\lengthvar}
        \addtolength{\raisedown}{-\tinyverdistance}
        \addtolength{\raisedown}{-\verdistance}
        \settodepth{\raiseup}{\usebox{\second}}
        \addtolength{\raiseup}{\tinyverdistance}
        \addtolength{\raiseup}{\verdistance}
        \setlength{\lift}{0.8ex}
        \settowidth{\firstwidth}{\usebox{\first}}
        \settowidth{\secondwidth}{\usebox{\second}}
        \ifthenelse{\lengthtest{\firstwidth = 0ex}
            \and
            \lengthtest{\secondwidth = 0ex}}
                {\setlength{\turnstilewidth}{\leasturnstilewidth}}
                {\setlength{\turnstilewidth}{2\extrawidth}
        \ifthenelse{\lengthtest{\firstwidth < \secondwidth}}
            {\addtolength{\turnstilewidth}{\secondwidth}}
            {\addtolength{\turnstilewidth}{\firstwidth}}}
        \ifthenelse{\lengthtest{\turnstilewidth < \leasturnstilewidth}}{\setlength{\turnstilewidth}{\leasturnstilewidth}}{}
    \setlength{\turnstileheight}{1.5ex}
    \sbox{\turnstilebox}
    {\raisebox{\lift}{\ensuremath{
        \makever{#2}{\dashthickness}{\turnstileheight}{\ddashthickness}
        \makehor{#3}{\dashthickness}{\turnstilewidth}{\ddashthickness}
        \hspace{-\turnstilewidth}
        \raisebox{\raisedown}
        {\makebox[\turnstilewidth]{\usebox{\first}}}
            \hspace{-\turnstilewidth}
            \raisebox{\raiseup}
            {\makebox[\turnstilewidth]{\usebox{\second}}}
        \makever{#6}{\dashthickness}{\turnstileheight}{\ddashthickness}}}}
        \mathrel{\usebox{\turnstilebox}}}

\newcommand{\axlabel}[1]{(#1) \phantomsection \label{ax:#1}}
\newcommand{\axtag}[1]{\label{ax:#1} \tag{#1}}
\newcommand{\axref}[1]{(\hyperref[ax:#1]{#1})}

\newcommand{\newref}[4][]{
\ifthenelse{\equal{#1}{}}{\newtheorem{h#2}[hthm]{#4}}{\newtheorem{h#2}{#4}[#1]}
\expandafter\newcommand\csname r#2\endcsname[1]{#3~\ref{#2:##1}}
\expandafter\newcommand\csname R#2\endcsname[1]{#4~\ref{#2:##1}}
\expandafter\newcommand\csname n#2\endcsname[1]{\ref{#2:##1}}
\newenvironmentx{#2}[2][1=,2=]{
\ifthenelse{\equal{##2}{}}{\begin{h#2}}{\begin{h#2}[##2]}
\ifthenelse{\equal{##1}{}}{}{\label{#2:##1}}
}{\end{h#2}}
}

\newref[section]{thm}{Theorem}{Theorem}
\newref{lem}{Lemma}{Lemma}
\newref{prop}{Proposition}{Proposition}
\newref{cor}{Corollary}{Corollary}
\newref{cond}{Condition}{Condition}

\theoremstyle{definition}
\newref{defn}{Definition}{Definition}
\newref{example}{Example}{Example}

\theoremstyle{remark}
\newref{remark}{Remark}{Remark}

\newcommand{\cat}[1]{\mathbf{#1}}
\newcommand{\colim}{\mathrm{colim}}
\newcommand{\C}{\cat{C}}
\newcommand{\PAlg}[1]{#1\text{-}\cat{PAlg}}
\newcommand{\Mod}[1]{#1\text{-}\cat{Mod}}
\newcommand{\Th}{\cat{Th}}
\newcommand{\St}{\cat{St}}
\newcommand{\PSt}{\cat{PSt}}
\newcommand{\algtt}{\cat{TT}}
\newcommand{\ThC}{\Th_{\mathcal{C}}}
\newcommand{\emptyCtx}{\mathbf{1}}
\newcommand{\nf}{\mathrm{nf}}
\newcommand{\red}{\Rightarrow}
\newcommand{\deq}{\equiv}
\newcommand{\repl}{:=}
\newcommand{\type}{\mathrm{type}}
\newcommand{\Syn}{\mathrm{Syn}}
\newcommand{\Lang}{\mathrm{Lang}}
\newcommand{\Ho}{\mathrm{Ho}}
\newcommand{\Term}{\mathrm{Term}}

\newcommand{\IdT}{\mathrm{Id}}
\newcommand{\wUA}{\mathrm{wUA}}
\newcommand{\coeT}{\mathrm{coe}}
\newcommand{\PathT}{\mathrm{Path}}
\newcommand{\transportT}{\mathrm{transport}}

\newcommand{\Id}{\mathit{Id}}
\newcommand{\leftI}{\mathit{left}}
\newcommand{\rightI}{\mathit{right}}
\newcommand{\pair}{\mathit{pair}}
\newcommand{\elim}{\mathit{elim}}
\newcommand{\coe}{\mathit{coe}}
\newcommand{\app}{\mathit{app}}
\newcommand{\sq}{\mathit{sq}}
\newcommand{\conc}{\mathit{conc}}
\newcommand{\congI}{\mathit{cong}}
\newcommand{\refl}{\mathit{refl}}
\newcommand{\subst}{\mathit{subst}}
\newcommand{\wk}{\mathit{wk}}
\newcommand{\transport}{\mathit{transport}}
\newcommand{\ft}{\mathit{ft}}
\newcommand{\ty}{\mathit{ty}}
\newcommand{\ctx}{\mathit{ctx}}
\newcommand{\tm}{\mathit{tm}}

\newcommand{\we}{\mathcal{W}}
\newcommand{\fib}{\mathcal{F}}
\newcommand{\cof}{\mathcal{C}}
\newcommand{\I}{\mathrm{I}}
\newcommand{\J}{\mathrm{J}}
\newcommand{\class}[2]{#1\text{-}\mathrm{#2}}
\newcommand{\Iinj}[1][\I]{\class{#1}{inj}}
\newcommand{\Icell}[1][\I]{\class{#1}{cell}}
\newcommand{\Icof}[1][\I]{\class{#1}{cof}}
\newcommand{\Jinj}[1][]{\Iinj[\J#1]}
\newcommand{\Jcell}[1][]{\Icell[\J#1]}
\newcommand{\Jcof}[1][]{\Icof[\J#1]}
\newcommand{\cyli}{i}

\numberwithin{figure}{section}

\newcommand{\pb}[1][dr]{\save*!/#1-1.2pc/#1:(-1,1)@^{|-}\restore}
\newcommand{\po}[1][dr]{\save*!/#1+1.2pc/#1:(1,-1)@^{|-}\restore}

\begin{document}

\title{Morita equivalences between algebraic dependent type theories}

\author{Valery Isaev}

\begin{abstract}
\end{abstract}

\maketitle

\section{Introduction}

The category of algebraic dependent type theories was defined in \cite{alg-tt}.

\section{Morita equivalences of theories}

In this section we define several notions of weak equivalence of algebraic dependent type theories.

\subsection{Algebraic dependent type theories}

Recall that an algebraic dependent type theory $T$ consists of a set $\mathcal{F}$ of function symbols, a set $\mathcal{P}$ of predicate symbols and a set of axioms.
The set of sorts $\mathcal{S}$ is defined as $\{ \ctx, \tm \} \times \mathbb{N}$.
We also write $(\ty,n)$ for $(\ctx,n+1)$.
Every function symbol $\sigma \in \mathcal{F}$ is equipped with a signature $\sigma : s_1 \times \ldots \times s_k \to s$ where $s_1, \ldots s_k, s \in \mathcal{S}$.
Every predicate symbol $R \in \mathcal{P}$ is equipped with a signature $R : s_1 \times \ldots \times s_k$ where $s_1, \ldots s_k \in \mathcal{S}$.
The set $\Term_T(V)_s$ of terms of sort $s$ with variable in $V$ is defined inductively from $\mathcal{F}$ as usual.
An atomic formula with variables in $V$ is an expression either of the form $t_1 = t_2$  where $t_i \in \Term_T(V)_s$ or of the form $R(t_1, \ldots t_k)$ where $t_i \in \Term_T(V)_{s_i}$.
A formula with variables in $V$ is an expression of the form $\varphi_1 \land \ldots \land \varphi_n$ where $\varphi_i$ are atomic formulas.
An axiom is an expression of the form $\varphi \sststile{}{V} \psi$ where $\varphi$ and $\psi$ are formulas with variables in $V$.
We will write $\varphi \sststile{T}{V} \psi$ to denote the fact that sequent $\varphi \sststile{}{V} \psi$ is derivable in $T$ using the following inference rules:
\begin{center}
$\varphi \sststile{}{V} \varphi$ \axlabel{b1}
\qquad
\AxiomC{$\varphi \sststile{}{V} \psi$}
\AxiomC{$\psi \sststile{}{V} \chi$}
\RightLabel{\axlabel{b2}}
\BinaryInfC{$\varphi \sststile{}{V} \chi$}
\DisplayProof
\qquad
$\varphi \sststile{}{V} \top$ \axlabel{b3}
\end{center}

\medskip
\begin{center}
$\varphi \land \psi \sststile{}{V} \varphi$ \axlabel{b4}
\qquad
$\varphi \land \psi \sststile{}{V} \psi$ \axlabel{b5}
\qquad
\AxiomC{$\varphi \sststile{}{V} \psi$}
\AxiomC{$\varphi \sststile{}{V} \chi$}
\RightLabel{\axlabel{b6}}
\BinaryInfC{$\varphi \sststile{}{V} \psi \land \chi$}
\DisplayProof
\end{center}

\medskip
\begin{center}
$\sststile{}{x} x\!\downarrow$ \axlabel{a1}
\qquad
$x = y \land \varphi \sststile{}{V,x,y} \varphi[y/x]$ \axlabel{a2}
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \psi$}
\RightLabel{, $x \in FV(\varphi)$ \axlabel{a3}}
\UnaryInfC{$\varphi[t/x] \sststile{}{V,V'} \psi[t/x]$}
\DisplayProof
\end{center}
\medskip

We will give several proofs by induction on the derivation of a sequent.
We need to work with sequents in which the left hand side has some property, but in a derivation of a sequent in this logic the left hand side may vary arbitrary.
Thus we describe another set of rules which is equivalent to this one and in which the left hand side stays the same.
We call these rules the \emph{natural deduction system}.
In this system the right hand side of all sequents is an atomic formula.

\begin{center}
\AxiomC{}
\RightLabel{\axlabel{nv}}
\UnaryInfC{$\varphi \sststile{}{V} x\!\downarrow$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} a = b$}
\RightLabel{\axlabel{ns}}
\UnaryInfC{$\varphi \sststile{}{V} b = a$}
\DisplayProof
\end{center}

\begin{center}
\AxiomC{}
\RightLabel{\axlabel{nh}}
\UnaryInfC{$\varphi_1 \land \ldots \land \varphi_n \sststile{}{V} \varphi_i$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} a = b$}
\AxiomC{$\varphi \sststile{}{V} \psi[a/x]$}
\RightLabel{\axlabel{nl}}
\BinaryInfC{$\varphi \sststile{}{V} \psi[b/x]$}
\DisplayProof
\end{center}

\begin{center}
\AxiomC{$\varphi \sststile{}{V} R(t_1, \ldots t_n)$}
\RightLabel{\axlabel{np}}
\UnaryInfC{$\varphi \sststile{}{V} t_i\!\downarrow$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} \sigma(t_1, \ldots t_n)\!\downarrow$}
\RightLabel{\axlabel{nf}}
\UnaryInfC{$\varphi \sststile{}{V} t_i\!\downarrow$}
\DisplayProof
\end{center}
where $R$ is a predicate symbol of the theory and $\sigma$ is its function symbol.

Finally, for every axiom $\psi_1 \land \ldots \land \psi_n \sststile{}{x_1 : s_1, \ldots x_k : s_k} \chi_1 \land \ldots \land \chi_m$
and for all terms $t_1 : s_1$, \ldots $t_k : s_k$, we have the following rules for all $1 \leq j \leq m$:
\smallskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} t_i\!\downarrow$, $1 \leq i \leq k$}
\AxiomC{$\varphi \sststile{}{V} \psi_i[t_1/x_1, \ldots t_k/x_k]$, $1 \leq i \leq n$}
\RightLabel{\axlabel{na}}
\BinaryInfC{$\varphi \sststile{}{V} \chi_j[t_1/x_1, \ldots t_k/x_k]$}
\DisplayProof
\end{center}

\begin{prop}
A sequent $\varphi \sststile{}{V} \psi_1 \land \ldots \land \psi_n$ is derivable in the system of rules \axref{b1}-\axref{b6}, \axref{a1}-\axref{a3} if and only if
sequents $\varphi \sststile{}{V} \psi_1$, \ldots $\varphi \sststile{}{V} \psi_n$ are derivable in the natural deduction system.
\end{prop}
\begin{proof}
It is easy to prove the ``if'' part.
Conversely, the rules \axref{b1}, \axref{b4}, and \axref{b5} follow from \axref{nh},
the rules \axref{b3} and \axref{b6} hold trivially,
the rule \axref{a1} follows from \axref{nv},
the rule \axref{a2} follows from \axref{nl} and \axref{nh},
and every axiom is derivable from \axref{na}.

To prove the rule \axref{b2}, we just need to show that if sequents $\varphi \sststile{}{V} \psi_1$, \ldots $\varphi \sststile{}{V} \psi_n$,
and $\psi_1 \land \ldots \land \psi_n \sststile{}{V} \chi$ are derivable in the natural deduction, then $\varphi \sststile{}{V} \chi$ is also derivable.
We can construct a derivation tree for this sequent as a derivation tree for $\psi_1 \land \ldots \land \psi_n \sststile{}{V} \chi$
in which the left hand sides of all sequents are replaced with $\varphi$ and rules \axref{nh} are replaced with derivation trees for $\varphi \sststile{}{V} \psi_i$.

To prove the rule \axref{a3}, consider a derivation tree for a sequent $\varphi \sststile{}{V} \psi$.
To construct a derivation tree for $\varphi[t/x] \sststile{}{V,V'} \psi[t/x]$, we just need to apply the substitution to every sequent in this derivation tree.
The only rule that is not closed under substitution is \axref{nv}.
By assumption, $x \in FV(\varphi)$.
In this case the sequent $\varphi[t/x] \sststile{}{V,V'} t\!\downarrow$ is derivable from \axref{np}, \axref{nf} and the following rules:
\begin{center}
\AxiomC{$\varphi \sststile{}{V} t_1 = t_2$}
\RightLabel{\axlabel{ne1}}
\UnaryInfC{$\varphi \sststile{}{V} t_1\!\downarrow$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} t_1 = t_2$}
\RightLabel{\axlabel{ne2}}
\UnaryInfC{$\varphi \sststile{}{V} t_2\!\downarrow$}
\DisplayProof
\end{center}
The rule \axref{ne2} follows from \axref{nl} if we take $\psi(x) = (x = b)$.
The rule \axref{ne1} follows from \axref{ne2} and \axref{ns}.
\end{proof}

We will need the following lemma later:

\begin{lem}[mcf]
A sequent $\varphi \sststile{}{x_1, \ldots x_n} \psi$ is provable in a theory $T$ if and only if
the sequent $\sststile{}{} \psi[c_1/x_1, \ldots c_n/x_n]$ is provable in the theory $T \cup \{ \sststile{}{} c_i\!\downarrow\ |\ 1 \leq i \leq n \} \cup \{ \varphi[c_1/x_1, \ldots c_n/x_n] \}$,
where $c_1$, \ldots $c_n$ are fresh constants.
\end{lem}
\begin{proof}
This follows from \cite[Theorem~10, Theorem~11]{PHL}.
\end{proof}

\subsection{Model categories of models of type theories}

To define Morita equivalences between two theories $T_1$ and $T_2$, they must have some additional structure.
We assume that all of the theories are equipped with a morphism from the theory that has one function symbol
$\Id : (\tm,0) \times (\tm,0) \to (\ty,0)$ and the only axiom $\Id(x,y)\!\downarrow\ \sststile{}{x,y} \ty(x) = \ty(y)$.
We will denote this theory by $\IdT_0$.
We often need to assume even more structure, but we will always state additional assumptions explicitly.

Let $T$ be a theory under $\IdT_0$ and let $X$ be a model of $T$.
A \emph{relative homotopy} between terms $a,a' \in X_{(\tm,n)}$ is a term $h \in X_{(\tm,n)}$ such that $\ty(h) = \Id(a,a')$.
A \emph{relative homotopy} between types $A,A' \in X_{(\ty,n)}$ is a tuple $(f,g,p,g',p')$, where $f,g,p,g',p' \in X_{(\tm,n+1)}$ such that
\begin{align*}
x : A & \vdash f : A' \\
y : A' & \vdash g : A \\
x : A & \vdash p : \Id(g[y \mapsto f], x) \\
y : A' & \vdash g' : A \\
y : A' & \vdash p' : \Id(f[x \mapsto g], y)
\end{align*}

In general the homotopy relation is not an equivalence relation, but it is if $T$ also has the reflexivity and transport operations:
\begin{center}
\AxiomC{}
\UnaryInfC{$\vdash \refl(x) : \Id(x,x)$}
\DisplayProof
\qquad
\AxiomC{$\vdash p : \Id(a,a')$}
\AxiomC{$\vdash b : B[a]$}
\BinaryInfC{$\vdash \transport(B,a,a',p,b) : B[a']$}
\DisplayProof
\end{center}

Let $X$ and $Y$ be models of a theory with identity types.
A morphism of models $f : X \to Y$ is \emph{weak equivalence} if it satisfies the following conditions:
\begin{enumerate}
\item For all $A \in X_{(\ty,n)}$ and $a \in Y_{(\tm,n)}$ such that $\ty(a) = f(A)$,
there is a term $a' \in X_{(\tm,n)}$ such that $\ty(a') = A$ and $f(a')$ is relatively homotopic to $a$.
In this case we will say that $f$ is \emph{essentially surjective on terms}.
\item For all $\Gamma \in X_{(\ctx,n)}$ and $A \in Y_{(\ty,n)}$ such that $\ft(A) = f(\Gamma)$,
there is a type $A' \in X_{(\ty,n)}$ such that $\ft(A') = \Gamma$ and $f(A')$ is relatively homotopic to $A$.
In this case we will say that $f$ is \emph{essentially surjective on types}.
\end{enumerate}

For every theory $T$ under $\IdT_0$, we define a set $\I$ of maps in the category of models of $T$ as the set consisting of maps of the form
\[ F(\{ A : (d_p,n) \}) \to F(\{ e_p(a) = A \}) \]
where $d_\ty = \ctx$, $d_\tm = \ty$, $e_\ty(a) = \ft(a)$, $e_\tm(a) = \ty(a)$,
and $F(S)$ is the free model generated by the specified generators and relations.
The class of \emph{cofibrations} of $\Mod{T}$ is generated by $\I$.

Let $\J$ be the set consisting of maps of the following forms:
\begin{align*}
F(\{ a : (\tm,n) \}) & \to F(\{ a, a' : (\tm,n), p : \Id(a,a') \}) \\
F(\{ A : (\ty,n) \}) & \to F(\{ A, A' : (\ty,n), f,g,p,g',p' : (\tm,n+1), S \}),
\end{align*}
where $S$ is the set of formulas asserting that $(f,g,p,g',p')$ is a relative homotopy between $A$ and $A'$.
The class of \emph{anodyne extensions} is generated by $\J$.

We are interested in question when the classes of cofibrations and weak equivalences as defined above determine a model structure or a left semi-model structure.
We will use the definition of left semi-model structures given in \cite[Lemma~6.7]{kap-lum-model}.
We will say that a theory is \emph{good} (resp., \emph{semi-good}) if this model structure (resp., left semi-model structure) exists on the category of its models.
We proved several results about model structures in \cite{f-model-structures} which are useful when working with this model structure and they also apply to left semi-model structure.

\begin{prop}[good-theories]
A theory is good if and only if the weak equivalences satisfy the 2-out-of-3 property and pushouts of maps in $\J$ are weak equivalences.
A theory is semi-good if and only if the weak equivalences satisfy the 2-out-of-6 property and a pushout of a map in $\J$ is a weak equivalence if it has a cofibrant domain.
\end{prop}
\begin{proof}
This follows from \cite[Proposition~3.1]{f-model-structures} and the fact that weak equivalences are closed under transfinite compositions.
\end{proof}

It was shown in \cite{kap-lum-model} that a certain theory with identity types, $\Sigma$-types, and $\Pi$-types is semi-good.
We proved in \cite{alg-models} that all theories under $\coeT_1 + \sigma + \PathT + \wUA$ are good.
The argument that shows this actually applies to any theory under $\coeT^{l'}_2 + \PathT + \wUA$ (see the cited paper for the definition of these theories).
We will prove that a theory under $\coeT_1 + \sigma + \PathT + \wUA$ is often equivalent to a theory under $\coeT^{l'}_2 + \PathT + \wUA$, so we might work with either of them,
but we prefer to use the latter theory since it is harder to show that theories with the $\sigma$ rule are confluent (see section~\ref{sec:confluent} for a definition of a confluent theory).

\subsection{Morita equivalences}

Now, we can give the main definition of this paper.

\begin{defn}
A \emph{Morita equivalence} between theories $T_1$ and $T_2$ is a morphism $f : T_1 \to T_2$ such that for every cofibrant model $X$ of $T_1$,
the unit $\eta_X : X \to f^*(f_!(X))$ of the adjunction $f_! \dashv f^*$ is a weak equivalence.
We will say that $f$ is a \emph{strong Morita equivalence} if $\eta_X$ is a weak equivalence for every $X$.
We will say that $f$ is a \emph{syntactic equivalence} if $\eta_X$ is a weak equivalence when $X$ is the initial model.
\end{defn}

If the theories are semi-good, then we can give a characterization of Morita equivalences in terms of the semi-model structures on the categories of their models.

\begin{prop}[morita-quillen]
Let $T_1$ and $T_2$ be semi-good theories.
Then, for every morphism $f : T_1 \to T_2$, the adjunction $f_! \dashv f^*$ is a Quillen adjunction.
It is a Quillen equivalence if and only if $f$ is a Morita equivalence.
\end{prop}
\begin{proof}
Since $f_!$ is a left adjoint, it preserves object defined by generators and relations.
Since the set of generating cofibration $\I$ and the set of generating trivial cofibration $\J_\I$
are both defined in terms of generators and relations, this implies that $f_!$ preserves them.
Hence $f_! \dashv f^*$ is a Quillen adjunction.
The second part of the proposition follows from \cite[Corollary~3.9]{f-model-structures}.
\end{proof}

We can give a useful characterization of (strong) Morita equivalences.
To do this, we need to define a notion of a relative homotopy between terms in a theory.
Let $T$ be a theory with identity types and let $\varphi$ be a formula of $T$.
A \emph{relative homotopy} between types $A,A' \in \Term_T(V)_{(\ty,n)}$ with respect to $\varphi$ is a tuple $f,g,p,g',p' \in \Term_T(V)_{(\tm,n+1)}$
such that sequent $\varphi \sststile{}{V} \psi$ is derivable in $T$, where $\psi$ is the conjunction of formulas that appear in the definition of a relative homotopy for models.
If $a,a' \in \Term_T(V)_{(\tm,n)}$ are terms such that $\varphi \sststile{}{V} \ty(a) = \ty(a')$, then a \emph{relative homotopy} between $a$ and $a'$ with respect to $\varphi$ is a term $h \in \Term_T(V)_{(\tm,n)}$
such that sequent $\varphi \sststile{}{V} \ty(h) = \Id(a,a')$ is derivable in $T$.
If $a$ and $a'$ are such that only $\varphi \sststile{}{V} \ft(\ty(a)) = \ft(\ty(a'))$ is true, then a \emph{relative (heterogeneous) homotopy} between $a$ and $a'$ with respect to $\varphi$
is a relative homotopy $f,g,p,g',p'$ between $\ty(a)$ and $\ty(a')$ together with a relative homotopy between $f[a]$ and $a'$.

Let $V$ be a set of variables and let $\varphi$ be a formula with free variables in $V$.
We will say that a morphism $f : T_1 \to T_2$ of theories with identity types has the weak lifting property with respect to $V,\varphi$ if
for every term $A \in \Term_{T_1}(V)_{(d_p,n)}$ and every term $a \in \Term_{T_2}(V)_{(p,n)}$ such that $\varphi \sststile{}{V} A\!\downarrow$ and $f(\varphi) \sststile{}{V} e_p(a) = f(A)$,
there exists a term $a' \in \Term_{T_1}(V)_{(p,n)}$ such that $f(a')$ is relatively homotopic to $a$ with respect to $\varphi$.
We will say that $f$ has the lifting property with respect to $V,\varphi$ if $f(a')$ is not only homotopic to $a$, but also equals it.

If $P$ is a set of pairs of the form $V,\varphi$, then we will say that a map has the (weak) lifting property with respect to $P$ if it has this property with respect to every element of $P$.
We define $P_0$ as the singleton set $\{ \varnothing,\top \}$, $P_S$ as the set of all pairs, and $P_M$ as the set of pairs $V,\varphi$ such that $V = \{ x_1, \ldots x_k \}$
and $\varphi = \varphi_1 \land \ldots \land \varphi_k$, where $\varphi_i$ equals to $e_p(x_i) = t_i$,
where $t_i$ is a term of $T_1$ with free variables in $\{ x_1, \ldots x_{i-1} \}$ such that for every $1 \leq i \leq k$,
sequent $\varphi_1 \land \ldots \land \varphi_{i-1} \sststile{}{x_1, \ldots x_{i-1}} t_i\!\downarrow$ is derivable in $T_1$.

\begin{prop}[str-morita-char]
A morphism $f : T_1 \to T_2$ between theories with identity types is a strong Morita equivalence if and only if it has the weak lifting property with respect to $P_S$.
\end{prop}
\begin{proof}
First, we need to introduce an auxiliary construction.
Let $T$ be a theory, let $V$ be a set of variables, and let $\mathcal{A}$ be a set formulas of $T$ with variables in $V$.
Then we define $\Syn(T,V,\mathcal{A})$ as $\Syn(T \cup \{ O_x : s\ |\ x \in V_s \} \cup \mathrm{sp}(\mathcal{A}))$ (functors $\Syn$ and $\Lang$ are defined in \cite{alg-models}),
where $\mathrm{sp}(\mathcal{A})$ consists of formulas of the form $\sststile{}{} O_x\!\downarrow$ for every $x \in V$
and formulas of $\mathcal{A}$ in which every variable $x$ is replaced with $O_x$.
If $f : T_1 \to T_2$ is a morphism of theories, then it is easy to see that $f_!(\Syn(T_1,V,\mathcal{A})) = \Syn(T_2,V,f(\mathcal{A}))$.

Let us prove the ``only if'' direction.
Note that elements of $\Syn(T_1, V, \{\,\sststile{}{}~\varphi\,\})$ correspond to terms $t$ of $T_1$ with variables in $V$ such that $\varphi \sststile{T_1}{V} t\!\downarrow$.
Moreover, two terms $t_1$ and $t_2$ map to the same element under this correspondence if and only if $\varphi \sststile{T_1}{V} t_1 = t_2$.
Analogous statement holds for $\Syn(T_2, V, \{\,\sststile{}{}~f(\varphi)\,\})$.
Using this correspondence, the required conditions immediately follow from the fact that
map $\Syn(T_1, V, \{\,\sststile{}{}~\varphi\,\}) \to f^*(\Syn(T_2, V, \{\,\sststile{}{}~f(\varphi)\,\}))$ is a weak equivalence.

Now, let us prove the ``if'' direction.
Let $M$ be a model of $T_1$.
Note that $M$ is isomorphic to $\Syn(T_1, U(M), \mathcal{A})$, where $U(M)$ is the underlying set of $M$ and $\mathcal{A}$ is the set of formulas of the form
$x = \sigma(x_1, \ldots x_k)$ and $R(x_1, \ldots x_k)$ for all $x, x_1, \ldots x_k \in M$ such that these formulas hold in $M$.
Note that $sp(\mathcal{A})$ is the set of axioms of $\Lang(M)$.

Let $A \in M_{(d_p,n)}$ and $a \in f^*(f_!(M))$ be elements such that $e_p(a) = A$.
Since $f_!(M) = \Syn(T_2, U(M), f(\mathcal{A}))$, $a$ is a closed term of $T_2$.
There is a finite subset $\mathcal{A}_0$ of $\mathcal{A}$ such that $\sststile{T_2 \cup \mathrm{sp}(\mathcal{A}_0)}{} e_p(a) = A$.
Let $\varphi$ be the conjunction of $\mathcal{A}_0$, and let $b$ and $B$ be $a$ and $A$, respectively, in which every constant $O_x$ is replaced with variable $x$.
Then $\varphi \sststile{T_2}{U(M)} e_p(b) = B$.
By assumption, there exist a term $b' \in \Term_{T_1}(U(M))_{(p,n)}$ and a relative homotopy $h$ between $f(b)$ and $b'$.
These terms correspond under $\mathrm{sp}$ to elements of $M$ and $f^*(f_!(M))$, respectively.
These conditions imply that $b'$ is the required lifting and $h$ is the required homotopy.
\end{proof}

Analogous characterizations hold for Morita and syntacric equivalences:

\begin{prop}[morita-char]
A morphism $f : T_1 \to T_2$ between theories with identity types is a Morita equivalence if and only if it has the weak lifting property with respect to $P_M$.
\end{prop}
\begin{proof}
Suppose that $f$ is a Morita equivalence.
To prove that $f$ has the weak lifting property, we just need to show that model $M = \Syn(T_1, \{ x_1, \ldots x_k \}, \{\,\sststile{}{}~\varphi\,\})$
constructed in the previous proposition is cofibrant.
Note that for every $1 \leq i \leq k$, we have the following pushout square:
\[ \xymatrix{ F(\{ A : (d_p,n) \}) \ar[d] \ar[r] &     \Syn(T_1, \{ x_1, \ldots x_{i-1} \}, \{\,\sststile{}{} \varphi_1 \land \ldots \land \varphi_{i-1} \,\}) \ar[d] \\
              F(\{ e_p(a) = A \})         \ar[r] & \po \Syn(T_1, \{ x_1, \ldots x_i \}, \{\,\sststile{}{} \varphi_1 \land \ldots \land \varphi_i \,\}),
            } \]
where the top arrow maps $A$ to $t_i$ and the bottome arrow maps $a$ to $x_i$.
This shows that $M$ is a relative $\I$-cell complex.

Now, let us prove the converse.
We just need to show that if $M$ is a cofibrant model of $T_1$, then we can choose formula $\varphi$
in the second part of the proof of the previous proposition so that it satisfies the conditions of this proposition.

Since every cofibrant object is a retract of a relative $\I$-cell complex and Morita equivalences are closed under retracts, we may assume that $M$ is a relative $\I$-cell complex.
Moreover, we may assume that there are subsets $\{S_i\}_{i \in \mathbb{N}}$ of elements of $M$ such that we have the following pushout diagrams:
\[ \xymatrix{ \coprod_{x \in S_i} F(\{ A_x : (d_p,n) \}) \ar[d] \ar[r] &     M_i \ar[d] \\
              \coprod_{x \in S_i} F(\{ e_p(a_x) = A_x \})       \ar[r] & \po M_{i+1},
            } \]
$M_0$ is the initial model, $M$ is the colimit of $M_i$, and map $F(\{ e_p(a_x) = A_x \}) \to M_{i+1} \to M$ sends $a_x$ to $x$.

Note that $M_i$ is isomorphic to $\Syn(T_1, \bigcup_{1 \leq j \leq i} S_j, \mathcal{A}_i)$,
where $\mathcal{A}_i$ consists of formulas of the form $e_p(x) = t$, where $x \in S_i$ and $t \in \Term_{T_1}(\bigcup_{1 \leq j < i} S_j)$ corresponds to the image of $A_x$ in $M_{i-1}$.
Thus, $M$ is isomorphic to $\Syn(T_1, \bigcup_{i \in \mathbb{N}} S_i, \bigcup_{i \in \mathbb{N}} \mathcal{A}_i)$.
Now, if we choose a finite subset of $\bigcup_{i \in \mathbb{N}} \mathcal{A}_i$ as before, then the conjunction of this subset satisfies the required conditions.
\end{proof}

\begin{prop}[syn-equiv-char]
A morphism $f : T_1 \to T_2$ between theories with identity types is a syntactic equivalence if and only if it has the weak lifting property with respect to $P_0$.
\end{prop}
\begin{proof}
This is obvious since elements of the initial model of $T_1$ are closed terms $t$ of $T_1$ such that $\sststile{}{} t\!\downarrow$ is derivable.
\end{proof}

We will show that there is a model structure on the category of theories with the interval type, path types and the weak univalence axiom as described in \cite{alg-models}.
Note that if we assume only usual identity types with the J rule since, then no such model structure (or left semi-model structure, or structure of a cofibration category) can exist since trivial cofibrations are not closed under pushouts.
Indeed, consider theories $T_1 = \IdT \amalg \{ A : (\ty,0), A\!\downarrow \}$ and $T_2 = \IdT \amalg \{ A, A' : (\ty,0), a : (\tm,1), A\!\downarrow, A'\!\downarrow, A \vdash a : A' \}$, where $\IdT$ is some version of the theory of identity types.
\Rprop{str-morita-char} implies that the obvious morphism $T_1 \to T_2$ is a strong Morita equivalence.
Now, consider the theory $T_3 = \{ \sigma : (\ty,0) \to (\ty,0), \sigma(x)\!\downarrow \}$.
Then the map $T_1 \amalg T_3 \to T_2 \amalg T_3$ is not even a syntactic equivalence since types $\sigma(A)$ and $\sigma(A')$ are equal in $T_2 \amalg T_3$, but there is no term between them in $T_1 \amalg T_3$.

It was shown in \cite{alg-models} that the category of models of a theory under $\coeT_1 + \sigma + \PathT + \wUA$ carries a model structure.
If the theory has only identity types, then there is only a left semi-model structure as shown in \cite{kap-lum-model}.
We can generalize this theorem using the following lemma:

\begin{lem}
Let $T_1$ be a theory such that the weak equivalences in $\Mod{T_1}$ satisfy the 2-out-of-6 property.
If $T_2$ is a semi-good theory and $F : T_1 \to T_2$ is a Morita equivalence, then $T_1$ is also semi-good and $F_! \dashv F^*$ is a Quillen equivalence between $\Mod{T_1}$ and $\Mod{T_2}$.
\end{lem}
\begin{proof}
By \rprop{good-theories}, we just need to prove that pushouts of maps in $\J$ with cofibrant codomains are weak equivalences in $\Mod{T_1}$.
Let $f : X \to Y$ be a pushout of a map in $\J$ such that $X$ is cofibrant.
Since $F_!$ preserves pushouts and maps in $\J$, the map $F_!(f)$ is a weak equivalence.
The functor $F^*$ always preserves weak equivalences.
Thus, $F^*(F_!(f))$ is a weak equivalence.
Since $X$ and $Y$ are cofibrant, the maps $\eta_X : X \to F^*(F_!(X))$ and $\eta_Y : Y \to F^*(F_!(Y))$ are weak equivalences.
Hence, $f$ is also a weak equivalence.
\end{proof}

Note that \cite[Proposition~3.3]{kap-lum-model} implies that, for all theories with identity types, $\Sigma$-types, and the unit type, the weak equivalences satisfy the 2-out-of-6 property.
Thus, the first condition of the previous lemma is often true.
We believe that this might be true more generally for all theories with only identity types, but the proofs become much harder without $\Sigma$-types.

Finally, let us prove an analogous lemma for strong Morita equivalences:

\begin{lem}
Let $T_1$ be a theory under $\IdT_0 + \transportT$.
If $T_2$ is a good theory and $F : T_1 \to T_2$ is a strong Morita equivalence, then $T_1$ is also good and $F_! \dashv F^*$ is a Quillen equivalence between $\Mod{T_1}$ and $\Mod{T_2}$.
\end{lem}
\begin{proof}
Since we have the transport operation, the homotopy relation is transitive.
This implies that weak equivalences are closed under composition.
It is also easy to see that if $f : X \to Y$ and $g : Y \to Z$ are maps such that $g$ and $g \circ f$ are weak equivalences, then $f$ is also a weak equivalence.
Now, the same proof as in the previous lemma shows that $F_!$ reflects weak equivalences.

By Theorem~4.2, Proposition~4.3, and Proposition~4.4 from \cite{f-model-structures}, the model structure on $\Mod{T_1}$ exists if there is a path object functor $P : \Mod{T_1} \to \Mod{T_1}$
such that $p : P(X) \to X \times X$ belongs to $\Jinj$ and $\pi_1 \circ p$ belongs to $\Iinj$.
We can define $P(X)$ as usual factorization of the diagonal $X \to X \times X$ into a map $t : X \to P(X)$ in $\Jcell$ followed by a map $p : P(X) \to X \times X$ in $\Jinj$.
Since $F_!$ preserves maps in $\Jcell$, the map $F_!(t)$ is a weak equivalence.
By the 2-out-of-3 property, the map $F_!(\pi_1 \circ p)$ is also a weak equivalence.
Since $F_!$ reflects weak equivalences, this implies that $\pi_1 \circ p$ is a weak equivalence.
Now, since $\pi_1 \circ p$ belongs to $\Jinj$, \cite[Proposition~3.1]{f-model-structures} implies that it also belongs to $\Iinj$.
\end{proof}

\section{Model structure on theories}

In this section we define a model structure on the category of algebraic dependent type theories with anough structure.

\subsection{Categories of theories}

It was shown in \cite{PHL} that partial Horn theories are equivalent to essentially algebraic theories.
It follows that categories of models of these theories are locally presentable.
In this subsection we will prove that different categories of theories are also locally finitely presentable.

We will consider a prestable theory $T$ under some prestable theory $B$.
Recall that a prestable theory is a theory $T$ with a map $\alpha : L(T) \to T$, where $L$ is a functor defined in \cite{alg-tt}.
It was shown in \cite[Lemma~4.4]{alg-tt} that every such theory is isomorphic to a contextual theory,
that is a theory which has $\mathcal{F}_B \amalg (\mathcal{F}_0 \times \mathbb{N})$,
$\mathcal{P}_B \amalg (\mathcal{P}_0 \times \mathbb{N})$ and $\mathcal{A}_B \amalg \mathcal{A}_0$ as the sets of function and predicate symbols and the set of axioms, respectively,
where $\mathcal{F}_0$, $\mathcal{P}_0$, and $\mathcal{A}_0$ are some sets and $\mathcal{F}_B$, $\mathcal{P}_B$, and $\mathcal{A}_B$ are the corresponding sets of $B$.
Elements of $\mathcal{F}_0$, $\mathcal{P}_0$ and $\mathcal{A}_0$ are called basic function symbols, basic predicate symbols, and basic axioms.

Now, we give an explicit construction of coproducts and coequalizers in the category $B/\PSt_{\mathcal{S}_0}$ of prestable theories under $B$,
which is similar to the one described in \cite[Proposition~2.12]{alg-tt} for the category of theories.
If $\{ T_i \}_{i \in I}$ is a set of theories under $B$, then the basic function and predicate symbols
and axioms of $\coprod_{i \in I} T_i$ are the disjoint union of corresponding sets of $T_i$.
If $f,g : T \to T'$ is a pair of maps of theories under $B$, then their coequalizer can be defined as
$T'$ together with the following axioms for every basic function symbol $\sigma$ and every basic predicate symbol $R$ of $T$:
\begin{align*}
& \sststile{}{x_1, \ldots x_k} f(\sigma(x_1, \ldots x_k)) \cong g(\sigma(x_1, \ldots x_k)) \\
& f(R(x_1, \ldots x_k)) \ssststile{}{x_1, \ldots x_k} g(R(x_1, \ldots x_k))
\end{align*}

The colimit of a diagram $T : I \to B/\PSt_{\mathcal{S}_0}$ can be described as the coequalizer of the coproduct $\coprod_{i \in I} T_i$ as usual.
Thus we can assume that the sets of basic function and predicate symbols of $\colim_{i \in I} T_i$ are disjoint unions of the corresponding sets of $T_i$.
The axioms of $\colim_{i \in I} T_i$ are axioms of $T_i$ together with axioms of the form $\sststile{}{x_1, \ldots x_n} \sigma(x_1, \ldots x_n) \cong f(\sigma(x_1, \ldots x_n))$
and $R(x_1, \ldots x_n) \ssststile{}{x_1, \ldots x_n} f(R(x_1, \ldots x_n))$ for every morphism $f : T_i \to T_j$
in the diagram and every function symbol $\sigma$ and predicate symbol $R$ of $T_i$ which are not symbols of $B$.

Let $\lambda$ be a regular cardinal.
We will say that a theory $T = ((\mathcal{S}, \mathcal{F}_0 \amalg \mathcal{F}, \mathcal{P}_0 \amalg \mathcal{P}), \mathcal{A}_0 \amalg \mathcal{A})$
in $\Th_B$ is \emph{$\lambda$-small} if cardinalities of sets $\mathcal{F}$, $\mathcal{P}$ and $\mathcal{A}$ are less than $\lambda$.
We will say that $T$ is \emph{finite} if it is $\aleph_0$-small.

\begin{prop}[theories-presentable]
The category of prestable theories under a prestable theory $B$ is locally finitely presentable.
An object of this category is $\lambda$-presentable if and only if it is isomorphic to a $\lambda$-small object.
\end{prop}
\begin{proof}
First, let us prove that every $\lambda$-small object is $\lambda$-presentable.
Let $\colim_{i \in I} T_i$ be a directed colimit of theories in $B/\PSt_{\mathcal{S}_0}$.
Every term and every formula of a theory is constructed from a finite number of function and predicate symbols.
Thus for every formula of $\colim_{i \in I} T_i$ there exists a theory $T_i$ such that this formula belongs to $T_i$.
The same is true for terms and restricted terms.

Every derivation of a theorem $\varphi \sststile{}{V} \psi$ is constructed from a finite number of function symbols, predicate symbols and axioms.
Thus for every theorem $\varphi \sststile{}{V} \psi$ of $\colim_{i \in I} T_i$ there exists a theory $T_i$ such that $\varphi \sststile{}{V} \psi$ is a theorem of $T_i$.
Note that the additional axioms of $\colim_{i \in I} T_i$ that was added for every $f : T_i \to T_j$ are always true in $T_j$.

Let $h : T \to \colim_{i \in I} T_i$ be a morphism from a $\lambda$-small theory $T$ to a $\lambda$-directed colimit of theories $\{ T_i \}_{i \in I}$.
Since $T$ is $\lambda$-small, there exists a theory $T_i$ such that for every function symbol $\sigma$, predicate symbol $R$ and axiom $\varphi \sststile{}{V} \psi$ of $T$,
restricted terms $h(\sigma(x_1, \ldots x_n))$ and formulae $h(R(x_1, \ldots x_n))$ belong to $T_i$, and $h(\varphi) \sststile{}{V} h(\psi)$ is a theorem of $T$.
Thus $h$ factors through $T_i$.

Let $h_1,h_2 : T \to T_i$ be morphisms such that $g_i \circ h_1 = g_i \circ h_2$, where $g_i : T_i \to \colim_{i \in I} T_i$.
Then for every function symbol $\sigma$ of $T$, sequent
\[ \sststile{}{x_1, \ldots x_n} h_1(\sigma(x_1, \ldots x_n)) \cong h_2(\sigma(x_1, \ldots x_n)) \]
is a theorem of $\colim_{i \in I} T_i$.
But we already know that there exists a theory $T_j$ such that $i \leq j$ and this sequent is a theorem of $T_j$.
The same is true for every predicate symbol of $T$.
It follows that $f \circ h_1 = f \circ h_2$, where $f : T_i \to T_j$.

Now, let us prove that $B/\PSt_{\mathcal{S}_0}$ is locally finitely presentable.
We only need to show that every theory in $B/\PSt_{\mathcal{S}_0}$ is a $\lambda$-directed colimit of its $\lambda$-small subtheories.
Let $T$ be a theory, and let $\{ f_i : T_i \to T' \}_{i \in I}$ be a cocone over the diagram of $\lambda$-small subtheories of $T$.
For every basic function or predicate symbol $p$ of $T$,
there is a finite subtheory $T_p$ of $T$ which contains symbols and axioms of $B$ and one additional symbol $p$ and no other axiom.
A morphism $h$ of cocones $T$ and $T'$ must commute with morphisms from $T_p$.
Thus it must be defined as $h(p(x_1, \ldots x_n)) = f_p(p(x_1, \ldots x_n))$; hence it is unique.
To prove that this defines a morphism, we need to show that $h$ preserves axioms of $T$.
But every axiom involes only a finite number of symbols of $T$.
Hence there exists a subtheory $T_i$ of $T$ which consists of these symbols and this axiom.
Since $f_i$ is a morphism of theories, this axiom also holds in $T'$.

Finally, let us prove that every $\lambda$-presentable theory $T$ in $B/\PSt_{\mathcal{S}_0}$ is isomorphic to a $\lambda$-small theory.
Consider the identity map $id_T : T \to T$.
Since $T$ is a $\lambda$-directed colimit of its $\lambda$-small subtheories, $id_T$ factors through some $\lambda$-small subtheory $T'$ of $T$.
Thus we have maps $f : T \to T'$ and $g : T' \to T$ such that $g \circ f = id_T$.
Since $T$ is a coequalizer of $f \circ g$ and $id_{T'}$, it is isomorphic to the coequalizer of $f \circ g$ and $id_{T'}$ as constructed above, which is a $\lambda$-small theory.
\end{proof}

\begin{cor}
The categories of stable and $c$-stable theories and categories of (stable, $c$-stable) algebraic dependent type theories are all locally finitely presentable.
\end{cor}
\begin{proof}
Each of this categories is a full reflective subcategory of the category of prestable theories closed under all colimits.
It follows from the previous propostion that they are locally finitely presentable.
\end{proof}

\subsection{Model structure}

Let $T_I = \coeT^{l'}_2 + \PathT + \wUA$ be the theory defined in \cite{alg-models}.
In this subsection we define a model structure on the category $T_I/\algtt$ of algebraic dependent type theories under $T_I$.

To construct this model structure, we need to recall a few definitions from \cite{f-model-structures}.
A reflexive cylinder object $C_U(V)$ for a map $i : U \to V$ is any factorization of $[id_V,id_V] : V \amalg_U V \to V$.
Maps $f,g : V \to X$ are homotopic relative to a cylinder object $[\cyli_0,\cyli_1] : V \amalg_U V \to C_U(V)$, if there exists a map $h : C_U(V) \to X$
such that $h \circ \cyli_0 = f$ and $h \circ \cyli_1 = g$.
In this case we will write $f \sim_i g$.
We say that a map $f : X \to Y$ has RLP up to $\sim_i$ with respect to $i : U \to V$ if for every commutative square of the form
\[ \xymatrix{ U \ar[r]^u \ar@{}[dr]|(.7){\sim_i} \ar[d]_i & X \ar[d]^f \\
              V \ar[r]_v \ar@{-->}[ur]^g                  & Y,
            } \]
there is a dotted arrow $g : V \to X$ such that $g \circ i = u$ and $(f \circ g) \sim_i v$.
We will say that a map has RLP up to relative homotopy with respect to a set $\I$ of maps if it has RLP up to $\sim_i$ with respecto to every $i \in \I$.

We will also need the following theorem from \cite{f-model-structures}:
\begin{thm}[model-structure]
Let $\C$ be a complete and cocomplete category, and let $\I$ be a set of maps of $\C$
such that the domains and the codomains of maps in $\I$ are small relative to $\Icell$.
For every $i : U \to V \in \I$, choose a reflexive relative cylinder object $C_U(V)$
such that $[\cyli_0,\cyli_1] : V \amalg_U V \to C_U(V) \in \Icof$.
Let $\J_\I = \{\ \cyli_0 : V \to C_U(V)\ |\ i : U \to V \in \I \ \}$, and
let $\we_\I$ be the set of maps which have RLP up to relative homotopy with respect to $\I$.

Suppose that for all composable $f \in \Jcell[_\I] \cup \we_\I$ and $g$, if $g \circ f \in \we_\I$, then $g \in \we_\I$.
Then there exists a cofibrantly generated model structure on $\C$ with $\I$ as a set of generating cofibrations,
$\J_\I$ as a set of generating trivial cofibrations, and $\we_\I$ as a class of weak equivalences.
\end{thm}

For every sequence $(p_1,n_1), \ldots (p_{k+1},n_{k+1})$ of sorts, let $T_{(p_1,n_1), \ldots (p_{k+1},n_{k+1})}$ be the theory
with function symbols $\sigma_i : (p_1,n_1) \times \ldots \times (p_{i-1},n_{i-1}) \to (d_{p_i},n_i)$ for every $1 \leq i \leq k$,
$\sigma_{k+1} : (p_1,n_1) \times \ldots \times (p_k,n_k) \to (p_{k+1},n_{k+1})$,
and axioms $\varphi_1 \land \ldots \land \varphi_i \sststile{}{x_1, \ldots x_i} \sigma_{i+1}(x_1, \ldots x_i)\!\downarrow$ for every $1 \leq i \leq k$,
where $\varphi_j$ equals to $e_{p_j}(x_j) = \sigma_j(x_1, \ldots x_{j-1})$.
Let $\I$ be the set of maps of the form $T_{l, (d_p,n)} \to T_{l, (p,n)}$, where $l = s_1, \ldots s_k$ is any sequence of sorts,
$\sigma_i$ maps to $\sigma_i$ for every $1 \leq i \leq k$, and $\sigma_{k+1}$ maps to $e_p(\sigma_{k+1})$.
Let $\I_0 \subseteq \I$ be the subset which consists of the maps $T_{l, (d_p,n)} \to T_{l, (p,n)}$ such that $l$ is empty.

For every map in $\I$, we need to define a relative cylinder object for it.
Let $C_{T_{l,(\ty,n)}}(T_{l,(\tm,n)})$ be the theory with the same symbols and axioms as $T_l$,
three additional function symbol $\sigma, \sigma', h : s_1 \times \ldots \times s_k \to (\tm,n)$,
and axioms making $h$ into a relative homotopy between $\sigma$ and $\sigma'$ with respect to $\varphi_1 \land \ldots \land \varphi_k$.
Analogously, we define $C_{T_{l,(\ctx,n)}}(T_{l,(\ty,n)})$ to be the theory with the same symbols and axioms as $T_l$,
seven additional function symbols $\sigma,\sigma' : s_1 \times \ldots \times s_k \to (\ty,n)$, $f,g,g',p,q : s_1 \times \ldots \times s_k \to (\tm,n+1)$,
and axioms making $(f,g,g',p,q)$ into a relative homotopy between $\sigma$ and $\sigma'$ with respect to $\varphi_1 \land \ldots \land \varphi_k$.
Maps $\cyli_0,\cyli_1 : T_{l,(\tm,n)} \to C_{T_{l,(\ty,n)}}(T_{l,(\tm,n)})$ and their retraction
$s : C_{T_{l,(\ty,n)}}(T_{l,(\tm,n)}) \to T_{l,(\tm,n)}$ are defined in the obvious way.

\begin{remark}[triv-fib-lift]
By \rprop{morita-char}, a map has RLP up to relative homotopy with respect to $\I$ if and only if it is a Morita equivalence.
Similarly, \rprop{syn-equiv-char} implies that a map has RLP up to relative homotopy with respect to $\I_0$ if and only if it is a syntactic equivalence.
\end{remark}

\begin{lem}[jcell-morita]
Let $f : X \to Y$ be a pushout of $\cyli_0 : T_{l,(\tm,n)} \to C_{T_{l,(\ty,n)}}(T_{l,(\tm,n)})$ (in the category of $I$-stable theories under $T_I$)
and let $g : Y \to X$ be the retraction of $f$ which is the pushout of $s$.
Let $\varphi$ be a formula of $X$ such that for every predicate symbol $R$ occurring in $\varphi$,
sequent $R(x_1, \ldots x_k) \sststile{}{x_1, \ldots x_k} \alpha(L(R))(I, I \times x_1, \ldots I \times x_k)$ is derivable in $X$.

Then for every term $t$ of $Y$ such that $f(\varphi) \sststile{}{V} t\!\downarrow$, terms $t$ and $f(g(t))$ are relatively homotopic with respect to $f(\varphi)$.
\end{lem}
\begin{proof}
This lemma is analogous to \cite[Lemma~3.7]{alg-models}.
We defined there a function $h : \Term_Y(V)_{(p,n)} \to \Term_Y(L(V))_{(p,n+1)}$ such that $h$ preserves theorems in the sense that
if $\chi \sststile{}{V} \psi$ is a theorem of $Y$, then $h(\chi) \land \bigwedge_{x \in L(V)} \ctx^n(x) = I \sststile{}{L(V)} h(\psi)$ is also a theorem.
Note that $h(f(\varphi)) = \alpha(L(f(\varphi)))$ since $f(\varphi)$ contains only symbols of $X$.
The condition we put on $\varphi$ implies that sequent $f(\varphi) \sststile{}{V} h(f(\varphi))[\rho]$ is derivable, where $\rho(x) = I \times x$.
Thus we have the following theorem: $f(\varphi) \sststile{}{V} h(t)[\rho]\!\downarrow$.

Moreover, we have theorems $h(t)[\rho]\!\downarrow\ \sststile{}{V} h(t)[\rho][left] = f(g(t))$ and $h(t)[\rho]\!\downarrow\ \sststile{}{V} h(t)[\rho][right] = t$
(here, $[\rho]$ is an operation of substitution on terms and $[left]$ and $[right]$ are derived function symbols in the theory; we are sorry for this clash of the notation).
Thus $h(t)[\rho]$ gives us the required homotopy between $t$ and $f(g(t))$.
\end{proof}

\begin{thm}[theories-model-structure]
There exists a model structure on the category of $I$-stable algebraic dependent type theories under $T_I$
with $\I$ as the set of generating cofibrations, Morita equivalences as weak equivalences, and in which all objects are fibrant.
We call it \emph{the Morita model structure}.
\end{thm}
\begin{proof}
Note that the set $\we_\I$ consists of Morita equivalences.
Since Quillen equivalences satisfy the 2-out-of-3 property, by \rprop{morita-quillen}, Morita equivalences between theories under $T_I$ also satisfy it.
Since the codomains of maps in $\I$ are finite, Morita equivalences are closed under transfinite compositions.
Thus by \rthm{model-structure}, we just need to prove that pushouts of maps $\cyli_0 : T_{l,(p,n)} \to C_{T_{l,(d_p,n)}}(T_{l,(p,n)})$ are Morita equivalences.
Let $f : X \to Y$ be a pushout of $\cyli_0$ and let $g : Y \to X$ be its retract.
Let $\varphi$ be a formula of $X$ which does not contain any predicate symbols and let $A$ be a term of $X$ such that $\varphi \sststile{}{V} A\!\downarrow$.
Let $a$ be a term of $Y$ such that $f(\varphi) \sststile{}{V} e_p(a) = f(A)$.
If we define $a'$ as $g(a)$, then $\varphi \sststile{}{V} e_p(a') = A$ and the fact that $f(a')$ and $a$ are relatively homotopic follows from \rlem{jcell-morita}.
\end{proof}

\Rlem{jcell-morita} implies that trivial cofibrations satisfying a mild additional condition are strong Morita equivalences:

\begin{prop}
Let $f : T_1 \to T_2$ be a trivial cofibration such that for every predicate symbol $R$ of $T_1$,
sequent $R(x_1, \ldots x_k) \sststile{}{x_1, \ldots x_k} \alpha(L(R))(I, I \times x_1, \ldots I \times x_k)$ is derivable.
Then $f$ is a strong Morita equivalence.
\end{prop}
\begin{proof}
Since trivial cofibrations are retracts of maps in $\Jcell[_\I]$ and strong Morita equivalences are closed under retracts,
we just need to prove that maps in $\Jcell[_\I]$ are strong Morita equivalences.
Since strong Morita equivalences are closed under transfinite compositions, we just need to prove this for maps $f$ which are pushouts of maps in $\Jcell[_\I]$.
Moreover, since maps in $\Jcell[_\I]$ do not change the set of predicate symbols,
we may assume that the domain and the codomain of $f$ satisfy the same condition on the predicate symbols as $T_1$.
Now, \rlem{jcell-morita} implies that such maps are strong Morita equivalences.
\end{proof}

Note that the domains and the codomains of maps in $\I$ do not have any predicate symbols.
Thus cofibrant objects also do not have them (to be precise, they are isomorphic to theories without predicate symbols).
So it seems rather pointless to have predicate symbols at this point.
We can consider the full subcategory $\algtt_f$ of $\algtt$ on theories without predicate symbols
(and without function symbols of the form $\sigma : s_1 \times \ldots \times s_k \to (\ctx,0)$).
\Rprop{theories-presentable} still holds for $\algtt_f$, so this category is locally finitely presentable.
There is a model structure on $T_I/\algtt_f$ in which the classes of cofibrations, fibrations, and weak equivalences
are the intersections of the corresponding classes in $T_I/\algtt$ with the class of morphisms of $\algtt_f$.
This model category has the same sets of generating cofibrations and generating trivial cofibrations as $\algtt$.

\begin{prop}
The inclusion functor $T_I/\algtt_f \to T_I/\algtt$ has a right adjoint and this adjunction is a Quillen equivalence.
\end{prop}
\begin{proof}
We will say that a theory $T$ \emph{has enough function symbols} if for every restricted term $t$ of sort $s$ with free variables $x_1 : s_1$, \ldots $x_k : s_k$,
there is a function symbol $\sigma : s_1 \times \ldots \times s_k \to s$ such that sequent $\sststile{}{x_1, \ldots x_k} t \cong \sigma(x_1, \ldots x_k)$ is derivable.
Note that every theory $T$ is isomorphic to a theory $T'$ with enough function symbols.
Indeed, function symbols of $T'$ are just terms of the original theory and
axioms of $T'$ are axioms of $T$ together with axioms that say that the new terms are equivalent to the old ones.

Thus we may restrict and corestrict the inclusion functor $i : \algtt_f \to \algtt$ to the full subcategories of $\algtt_f$ and $\algtt$ on theories with enough function symbols.
We will denote this functor by $i' : \algtt'_f \to \algtt'$.
Now, it is easy to describe a right adjoint to $i'$.
For every theory $T \in \algtt'$, let $r'(T)$ be the theory with the same function symbols as $T$, no predicate symbols,
and with the set of axioms which consists of all theorems of $T$ which do not involve predicate symbols.
Then $r'$ is a functor $\algtt' \to \algtt'_f$.
It is easy to see that $r'$ is right adjoint to $i'$.
Since $i'(r'(T))$ and $T$ have the same sets of terms and theorems (which do not involve predicate symbols), the counit $\epsilon_T : i'(r'(T)) \to T$ is a trivial fibration.

Finally, note that the inclusion functor $T_I/i : T_I/\algtt_f \to T_I/\algtt$ preserves and reflects cofibrations and weak equivalences.
Moreover, it has a right adjoint and the counit of the adjunction is a trivial fibrations.
Thus this adjunction is a Quillen equivalence.
\end{proof}

Now, let us return to the original problem of the absence of predicate symbols in cofibrant objects.
Instead of forbidding predicate symbols completely, we can enlarge the class of cofibrations to include predicate symbols.
For every sequence of sorts $s_1, \ldots s_k$, let $P^1_{s_1, \ldots s_k}$ be the theory under $T_I$ with one additional predicate symbol $P : s_1 \times \ldots \times s_k$.
Also, we define the following theories:
\begin{align*}
P^2_{s_1, \ldots s_k} & = P^1_{s_1, \ldots s_k} \cup \{ Q : s_1 \times \ldots \times s_k, P(x_1, \ldots x_k) \sststile{}{x_1, \ldots x_k} Q(x_1, \ldots x_k) \} \\
P^3_{s_1, \ldots s_k} & = P^2_{s_1, \ldots s_k} \cup \{ R : s_1 \times \ldots \times s_k, Q(x_1, \ldots x_k) \sststile{}{x_1, \ldots x_k} R(x_1, \ldots x_k) \}
\end{align*}
Let $\I^P$ be the union of $\I$ and maps of the form $P^1_l \to P^2_l$, $P \mapsto Q$ and $P^2_l \to P^3_l$, $P \mapsto P$, $Q \mapsto R$, where $l$ is any sequence of sorts.
We define a relative cylinder object for the map $P^\alpha_l \to P^{\alpha+1}_l$ as $P^{\alpha+1}_l \amalg_{P^\alpha_l} P^{\alpha+1}_l$, where $\alpha \in \{ 1, 2\}$.
Thus any two maps $P^{\alpha+1}_l \to X$ are homotopic.
This implies that $\we_{\I^P} = \we_\I$.
To prove that there is a model structure on $T_I/\algtt$ with $\I^P$ as a set of generating cofibrations,
we just need to show that pushouts of maps $P^{\alpha+1}_l \to P^{\alpha+1}_l \amalg_{P^\alpha_l} P^{\alpha+1}_l$ are Morita equivalences.
But this is obvious since the domain and the codomain of such a pushout have the same sets of terms and axioms.
Of course, the identity functor determine a Quillen equivalence between the two model structures on $T_I/\algtt$.

Finally, let us discuss another model structure on the category of $I$-stable theories under $T_I$, which we call \emph{the syntactic model structure}.
The weak equivalences of this model structure are syntactic equivalences, $\I_0$ is a set of generating cofibrations, and every object is fibrant in this model structure.

Recall that for every theory $T$, we have a left adjoint functor $\Lang_T : \Mod{T} \to T/\algtt$ with a right adjoint $\Syn_T : T/\algtt \to \Mod{T}$.
Note that a map $f : T_1 \to T_2$ of theories under $T_I$ is a syntactic equivalence if and only if $\Syn_{T_I}(f)$ is a weak equivalence of models.
Thus we can transfer the model structure on $\Mod{T_I}$ to a model structure on $T_I/\algtt$.
To do this, we need to prove that $\Lang_{T_I}$ maps trivial cofibrations to syntactic equivalences.
But we already proved that it actually maps them to Morita equivalences.
Note that the identity functor on $T_I/\algtt$ is a left Quillen functor from the syntactic model structure to the Morita model structure
since it preserves generating cofibrations and generating trivial cofibrations.

Let $T$ be an $I$-stable theory under $T_I$.
Then the adjunction $\Lang_T \dashv \Syn_T$ is a Quillen equivalence between the model structure on $\Mod{T}$ and the syntactic model structure on $T/\algtt$.
To prove this, we just need to show that the unit of the adjunction is a weak equivalence.
But it is actually an isomorphism since $\Lang_T$ is full and faithful.

\section{Characterization of lifting properties}
\label{sec:char-lift-prop}

In this section we prove several useful lemmas that characterize trivial fibrations in various model structures that we considered in previous section.
Since all of these notations are defined in terms of lifting properties, we will prove general results about them.
Indeed, if we think about a map that has the weak lifting property with respect to a pair $V,\varphi$ as a weak equivalence,
then a map having the lifting property with respect to this pair can be thought of as a trivial fibration.
We begin with a simple lemma:

\begin{lem}[eq-char-fib]
Let $V$ be a set of variables and let $\varphi$ be a formula of a theory $T_1$ with free variables in $V$.
Let $f : T_1 \to T_2$ be a morphism of theories such that the following conditions hold:
\begin{enumerate}
\item \label{it:char-fun-fib} For every function symbol $\sigma$ of $T_2$, there exist terms $A_1$, \ldots $A_k$, $t$ of $T_1$ such that $FV(A_i) \subseteq \{ x_1, \ldots x_{i-1} \}$ and the following sequents are derivable:
\begin{align*}
\bigwedge_{1 \leq i < j} e_{p_i}(x_i) = A_i & \sststile{T_1}{x_1, \ldots x_{j-1}} A_j\!\downarrow \text{ for every } 1 \leq j \leq k \\
\bigwedge_{1 \leq i \leq k} e_{p_i}(x_i) = A_i & \sststile{T_1}{x_1, \ldots x_k} t\!\downarrow \\
\sigma(x_1, \ldots x_k)\!\downarrow & \sststile{T_2}{x_1, \ldots x_k} f(t) = \sigma(x_1, \ldots x_k) \land \bigwedge_{1 \leq i \leq k} e_{p_i}(x_i) = f(A_i)
\end{align*}
\item \label{it:char-type-fib} For all terms $A$, $B$, and $a$ of $T_1$ such that $\varphi \sststile{T_1}{V} e_p(a) = A$ and $f(\varphi) \sststile{T_2}{V} f(A) = f(B)$,
there exists a term $b$ such that $\varphi \sststile{T_1}{V} e_p(b) = B$ and $f(b)$ equals to $f(a)$.
\end{enumerate}
Then $f$ has the lifting property with respect to $V,\varphi$.
\end{lem}
\begin{proof}
Let $A$ and $a$ be terms such that $\varphi \sststile{}{V} A\!\downarrow$ and $f(\varphi) \sststile{}{V} e_p(a) = f(A)$.
Then we construct the required lifting by induction on $a$.
If $a = x$ is a variable, then \eqref{it:char-type-fib} implies that that the required lifting exists.

Now, suppose that $a = \sigma(a_1, \ldots a_k)$.
Let $A_1$, \ldots $A_k$, $t$ be terms as described in \eqref{it:char-fun-fib}.
By induction hypothesis, there exist terms $a_1'$, \ldots $a_k'$ such that $\varphi \sststile{}{V} e_{p_i}(a_i') = A_i[x_1 \repl a_1', \ldots x_{i-1} \repl a_{i-1}']$ and $f(\varphi) \sststile{}{V} f(a_i') = a_i$.
Let $a' = t[x_1 \repl a_1', \ldots x_k \repl a_k']$.
Since $\varphi \sststile{}{V} a'\!\downarrow$ and $f(\varphi) \sststile{}{V} f(a') = f(a)$, \eqref{it:char-type-fib} implies that there exists the required lifting.
\end{proof}

\begin{remark}[stable-eq-char-fib]
If $T_2$ is a stable contextual theory, then it is enough to check the first condition of the previous lemma for basic function symbols.
It is easy to see that this implies the general case.
\end{remark}

Now, we want to simplify conditions of \rlem{eq-char-fib}.
It is easy to do this for the second one:

\begin{lem}[char-type-fib]
Let $V$ be a set of variables and let $\varphi$ be a formula of a theory $T_1$ with free variables in $V$.
Let $f : T_1 \to T_2$ be a morphism of theories such that the following condition holds.
For every pair of terms $A$ and $B$ of $T_1$ of sort $(\ty,n)$ such that
$\varphi \sststile{T_1}{V} \ft(A) = \ft(B)$ and $f(\varphi) \sststile{T_2}{V} f(A) = f(B)$,
there exists a term $b$ such that $\varphi \sststile{T_1}{V} A \vdash b : B$ and $f(b)$ equals to $v_0(f(A))$.
Then the second condition of \rlem{eq-char-fib} holds.
\end{lem}
\begin{proof}
First, note that if $\Gamma$ and $\Delta$ are context such that $\varphi \sststile{T_1}{V} \Gamma\!\!\downarrow\!\land\:\Delta\!\!\downarrow$ and $f(\varphi) \sststile{T_2}{V} f(\Gamma) = f(\Delta)$,
then there is a morphism of context $d : \Gamma \to \Delta$ such that $f(d)$ is the identity morphism.
We prove this by induction on the length of contexts.
There is a unique morphism between empty contexts.
If contexts are not empty, then we have a morphism $d : \ft(\Gamma) \to \ft(\Delta)$ by induction hypothesis.
Since $f(d^*(\Delta))$ equals to $f(\Gamma)$, we have a term $\Gamma \vdash b : d^*(\Delta)$ such that $f(b)$ equals to $v_0(f(\Gamma))$ by assumption.
Thus, $d,b$ is the required morphism of contexts $\Gamma$ and $\Delta$.

For all terms $A$, $B$, and $a$ of $T_1$ such that $\varphi \sststile{T_1}{V} e_p(a) = A$ and $f(\varphi) \sststile{T_2}{V} f(A) = f(B)$,
there exists a term $b$ such that $\varphi \sststile{T_1}{V} e_p(b) = B$ and $f(\varphi) \sststile{T_2}{V} f(a) = f(b)$.
We have a morphism $d : A \to B$ such that $f(d)$ equals to the identity morphism.
if $p = \ty$, then we can define $b$ as $d^*(a)$.
if $p = \tm$, then let $B = d^*(\ty(a))$.
Since $f(B) = f(\ty(a))$, we have a term $\ty(a) \vdash b' : B$ such that $f(b')$ equals to $v_0(f(B))$ by assumption.
Then we can define $b$ as $b'[d^*(a)]$.
\end{proof}

If we want to simplify the first condition of \rlem{eq-char-fib}, then we need certain assumptions on the theory $T_2$.
We will say that a theory \emph{has well-defined function symbols} if (it is isomorphic to a theory such that) there exists a well-founded relation on the set of function symbols such that,
for every function symbol $\sigma$, either $\sigma$ equals to one of the function symbols $\ty_n$, $\ft_n$ or there exist terms $A_1$, \ldots $A_k$ satisfying the following conditions:
\begin{enumerate}
\item All function symbols that occur in $A_1$, \ldots $A_k$ are less than $\sigma$.
\item $FV(A_i) \subseteq \{ x_1, \ldots x_{i-1} \}$ for every $1 \leq i \leq k$.
\item The following sequents are derivable:
\begin{align*}
\bigwedge_{1 \leq i < j} e_{p_i}(x_i) = A_i & \sststile{}{x_1, \ldots x_{j-1}} A_j\!\downarrow \text{ for every } 1 \leq j \leq k \\
\bigwedge_{1 \leq i \leq k} e_{p_i}(x_i) = A_i & \ssststile{}{x_1, \ldots x_k} \sigma(x_1, \ldots x_k)\!\downarrow
\end{align*}
\end{enumerate}
We will say that terms $A_1$, \ldots $A_k$ \emph{define} the function symbol $\sigma$.

This condition is easy to check and most of the theories that occur in practice satisfy it.
An example of a theory that does not satisfy it appeared in \cite{alg-models}: it is the theory of filler operations.
The rest of the theories that appear in \cite{alg-models} and also all of the theories in this paper and in \cite{alg-tt} have well-defined function symbols.

\begin{lem}[eq-comp-char-fib]
Let $V$ be a set of variables and let $\varphi$ be a formula of a theory $T_1$ with free variables in $V$.
Let $f : T_1 \to T_2$ be a morphism of theories such that $T_2$ has well-defined function symbols.
Suppose that the second condition of \rlem{eq-char-fib} holds.
Moreover, suppose that, for every function symbol $\sigma$ of $T_2$, either the first condition of \rlem{eq-char-fib} holds for $\sigma$ or,
for every pair $\{ x_1, \ldots x_k \},\psi$ in $P_M$, if $f(\psi) \sststile{T_2}{x_1, \ldots x_k} \sigma(x_1, \ldots x_k)\!\downarrow$ is derivable, then there exists a term $t$ of $T_1$ such that the following sequents are derivable:
\begin{align*}
\psi & \sststile{T_1}{x_1, \ldots x_k} t\!\downarrow \\
f(\psi) & \sststile{T_2}{x_1, \ldots x_k} \sigma(x_1, \ldots x_k) = f(t)
\end{align*}
Then the first condition of \rlem{eq-char-fib} holds.
\end{lem}
\begin{proof}
First, note that if the first condition of \rlem{eq-char-fib} holds for some subset of function symbols of $T_2$, then we still can lift terms constructed from function symbols from this subset.
The proof of this fact is the same as the proof of \rlem{eq-char-fib}.
We also note that symbols $\ty_n$ and $\ft_n$ satisfy the first condition of \rlem{eq-char-fib}, so we may assume that they are less than every other symbol.

Now, we can prove by well-founded induction on $\sigma$ that the first condition of \rlem{eq-char-fib} holds.
If it holds for $\sigma$, then we are done.
Otherwise, let $A_1$, \ldots $A_k$ be terms that define $\sigma$.
By induction hypothesis, there exist lifts $A_1'$, \ldots $A_k'$ of these terms (we first lift $\ft^{n_i}(e_{p_i}(A_i))$, then $\ft^{n_i-1}(e_{p_i}(A_i))$, and so on; finally, we can lift $A_i$).
If we let $\psi = (\bigwedge_{1 \leq i \leq k} e_{p_i}(x_i) = A_i')$, then $f(\psi) \sststile{T_2}{x_1, \ldots x_k} \sigma(x_1, \ldots x_k)\!\downarrow$.
Thus, by assumption, we have a term $t$ such that $\psi \sststile{T_1}{x_1, \ldots x_k} t\!\downarrow$ and $f(\psi) \sststile{T_2}{x_1, \ldots x_k} f(t) = \sigma(x_1, \ldots x_k)$.
Since $\sigma(x_1, \ldots x_k)\!\downarrow\ \sststile{T_2}{x_1, \ldots x_k} f(\psi)$, we are done.
\end{proof}

Finally, we can show that the conditions of the previous lemmas are often not only sufficient, but also necessary:

\begin{prop}[eq-comp-char-fib]
Let $P$ be a set such that $P_M \subseteq P \subseteq P_S$.
If $f : T_1 \to T_2$ is a morphism of theories such that $T_2$ has well-defined function symbols, then the following conditions are equivalent:
\begin{enumerate}
\item \label{it:lem-fib-sec} The first condition of \rlem{eq-char-fib} and conditions of \rlem{char-type-fib} hold for all pairs in $P$.
\item \label{it:lem-fib} Both conditions of \rlem{eq-char-fib} hold for all pairs in $P$.
\item \label{it:eq-fib} $f$ has the lifting property with respect to $P$.
\item \label{it:cond-fib} Conditions of \rlem{eq-comp-char-fib} hold for all pairs in $P$.
\end{enumerate}
\end{prop}
\begin{proof}
The implication \eqref{it:lem-fib-sec} $\implies$ \eqref{it:lem-fib} follows from \rlem{char-type-fib}.
The implication \eqref{it:lem-fib} $\implies$ \eqref{it:eq-fib} follows from \rlem{eq-char-fib}.
The implication \eqref{it:eq-fib} $\implies$ \eqref{it:cond-fib} is obvious since conditions in \eqref{it:cond-fib} are just special cases of the lifting property.
Finally, \eqref{it:cond-fib} implies \eqref{it:lem-fib} by \rlem{eq-comp-char-fib}, and conditions of \rlem{char-type-fib} are a special case of the lifting property, hence they follow from \eqref{it:eq-fib}.
\end{proof}

\section{Confluent theories}
\label{sec:confluent}

The axioms of type theories that occur in practice often can be divided in two parts: the first part determines when function symbols are defined and the second part is defined in terms of some reduction relation,
which often satisfies some additional properties such as confluence.
In this section we define confluent theories as theories in this form.
We also prove that Morita equivalences between them are easier to construct.

\subsection{Theories with separated axioms}

We will say that a theory is a \emph{maximal} theory with separated axioms if it is isomorphic to a theory in which the set of axioms consists of three disjoint parts $\mathcal{A}_d$, $\mathcal{A}'_d$, and $\mathcal{A}_e$ such that the following conditions hold:
\begin{enumerate}
\item The set $\mathcal{A}_d$ consists of axioms of the form $\varphi \sststile{}{x_1, \ldots x_k} \sigma(x_1, \ldots x_k)\!\downarrow$ and, for every $\sigma$, there is exactly one axiom of this form.
We will denote the left hand side of this axiom by $\varphi_\sigma$.
\item The set $\mathcal{A}'_d$ consists of sequents of the form $\sigma(x_1, \ldots x_k)\!\downarrow\ \sststile{}{x_1, \ldots x_k} \varphi_\sigma$.
\item For every axiom $\varphi \sststile{}{V} \psi$ in $\mathcal{A}_e$, every subterm $\sigma(t_1, \ldots t_k)$ of the formula $\psi$, and every substitution $\rho$,
if the sequent $\sststile{}{} \varphi[\rho]$ is derivable from the axioms $\mathcal{A}_d \cup \mathcal{A}_e$, then so is the sequent $\sststile{}{} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k][\rho]$.
\end{enumerate}
The \emph{minimal} theory with separated axioms corresponding to such theory is its subtheory with axioms $\mathcal{A}_d \cup \mathcal{A}_e$.
Finally, we will say that a theory \emph{has separated axioms} if it is (isomorphic to) a subtheory of a maximal theory containing the minimal subtheory.

\begin{lem}[der-separated-closed]
Let $T$ be a theory with separated axioms.
If a sequent $\sststile{}{} \psi$ is derivable in $T$, then it is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$.
\end{lem}
\begin{proof}
First, let us prove the following fact.
If a sequent $\sststile{}{} \psi$ is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$ and a term $\sigma(t_1, \ldots t_k)$ is a subterm of $\psi$,
then the sequent $\sststile{}{} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k]$ is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$.
We prove this by induction on the derivation of $\sststile{}{} \psi$ in the natural deduction system.
Let us consider the case \axref{nl}:
\begin{center}
\AxiomC{$\sststile{}{} a = b$}
\AxiomC{$\sststile{}{} \psi[a/x]$}
\RightLabel{\axref{nl}}
\BinaryInfC{$\sststile{}{} \psi[b/x]$}
\DisplayProof
\end{center}
If $\sigma(t_1, \ldots t_k)$ is a subterm of $b$, then the required property follows from the induction hypothesis for $\sststile{}{} a = b$.
Otherwise, $\sigma$ belongs to $\psi$ and there exist terms $t_1'$, \ldots $t_k'$ and a formula $\psi'$ such that $t_i = t_i'[b/x]$, $\psi = \psi'[\sigma(t_1', \ldots t_k')/x]$, and $x \notin FV(\psi')$.
The induction hypothesis implies that the sequent \[ \sststile{}{} \varphi_\sigma[t_1'[a/x]/x_1, \ldots t_k'[a/x]/x_k] \] is derivable.
Since the sequent $\sststile{}{} a = b$ is derivable, this implies that the required sequent $\sststile{}{} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k]$ is also derivable.

Let us consider the inference rule for axioms from $\mathcal{A}_d$:
\smallskip
\begin{center}
\AxiomC{$\sststile{}{} s_i\!\downarrow$, $1 \leq i \leq n$}
\AxiomC{$\sststile{}{} \varphi_\tau[s_1/y_1, \ldots s_n/y_n]$}
\RightLabel{\axref{na}}
\BinaryInfC{$\sststile{}{} \tau(s_1, \ldots s_n)\!\downarrow$}
\DisplayProof
\end{center}
If $\sigma(t_1, \ldots t_k)$ is a subterm of $s_i$ for some $i$, then the required property follows from the induction hypothesis for $\sststile{}{} s_i\!\downarrow$.
Otherwise, $\tau(s_1, \ldots s_n) = \sigma(t_1, \ldots t_k)$ and the required property is obvious.
This inference rule for axioms from $\mathcal{A}_e$ follows from the assumption that we put on these axioms.
The rest of the inference rules are trivial.

Now, we can prove the lemma.
We proceed by induction on the inference of $\sststile{}{} \psi$.
Most of the cases follow immediately from the induction hypothesis.
The only nontrivial case is the inference rule for axioms from $\mathcal{A}'_d$:
\smallskip
\begin{center}
\AxiomC{$\sststile{}{} t_i\!\downarrow$, $1 \leq i \leq k$}
\AxiomC{$\sststile{}{} \sigma(t_1, \ldots t_k)\!\downarrow$}
\RightLabel{\axlabel{na}}
\BinaryInfC{$\sststile{}{} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k]$}
\DisplayProof
\end{center}
By the induction hypothesis, the sequent $\sststile{}{} \sigma(t_1, \ldots t_k)\!\downarrow$ is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$
and the fact that we just proved implies that $\sststile{}{} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k]$ is also derivable from these axioms.
\end{proof}

\begin{lem}[morita-separated]
Let $T$ be a theory with separated axioms and let $(\varphi_1 \land \ldots \land \varphi_n, V)$ be a pair in $P_M$.
Then the theory $T_0 \cup \{ \sststile{}{} c_i\!\downarrow |\ 1 \leq i \leq n \} \cup \{ \varphi_i[c_1/x_1, \ldots c_i/x_i]\ |\ 1 \leq i \leq n \}$ also has separated axioms.
\end{lem}
\begin{proof}
If $\varphi_i$ equals to $e_{p_i}(x_i) = A_i$, then, for each $0 \leq i \leq n$, we define a theory $T_i$ as $T \cup \{ \sststile{}{} c_j\!\downarrow |\ 1 \leq j \leq i \} \cup \{ \varphi_j[c_1/x_1, \ldots c_j/x_j]\ |\ 1 \leq j \leq i \}$.
Since $T_n = T$, we just need to prove that all theories $T_i$ have separated axioms.
We proceed by induction on $i$.
Since $T_0 = T$, the case $i = 0$ holds by assumptions on $T$.
Assume that $T_i$ has separated axioms.
To prove that $T_{i+1}$ also has separated axioms, we need to show that, for every subterm $\sigma(t_1, \ldots t_k)$ of $A_{i+1}[c_1/x_1, \ldots c_i/x_i]$,
the sequent $\sststile{}{} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k]$ is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$.
Since the sequent $\sststile{}{} A_{i+1}[c_1/x_1, \ldots c_i/x_i]$ is derivable in $T_i$, the sequents $\sststile{}{} \sigma(t_1, \ldots t_k)\!\downarrow$ and $\sststile{}{} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k]$ are also derivable in it.
Since $T_i$ has separated axioms, \rlem{der-separated-closed} implies that $\sststile{}{} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k]$ is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$ in $T_i$ and hence in $T_{i+1}$.
\end{proof}

\begin{prop}[der-separated]
Let $T$ be a theory with separated axioms and let $(\varphi,V)$ be a pair in $P_M$.
If a sequent $\varphi \sststile{}{V} \psi$ is derivable in $T$, then it is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$.
\end{prop}
\begin{proof}
\Rlem{mcf} implies that $\sststile{}{} \psi[c_1/x_1, \ldots c_n/x_n]$ is derivable in $T \cup \mathcal{A}'$, where $\mathcal{A}' = \{ \sststile{}{} c_i\!\downarrow |\ 1 \leq i \leq n \} \cup \{ \varphi_i[c_1/x_1, \ldots c_i/x_i]\ |\ 1 \leq i \leq n \}$.
By \rlem{morita-separated} and \rlem{der-separated-closed}, this sequent is derivable from $\mathcal{A}_d \cup \mathcal{A}_e \cup \mathcal{A}'$.
\Rlem{mcf} implies that $\varphi \sststile{}{V} \psi$ is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$.
\end{proof}

The previous proposition implies that the maps between theories with separated axioms corresponding to inclusions of subtheories are Morita equivalences.
This shows that if we are interested in a theory with separated axioms, then we can work with either minimal or maximal theory corresponding to it instead.
In general, we prefer to work with the latter, but sometimes it is convenient to switch to the former.

Note that relative $\I$-cell complexes are minimal theories with simples axioms.
We can define another set $\I'$ of generating cofibrations such that relative $\I'$-cell complexes are maximal theories with simples axioms.
Recall that $T_{(p_1,n_1), \ldots (p_{k+1},n_{k+1})}$ is the theory with function symbols $\sigma_i : (p_1,n_1) \times \ldots \times (p_{i-1},n_{i-1}) \to (d_{p_i},n_i)$ for every $1 \leq i \leq k$,
$\sigma_{k+1} : (p_1,n_1) \times \ldots \times (p_k,n_k) \to (p_{k+1},n_{k+1})$, and axioms $\varphi_1 \land \ldots \land \varphi_i \sststile{}{x_1, \ldots x_i} \sigma_{i+1}(x_1, \ldots x_i)\!\downarrow$ for every $1 \leq i \leq k$,
where $\varphi_j$ equals to $e_{p_j}(x_j) = \sigma_j(x_1, \ldots x_{j-1})$.
The set $\I$ consists of maps of the form $T_{l, (d_p,n)} \to T_{l, (p,n)}$.
We define $T'_{s_1, \ldots s_{k+1}}$ as $T_{s_1, \ldots s_{k+1}}$ together with the axiom $\sigma_{k+1}(x_1, \ldots x_k)\!\downarrow\ \sststile{}{x_1, \ldots x_k} \varphi_1 \land \ldots \land \varphi_k$.
Let $\I'$ be the set of maps of the form $T_{l, (d_p,n)} \to T'_{l, (p,n)}$.

Note that $\I'$ is a retract of $\I$.
Indeed, we can define a map $T'_{s_1, \ldots s_{k+1}} \to T_{s_1, \ldots s_{k+1}}$ as $\sigma_{k+1}(x_1, \ldots x_k) \mapsto \sigma_{k+1}(x_1, \ldots x_k)|_{\varphi_1 \land \ldots \land \varphi_k}$
and a map $T_{s_1, \ldots s_{k+1}} \to T'_{s_1, \ldots s_{k+1}}$ as the obvious inclusion.
Then the composite $T'_{s_1, \ldots s_{k+1}} \to T_{s_1, \ldots s_{k+1}} \to T'_{s_1, \ldots s_{k+1}}$ is the identity morphism.
Thus, the class of $\I'$-cofibrations is a subclass of $\I$-cofibrations.
Moreover, the composite $T_{s_1, \ldots s_{k+1}} \to T'_{s_1, \ldots s_{k+1}} \to T_{s_1, \ldots s_{k+1}}$ is homotopic to the identity morphism.
Hence a map has the weak lifting property with respect to $\I$ if and only if it has this property with respect to $\I'$.

It follows that there is another model structure on the category $T_I/\algtt$ in which all objects are fibrant, weak equivalences are Morita equivalences, and cofibrations are $\I'$-cofibrations.
The identity functor is a Quillen equivalence between this model structure and the model structure that we constructed in the previous section.

\subsection{Confluent theories}

In this subsection we define confluent theories and prove their properties.
First, we need to define a few notions from the theory of term rewriting systems.
For a general introduction to term rewriting systems we refer the reader to \cite{Terese,klop-trs,ohlebusch-advanced}.
\begin{enumerate}
\item An \emph{abstract reduction system} is a set $A$ together with a binary relation $\Rightarrow$ on it.
We will denote by $\Rightarrow^*$ the reflexive transitive closure of $\Rightarrow$.
If $\Rightarrow_1$ and $\Rightarrow_2$ are some relations, then we will write $\Rightarrow_1 \Rightarrow_2$ for the following relation:
$t \Rightarrow_1 \Rightarrow_2 t'$ if and only if there is a term $s$ such that $t \Rightarrow_1 s$ and $s \Rightarrow_2 t'$.
\item An element $a$ \emph{reduces} to an element $a'$ if $a \Rightarrow^* a'$.
A \emph{reduction sequence} is a finite or infinite sequence of elements $a_i$ such that $a_0 \Rightarrow a_1 \Rightarrow a_2 \Rightarrow \ldots$.
\item Two elements $a$ and $b$ are \emph{joinable} if there is an element $c$ such that $a \Rightarrow^* c$ and $b \Rightarrow^* c$.
We will also say that $a$ and $b$ are joinable under $\Rightarrow$ if the reduction relation is not clear from the context.
An element $a$ is \emph{confluent} if whenever $a \Rightarrow^* b$ and $a \Rightarrow^* c$ the terms $b$ and $c$ are joinable.
The system is confluent if every element is confluent.
Equivalently, the system is confluent if every pair of elements is joinable.
\item Two elements $a$ and $b$ are \emph{$\Rightarrow$-equivalent} if there is a sequence of elements $a_1$, \ldots $a_n$ such that $a = a_1$, $b = a_n$,
and, for every $1 \leq i < n$, either $a_i \Rightarrow a_{i+1}$ or $a_{i+1} \Rightarrow a_i$.
\item An element $a$ is a \emph{normal form} if there is no element $a'$ such that $a \Rightarrow a'$.
We will write $a \Rightarrow^\nf b$ if $a \Rightarrow^* b$ and $b$ is a normal form.
We will say that an element $a$ \emph{has a normal form} (or that it is \emph{weakly normalizable}) if $a \Rightarrow^\nf b$ for some $b$.
The system is \emph{weakly normalizing} if every element has a normal form.
\item An element $a$ is \emph{strongly normalizable} if there is no infinite reduction sequence sequence starting with $a$.
The system is \emph{strongly normalizing} if all elements are.
\item A subset $A'$ of $A$ is \emph{closed} under $\Rightarrow$ if $a' \in A'$ and $a' \Rightarrow a$ implies that $a \in A'$.
\end{enumerate}

A \emph{term rewriting system} is a binary relation $R$ on the set of terms of some theory such that the following conditions hold:
\begin{enumerate}
\item If $R(t,s)$, then $FV(s) \subseteq FV(t)$.
\item If $R(t,s)$, then $t$ is not a variable.
\end{enumerate}
A term rewriting system $R$ is \emph{left-linear} if, for every $t$ and $s$ such that $R(t,s)$, every variables occurs in $t$ at most once.

If $R$ is a term rewriting system, then we define the relation $\Rightarrow_R$ on the set of terms as follows:
if $R(t,s)$, then $c[x \repl t[x_1 \repl t_1, \ldots x_k \repl t_k]] \Rightarrow_R c[x \repl s[x_1 \repl t_1, \ldots x_k \repl t_k]]$ for all $c$, $x_1$, \ldots $x_k$, and $t_1$, \ldots $t_k$.
Every term rewriting system has the underlying abstract reduction system $(\Term_T,\Rightarrow_R)$.

We will say that a term $t$ of a theory $T$ is \emph{defined} with respect to a pair $(\varphi,V) \in P_M$ if the sequent $\varphi \sststile{}{V} t\!\downarrow$ is derivable.
Let $\Term_{T,\varphi}^d$ be the set of defined terms with respect to the pair $(\varphi,FV(\varphi))$.
There is an abstract reduction system $\Rightarrow_\varphi$ on the set $\Term_{T,\varphi}^d$ defined as follows.
If $\varphi = \varphi_1 \land \ldots \land \varphi_n$ and $\varphi_i$ equals to $e_{p_i}(x_i) = t_i$, then $\Rightarrow_\varphi$ consists of pairs $(c[e_{p_i}(x_i)/y],c[t_i/y])$
for every $1 \leq i \leq n$ and every term $c$ such that there is exactly one occurrence of $y$ in $c$.
We will denote by $\Rightarrow_{R_T,\varphi}$ the relation $\Rightarrow_{R_T} \cup \Rightarrow_\varphi$.

Axioms of a type theory are often presented in the form of a term rewriting system.
We axiomatize this situation in the following definition:

\begin{defn}[directed]
Let $T$ be a theory with separated axioms.
A \emph{reduction system} on $T$ is a term rewriting system $R_T$ such that, for every pair $(\varphi,V) \in P_M$ and every substitution $\rho$, the following conditions hold:
\begin{enumerate}
\item \label{it:dir-first} For every pair of terms $t$ and $s$ such that $(t,s) \in R_T$, if $\varphi \sststile{T}{V} t[\rho]\!\downarrow$, then $\varphi \sststile{T}{V} t[\rho] = s[\rho]$.
\item \label{it:dir-second} For every axiom $\psi \sststile{}{V'} t = s$ in $\mathcal{A}_e$ such that $\varphi \sststile{}{V} \psi[\rho]$ is derivable,
terms $t[\rho]$ and $s[\rho]$ are equivalent in the system $(\Term_{T,\varphi}^d,\Rightarrow_{R_T,\varphi})$.
\end{enumerate}
\end{defn}

\begin{example}[dir-ax]
Let $T$ be a theory with a set of axioms $\mathcal{A}_d$ and a term rewriting system $R_T$.
If we define $\mathcal{A}_e$ as the set of axioms of the form $t\!\downarrow\ \sststile{}{FV(t)} t = s$ for every $(t,s) \in R_T$, then $R_T$ is a reduction system on $T \cup \mathcal{A}_e$.
We will show in \rexample{directed} that every theory with a reduction system is Morita equivalent to a theory of this form.
\end{example}

Let $T$ be a theory with separated axioms such that, for every axiom $\psi \sststile{}{V'} t = s$ in $\mathcal{A}_e$, the following conditions hold:
\begin{itemize}
\item The term $t$ is not a variable and $FV(s) \subseteq FV(t)$.
\item For every pair $(\varphi,V) \in P_M$ and every substitution $\rho$, if $\varphi \sststile{T}{V} t[\rho]\!\downarrow$, then $\varphi \sststile{T}{V} t[\rho] = s[\rho]$.
\end{itemize}
Then we can define a term rewriting system $R_T$ as the set of pairs $(t,s)$ such that there is an axiom of the form $\psi \sststile{}{V'} t = s$ in $\mathcal{A}_e$.
The first condition implies that this is indeed a term rewriting system and the second condition implies that it is a reduction system on $T$.
We will say that $T$ \emph{has directed axioms} if these condition hold.
Most of the theories are presented in this way, so we do not need to specify a term rewriting system explicitly.
The theory constructed in \rexample{dir-ax} has directed axioms.

Now let us prove a technical lemma which shows that a sequent $\varphi \sststile{}{V} t = s$ is provable in $T$ if and only if
terms $t$ and $s$ are equivalent in the term rewriting system consisting of the right hand sides of the axioms of $T$ and equalities in $\varphi$.

\begin{lem}[der-eq]
If a sequent $\varphi \sststile{}{V} t = s$ is derivable in a theory $T$, then there exist terms $t_1, \ldots t_n$ such that $t = t_1$, $s = t_n$, and, for every $1 \leq i < n$, $t_i = c[a/x]$ and $t_{i+1} = c[b/x]$
for some terms $a$, $b$, and $c$ such that there is a unique occurrence of the variable $x$ in $c$ and one of the following conditions hold:
\begin{enumerate}
\item There exists an application of \axref{na} in which the premise is derivable from $\varphi$ and the conclusion is either $\varphi \sststile{}{V} a = b$ or $\varphi \sststile{}{V} b = a$.
Moreover, a derivation of $\varphi \sststile{}{V} t = s$ in the natural deduction system contains a derivation of this conclusion as a subderivation.
\item $\varphi = \varphi_1 \land \ldots \land \varphi_k$ and there exists $j$ such that $\varphi_j$ equals to either $a = b$ or $b = a$.
\end{enumerate}
\end{lem}
\begin{proof}
We prove this by induction on a derivation of $\varphi \sststile{}{V} t = s$ in the natural deduction system.
The rules \axref{nv}, \axref{np}, and \axref{nf} are obvious.
The rules \axref{nh} and \axref{na} follow immediately from assumptions.
We can take $t_1 = a = t$, $t_2 = b = s$, and $c = x$.
Let us consider the rule \axref{ns}.
If $t_1$, \ldots $t_n$ is a sequence for $\varphi \sststile{}{V} s = t$, then we can take the sequence $t_n$, \ldots $t_1$ for $\varphi \sststile{}{V} t = s$.

Finally, let us consider the rule \axref{nl}:
\begin{center}
\AxiomC{$\varphi \sststile{}{V} p = q$}
\AxiomC{$\varphi \sststile{}{V} t'[p/y] = s'[q/y]$}
\RightLabel{\axref{nl}}
\BinaryInfC{$\varphi \sststile{}{V} t'[q/y] = s'[q/y]$}
\DisplayProof
\end{center}
Note that we may assume that there is a unique occurrence of the variable $y$ in $\psi$ since the general rule follows from this special case.
Let $t_1$, \ldots $t_n$ be a sequence for $\varphi \sststile{}{V} p = q$ and let $s_1$, \ldots $s_m$ be a sequence for $\varphi \sststile{}{V} t'[p/y] = s'[p/y]$.
Then $t'[t_n/y]$, \ldots $t'[t_1/y] = s_1$, \ldots $s_m = s'[t_1/y]$, \ldots $s'[t_n/y]$ is a sequence for $\varphi \sststile{}{V} t'[q/y] = s'[q/y]$.
\end{proof}

The following proposition is the main property of theories with reduction systems:

\begin{prop}[conf-main]
Let $T$ be a theory with a reduction system and let $(\varphi,V)$ be a pair in $P_M$.
Then a sequent $\varphi \sststile{}{V} t = s$ is derivable if and only if the terms $t$ and $s$ are equivalent in the system $(\Term_{T,\varphi}^d,\Rightarrow_{R_T,\varphi})$.
\end{prop}
\begin{proof}
If $t$ and $s$ are equivalent in $(\Term_{T,\varphi}^d,\Rightarrow_{R_T,\varphi})$, then there is a zig-zag of $\Rightarrow_{R_T,\varphi}$-reducations between them.
We need to show that, for every reduction $c[a[\rho]/x] \Rightarrow_{R_T} c[b[\rho]/x]$, the sequent $\varphi \sststile{}{V} c[a[\rho]/x] = c[b[\rho]/x]$ is derivable.
Since the term $c[a[\rho]/x]$ is $\varphi$-defined, the term $a[\rho]$ is also $\varphi$-defined.
Condition~\eqref{it:dir-first} of \rdefn{directed} implies that $\varphi \sststile{T}{V} a[\rho] = b[\rho]$ from which follows that the required sequent is derivable.
If $c[a/x] \Rightarrow_\varphi c[b/x]$, then $\varphi \sststile{}{V} a = b$ is derivable by \axref{nh} which implies that $\varphi \sststile{}{V} c[a/x] = c[b/x]$ is also derivable.

If $t$ and $s$ are terms such that $\varphi \sststile{T}{V} t = s$, then \rlem{der-eq} and \rprop{der-separated} imply that there exists a sequence $t_1$, \ldots $t_n$ such that $t = t_1$, $s = t_n$, and, for every $1 \leq i < n$,
either $t_i \Rightarrow_\varphi t_{i+1}$ or $t_{i+1} \Rightarrow_\varphi t_i$ or there is an axiom $\psi \sststile{}{V'} a = b$, a substitution $\rho$, and a term $c$ such that
the sequent $\varphi \sststile{}{V} \psi[\rho]$ is derivable and $t_i = c[a[\rho]/y]$ and $t_{i+1} = c[b[\rho]/y]$ (or vice versa).
Condition~\eqref{it:dir-second} of \rdefn{directed} implies that $t_i$ and $t_{i+1}$ are equivalent in the system $(\Term_{T,\varphi}^d,\Rightarrow_{R_T,\varphi})$.
\end{proof}

\begin{cor}[conf-main]
Let $T$ be a theory with a reduction system and let $(\varphi,V)$ be a pair in $P_M$.
Then the system $(\Term_{T,\varphi}^d,\Rightarrow_{R_T,\varphi})$ is confluent if and only if any pair of terms $t$ and $s$ such that $\varphi \sststile{T}{V} t = s$ is joinable in this system.
\end{cor}

Note that even if $R_T$ is confluent, in general this does not imply the confluence of $(\Term_{T,\varphi}^d,\Rightarrow_{R_T,\varphi})$.
Nevertheless, this is often true under some additional assumptions:

\begin{lem}[morita-conf]
Let $T$ be a theory with a reduction system and let $(\varphi,V)$ be a pair in $P_M$.
Suppose that the following conditions hold:
\begin{itemize}
\item The underlying term rewriting system of $T$ is left-linear.
\item The abstract reduction system $(\Term_{T,\varphi}^d,\Rightarrow_{R_T})$ is confluent.
\item For every reduction rule $(t,s) \in R_T$, if $t$ contains a subterm of the form $e_p(t')$, then $t'$ is not a variable.
\end{itemize}
Then the abstract reduction system $(\Term_{T,\varphi}^d,\Rightarrow_{R_T,\varphi})$ is confluent.
\end{lem}
\begin{proof}
We can think of variables in $V$ as additional constants.
Then $\Rightarrow_{R_T,\varphi}$ is the union of two confluent term rewriting systems $R_T$ and $\Rightarrow_\varphi$.
The last condition implies that they are orthogonal to each other.
It was shown in \cite{raoult} (see also \cite[Theorem~8.6.35]{ohlebusch-advanced}) that the union of confluent orthogonal left-linear systems is confluent.
\end{proof}

Note that the second condition of \rlem{morita-conf} is true if $R_T$ is confluent.
So the only serious restriction of this lemma is the left-linearity of $R_T$.
We will give another set of conditions that implies the same result in \rprop{ty-elim}.

\begin{defn}[confluent]
A \emph{confluent} type theory is a type theory $T$ with a reduction system such that equivalent conditions of \rcor{conf-main} hold.
\end{defn}

\section{Comparsion of algebraic and ordinary type theories}

It is well-known that standard examples of type theories (such as theories of identity types, $\Sigma$-types, and $\Pi$-types) are confluent.
Terms of algebraic type theories are similar to terms of usual type theories, but they still differ from them.
The first difference is that they have an explicit substitution operation.
Another difference is that they contain more information than ordinary terms so that the type and the context of a term can be inferred from it.
In this section we prove that it is often possible to show that an algebraic type theory is confluent if corresponding usual type theory is.

More precisely, for every contextual theory $T$, we will define a set $\Term_{T,\varphi}^s$ which can be described informally as the set of defined terms
in which function symbols $\ty_m$, $\ft_m$, and $\subst_{p,n,k}$ do not occur and in which we omit contexts in function symbols.
The precise definition of this set will be given in subsection~\ref{sec:subst}.
We also define there a reduction relation $\Rightarrow_{sf} \Rightarrow_s^\nf$ on this set.
This set corresponds to the set of terms of an ordinary type theory and the reduction relation corresponds to the usual reduction relation.
The idea is that $\Rightarrow_{sf}$ reduces one of the redexes and then $\Rightarrow_s^\nf$ evaluates all explicit substitution expressions.
Then we can prove the following theorem:

\begin{thm}[conf-comp]
Let $T$ be a contextual type theory with a reduction system in which typing rules are separated, substitution rules are separated, contexts are simples, and $\ty$-free rules preserve types.
Then $T$ is confluent if and only if the abstract reduction system $(\Term_{T,\varphi}^s, \Rightarrow_{sf} \Rightarrow_s^\nf)$ is confluent for every pair $(\varphi,V) \in P_M$.
\end{thm}

The technical assumptions that we put on the theory will be defined in this section.
The theorem itself follows from \rprop{ty-elim}, \rprop{ctx-elim}, and \rprop{subst-elim}.

\subsection{Typing axioms}

Let us begin by showing that a term rewriting system is confluent whenever the subsystem on terms without function symbols $\ty$ and $\ft$ is.
To do this we need to know that typing axioms are well-behaved in some sense.
\begin{defn}
A reduction rule is a \emph{typing rule} if it is of the form
\[ e_p(\sigma(x_1, \ldots x_k)) \Rightarrow s \]
where $\sigma$ is neither $\ft$ nor $\ty$ and the function symbols $\ft$ and $\ty$ are applied only to variables in $s$ (if they appear in this term).
A reduction rule $t \Rightarrow s$ is \emph{$\ty$-free (and $\ft$-free)} if the function symbols $\ft$ and $\ty$ do not appear in $t$.
We will say that a theory $T$ with a reduction system has \emph{separated typing rules} if every rule in the underlying term rewriting system of $T$ is either a typing rule or a $\ty$-free rule.
The sets of typing and $\ty$-free reduction rules will be denoted by $R^t_T$ and $R^{tf}_T$, respectively.

Let $T$ be a theory with separated typing rules.
We will say that $\ty$-free rules of $T$ \emph{preserve types} if there is a well-founded relation on the set of $\ty$-free rules of $T$ such that,
for every $\ty$-free rule $(t,s) \in R^{tf}_T$ and every substitution $\rho$ such that $t[\rho]$ is $\varphi$-defined,
terms $e_p(t[\rho])$ and $e_p(s[\rho])$ are equivalent in the system $(\Term_{T,\varphi}^d,\Rightarrow_{R^t_T \cup R^{tf'}_T, \varphi})$,
where $R^{tf'}_T$ is the set of $\ty$-free rules which are less than $(t,s)$.
\end{defn}

The main property of theories with separated typing axioms is proved in the following lemma:

\begin{lem}[types-red]
Let $T$ be a theory with separated typing axioms and let $(\varphi,V)$ be a pair in $P_M$.
Then the abstract reduction system $(\Term_{T,\varphi}^d,\Rightarrow_{R^t_T,\varphi})$ is strongly normalizing and confluent.
\end{lem}
\begin{proof}
Note that $V = \{ x_1, \ldots x_k \}$ and $e_{p_i}(x_i) \Rightarrow_\varphi s_i$ where $s_i$ is a term such that $FV(s_i) \subseteq \{ x_1, \ldots x_{i-1} \}$.
To show that the system is strongly normalizing we define, for each term $t$, an ordinal $|t|$ less than $\varepsilon_\omega$ such that if $t \Rightarrow_{R^t_T,\varphi} s$, then $|t| > |s|$.
\begin{align*}
|x_i| & = \varepsilon_{i-1} \\
|\ty(t)| = |\ft(t)| & = \omega^{|t|}\\
|\sigma(t_1, \ldots t_k)| & = |t_1| \oplus \ldots \oplus |t_k| \oplus 1
\end{align*}
where $\oplus$ is the natural sum of ordinals.

If $e_p(\sigma(t_1, \ldots t_k)) \Rightarrow_{R_T^t} s(e_{p_1}(t_1), \ldots e_{p_k}(t_k), t_1, \ldots t_k)$, then we need to show that $|e_p(\sigma(t_1, \ldots t_k))| > |s(e_{p_1}(t_1), \ldots e_{p_k}(t_k), t_1, \ldots t_k)|$.
Let $\alpha_i = |t_i|$ and let $\alpha$ be the maximum of $\alpha_1$, \ldots $\alpha_k$.
Then $|e_p(\sigma(t_1, \ldots t_k))| = \omega^{\alpha_1 \oplus \ldots \oplus \alpha_k \oplus 1} \geq \omega^{\alpha + 1}$.
Note that $\ft$ and $\ty$ do not occur in the term $s$.
It follows that
\begin{align*}
|s(e_{p_1}(t_1), \ldots e_{p_k}(t_k), t_1, \ldots t_k)| & = \omega^{\alpha_1} n_1 \oplus \ldots \oplus \omega^{\alpha_k} n_k \oplus \alpha_1 m_1 \oplus \ldots \oplus \alpha_k m_k \oplus c \\
                                                        & \leq \omega^\alpha n \oplus \alpha m \oplus c
\end{align*}
for some natural numbers $n_1$, \ldots $n_k$, $m_1$, \ldots $m_k$, $n$, $m$, and $c$.
Since $\alpha \leq \omega^\alpha$ and $1 \leq \omega^\alpha$, we have $\omega^\alpha n \oplus \alpha m \oplus c \leq \omega^\alpha (n + m + c) < \omega^{\alpha + 1}$.

If $e_p(x_i) \Rightarrow_\varphi s_i$, then $FV(s_i) \subseteq \{ x_1, \ldots x_{i-1} \}$.
It follows that $|e_p(x_i)| = \omega^{\varepsilon_{i-1}} = \varepsilon_{i-1} > |s_i|$ since $|s_i|$ involves only ordinals less than $\varepsilon_{i-1}$.
This finishes the proof that $(\Term_{T,\varphi}^d,\Rightarrow_{R^t_T,\varphi})$ is strongly normalizing.

By Newman's lemma (see \cite[Lemma~2.2.5]{ohlebusch-advanced} for a proof), to prove that a strongly normalizing system is confluent it is enough to show that it is locally confluent,
that is if $a \Rightarrow_{R^t_T} b$ and $a \Rightarrow_{R^t_T} c$, then there exists a term $d$ such that $b \Rightarrow_{R^t_T}^* d$ and $c \Rightarrow_{R^t_T}^* d$.
This is obvious in our case since the rules in $R^t_T$ do not overlap.
\end{proof}

We will need the following general lemma about term rewriting systems:

\begin{lem}[conf-nf]
Let $\Rightarrow_1$ and $\Rightarrow_2$ be abstract reduction systems on the same set $A$.
Let $A'$ be a subset of $A$ containing all $\Rightarrow_1$-normal forms and let $\Rightarrow_0$ be an abstract reduction system on it.
Suppose that $(A',\Rightarrow_0)$ is confluent, $(A,\Rightarrow_1)$ is confluent and weakly normalizable,
and if $a,b \in A$ are such that $a \Rightarrow_2 b$, then $a$ and $b$ are joinable under the relation $\Rightarrow_1^\nf \Rightarrow_0^*$.
Then any two $\Rightarrow_2$-equivalent elements $a,b \in A$ are joinable under $\Rightarrow_1^\nf \Rightarrow_0^*$.
\end{lem}
\begin{proof}
Since being joinable is a symmetric relation, we can assume that $\Rightarrow_2$ is also symmetric.
Let $a_1$, \ldots, $a_n$ be a sequence such that $a_i \Rightarrow_2 a_{i+1}$ for every $1 \leq i < n$.
We prove that $a_1$ and $a_n$ are joinable under $\Rightarrow_1^\nf \Rightarrow_0^*$ by induction on $n$.
If $n = 0$, then this follows from the fact that $(A,\Rightarrow_1)$ is weakly normalizable.
Suppose $n > 0$.
We have $a_1 \Rightarrow_1^\nf a_1'$, $a_1' \Rightarrow_0^* c_1$, $a_{n-1} \Rightarrow_1^\nf a_{n-1}'$, $a_{n-1}' \Rightarrow_0^* b$ by assumption.
We have $a_n \Rightarrow_1^\nf a_n'$, $a_n' \Rightarrow_0^* c_2$, $a_{n-1} \Rightarrow_1^\nf a_{n-1}'$, $a_{n-1}' \Rightarrow_0^* c$ by the induction hypothesis.
Since $\Rightarrow_0$ is confluent, $c \Rightarrow_0^* d$ and $c \Rightarrow_0^* d$:
\[ \xymatrix@=1em{  a_1 \ar[rr]^{\Rightarrow_2^*} \ar@{-->}[d]^{\Rightarrow_1^\nf}  &                                   & a_{n-1} \ar[rr]^{\Rightarrow_2} \ar@{-->}[d]^{\Rightarrow_1^\nf}          &                                   & a_n \ar@{-->}[d]^{\Rightarrow_1^\nf}  \\
                    a_1' \ar@{-->}[rd]_{\Rightarrow_0^*}                            &                                   & a_{n-1}' \ar@{-->}[ld]_{\Rightarrow_0^*} \ar@{-->}[rd]^{\Rightarrow_0^*}  &                                   & a_n' \ar@{-->}[ld]^{\Rightarrow_0^*}  \\
                                                                                    & b \ar@{-->}[rd]_{\Rightarrow_0^*} &                                                                           & c \ar@{-->}[ld]^{\Rightarrow_0^*} &                                       \\
                                                                                    &                                   & d                                                                         &                                   &
                 } \]
\end{proof}

Let $\Term_{T,\varphi}^t$ be the subset of $\Term_{T,\varphi}^d$ consisting of terms in which function symbols $\ty$ and $\ft$ do not occur.
Let $\Rightarrow_{R_T^t,\varphi}$ be the union of $\Rightarrow_{R^t_T}$ and $\Rightarrow_\varphi$.
Then every $\Rightarrow_{R_T^t,\varphi}$-normal form belongs to $\Term_{T,\varphi}^t$.
This implies that the relation $\Rightarrow_{R^{tf}_T} \Rightarrow_{R^t_T,\varphi}^\nf$ is an abstract reduction system on $\Term_{T,\varphi}^t$
Let us denote the relation $\Rightarrow_{R^{tf}_T} \Rightarrow_{R^t_T,\varphi}^\nf$ by $\Rightarrow_{tf}$
Now we can prove that the confluence under $\Rightarrow_{tf}$ implies the confluence under $\Rightarrow_{R_T,\varphi}$:

\begin{prop}[ty-elim]
Let $T$ be a theory with a reduction system in which typing axioms are spearated and $\ty$-free axioms preserve types.
Then $T$ is confluent if and only if the abstract reduction system $(\Term_{T,\varphi}^t, \Rightarrow_{tf})$ is.
\end{prop}
\begin{proof}
If $<$ is a well-founded relation on a set $A$, then we can define a well-founded relation on the set of subset of $A$ as follows.
A subset $S$ is less than a subset $T$ if and only there is an element $a \in T$ which is greater than every element of $S$.
It is easy to see that this relation is well-founded.

Let us prove the ``if'' direction.
Suppose that the system $(\Term_{T,\varphi}^t,\Rightarrow_{tf})$ is confluent.
Let $R^{tf'}_T$ be a subset of $R^{tf}_T$.
Then we prove by induction on $R^{tf'}_T$ that terms $t$ and $s$ are joinable under $\Rightarrow_{R_T^t,\varphi}^\nf \Rightarrow_{tf}^*$ whenever they are equivalent in the system $(\Term_{T,\varphi}^d,\Rightarrow_{R^t_T \cup R^{tf'}_T, \varphi})$.

The abstract reduction system $(\Term_{T,\varphi}^d,\Rightarrow_{R^t_T,\varphi})$ is normalizing and confluent by \rlem{types-red}.
Thus we can apply \rlem{conf-nf} with $A = \Term^d_{T,\varphi}$, $A' = \Term^t_{T,\varphi}$, $(\Rightarrow_0) = (\Rightarrow_{tf})$, $(\Rightarrow_1) = (\Rightarrow_{R^t_T,\varphi})$, and $(\Rightarrow_2) = (\Rightarrow_{R_T,\varphi})$
to show that the terms $t$ and $s$ are joinable under $\Rightarrow_{R_T^t,\varphi}^\nf \Rightarrow_{tf}^*$.
To do this, we need to prove that if $t \Rightarrow_{R^t_T \cup R^{tf'}_T, \varphi} s$, then $t$ and $s$ are joinable.

Note that $\Rightarrow_{R^t_T \cup R^{tf'}_T, \varphi}$ is the union of $\Rightarrow_{R^t_T,\varphi}$ and $\Rightarrow_{R^{tf'}_T}$.
If $t \Rightarrow_{R^t_T,\varphi} s$, then this is obvious, so let us assume that $t \Rightarrow_{R^{tf'}_T} s$.
Then $t = c[a[\rho]/x]$ and $s = c[b[\rho]/x]$ for some terms $a$, $b$, and $c$ and some substitution $\rho$ such that $(a,b) \in R^{tf'}_T$.
Since the left hand side of reduction rules in $R_T^{tf}$ does not contain function symbols $\ft$ and $\ty$,
reductions $\Rightarrow_{R_T^{tf}}$ and $\Rightarrow_{R_T^t,\varphi}$ can overlap only in a term of the form $e_p(\sigma(t_1, \ldots t_k))$ as follows:
$e_p(\sigma(t_1, \ldots t_k)) \Rightarrow_{R_T^t,\varphi} u[t_1/x_1, \ldots t_k/x_k]$ for some term $u$ and $e_p(\sigma(t_1, \ldots t_k)) \Rightarrow_{R_T^{tf}} e_p(v)$ for some term $v$.
We may assume that $\Rightarrow_{R_T^t,\varphi}$-reductions occur only in such overlappings since other $\Rightarrow_{R_T^t,\varphi}$-redexes occur inside either $c$ or $\rho$, so if we reduce them in $c[a[\rho]/x]$ and $c[b[\rho]/x]$
we will still have a reduction of the form $c'[a[\rho']/x] \Rightarrow_{R_T^{tf}}^* c'[b[\rho']/x]$ for some $c'$ and $\rho'$ such that $c \Rightarrow_{R_T^t,\varphi}^\nf c'$ and $\rho \Rightarrow_{R_T^t,\varphi}^\nf \rho'$.

Since $a$, $b$, $c'$, and $\rho'$ do not contain $\Rightarrow_{R_T^t,\varphi}$-redexes, such a redex can occur in terms $c'[a[\rho']/x]$ and $c'[b[\rho']/x]$ only when $c'$ contains subterms of the form $e_p(x)$.
So there is a term $c''$ which does not contain function symbols $\ty$ and $\ft$ such that the following equations hold:
\begin{align*}
c'[a[\rho']/x] & = c''[e_p(a[\rho'])/y,a[\rho']/z] \\
c'[b[\rho']/x] & = c''[e_p(b[\rho'])/y,b[\rho']/z].
\end{align*}

Since $\ty$-free axioms of $T$ preserve types, terms $e_p(a[\rho'])$ and $e_p(b[\rho'])$ are equivalent in the system $(\Term_{T,\varphi}^d,\Rightarrow_{R^t_T \cup R^{tf''}_T, \varphi})$ for some $\mathcal{A}_{tf}'' < \mathcal{A}_{tf}'$.
It follows that $c''[e_p(a[\rho'])/y,a[\rho']/z]$ and $c''[e_p(b[\rho'])/y,a[\rho']/z]$ are also equivalent in this system.
Since $\mathcal{A}_{tf}'' < \mathcal{A}_{tf}'$, we can apply the induction hypothesis to conclude that $c''[e_p(a[\rho'])/y,a[\rho']/z]$ and $c''[e_p(b[\rho'])/y,a[\rho']/z]$ are joinable under $\Rightarrow_{R_T^t,\varphi}^\nf \Rightarrow_{tf}^*$.
Since $c''$ does not contain function symbols $\ty$ and $\ft$, terms $c''[e_p(b[\rho'])/y,a[\rho']/z]$ and $c''[e_p(b[\rho'])/y,b[\rho']/z]$ are also joinable.
Finally, \rlem{conf-nf} implies that terms $c''[e_p(a[\rho'])/y,a[\rho']/z]$ and $c''[e_p(b[\rho'])/y,b[\rho']/z]$ are joinable.

Now let us prove the ``only if'' direction.
If $T$ is confluent, then the abstract reduction system $(\Term_{T,\varphi}^d, \Rightarrow_{R_T,\varphi})$ is also confluent.
Since $\Rightarrow_{tf}$ is a subset of $\Rightarrow_{R_T,\varphi}$, it is enough to show that $\Rightarrow_{R_T,\varphi}$-equivalent terms are joinable under $\Rightarrow_{tf}$.
% But this follows from \rlem{conf-nf}.
TODO
\end{proof}

\subsection{Contexts}

In this subsection we will work with contextual theories with directed axioms (see \cite{alg-tt} for a definition of a contextual theory).
If $T$ is a contextual theory, then we have a set of function symbols $\mathcal{F}_0$ (which we call \emph{basic function symbols}) such that the set of function symbols of $T$ consists of the following function symbols:
\begin{align*}
* & : (\ctx,0) \\
\ft_m & : (\ty,m) \to (\ctx,m) \\
\ty_m & : (\tm,m) \to (\ty,m) \\
v_{m,i} & : (\ctx,m) \to (\tm,m) \text{, } 0 \leq i < m \\
\subst_{p,m,0} & : (\ctx,m) \times (p,0) \times (p,m) \\
\subst_{p,m,k} & : (p,k) \times (\tm,m)^k \to (p,m) \text{, } k > 0 \\
\sigma_m & : (\ctx,m) \times (p_1,n_1+m) \times \ldots \times (p_k,n_k+m) \to (p,n+m)
\end{align*}
where $\sigma : (p_1,n_1) \times \ldots \times (p_k,n_k) \to (p,n)$ is a basic function symbol, $m \in \mathbb{N}$, and $p_1, \ldots, p_k, p \in \{ \ty, \tm \}$.
Moreover, we may assume that $n = 0$ for every $\sigma \in \mathcal{F}_0$.
Note that we omit the context for function symbols $\subst_{p,m,k}$ when $k > 0$.
We can do this since it can be inferred from any of the last $k$ parameters.

Let $T$ be a contextual theory and let $\mathcal{F}_0$ be the set of its basic function symbols.
Let $\mathcal{F}_0'$ be the set consisting of elements of $\mathcal{F}_0$, function symbols $v_i$ for all $i \in \mathbb{N}$, and function symbols $\subst_{p,n,k}$.
If $t$ is a term of $T$ in which function symbols $\ft_m$ and $\ty_m$ do not occur, then we can define a term $U(t) \in \Term_{\mathcal{F}'_0}$ in the obvious way:
\begin{align*}
U(x) & = x \\
U(\sigma_m(\Gamma, t_1, \ldots t_k)) & = \sigma(U(t_1), \ldots U(t_k)) \\
U(v_{n,i}(\Gamma)) & = v_i \\
U(\subst_{p,m,0}(\Gamma,t)) & = U(t) \\
U(\subst_{p,m,k}(t, a_1, \ldots a_k)) & = \subst_{p,m,k}(U(t), U(a_1), \ldots U(a_k))
\end{align*}

Let $\Term_T^c$ be the image of $\Term_T^t$ under $U$.
We define a reduction relation $\Rightarrow_{cf}$ on $\Term_T^c$ as follows:
it is the minimal relation containing pairs $(U(t),U(s))$ for all $t$ and $s$ such that $t \Rightarrow_{tf} s$.

If $t \in \Term_T^t$, then let $C(t)$ be the set of terms discarded by $U$.
That is, $C(t)$ is defined inductively as follows:
\begin{align*}
C(x) & = \varnothing \\
C(\sigma_m(\Gamma, t_1, \ldots t_k)) & = \{ \Gamma \} \cup \bigcup_{1 \leq i \leq k} C(t_i) \\
C(v_{n,i}(\Gamma)) & = \{ \Gamma \} \\
C(\subst_{p,m,0}(t)) & = C(t) \\
C(\subst_{p,m,k}(t, a_1, \ldots a_k)) & = C(t) \cup \bigcup_{1 \leq i \leq k} C(a_i)
\end{align*}
Sometimes we need to regard $C(t)$ as a sequence in which case the order is 
There is a natural linear order on the multiset $C(t)$, so we can also think of it as a sequence of terms.

\begin{defn}[simp-ctx]
We will say that a contextual theory $T$ with separated typing axioms \emph{has simple contexts} if the following conditions hold:
\begin{enumerate}
\item For all terms $t$ and $s$ in $\Term_T^t$ such that $(t,s) \in R^{tf}_T$, the sequence $C(t)$ consists of distinct variables and the set $C(s)$ consists of strongly normalizable terms.
\item For every basic function symbol $\sigma : (p_1,n_1) \times \ldots \times (p_k,n_k) \to (p,0)$ and every $1 \leq i \leq k$,
if the sequent $\sststile{}{\Gamma, x_1, \ldots x_k} \sigma_m(\Gamma, x_1, \ldots x_k)\!\downarrow$ is derivale,
then there exists a term $A_{\sigma,i}$ such that $FV(A_{\sigma,i}) \subseteq \{ \Gamma, x_1, \ldots x_{i-1} \}$ and the sequent $\sststile{}{\Gamma, x_1, \ldots x_i} e_{p_i}(x_i) = A_{\sigma,i}$ is derivale.
\item There is a well-founded relation on the set $\Term_T^t$ such that each element of $C(s)$ is less than $t$ whenever $t \Rightarrow_{tf}^* s$.
\end{enumerate}
\end{defn}
These conditions are true for all theories that occur in practice.
The first condition is easy to verify, but the last two require some explanation.
The second condition might not hold in a reasonable theory, but every theory is isomoprhic to a theory in which it holds.
For example, we can define a theory of $\Pi$-types in which the application function symbol is defined as follows:
\[ \ft(\ft(B)) = \Gamma \land \ty(b) = B \land \ty(a) = \ft(B) \sststile{}{\Gamma,B,b,a} \app_m(\Gamma,B,b,a)\!\downarrow \]
This theory does not satisfy the second condition of \rdefn{simp-ctx}, but it is easy to modify the definition of $\app$ to fix this problem:
\[ \ft(A) = \Gamma \land \ft(B) = A \land \ty(b) = B \land \ty(a) = A \sststile{}{\Gamma,A,B,b,a} \app_m(\Gamma,A,B,b,a)\!\downarrow \]
This trick can be applied to any theory to get a theory satisfying the second condition of \rdefn{simp-ctx}.

The third condition of \rdefn{simp-ctx} holds if the underlying term rewriting system of $T$ is strongly normalizing.
Indeed, we can define a well-founded relation on the set $\Term_T^t$ as follows: $t_1 > t_2$ if $|t_1| > |t_2|$ where $|t_i|$ is the length of the longest sequence of reductions starting from $t_i$.
If $t \Rightarrow_{tf}^* s$, then $|t| > |s|$ and if $\Gamma \in C(s)$, then $\Gamma$ is a subterm of $s$, so $|s| \geq |\Gamma|$.
Many theories that occur in practice are strongly normalizing, but this property is hard to verify, so let us describe another condition on a theory which implies that it has simple contexts.

Let $T$ be a theory such that, for every pair of terms $t$ and $s$ in $\Term_T^t$ such that $(t,s) \in R^{tf}_T$, the set $C(t)$ consists of distinct variables and $C(s) \subseteq C(t)$.
This condition is easy to verify and it holds for all theories that occur in practice.
If it holds, then the first and the third conditions of \rdefn{simp-ctx} hold for $T$.
The first condition holds for obvious reasons.
To prove the third condition, we define a well-founded relation on the set $\Term_T^t$ as follows: $t_1 > t_2$ if the size of $t_1$ is greater than the size of $t_2$.
If $t \Rightarrow_{tf}^* s$, then it is easy to see that $C(s) \subseteq C(t)$.
Thus, for every $\Gamma \in C(s)$, the size of $\Gamma$ is less than the size of $t$.

A theory with simple contexts satisfies the following properties:
\begin{enumerate}
\item \label{it:red-fib} Let $t$ be a term in $\Term_T^t$ such that $U(t) \Rightarrow_{cf} s$ for some term $s$.
Then there exists a term $s'$ such that $t \Rightarrow_{tf} s'$ and $U(s') = s$.
This follows from the fact that the same reduction rule that we applied to $U(t)$ also applies to $t$ since there is no additional conditions on $t$ by the first condition of \rdefn{simp-ctx}.
\item \label{it:red-nf} $U$ preserves normal forms. This follows from the previous property.
\end{enumerate}

Now we can show that we can omit contexts if they are simple:
\begin{prop}[ctx-elim]
Let $T$ be a theory with simple contexts and let $(\varphi,V)$ be a pair in $P_M$.
Then the abstract reduction system $(\Term_{T,\varphi}^t, \Rightarrow_{tf})$ is confluent if and only if the system $(\Term_{T,\varphi}^c, \Rightarrow_{cf})$ is.
\end{prop}
\begin{proof}
If $\Rightarrow_{tf}$ is confluent on $\Term_T^t$, then it is easy to show that the same is true for $\Term_T^c$.
Indeed, if we have a term $t \in \Term_T^c$ such that $t \Rightarrow_{cf}^* t_1$ and $t \Rightarrow_{cf}^* t_2$,
then there is a term $t' \in \Term_T^t$ and \eqref{it:red-fib} implies that there are terms $t_1'$ and $t_2'$ such that
$t' \Rightarrow_{tf}^* t_1'$, $t' \Rightarrow_{tf}^* t_2'$, $U(t_1') = t_1'$, and $U(t_2') = t_2'$.
Since $t'$ is confluent, there exists a term $s'$ such that $t_1' \Rightarrow_{tf}^* s'$ and $t_2' \Rightarrow_{tf}^* s'$.
Hence $U(t_1') \Rightarrow_{cf}^* U(s')$ and $U(t_2') \Rightarrow_{cf}^* U(s')$.

Conversely, let $t_1$ and $t_2$ be equivalent terms in $\Term_T^t$.
Note that \rlem{der-separated-closed} and \rlem{der-eq} imply that $t_1$ and $t_2$ are equivalent if and only if there is a zig-zag of reductions between $t_1$ and $t_2$.
We proceed by induction on $t_1$ (using the well-founded relation from \rdefn{simp-ctx}).
Since the reduction relation on $\Term_T^c$ is confluent, we have a term $s' \in \Term_T^c$ such that $U(t_1) \Rightarrow_{cf}^* s'$ and $U(t_2) \Rightarrow_{cf}^* s'$.
By \eqref{it:red-fib}, there are terms $s_1$ and $s_2$ such that $t_1 \Rightarrow_{tf}^* s_1$, $t_2 \Rightarrow_{tf}^* s_2$, and $U(s_1) = U(s_2) = s'$.

To prove that $s_1$ and $s_2$ are joinable, it is enough to show that sequences $C(s_1)$ and $C(s_2)$ are equal up to equivalence.
Indeed, if this is true, then we can conclude that $j$-th elements of $C(s_1)$ and $C(s_2)$ are joinable by induction hypothesis for every $j$.
This implies that $s_1$ and $s_2$ are also joinable.
The first elements of $C(s_i)$ are equivalent to $\ctx(s_i)$ and they are equivalent since $s_1$ and $s_2$ are.
The second condition of \rdefn{simp-ctx} implies that other elements of $C(s_i)$ are determined by the first element.
Indeed, if $\sststile{}{V} \sigma_m(\Delta, t_1, \ldots t_k)\!\downarrow$ is derivable, then $\sststile{}{V} e_{p_i}(t_i) = A_{\sigma,i}[\Delta/\Gamma, t_1/x_1, \ldots t_{i-1}/x_{i-1}]$ is also derivable.
This implies that $j$-th element of $C(s_i)$ are equivalent for all $j$.
\end{proof}

\subsection{Substitution}
\label{sec:subst}

Let $T$ be a contextual theory with simple contexts.
Evety such theory $T$ has a few $\ty$-free axioms that involve function symbols $\subst_{p,m,k}$.
Corresponding $\Rightarrow_{cf}$-reduction rules look like this:
\begin{align*}
\subst_{\tm,n,k}(v_i, a_1, \ldots a_k) & \Rightarrow a_{k-i} \\
\subst_{p,k,k}(a, v_{k-1}, \ldots v_0) & \Rightarrow a \\
\subst_{p,n,m}(\sigma_m(b_1, \ldots b_k), a_1, \ldots a_m) & \Rightarrow \sigma_n(b_1', \ldots b_k') \\
\subst_{p,n,k}(\subst_{p,k,m}(a, a_1, \ldots a_m), b_1, \ldots b_k) & \Rightarrow \subst_{p,n,m}(a, a_1', \ldots a_m')
\end{align*}
where $a_i' = \subst_{\tm,n,k}(a_i, b_1, \ldots b_k)$ and $b_i'$ equals to
\[ \subst_{p_i,n+n_i,m+n_i}(b_i, \wk^{n_i}_{\tm,n}(a_1), \ldots \wk^{n_i}_{\tm,n}(a_m), v_{n_i-1}, \ldots v_0), \]
where $\wk^k_{p,n}(a) = \subst_{p,n+k,n}(a, v_{n+k-1}, \ldots v_k)$.

To show that we can eliminate function symbols $\subst_{p,n,m}$, we need to assume that reduction rules are well-behaved in some sense with respect to substitutions.
For example, we can assume that the only reduction rules in which function symbols $\subst_{p,n,m}$ occur on the left are the ones listed above.
But there is an example of a theory which we want to consider and which does not satisfy this condition.
% Namely, the theory of the interval type with the $\sigma$ rule:
% \[ \coe_1(\wk_{\ty,0}(A), a, i) \Rightarrow a \]
% where $\wk_{p,n} : (\ctx,n+1) \times (p,n) \to (p,n+1)$ is the weakening operation defined as follows: $\wk_{p,n}(\Gamma,a) = \subst_{p,n+1,n}(\Gamma, a, v_n, \ldots v_1)$.
% Note that this theory is not confluent as formulated since
% \begin{align*}
% \coe_1(\wk_{\ty,0}(I_0), \leftI_0, \rightI_0) & \Rightarrow \leftI_0 \\
% \coe_1(\wk_{\ty,0}(I_0), \leftI_0, \rightI_0) & \Rightarrow \coe_1(I_1, \leftI_0, \rightI_0)
% \end{align*}
% and terms $\leftI_0$ and $\coe_1(I_1, \leftI_0, \rightI_0)$ are not joinable.
% This problem can be fixed, but let us consider the simple situation first.
% We can fix this problem by adding more axioms:
% \[ \ty(a) = A \land \ty(i) = I \sststile{}{a,i} \coe_1(A, a, i) = a \]
% where $A$ is a closed term such that there is a closed term $A'$ such that w

Let $T$ be a theory with simple contexts.
A $\ty$-free axiom of $T$ is called a \emph{substitution axiom} if it is one of the axioms for $\subst_{p,n,k}$ listed above.
A $\ty$-free axiom of $T$ is called a \emph{$\subst$-free axiom} if function symbols $\subst_{p,n,k}$ do not occur on the left hand side.
We will say that a theory $T$ with simple contexts has \emph{separated substitution axioms} if every $\ty$-free axiom of $T$ is either a substitution axiom or a $\subst$-free axiom.
The sets of substitution and $\subst$-free axioms will be denoted by $\mathcal{A}_s$ and $\mathcal{A}_{sf}$, respectively.
The sets of reduction rules corresponding to substitution and $\subst$-free axioms will be denoted by $R^s_T$ and $R^{sf}_T$, respectively.

The relation $\Rightarrow_{R_T^{tf}}$ is the union of relations $\Rightarrow_{R_T^s}$ and $\Rightarrow_{R_T^{sf}}$.
Since $\Rightarrow_{R_T^s}$ preserves $\Rightarrow_{R_T^t,\varphi}$-normal forms, this implies that the relation $\Rightarrow_{tf}$ is the union of relations $\Rightarrow_{R_T^s}$ and $\Rightarrow_{R_T^{sf}} \Rightarrow_{R_T^t,\varphi}^\nf$.
It follows that the relation $\Rightarrow_{cf}$ is also the union of two relations $\Rightarrow_s$ and $\Rightarrow_{sf}$, the images of $\Rightarrow_{R_T^s}$ and $\Rightarrow_{R_T^{sf}} \Rightarrow_{R_T^t,\varphi}^\nf$ under $U$, respectively.

\begin{lem}[subst-red]
Let $T$ be a theory with separated substitution axioms.
Then the abstract reduction system $(\Term_{T,\varphi}^c, \Rightarrow_s)$ is confluent and strongly normalizing for every $(\varphi,V) \in P_M$.
\end{lem}
\begin{proof}
If $t$ is a term, then let $l(t)$ be its size:
\begin{align*}
l(x) & = 0 \\
l(v_i) & = 0 \\
l(\subst_{p,n,k}(b, a_1, \ldots a_m)) & = l(b) + l(a_1) + \ldots + l(a_m) + 1 \\
l(\sigma_n(a_1, \ldots a_n)) & = l(a_1) + \ldots + l(a_n) + 1
\end{align*}
For every term $t$, we define a nonzero ordinal $|t|$ less than $\omega^{\omega 2}$:
\begin{align*}
|x| & = 1 \\
|v_i| & = 1 \\
|\subst_{p,n,k}(b, a_1, \ldots a_m)| & = |b| \otimes 2 \oplus \omega^{l(b)} \otimes (|a_1| \oplus \ldots \oplus |a_m|) \\
|\sigma_n(a_1, \ldots a_n)| & = |a_1| \oplus \ldots \oplus |a_n| \oplus \omega^\omega
\end{align*}

Let us prove that $|t| > |t'|$ whenever $t \Rightarrow_s t'$.
This is obvious for the first rule:
\[ |\subst_{\tm,n,k}(v_i, a_1, \ldots a_k)| = 2 \oplus |a_1| \oplus \ldots \oplus |a_k| > |a_{k-i}|. \]

The second rule follows from the fact that $|a| > 0$:
\[ |\subst_{p,k,k}(a, v_{k-1}, \ldots v_0)| = |a| \oplus |a| \oplus k > |a|. \]

Let us consider the following rule:
\[ \subst_{p,n,m}(\sigma_m(b_1, \ldots b_k), a_1, \ldots a_m) \Rightarrow_s \sigma_n(b_1', \ldots b_k'). \]

The value of the left hand side can be computed as follows:
\begin{align*}
|\subst_{p,n,m}(\sigma_m(b_1, \ldots b_k), a_1, \ldots a_m)| & = \\
((\sum_{1 \leq i \leq k} |b_i|) \oplus \omega^\omega) \otimes 2 \oplus \omega^{l(b_1) + \ldots + l(b_k) + 1} \otimes \sum_{1 \leq i \leq m} |a_i| & = \\
(\sum_{1 \leq i \leq k} |b_i|) \otimes 2 \oplus \omega^\omega \oplus \omega^\omega \oplus \omega^{l(b_1) + \ldots + l(b_k) + 1} \otimes \sum_{1 \leq i \leq m} |a_i|. &
\end{align*}

Note that $|\wk^k_{p,n}(a)| = |a| \otimes 2 \oplus \omega^{l(a)} n$.
Now we can compute the value of the right hand side:
\begin{align*}
|\sigma_n(\ldots \subst_{p_i,n+n_i,m+n_i}(b_i, \wk^{n_i}_{\tm,n}(a_1), \ldots \wk^{n_i}_{\tm,n}(a_m), v_{n_i-1}, \ldots v_0), \ldots)| & = \\
(\sum_{1 \leq i \leq k} |b_i| \otimes 2 \oplus \omega^{l(b_i)} \otimes ((\sum_{1 \leq j \leq m} |a_j| \otimes 2 \oplus \omega^{l(a_j)} n) \oplus n_i)) \oplus \omega^\omega & = \\
(\sum_{1 \leq i \leq k} |b_i|) \otimes 2 \oplus \omega^\omega \oplus \sum_{1 \leq i \leq k} \omega^{l(b_i)} \otimes ((\sum_{1 \leq j \leq m} \omega^{l(a_j)} n) \oplus n_i) \oplus & \\
(\sum_{1 \leq i \leq k} \omega^{l(b_i)}) \otimes 2 \otimes (\sum_{1 \leq j \leq m} |a_j|). &
\end{align*}
Since $\sum_{1 \leq i \leq k} \omega^{l(b_i)} \otimes ((\sum_{1 \leq j \leq m} \omega^{l(a_j)} n) \oplus n_i) < \omega^\omega$,
we just need to show that $(\sum_{1 \leq i \leq k} \omega^{l(b_i)}) \otimes 2 \leq \omega^{l(b_1) + \ldots + l(b_k) + 1}$.
Let $\beta$ be the maximum of $l(b_1), \ldots l(b_k)$.
Then $\omega^{l(b_1) + \ldots + l(b_k) + 1} \geq \omega^{\beta + 1}$ and $(\sum_{1 \leq i \leq k} \omega^{l(b_i)}) \otimes 2 \leq \omega^\beta 2 k < \omega^{\beta + 1}$.

Finally, let us consider the last rule:
\[ \subst_{p,n,k}(\subst_{p,k,m}(a, a_1, \ldots a_m), b_1, \ldots b_k) \Rightarrow_s \subst_{p,n,m}(a, a_1', \ldots a_m'). \]

The values of the involved terms can be computed as follows:
\begin{align*}
|\subst_{p,n,k}(\subst_{p,k,m}(a, a_1, \ldots a_m), b_1, \ldots b_k)| & = \\
(|a| \otimes 4) \oplus (\omega^{l(a)} \otimes \sum_{1 \leq i \leq m} |a_i| \otimes 2) \oplus (\omega^{l(a) + l(a_1) + \ldots + l(a_m) + 1} \otimes \sum_{1 \leq i \leq k} |b_i|), &
\end{align*}

\begin{align*}
|\subst_{p,n,m}(a, \subst_{\tm,n,k}(a_1, b_1, \ldots b_k), \ldots \subst_{\tm,n,k}(a_m, b_1, \ldots b_k))| & = \\
(|a| \otimes 2) \oplus (\omega^{l(a)} \otimes \sum_{1 \leq i \leq m} (|a_i| \otimes 2) \oplus (\omega^{l(a_i)} \otimes \sum_{1 \leq j \leq k} |b_j|)) & = \\
(|a| \otimes 2) \oplus (\omega^{l(a)} \otimes \sum_{1 \leq i \leq m} |a_i| \otimes 2) \oplus (\sum_{1 \leq i \leq m} \omega^{l(a) + l(a_i)} \otimes \sum_{1 \leq j \leq k} |b_j|). &
\end{align*}

Since $|a| \otimes 4 > |a| \otimes 2$, we just need to show that
\[ \omega^{l(a) + l(a_1) + \ldots + l(a_m) + 1} \geq \sum_{1 \leq i \leq m} \omega^{l(a) + l(a_i)}. \]
Let $\alpha$ be the maximum of $l(a_1), \ldots l(a_m)$.
Then $\omega^{l(a) + l(a_1) + \ldots l(a_m) + 1} \geq \omega^{l(a) + \alpha + 1}$ and $\sum_{1 \leq i \leq m} \omega^{l(a) + l(a_i)} \leq \omega^{l(a) + \alpha} m < \omega^{l(a) + \alpha + 1}$.

This completes the proof that the system is strongly normalizing.
It follows that the system is confluent if and only if it is locally confluent and local confluence is easy to verify by considering all critical pairs.
\end{proof}

Let $\Term_{T,\varphi}^s$ be the subset of $\Term_{T,\varphi}^c$ consisting of $\Rightarrow_s$-normal forms.

\begin{prop}[subst-elim]
Let $T$ be a theory with separated substitution axioms and let $(\varphi,V)$ be a pair in $P_M$.
Then the abstract reduction system $(\Term_{T,\varphi}^c,\Rightarrow_{cf})$ is confluent if and only if the system $(\Term_{T,\varphi}^s, \Rightarrow_{sf} \Rightarrow_s^\nf)$ is.
\end{prop}
\begin{proof}
Since $\Term_{T,\varphi}^s$ is a subset of $\Term_{T,\varphi}^t$ which is closed under $\Rightarrow_{tf}$, the ``only if'' direction is obvious.
The converse follows from \rlem{conf-nf}.
By \rlem{subst-red}, $\Rightarrow_{R^s_T,\varphi} \Rightarrow_{R^t_T,\varphi}^\nf$ is strongly normalizing and confluent, so we just need to check that if $t \Rightarrow_{R_T^{sf}} s$,
then the terms $t$ and $s$ are joinable under $\Rightarrow_{R_T^s}^\nf \Rightarrow_{R_T^{sf}}^*$.
TODO
\end{proof}

TODO: Consider the more complicated case.

\section{Applications}
\label{sec:applications}

In this section we construct several examples of Morita equivalences and describe other applications of results of this paper.

\subsection{Simple examples}
\label{sec:simp-applications}

In this subsection we consider maps of the form $f : T \to T \cup \mathcal{A}$, where $\mathcal{A}$ is a set of axioms.

\begin{prop}[ext-morita]
Let $\mathcal{A}$ be a set of sequents in a theory $T$.
Suppose that, for every axiom $\psi \sststile{}{V'} \chi$ in $\mathcal{A}$, every pair $(\varphi,V) \in P_M$, and every substitution $\rho$,
the sequent $\varphi \sststile{}{V} \chi[\rho]$ is derivable whenever $\varphi \sststile{}{V} \psi[\rho]$ is.
Then, for every pair $(\varphi,V)$ in $P_M$, if a sequent $\varphi \sststile{}{V} \psi$ is derivable in $T \cup \mathcal{A}$, then it is also derivable in $T$.
In particular, the map $T \to T \cup \mathcal{A}$ is a Morita equivalence.
\end{prop}
\begin{proof}
Obvious induction on the derivation of $\varphi \sststile{}{V} \psi$.
\end{proof}

\begin{example}
We already saw examples of such a Morita equivalence in \rprop{der-separated}.
This proposition implies that the map $T \to T \mathcal{A}_e$ is a Morita equivalence for every theory $T$ with separated axioms.
This observation has the following implication.
Suppose that we want to extend $T$ with a typing axiom of the following form:
\[ \psi \sststile{}{V} e_p(\sigma(x_1, \ldots x_k)) = A \]
There are two natural choices for the formula $\psi$: $\varphi_\sigma$ and $\sigma(x_1, \ldots x_k)\!\downarrow$.
Let $T_1 = T \cup \{ \varphi_\sigma \sststile{}{V} e_p(\sigma(x_1, \ldots x_k)) = A \}$ and $T_2 = T \cup \{ \sigma(x_1, \ldots x_k)\!\downarrow\ \sststile{}{V} e_p(\sigma(x_1, \ldots x_k)) = A \}$.
Then the obvious map $T_1 \to T_2$ is a Morita equivalence.
Indeed, theories $T_1 \cup \mathcal{A}_e$ and $T_2 \cup \mathcal{A}_e$ are isomorphic and the maps $T_1 \to T_1 \cup \mathcal{A}_e$ and $T_2 \to T_2 \cup \mathcal{A}_e$ are Morita equivalences.
So $T_1 \to T_2$ is a Morita equivalence by the 2-out-of-3 property.
\end{example}

\begin{example}[directed]
If $T$ is a theory with a reduction system $R_T$, then we can define another theory which consists of axioms $t\!\downarrow\ \sststile{}{FV(t)} t = s$ for all $(t,s) \in R_T$.
Let us denote this theory by $T'$.
Then $T$ and $T'$ are Morita equivalent.
Indeed, both maps $T \to T \cup T'$ and $T' \to T \cup T'$ satisfy the condition of \rprop{ext-morita}.
This follows immediately from the definition of reduction systems.
Condition~\eqref{it:dir-first} of \rdefn{directed} implies that this is true for the first map and \eqref{it:dir-second} implies this for the second.
\end{example}

\begin{example}
Let $T_\Pi$ be the theory of $\Pi$-types.
One of the axioms (beta reduction) of this theory looks like this:
\[ \ft(B) = A \land \ty(b) = B \land \ty(a) = A \sststile{}{A,B,a,b} \app(A,B,\lambda(A,b),a) = b[a] \]
If we replace this axiom with the following one, then we obtain a new theory which we will denote by $T_\Pi'$.
\[ \app(A,B,\lambda(A,b),a)\!\downarrow\ \sststile{}{A,B,a,b} \app(A,B,\lambda(A,b),a) = b[a] \]

We want to show that the obvious map $T_\Pi \to T_\Pi'$ is a Morita equivalence.
It is a folklore result that the underlying term rewriting system of $T_\Pi'$ is confluent.
By \rthm{conf-comp}, the theory $T_\Pi'$ is confluent.

Let us show that the condition of \rprop{ext-morita} holds.
Note that the formula $\app(A,B,\lambda(A,b),a)\!\downarrow$ is equivalent to $\ft(B) = A \land \Pi(A,\ty(b)) = \Pi(A,B) \land \ty(a) = A$.
Suppose that $\varphi \sststile{}{V} \ft(B) = A \land \Pi(A,\ty(b)) = \Pi(A,B) \land \ty(a) = A$ is derivable in $T_\Pi'$.
Since $T_\Pi'$ is confluent and there are no reductions of the form $\Pi(A,B) \Rightarrow t$, it follows that $\ty(b) \Rightarrow B$.
Hence, $\varphi \sststile{}{V} \ty(b) = B$.
This shows that the condition of \rprop{ext-morita} holds.

This also implies that $T_\Pi$ is confluent.
Indeed, the conditions of \rdefn{directed} and \rdefn{confluent} involve only sequents of the form $\varphi \sststile{}{V} \psi$ where $(\varphi,V) \in P_M$
and \rprop{ext-morita} implies that such a sequent is derivable in $T_\Pi$ if and only if it is derivable in $T_\Pi'$.
Moreover, the underlying term rewriting systems of $T_\Pi$ and $T_\Pi'$ coincide.
These facts imply that $T_\Pi$ is confluent if and only if $T_\Pi'$ is confluent.
\end{example}

\begin{example}
We can formulate the beta reduction axiom in one of the following ways:
\begin{align*}
\ft(B) = A \land A = A' \land \ty(b) = B \land \ty(a) = A & \sststile{}{A,A',B,a,b} \app(A,B,\lambda(A',b),a) = b[a] \\
\app(A,B,\lambda(A',b),a)\!\downarrow & \sststile{}{A,A',B,a,b} \app(A,B,\lambda(A',b),a) = b[a]
\end{align*}
Let us denote the theory with the former axiom by $T_\Pi''$ and the theory with the latter by $T_\Pi'''$.
Then we have the following commutative diagram of theories:
\[ \xymatrix{ T_\Pi  \ar[r] \ar[d]  & T_\Pi'' \ar[d] \\
              T_\Pi' \ar[r]         & T_\Pi'''
            } \]
The top arrow is actually an isomorphism and we can prove that the two remaining arrows are Morita equivalences using \rprop{ext-morita} in the same way as we did this for the arrow $T_\Pi \to T_\Pi'$.
Note that even theories $T_\Pi$ and $T_\Pi''$ are isomorphic they differ as theories with directed axioms.
In particular, the underlying term rewriting systems of $T_\Pi$ and $T_\Pi''$ differ.
The latter is left-linear (assuming that other reduction rules are also left-linear) and this is the main reason why we might be interested in this theory.
\end{example}

We can summarize results of this subsection as follows.
There are several ways to defined a theory of $\Pi$-types, but they are all Morita equivalent.
Also, similar results can be proved for other theories such as the theory of $\Sigma$-types or the theory of identity types.

\subsection{Other examples}

Let us consider the theory of $\Sigma$-types:
\medskip
\begin{center}
\AxiomC{}
\UnaryInfC{$\vdash \Sigma(A, x.\,B)\ \type$}
\DisplayProof
\quad
\AxiomC{$\vdash b : B[a]$}
\doubleLine
\UnaryInfC{$\vdash \pair(A, x.\,B, a, b) : \Sigma(A, x.\,B)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$z : \Sigma(A, x.\,B) \vdash D\ \type$}
\AxiomC{$x : A, y : B \vdash d : D'$}
\AxiomC{$\vdash p : \Sigma(A, x.\,B)$}
\doubleLine
\TrinaryInfC{$\vdash \Sigma\text{-}\elim(A, B, z.\,D, x y.\,d, p) : D[p]$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$z : \Sigma(A,x.\,B) \vdash D\ \type$}
\AxiomC{$x : A, y : B \vdash d : D'$}
\AxiomC{$\vdash b : B[a]$}
\TrinaryInfC{$\vdash \Sigma\text{-}\elim(A, B, z.\,D, x y.\,d, \pair(A, x.\,B, a, b)) \deq d[a,b]$}
\DisplayProof
\end{center}

where $D' = D[\pair(A, B, x, y)]$.
We will denote this theory by $\Sigma$.
We can modify the last rule as follows:
\medskip
\begin{center}
\AxiomC{$\Sigma\text{-}\elim(A, B, z.\,D, x y.\,d, \pair(A', x.\,B', a, b))\!\downarrow$}
\UnaryInfC{$\vdash \Sigma\text{-}\elim(A, B, z.\,D, x y.\,d, \pair(A', x.\,B', a, b)) \deq d[a,b]$}
\DisplayProof
\end{center}
The modified theory will be denoted by $\Sigma'$.
There is an obvious map $\Sigma \to \Sigma'$.

\begin{example}
Let $T$ be a theory under $\Sigma$ and let $f : T \to T'$ be the pushout of the map $\Sigma \to \Sigma'$.
If $T'$ is confluent and there is no reduction rules of the form $\Sigma(A, x.\,B) \Rightarrow t$, then $f$ is a Morita equivalence.
To prove this it is enough to show that, for every $(\varphi,V) \in P_M$, if a sequent $\varphi \sststile{}{V} t = s$ is derivable in $T'$, then it is derivable in $T$.
% If \varphi \sststile{}{V} t\!\downarrow in T and t => s in T', then t => s in T. We do this by induction on the length of the maximal reduction sequence starting from $t$.
% This implies:
% If \varphi \sststile{}{V} t\!\downarrow \land s\!\downarrow in T and \varphi \sststile{}{V} t = s in T', then \varphi \sststile{}{V} t = s in T.
% We just need to show that if $\varphi \sststile{}{V} t\!\downarrow$ in T', then the same is true in T.
% We do this by induction on the size of $t$, where the size of $t$ is the maximum among ordinals (natural sum of \omega^{\omega*f(\sigma)} for every \sigma in p, where $f$ is the ordinal corresponding to $\sigma$) for every paths p from the root of $t$ to a leaf.
\end{example}

% Note that this proposition does not use the condition that we put on formulas $\varphi_{t,s}$, so we can use it to prove that it holds.
% Let us sketch a proof of this fact for the theory of $\Pi$-types.
% We need to show that if $t \Rightarrow_R s$ and $\psi \sststile{}{V} t\!\downarrow$, then $\psi \sststile{}{V} \varphi_{t,s}$.
% 
% 
% The reduction relation in the theory of $\Pi$-types is strongly normalizable (that is, the relation $R_0$ is well-founded).
% We proceed by induction on the length of the longest chain of reductions starting in $t$ ignoring the reductions of the form $\ty(t_1) \Rightarrow t_2$ (we can do this since this relation is also strongly normalizable).
% The only interesting case is when $t = \app(B, \lambda(b), a)$.
% In this case, $\psi \sststile{}{V} \Pi(\ty(b)) = \Pi(B)$ and we need to prove that $\psi \sststile{}{V} \ty(b) = B$.
% \Rprop{conf-main} implies that $\Pi(\ty(b))$ and $\Pi(B)$ reduce to the same term and, since there is no reduction rule of the form $\Pi(t) \Rightarrow s$, this implies that $\ty(b)$ and $B$ also reduce to the same term.
% The induction hypothesis applies to $\ty(b)$ and $B$ and implies that $\psi \sststile{}{V} \ty(b) = B$.

\begin{comment}
\subsection{Properness of the model categories of models}

Let us show that the model category of models of a confluent theory is proper:

\begin{prop}
Let $T$ be a confluent theory under $\coeT_1 + \sigma + \PathT + \wUA$ with well-defined function symbols.
Then the category of models of $T$ is proper model category
\end{prop}
\begin{proof}
Since all objects of $\Mod{T}$ are fibrant, this category is right proper.
To prove that it is left proper, we just need to prove that trivial fibrations are closed under the operation of attaching a single term or type.
To be more precise, we need to prove that for every trivial fibration $f : X \to Y$ in $\Mod{T}$ and every map $F(\{ A : (d_p,n) \}) \to X$,
the following pushout of $f$ is also a trivial fibration:
\[ \xymatrix{ X \ar[r] \ar[d]_f &     X \amalg_{F(\{ A : (d_p,n) \})} F(\{ e_p(a) = A \}) \ar[d] \\
              Y \ar[r]          & \po Y \amalg_{F(\{ A : (d_p,n) \})} F(\{ e_p(a) = A \})
            } \]

Since $\Lang$ is a left adjoint, we have the following pushout square:
\[ \xymatrix{ \Lang(X) \ar[r] \ar[d]_\Lang(f) &     \Lang(X) \amalg_{\{ A : (d_p,n) \}} \{ e_p(a) = A \} \ar[d] \\
              \Lang(Y) \ar[r]                 & \po \Lang(Y) \amalg_{\{ A : (d_p,n) \}} \{ e_p(a) = A \}
            } \]
A map $g$ of models is a trivial fibration if and only if $\Lang(g)$ has the lifting property with respect to $P_0$.
Thus it is enough to show that conditions of \rlem{eq-char-fib} hold for this pushout of $\Lang(f)$.
The first condition is easy to prove.
If $\sigma$ is a function symbol of $T$ or $\sigma = a$, then we can lift it to itself.
If $\sigma = O_y$ for some $y \in Y$, then we can lift it to $O_x$, where $x \in X$ is a lift of $y$

TODO
\end{proof}
\end{comment}

% trivial fibrations are closed under pushouts along weak cofibrations, in particular weak equivalences are closed under coproducts
% the universe functor preserves trivial fibrations and hence weak equivalences
% two different versions of Sigma are Morita equivalent (using cylinder objects for theories)
% arrows and pi types are Morita equivalent
% cofibrant replacement of theories (in particular, Id_- for Id, also Sigma and other simple theories)
% T -> T + wUA is a Morita equivalence
% ommiting contexts in terms

TODO: Modularity.
Since many type theories are constructed as coproducts of simple basic theories, it is natural to ask whether coproducts preserve the confluence property.
If the confluence property is stable under the union in some class of theories, then we say that it is \emph{modular} for this class.
It was shown by Toyama in \cite{toyama} (see also \cite{klop-confluence,oostrom-confluence}) that the confluence is modular for disjoint theories.
There are many generalizations of this result for theories that may share particular some function symbols (see for instance \cite{ohlebusch-confluence,ohlebusch-composable,middeldorp-completeness}).

\bibliographystyle{amsplain}
\bibliography{ref}

\end{document}
