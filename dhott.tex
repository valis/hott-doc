\documentclass[reqno]{amsart}

\usepackage{amssymb}
\usepackage{hyperref}
\usepackage{mathtools}
\usepackage[all]{xy}
\usepackage{verbatim}
\usepackage{ifthen}
\usepackage{xargs}
\usepackage{bussproofs}
\usepackage{turnstile}
\usepackage{etex}

\hypersetup{colorlinks=true,linkcolor=blue}

\newcommand{\axlabel}[1]{(#1) \phantomsection \label{ax:#1}}
\newcommand{\axtag}[1]{\label{ax:#1} \tag{#1}}
\newcommand{\axref}[1]{(\hyperref[ax:#1]{#1})}

\newcommand{\newref}[4][]{
\ifthenelse{\equal{#1}{}}{\newtheorem{h#2}[hthm]{#4}}{\newtheorem{h#2}{#4}[#1]}
\expandafter\newcommand\csname r#2\endcsname[1]{#3~\ref{#2:##1}}
\expandafter\newcommand\csname R#2\endcsname[1]{#4~\ref{#2:##1}}
\expandafter\newcommand\csname n#2\endcsname[1]{\ref{#2:##1}}
\newenvironmentx{#2}[2][1=,2=]{
\ifthenelse{\equal{##2}{}}{\begin{h#2}}{\begin{h#2}[##2]}
\ifthenelse{\equal{##1}{}}{}{\label{#2:##1}}
}{\end{h#2}}
}

\newref[section]{thm}{Theorem}{Theorem}
\newref{lem}{Lemma}{Lemma}
\newref{prop}{Proposition}{Proposition}
\newref{cor}{Corollary}{Corollary}
\newref{cond}{Condition}{Condition}

\theoremstyle{definition}
\newref{defn}{Definition}{Definition}
\newref{example}{Example}{Example}

\theoremstyle{remark}
\newref{remark}{Remark}{Remark}

\newcommand{\type}{}
\newcommand{\ob}{}
\newcommand{\term}{1}
\newcommand{\unit}{()}

\newcommand{\fs}[1]{\mathrm{#1}}
\newcommand{\cat}[1]{\mathbf{#1}}
\newcommand{\scat}[1]{\mathcal{#1}}
\newcommand{\sSet}{\cat{sSet}}
\newcommand{\Hom}{\fs{Hom}}
\newcommand{\Id}{\fs{Id}}
\newcommand{\id}{\fs{id}}

\numberwithin{figure}{section}

\newcommand{\ct}{%
  \mathchoice{\mathbin{\raisebox{0.25ex}{$\displaystyle\centerdot$}}}%
             {\mathbin{\raisebox{0.25ex}{$\centerdot$}}}%
             {\mathbin{\raisebox{0.25ex}{$\scriptstyle\,\centerdot\,$}}}%
             {\mathbin{\raisebox{0.25ex}{$\scriptscriptstyle\,\centerdot\,$}}}
}

\newcommand{\pb}[1][dr]{\save*!/#1-1.2pc/#1:(-1,1)@^{|-}\restore}
\newcommand{\po}[1][dr]{\save*!/#1+1.2pc/#1:(1,-1)@^{|-}\restore}

\begin{document}

\title{An indexed type theory for synthetic $\infty$-categories}

\author{Valery Isaev}

\begin{abstract}
% TODO
\end{abstract}

\maketitle

\section{Introduction}

% TODO

\section{Models of indexed type theories}

In this section, we discuss several examples of models of indexed type theories.
Indexed type theories are defined in \cite{indexed-tt} as certain essentially algebraic theory.
Thus, we have a notion of a model of such a theory.
We will call models of indexed unary (resp., dependent) type theories \emph{contextually indexed categories} (resp., \emph{contextually indexed contextual categories}).
A contextually indexed category is a contextual category $B$ together with a category indexed over $B$, that is a functor $B^\fs{op} \to \cat{Cat}$.
A contextually indexed contextual category is a contextual category $B$ together with a contextual category indexed over $B$, that is a functor $B^\fs{op} \to \cat{ConCat}$.

One class of contextually indexed contextual categories was already defined in \cite{indexed-tt}.
An indexed type theory can be interpreted in an appropriate homotopy type theory.
This implies that there is a forgetful functor $U$ from the category of contextual categories to the category of contextually indexed contextual categories.
If $M$ is a contextual category, then $U(M)$ will be called \emph{the canonical indexing of $M$ over itself}.
The underlying contextual category of $U(M)$ is indeed $M$ itself.

Let $F$ be a functor between underlying categories of contextual categories $\scat{B}'$ and $\scat{B}$.
If $\scat{C}$ is a contextual category over $\scat{B}$, then \emph{change of base} of $\scat{C}$ along $F$ is defined as $\scat{C} \circ F^\fs{op}$ and denoted by $F^*(\scat{C})$.
If $F$ and $G$ are isomorphic functors between categories underlying contextual categories $\scat{B}'$ and $\scat{B}$, then $F^*(\scat{C})$ and $G^*(\scat{C})$ are also isomorphic for every contextuall indexed (contextual) category $\scat{C}$.

The intended models of theories that we will be discussing in this paper can be described as full subcategories of the category $\sSet^{\Delta^\fs{op}}$,
where $\sSet$ is the canonical indexing of the category of simplicial set (considered as a contextual category as described in \cite{kap-lum-voe}) over itself.
Our aim here is to define the model $\sSet^{\Delta^\fs{op}}$.
Since it requires little additional effort, we will define more general contextually indexed category $\scat{C}^\scat{J}$ for every appropriate category $\scat{C}$ and category $\scat{J}$.

Even more generally, we describe models of the form $F^*(\scat{C})$ for a functor $F : \scat{B} \to \scat{C}$ between type-theoretic semi-fibration categories.
Change of base $F^*(\scat{C})$ is defined in the first subsection.
The second subsection discusses type-theoretic semi-fibration categories.
The next few subsections are dedicated to studying various categorical properties of such models.
Finally, the last subsection discusses another class of models, namely full subcategories of models.

\subsection{Change of base}

Let $\scat{C}$ be a category with a chosen class of maps, called fibrations, such that the terminal object exists and pullbacks of fibrations exist and are fibrations.
Such categories will be called \emph{categories with fibrations}.
The local universes construction defined in \cite{local-universes}, for every category with fibrations $\scat{C}$,
gives us a contextual category $\scat{C}_!$ whose types over $\Gamma$ are diagrams of the form
\[ \xymatrix{                       & E_A \ar@{->>}[d]^{p_A} \\
              \Gamma \ar[r]_-{r_A}  & V_A
            } \]
where $p_A$ is a fibration.
Terms of this type are sections $\Gamma \to E_A$.
For every type $\Gamma \vdash A$, the extended context $\Gamma, x : A$ is the pullback of this diagram.
If $\scat{C}$ satisfies additional conditions listed in \cite[Definition~4.2.1]{local-universes}, then $\scat{C}_!$ models unit types, identity types, $\Sigma$-types, and $\Pi$-types.

If $\scat{B}$ is a category with fibrations, then the underlying category of $\scat{B}_!$ is equivalent to the category $\scat{B}_\fs{f}$ of fibration objects of $\scat{B}$.
Thus, change of base for (contextual) categories indexed over $\scat{B}_!$ is defined for every functor $\scat{B}'_\fs{f} \to \scat{B}_\fs{f}$.
If $F : \scat{B}' \to \scat{B}$ is a functor that preserves fibrations, terminal objects, and pullbacks of fibrations, then there is an obvious contextual functor between contextual categories $F_! : \scat{B}'_! \to \scat{B}_!$.
The underlying functor of $F_!$ is isomorphic to $F_\fs{f} : \scat{B}'_\fs{f} \to \scat{B}_\fs{f}$, the restriction of $F$ to fibrant objects of $\scat{B}'$.

Let $\scat{B}$ be a contextual category, let $\scat{C}$ be a category with fibrations, and let $F : \scat{B} \to \scat{C}$ be a functor.
We showed above that if the image of $F$ consists of fibrant objects, then we can define change of base $F^*(\scat{C}_!)$.
Actually, we can define this contextual category for arbitrary $F$.
This is a straightforward generalization of the local universes model.
Closed indexed types in context $\Gamma$ are diagrams of the form
\[ \xymatrix{                           & E_A \ar@{->>}[d]^{p_A} \\
              F(\Gamma) \ar[r]_-{r_A}   & V_A
            } \]
where $p_A$ is a fibration.
Contexts, terms, and non-closed types are defined as before.

We are mainly interested in locally small contextually indexed categories since most of the constructions in \cite{indexed-tt} use this property.
In general, local smallness of $\scat{C}$ does not imply local smallness of $F^*(\scat{C})$.
We consider a special case when it does:

\begin{prop}[locally-small]
Let $F : \scat{B} \to \scat{C}$ be a functor between categories with fibrations (which might not preserve any structure).
Suppose that, for every fibration $f : A \twoheadrightarrow B$ in $\scat{C}$, the pullback functor $f^* : \scat{C}/B \to \scat{C}/A$ has a partial right adjoint $\Pi_f : \scat{C}/A \to \scat{C}/B$, defined for all fibraitons over $A$, and whose values are fibrations over $B$.
Then $F^*(\scat{C}_!)$ has $\Pi$-types.
If $F$ has a right adjoint $G : \scat{C} \to \scat{B}$ which preserves fibrations, then $F^*(\scat{C}_!)$ has dependent $\Hom$-types.
In particular, it is locally small.
\end{prop}
\begin{proof}
The fact that $F^*(\scat{C}_!)$ has $\Pi$-types was proved in \cite{local-universes}.
Since we have $\Pi$-types, it is enough to define dependent $\Hom$-types for closed types:
\begin{center}
\AxiomC{$\Gamma \mid \cdot \vdash B \ob$}
\UnaryInfC{$\Gamma \vdash \Hom(\cdot.B) \type$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \mid \cdot \vdash b : B$}
\UnaryInfC{$\Gamma \vdash \lambda(b) : \Hom(\cdot.B)$}
\DisplayProof
\qquad
\AxiomC{$\Gamma \vdash f : \Hom(\cdot.B)$}
\UnaryInfC{$\Gamma \mid \Delta \vdash f\,() : B$}
\DisplayProof
\end{center}

\begin{align*}
\lambda(b)\,() & = b \\
\lambda(f\,()) & = f
\end{align*}

If $B$ is a closed type, then we define $\Gamma \vdash \Hom(\cdot.B)$ as the following diagram:
\[ \xymatrix{                               & G(E_B) \ar@{->>}[d]^{G(p_B)} \\
              \Gamma \ar[r]_-{\varphi(r_B)} & G(V_B)
            } \]
where $\varphi(r_B)$ is the map corresponding to $r_B$ by adjointness.
A term $\Gamma \mid \cdot \vdash b : B)$ corresponds to a section $b : F(\Gamma) \to E_B$ of $p_B$.
We define $\lambda(b)$ as $\varphi(b) : \Gamma \to G(E_B)$.
Conversely, if $f : \Gamma \to G(E_B)$ is a section of $G(p_B)$, then we define $f\,()$ as $\varphi^{-1}(f) : F(\Gamma) \to E_B$.
The fact that these constructions are stable under substitution follows from the naturality of $\varphi$.
\end{proof}

\subsection{Type-theoretic semi-fibration categories}

Let $\scat{C}$ be a category with fibrations.
Then over categories $\scat{C}/\Gamma$ are also categories with fibrations.
We will say that a map of $\scat{C}$ is a \emph{trivial cofibration} if it has the left lifting property with respect to fibrations.
Then a map in each of the categories $\scat{C}_\fs{f}$, $\scat{C}/\Gamma$, and $(\scat{C}/\Gamma)_\fs{f}$ is a trivial cofibration if and only if it is a trivial cofibration in $\scat{C}$.

\begin{prop}
A map $i : A \to B$ in $(\scat{C}/\Gamma)_\fs{f}$ is a trivial cofibration if and only if it is an inclusion of a strong deformation retract.
That is, there is a map $r : B \to A$ and a homotopy $h$ between $i \circ r$ and $\id_B$ such that $r \circ i = \id_A$ and $h \circ i$ is the trivial homotopy.
\end{prop}
\begin{proof}
% TODO
\end{proof}

The notion of a type-theoretic fibration category was defined in \cite[Definition~2.1]{shul-inv}.
We define a generalization of this notion:
\begin{defn}[ttsfc]
A \emph{type-theoretic semi-fibration category} consists of a category $\scat{C}$ with a chosen class of maps, called fibrations, a chosen terminal object, and chosen pullbacks of fibrations such that the following conditions hold:
\begin{enumerate}
\item \label{it:ttsfc-pi} For every fibration $p : A \twoheadrightarrow B$, the pullback functor $p^* : \scat{C}/B \to \scat{C}/A$ has a partial right adjoint $\Pi_p : \scat{C}/A \to \scat{C}/B$, defined for all fibraitons over $A$.
\item The class of fibrations contains identity morphisms and is closed under compositions and pullbacks.
\item Let $i : A \to B$ be a trivial cofibration in $(\scat{C}/\Gamma)_\fs{f}$ for some $\Gamma$.
Then pullbacks of $i$ along fibrations are trivial cofibrations.
\item \label{it:ttsfc-factor} Let $i : A \to B$ be a map in $(\scat{C}/\Gamma)_\fs{f}$ for some $\Gamma$.
Then $i$ factors as a trivial cofibration followed by a fibration.
\item Let $i : A \to B$ be a trivial cofibration in $(\scat{C}/\Gamma)_\fs{f}$ for some $\Gamma$.
Then, for every map $r : \Delta \to \Gamma$, the pullback map $r^*(A) \to r^*(B)$ is a trivial cofibration.
\end{enumerate}
\end{defn}

The first condition is a technical assumption required by the local universes construction.
The second condition implies the existence of $\Sigma$-types and unit types.
The third condition is a technical assumption that guarantees that the category is homotopically well-behaved.
The last two conditions imply the existence of identity types.
We will say that $\scat{C}$ is \emph{right proper} if $\Pi_p$ preserves fibrations.
We will say that $\scat{C}$ is \emph{extensional} if $\Pi_p$ preserves fibrations and trivial fibrations (that is, fibrations which are also homotopy equivalences).
We will say that $\scat{C}$ is \emph{cofibrantly generated} if it is cocomplete and trivial cofibrations are generated by a small set permiting the small object argument.
We will say that $\scat{C}$ is \emph{combinatorial} if it is locally presentable and trivial cofibrations are generated by a small set.

\begin{remark}
A type-theoretic fibration category is precisely a right proper type-theoretic semi-fibration category in which all objects are fibrant.
\end{remark}

\begin{remark}[semi-fib]
The full subcategory of a type-theoretic semi-fibration category on fibrant objects is a type-theoretic fibration category.
\end{remark}

\begin{remark}[semi-over]
Slice categories of a type-theoretic semi-fibration category are also type-theoretic semi-fibration categories.
\end{remark}

\begin{example}
Let $\scat{M}$ be a model category in which cofibrations are stable under pullbacks and such that condition~\eqref{it:ttsfc-pi} of \rdefn{ttsfc} holds.
Then $\scat{M}$ is a type-theoretic semi-fibration category.
We will call such a model category \emph{type-theoretic model category}.
This is a slightly more general notion than the one defined in \cite[Definition~2.12]{shul-inv}.

A type-theoretic model category is right proper as a type-theoretic semi-fibration category if and only if it is right proper as a model category.
If trivial fibrations in a type-theoretic model category $\scat{M}$ are homotopy equivalences, then $\scat{M}$ is extensional.
In particular, every right proper locally Cartesian closed model category in which cofibrations are precisely monomorphisms is an extensional type-theoretic semi-fibration category.

Every cofibrantly generated (resp., combinatorial) type-theoretic model category is cofibrantly generated (resp., combinatorial) as a type-theoretic semi-fibration category.
\end{example}

Let $\scat{C}$ be a type-theoretic semi-fibration category and let $\scat{J}$ be a small category.
A map of $\scat{C}^\scat{J}$ is an \emph{injective fibration} if it has the right lifting property with respect to objectwise trivial cofibrations.
A structure of a type-theoretic semi-fibration category on $\scat{C}^\scat{J}$ is \emph{injective} if its fibrations are injective.

\begin{prop}[injective]
Let $\scat{C}$ be a type-theoretic semi-fibration category and let $\scat{J}$ be a small category.
Suppose that $\scat{C}$ is bicomplete and fibrations are exponentiable.
Then an injective class of fibrations of $\scat{C}^\scat{J}$ makes this category into a type-theoretic semi-fibration category if and only if condition~\eqref{it:ttsfc-factor} of \rdefn{ttsfc} holds.
\end{prop}
\begin{proof}
The ``only if'' direction is obvious.
Let us prove the converse.
First, let us prove that fibrations are objectwise retracts of fibrations in $\scat{C}$.
Let $j$ be an object of $\scat{J}$.
Then the functor $E_j : \scat{C}^\scat{J} \to \scat{C}$ of evaluating at $j$ has a left adjoint $F : \scat{C} \to \scat{C}^\scat{J}$, which is defined as $F(X) = \Hom(j,-) \cdot X$.
If $f : A \to B$ is a trivial cofibration of $\scat{C}$, then $F(f)$ is an objectwise trivial cofiration.
Thus, every fibration $p : X \twoheadrightarrow Y$ has the right lifting property with respect to $F(f)$.
By adjointness, $E_j(p)$ has the right lifting property with respect to $f$.
% TODO

The right adjoint to pullback functors exists by \cite[Theorem~2.12]{comp-fact-tor}.
To prove that other conditions hold, it is enough to prove that a map in $(\scat{C}^\scat{J}/\Gamma)_\fs{f}$ is a trivial cofibration if and only if it is an objectwise trivial cofibration.
The ``if'' direction holds by the assumption that fibrations are injective.
To prove the converse, let $i : A \to B$ be a map in $(\scat{C}^\scat{J}/\Gamma)_\fs{f}$ that has the left lifting property with respect to fibrations.
% TODO
\end{proof}

\begin{cor}
If $\scat{C}$ is a combinatorial type-theoretic semi-fibration category in which fibrations are exponentiable and $\scat{J}$ is a small category, then $\scat{C}^\scat{J}$ is a combinatorial injective type-theoretic semi-fibration category.
If $\scat{C}$ is right proper, then so is $\scat{C}^\scat{J}$.
If $\scat{C}$ is a right proper type-theoretic combinatorial model category in which all object are cofibrant, then $\scat{C}^\scat{J}$ with its injective model structure is an extensional combinatorial type-theoretic model category.
\end{cor}
\begin{proof}
We define fibrations as maps that have the right lifting property with respect to objectwise trivial cofibrations.
By \rprop{injective}, it is enough to prove that every map factors into a objectwise trivial cofibration followed by a fibration which is true by \cite[Lemma~A.2.8.3]{lurie-topos}.
If $\scat{C}$ is right proper, then the fact that $\scat{C}^\scat{J}$ is also right proper follows from the fact that objectwise trivial cofibrations are stable under pullbacks along fibrations which is true since fibrations are objectwise fibrations and pullbacks of trivial cofibrations are stable under pullbacks along fibrations in $\scat{C}$ by the right properness.
Finally, if $\scat{C}$ is a model category in which all objects are cofibrant, then this is also true for $\scat{C}^\scat{J}$.
It follows that trivial fibrations are precisely maps with the right lifting property with respect to cofibrations.
Thus, $\Pi$ whenever cofibrations are stable under pullbacks which is true since cofibrations are precisely objectwise cofibrations,
\end{proof}

\begin{defn}
A \emph{Quillen adjunction} between type-theoretic semi-fibration categories is an adjunction such that the right adjoint preserves fibrations and trivial fibrations.
If $F \dashv G$ is a Quillen adjunction, then $F$ (resp., $G$) will be called \emph{left (resp., right) Quillen functor}.
\end{defn}

\begin{prop}[indexed-locally-small]
Let $F$ be a left Quillen functor between type-theoretic semi-fibration categories $\scat{B}$ and $\scat{C}$.
Then $F^*(\scat{C}_!)$ is a contextually indexed contextual category with unit types, $\Sigma$-types, and identity types.
If $\scat{C}$ is right proper, then $F^*(\scat{C}_!)$ has $\Pi$-types and dependent $\Hom$-types.
In particular, it is locally small.
If $\scat{C}$ is extensional, then $\Pi$-types and identity types are extensional.
\end{prop}
\begin{proof}
The existence of unit types, $\Sigma$-types, identity types, and $\Pi$-types follows from \cite{local-universes}.
The existence of dependent $\Hom$-types is proved in \rprop{locally-small}.
The functional extensionality holds by \cite[Lemma~5.9]{shul-inv}.
Thus, we just need to prove that identity types are extensional.

We need to prove that the canonical function
\[ \Id_{\Hom(\Delta.B)}(f,g) \to \Hom(\Delta.\,\Id_B(f\,\overline{x},g\,\overline{x})) \] is an equivalence, where $\Delta = x_1 : A_1, \ldots x_n : A_n$.
Since we have $\Pi$-types this function is equivalent to the canonical function $\Id_{\Hom(\cdot . \Pi(\Delta,B))(\lambda(\lambda \overline{x}.f\overline{x}),\lambda(\lambda \overline {x}.g\overline{x}))} \to \Hom(\cdot . \Pi(\Delta, \Id(f\,\overline{x},g\,\overline{x})))$.
This function factors through the canonical function $\Hom(\cdot . \Id_{\Pi(\Delta,B)}(\lambda \overline{x}. f\,\overline{x}, \lambda \overline{x}. g\,\overline{x})) \to \Hom(\cdot . \Pi(\Delta, \Id(f\,\overline{x},g\,\overline{x})))$.
Since $\Pi$-types are extensional, we just need to show that the map $\Id_{\Hom(\cdot . \Pi(\Delta,B))(\lambda(\lambda \overline{x}.f\overline{x}),\lambda(\lambda \overline {x}.g\overline{x}))} \to \Hom(\cdot . \Id_{\Pi(\Delta,B)}(\lambda \overline{x}. f\,\overline{x}, \lambda \overline{x}. g\,\overline{x}))$ is an equivalence.
We prove that, more generally, for every closed type $A$ and terms $\Gamma \vdash a : \Hom(\cdot.A)$ and $\Gamma \vdash a' : \Hom(\cdot.A)$, the canonical function $\Id_{\Hom(\cdot . A)}(a,a') \to \Hom(\cdot . \Id_A(a\,(),a'\,()))$ is an equivalence.
This function will be denoted by $\fs{hap}_A$.

The type $A$ correspond to a diagram of the form
\[ \xymatrix{                           & E_A \ar@{->>}[d]^{p_A} \\
              F(\Gamma) \ar[r]_-{r_A}   & V_A
            } \]
and terms $a$ and $a'$ correspond to section $a,a' : F(\Gamma) \to E_A$ of $p_A$.
Types $\Id_{\Hom(\cdot . A)}(a,a')$ and $\Hom(\cdot . \Id_A(a\,(),a'\,()))$ are interpreted as the following diagrams:
\[ \xymatrix{                                                           & & P_{G(V_A)}(G(E_A)) \ar@{->>}[d]^q \\
              \Gamma \ar[rr]_-{\langle \varphi(a), \varphi(a') \rangle} & & G(E_A) \times_{G(V_A)} G(E_A)
            } \qquad
   \xymatrix{                                                   & & G(P_{V_A}(E_A)) \ar@{->>}[d]^{G(q')} \\
              \Gamma \ar[rr]_-{\varphi(\langle a, a' \rangle)}  & & G(E_A \times_{V_A} E_A)
            } \]
where $P_{X}(Y)$ is the path object for the diagonal $Y \to Y \times_{X} Y$.
Since the map $G(E_A) \to P_{G(V_A)}(G(E_A))$ is a trivial cofiration, we have a lift in the following diagram:
\[ \xymatrix{ G(E_A) \ar[d]_r \ar[rr]^-{G(r')}                      &                                               & G(P_{V_A}(E_A)) \ar@{->>}[d]^{G(q')} \\
              P_{G(V_A)}(G(E_A)) \ar@{->>}[r]_-q \ar@{-->}[urr]^s   & G(E_A) \times_{G(V_A)} G(E_A) \ar[r]_-\simeq  & G(E_A \times_{V_A} E_A)
            } \]
This lift is the interpretation of $\fs{hap}_A$.
To prove that the pullback of $s$ over $\Gamma$ is an equivalence which is stable under pullbacks, it is enough to show that $s$ is an equivalence.

There is a fibration $G(E_A \times_{V_A} E_A) \twoheadrightarrow G(E_A)$.
Moreover, the induced maps $X \to G(E_A)$ for every object in the diagram above are also fibrations.
By \rremark{semi-fib} and \rremark{semi-over}, we can think of this diagram as a diagram in the type-theoretic fibration category of fibrations over $G(E_A)$.
Since $r$ is trivial cofibration, \cite[Lemma~3.6]{shul-inv} implies that it is an equivalence.
The map $r'$ is also an equivalence for the same reasons.
By the 2-out-of-3 property, the map $P_{V_A}(E_A) \to E_A$ is a trivial fibration.
Since $G$ preserves trivial fibrations, the 2-out-of-3 property implies that $G(r')$ is an equivalence.
Finally, by the 2-out-of-3 property, $s$ is an equivalence.
\end{proof}

\begin{example}
If $\scat{M}$ is a type-theoretic model category and $\scat{J}$ is a small category, then the diagonal functor $D :\scat{M} \to \scat{M}^\scat{J}$ satisfies the conditions of \rprop{indexed-locally-small}.
If $\scat{M}$ is right proper and all objects of $\scat{M}$ are cofibrant, then this is also true for $\scat{M}^\scat{J}$, which implies that it is extensional.
\end{example}

\subsection{Products}

Let $F$ be a functor between type-theoretic semi-fibration categories $\scat{B}$ and $\scat{C}$.
We will say that a map of $\scat{C}$ is an \emph{$F$-fibration} if it is a pullback of the map $F(f)$ for some fibration $f$.

\begin{prop}
Let $F$ be a functor between type-theoretic semi-fibration categories $\scat{B}$ and $\scat{C}$.
Suppose that $F$ preserves pullbacks along fibrations and that, for every $F$-fibration $g : A \to B$, pullbacks of $g$ exist and the pullback functor $g^* : \scat{C}/B \to \scat{C}/A$ has a right adjoint $\Pi_g$ which preserves fibrations.
Then $F^*(\scat{C}_!)$ has products.
\end{prop}
\begin{proof}
First, we need to describe the interpretation of the following rule:
\begin{center}
\AxiomC{$\Gamma, i : I \mid \Delta \vdash B \ob$}
\RightLabel{, $i \notin \mathrm{FV}(\Delta)$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \prod_{i : I} B \ob$}
\DisplayProof
\end{center}
Suppose that we have diagrams depicted below which correspond to types $\Gamma \vdash I$ and $\Gamma, i : I \mid \Delta \vdash B$.
\[ \xymatrix{                       & E_I \ar@{->>}[d]^{p_I} \\
              \Gamma \ar[r]_{r_I}   & V_I
            } \qquad
   \xymatrix{                               & E_B \ar@{->>}[d]^{p_B} \\
              \Gamma.I.\Delta \ar[r]_{r_B}  & V_B
            } \]
where $\Gamma.I.\Delta$ is the following pullback:
\[ \xymatrix{ \Gamma.I.\Delta \ar[r] \ar@{->>}[d] \pb   & \Delta \ar@{->>}[d]^{p_\Delta} \\
              F(\Gamma.I) \ar[r] \ar[d] \pb             & F(\Gamma) \ar[d]^{F(r_I)} \\
              F(E_I) \ar[r]_{F(p_I)}                    & F(V_I)
            } \]
We define $V_\Pi$ as $\Pi_{F(p_I)}(F(E_I) \times V_B)$.
Consider the following diagrams:
\[ \xymatrix{ V_\Pi \times_{F(V_I)} F(E_I) \ar[r] \ar[d]_p \pb  & F(E_I) \ar[d]^{F(p_I)} \\
              V_\Pi \ar[r]                                      & F(V_I)
            } \qquad
   \xymatrix{ Z \ar[r] \ar@{->>}[d]_q \pb                       & F(E_I) \times E_B \ar@{->>}[d]^{\id_{F(E_I)} \times p_B} \\
              V_\Pi \times_{F(V_I)} F(E_I) \ar[r]_-{\fs{ev}}    & F(E_I) \times V_B
            } \]
We define $p_\Pi : E_\Pi \to V_\Pi$ as $\Pi_p(Z)$.
To define a map $\Delta \to V_\Pi$, it is enough to specify a map $r_I' : \Delta \to F(V_I)$ together with a map $r_B' : \Delta.I \to V_B$, where $\Delta.I$ is the pullback of $r_I'$ and $F(p_I)$.
Let $r_I' = F(r_I) \circ p_\Delta$ and $r_B' = r_B$.
These maps determine a map $[r_I',r_B] : \Delta \to V_\Pi$.
We define the interpretation of $\prod_{i : I} B$ as the following diagram:
\[ \xymatrix{                               & E_\Pi \ar[d]^{p_\Pi} \\
              \Delta \ar[r]_{[r_I',r_B]}    & V_\Pi
            } \]

Now, let us decribe the interpretation of the following rule:
\begin{center}
\AxiomC{$\Gamma, i : I \mid \Delta \vdash b : B$}
\RightLabel{, $i \notin \mathrm{FV}(\Delta)$}
\UnaryInfC{$\Gamma \mid \Delta \vdash \lambda i.\,b : \prod_{i : I} B$}
\DisplayProof
\end{center}
The interpretation of $b$ is a section $b : \Gamma.I.\Delta \to E_B$ of $p_B$.
Note that we have the following diagram in which the composition of bottom maps equals to $r_I'$:
\[ \xymatrix{ \Gamma.I.\Delta \ar[r]^-s \ar[d] \pb  & V_\Pi \times_{F(V_I)} F(E_I) \ar[r] \ar[d]_p \pb  & F(E_I) \ar[d]^{F(p_I)} \\
              \Delta \ar[r]_{[r_I',r_B]}            & V_\Pi \ar[r]                                      & F(V_I)
            } \]
An interpretation of $\lambda i.\,b$ is a section of $\Delta \to E_\Pi$ of $p_\Pi$.
To define such a section, it is enough to specify a section $b' : \Gamma.I.\Delta \to Z$ of $q$ over $s$.
Since $q$ is a pullback of $p_B$, this is equivalent to specifying a section of $p_B$ and we can take this section to be $b$.

Finally, we need to define the interpretation of the application:
\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash f : \prod_{i : I} B$}
\AxiomC{$\Gamma \vdash j : I$}
\BinaryInfC{$\Gamma \mid \Delta \vdash f\,j : B[j/i]$}
\DisplayProof
\end{center}
Let $f : \Delta \to E_\Pi$ be a section of $p_\Pi$ and let $j : \Gamma \to E_I$ be a section of $p_I$.
We define the interpretation of $f\,j$ as $f' \circ j''$, where $f' : \Gamma.I.\Delta \to E_B$ is a section of $p_B$ corresponding to $f$ as discussed before and $j''$ is the following pullback:
\[ \xymatrix{ \Delta \ar[r]^-{j''} \ar@{->>}[d]_{p_\Delta} \pb  & \Gamma.I.\Delta \ar[r] \ar@{->>}[d] \pb   & \Delta \ar@{->>}[d]^{p_\Delta} \\
              F(\Gamma) \ar[r]_{F(j')}                          & F(\Gamma.I) \ar[r]                        & F(\Gamma)
            } \]
where $j' : \Gamma \to \Gamma.I$ is a section of $\Gamma.I \twoheadrightarrow \Gamma$ corresponding to $j$.

It is easy to verify the stability under substitutions of the constructions that we decsribed.
We also need to prove that $\beta$ and $\eta$ equivalences hold, but this follows from the fact that functions that we used to go from sections of $p_\Pi$ and $p_B$ and back are mutually inverse.
\end{proof}

\begin{example}
If $\scat{M}$ is a right proper type-theoretic semi-fibrations category and $\scat{J}$ is a small category, then $D^*((\scat{M}^\scat{J})_!)$ has products.
Since $D$ is a right adjoint, it preserves all limits.
Since $D$-fibrations are objectwise fibrations, the right adjoint to the pullback functor $g^*$ for a $D$-fibration $g$ exists by \cite[Theorem~2.12]{comp-fact-tor}.
The fact that this right adjoint preserves fibrations is equivalent to the fact that trivial cofibrations are stable under pullbacks along $D$-fibrations.
This follows from the facts that $\scat{M}$ is right proper and that $D$-fibrations and trivial cofibrations are objectwise fibrations and trivial cofibrations, respectively.
\end{example}

\subsection{Colimits}

In this subsection, we give sufficient conditions for a model $F^*(\scat{C})$ to have initial types, pushouts, and coproducts.

\begin{prop}
Let $\scat{B}$ be a contextually indexed category, let $\scat{C}$ be a category with fibrations, and let $F : \scat{B} \to \scat{C}$ be a functor between them.
If $\scat{C}$ has a strict fibrant initial object, then $F^*(\scat{C})$ has strict initial types.
\end{prop}
\begin{proof}
We define the initial type in any context as the fibration $0 \twoheadrightarrow 1$:
\[ \xymatrix{               & 0 \ar@{->>}[d] \\
              \Delta \ar[r] & 1
            } \]
By \cite[Proposition~7.4]{indexed-tt}, we just need to described the interpretation of the following rule:
\begin{center}
\AxiomC{$\Gamma \mid \Delta \vdash D \type$}
\AxiomC{$\Gamma \mid \Delta \vdash a : 0$}
\BinaryInfC{$\Gamma \mid \Delta \vdash 0\text{-}\fs{elim'}(D,a) : D$}
\DisplayProof
\end{center}

Let $a : \Delta \to 0$ be a map in $\scat{C}$ and let $r_D : \Delta \to V_D$, $p_D : E_D \twoheadrightarrow V_D$ be the interpretation of $D$.
Then we need to construct a section of $p_D$ over $r_D$.
Since $0$ is a strict initial object, $\Delta$ is also initial; so, there is a unique section $\Delta \to E_D$.
\end{proof}

\begin{example}
If $\scat{M}$ is a type-theoretic model category with a strict fibrant initial object and $\scat{J}$ is a small category, then $\scat{M}^\scat{J}$ also has a strict fibrant initial object.
\end{example}

\subsection{Factorization systems}

% TODO

\subsection{Universes}

% TODO

\subsection{Full subcategories}

% TODO

\bibliographystyle{amsplain}
\bibliography{ref}

\end{document}
