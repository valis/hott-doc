\documentclass[reqno]{amsart}

\usepackage{amssymb}
\usepackage{hyperref}
\usepackage{mathtools}
\usepackage[all]{xy}
\usepackage{verbatim}
\usepackage{ifthen}
\usepackage{xargs}
\usepackage{bussproofs}
\usepackage{turnstile}
\usepackage{etex}

\hypersetup{colorlinks=true,linkcolor=blue}

\renewcommand{\turnstile}[6][s]
    {\ifthenelse{\equal{#1}{d}}
        {\sbox{\first}{$\displaystyle{#4}$}
        \sbox{\second}{$\displaystyle{#5}$}}{}
    \ifthenelse{\equal{#1}{t}}
        {\sbox{\first}{$\textstyle{#4}$}
        \sbox{\second}{$\textstyle{#5}$}}{}
    \ifthenelse{\equal{#1}{s}}
        {\sbox{\first}{$\scriptstyle{#4}$}
        \sbox{\second}{$\scriptstyle{#5}$}}{}
    \ifthenelse{\equal{#1}{ss}}
        {\sbox{\first}{$\scriptscriptstyle{#4}$}
        \sbox{\second}{$\scriptscriptstyle{#5}$}}{}
    \setlength{\dashthickness}{0.111ex}
    \setlength{\ddashthickness}{0.35ex}
    \setlength{\leasturnstilewidth}{2em}
    \setlength{\extrawidth}{0.2em}
    \ifthenelse{%
      \equal{#3}{n}}{\setlength{\tinyverdistance}{0ex}}{}
    \ifthenelse{%
      \equal{#3}{s}}{\setlength{\tinyverdistance}{0.5\dashthickness}}{}
    \ifthenelse{%
      \equal{#3}{d}}{\setlength{\tinyverdistance}{0.5\ddashthickness}
        \addtolength{\tinyverdistance}{\dashthickness}}{}
    \ifthenelse{%
      \equal{#3}{t}}{\setlength{\tinyverdistance}{1.5\dashthickness}
        \addtolength{\tinyverdistance}{\ddashthickness}}{}
        \setlength{\verdistance}{0.4ex}
        \settoheight{\lengthvar}{\usebox{\first}}
        \setlength{\raisedown}{-\lengthvar}
        \addtolength{\raisedown}{-\tinyverdistance}
        \addtolength{\raisedown}{-\verdistance}
        \settodepth{\raiseup}{\usebox{\second}}
        \addtolength{\raiseup}{\tinyverdistance}
        \addtolength{\raiseup}{\verdistance}
        \setlength{\lift}{0.8ex}
        \settowidth{\firstwidth}{\usebox{\first}}
        \settowidth{\secondwidth}{\usebox{\second}}
        \ifthenelse{\lengthtest{\firstwidth = 0ex}
            \and
            \lengthtest{\secondwidth = 0ex}}
                {\setlength{\turnstilewidth}{\leasturnstilewidth}}
                {\setlength{\turnstilewidth}{2\extrawidth}
        \ifthenelse{\lengthtest{\firstwidth < \secondwidth}}
            {\addtolength{\turnstilewidth}{\secondwidth}}
            {\addtolength{\turnstilewidth}{\firstwidth}}}
        \ifthenelse{\lengthtest{\turnstilewidth < \leasturnstilewidth}}{\setlength{\turnstilewidth}{\leasturnstilewidth}}{}
    \setlength{\turnstileheight}{1.5ex}
    \sbox{\turnstilebox}
    {\raisebox{\lift}{\ensuremath{
        \makever{#2}{\dashthickness}{\turnstileheight}{\ddashthickness}
        \makehor{#3}{\dashthickness}{\turnstilewidth}{\ddashthickness}
        \hspace{-\turnstilewidth}
        \raisebox{\raisedown}
        {\makebox[\turnstilewidth]{\usebox{\first}}}
            \hspace{-\turnstilewidth}
            \raisebox{\raiseup}
            {\makebox[\turnstilewidth]{\usebox{\second}}}
        \makever{#6}{\dashthickness}{\turnstileheight}{\ddashthickness}}}}
        \mathrel{\usebox{\turnstilebox}}}

\newcommand{\axlabel}[1]{(#1) \phantomsection \label{ax:#1}}
\newcommand{\axtag}[1]{\label{ax:#1} \tag{#1}}
\newcommand{\axref}[1]{(\hyperref[ax:#1]{#1})}

\newcommand{\newref}[4][]{
\ifthenelse{\equal{#1}{}}{\newtheorem{h#2}[hthm]{#4}}{\newtheorem{h#2}{#4}[#1]}
\expandafter\newcommand\csname r#2\endcsname[1]{#3~\ref{#2:##1}}
\expandafter\newcommand\csname R#2\endcsname[1]{#4~\ref{#2:##1}}
\expandafter\newcommand\csname n#2\endcsname[1]{\ref{#2:##1}}
\newenvironmentx{#2}[2][1=,2=]{
\ifthenelse{\equal{##2}{}}{\begin{h#2}}{\begin{h#2}[##2]}
\ifthenelse{\equal{##1}{}}{}{\label{#2:##1}}
}{\end{h#2}}
}

\newref[section]{thm}{Theorem}{Theorem}
\newref{lem}{Lemma}{Lemma}
\newref{prop}{Proposition}{Proposition}
\newref{cor}{Corollary}{Corollary}
\newref{cond}{Condition}{Condition}

\theoremstyle{definition}
\newref{defn}{Definition}{Definition}
\newref{example}{Example}{Example}

\theoremstyle{remark}
\newref{remark}{Remark}{Remark}

\newcommand{\fs}[1]{\mathrm{#1}}
\newcommand{\Term}{\fs{Term}}
\newcommand{\FV}{\fs{FV}}
\newcommand{\subst}{\fs{subst}}
\newcommand{\Id}{\fs{Id}}
\newcommand{\refl}{\fs{refl}}
\newcommand{\El}{\fs{El}}
\newcommand{\emptyCtx}{\cdot}
\newcommand{\ft}{\fs{ft}}
\newcommand{\ty}{\fs{ty}}
\newcommand{\ctx}{\fs{ctx}}
\newcommand{\tm}{\fs{tm}}
\newcommand{\sub}{\fs{Sub}}
\newcommand{\id}{\fs{id}}

\newcommand{\cat}[1]{\mathbf{#1}}
\newcommand{\Th}{\cat{Th}}
\newcommand{\algtt}{\cat{TT}}

\numberwithin{figure}{section}

\newcommand{\pb}[1][dr]{\save*!/#1-1.2pc/#1:(-1,1)@^{|-}\restore}
\newcommand{\po}[1][dr]{\save*!/#1+1.2pc/#1:(1,-1)@^{|-}\restore}

\begin{document}

\title{Syntax of Algebraic Dependent Type Theories}

\author{Valery Isaev}

\begin{abstract}
TODO
\end{abstract}

\maketitle

\section{Introduction}

TODO

\section{Syntax}

In this section, we define a syntax for algebraic dependent type theories which is closer to the usual presentation.

\subsection{Preliminaries}

Let us recall definitions from \cite{PHL} and \cite{alg-tt}.
A many sorted first-order signature $(\mathcal{S},\mathcal{F},\mathcal{P})$ consists of a set $\mathcal{S}$ of sorts,
a set $\mathcal{F}$ of function symbols and a set $\mathcal{P}$ of predicate symbols.
Each function symbol $\sigma$ is equipped with a signature of the form $\sigma : s_1 \times \ldots \times s_k \to s$, where $s_1$, \ldots $s_k$, $s$ are sorts.
Each predicate symbol $R$ is equipped with a signature of the form $R : s_1 \times \ldots \times s_k$.
If $V$ is an $\mathcal{S}$-set, then the $\mathcal{S}$-set of terms of $T$ with free variables in $V$ will be denoted by $\Term^e_\mathcal{F}(V)$ or by $\Term^e_T(V)$.

An atomic formula is an expression either of the form $t_1 = t_2$ or of the form $R(t_1, \ldots t_n)$,
where $R$ is a predicate symbol and $t_1$, \ldots $t_n$ are terms.
We abbreviate $t = t$ to $t\!\downarrow$.
A Horn formula is an expression of the form $\varphi_1 \land \ldots \land \varphi_n$, where $\varphi_1$, \ldots $\varphi_n$ are atomic formulas.
The conjunction of the empty set of atomic formulas is denoted by $\top$.
A sequent is an expression of the form $\varphi \sststile{}{x_1, \ldots x_n} \psi$, where $x_1$, \ldots $x_n$ are variables
and $\varphi$ and $\psi$ are Horn formulas such that $\FV(\varphi) \cup \FV(\psi) \subseteq \{ x_1, \ldots x_n \}$.
We also write $\varphi \ssststile{}{V} \psi$ to denote the pair of sequents $\varphi \sststile{}{V} \psi$ and $\psi \sststile{}{V} \varphi$.
A \emph{partial Horn theory} consists of a signature and a set of Horn sequents in this signature.

The rules of \emph{partial Horn logic} are listed below.
A \emph{theorem} of a partial Horn theory $T$ is a sequent derivable from $T$ in this logic.
We will write $\varphi \sststile{T}{V} \psi$ to denote the fact that sequent $\varphi \sststile{}{V} \psi$ is derivable in $T$.

\begin{center}
\AxiomC{}
\RightLabel{\axlabel{nv}}
\UnaryInfC{$\varphi \sststile{}{V} x\!\downarrow$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} a = b$}
\RightLabel{\axlabel{ns}}
\UnaryInfC{$\varphi \sststile{}{V} b = a$}
\DisplayProof
\end{center}

\begin{center}
\AxiomC{}
\RightLabel{\axlabel{nh}}
\UnaryInfC{$\varphi_1 \land \ldots \land \varphi_n \sststile{}{V} \varphi_i$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} a = b$}
\AxiomC{$\varphi \sststile{}{V} \psi[a/x]$}
\RightLabel{\axlabel{nl}}
\BinaryInfC{$\varphi \sststile{}{V} \psi[b/x]$}
\DisplayProof
\end{center}

\begin{center}
\AxiomC{$\varphi \sststile{}{V} R(t_1, \ldots t_n)$}
\RightLabel{\axlabel{np}}
\UnaryInfC{$\varphi \sststile{}{V} t_i\!\downarrow$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} \sigma(t_1, \ldots t_n)\!\downarrow$}
\RightLabel{\axlabel{nf}}
\UnaryInfC{$\varphi \sststile{}{V} t_i\!\downarrow$}
\DisplayProof
\end{center}
where $R$ is a predicate symbol of the theory and $\sigma$ is its function symbol.
Note that this system derives only sequents in which the conclusion is atomic.
For this reason, we will consider only such sequents.

Finally, for every axiom $\psi_1 \land \ldots \land \psi_n \sststile{}{x_1 : s_1, \ldots x_k : s_k} \chi_1 \land \ldots \land \chi_m$
and for all terms $t_1 : s_1$, \ldots $t_k : s_k$, we have the following rules for all $1 \leq j \leq m$:
\smallskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} t_i\!\downarrow$, $1 \leq i \leq k$}
\AxiomC{$\varphi \sststile{}{V} \psi_i[t_1/x_1, \ldots t_k/x_k]$, $1 \leq i \leq n$}
\RightLabel{\axlabel{na}}
\BinaryInfC{$\varphi \sststile{}{V} \chi_j[t_1/x_1, \ldots t_k/x_k]$}
\DisplayProof
\end{center}

The \emph{theory of substitutions} is the theory with $\mathcal{S} = \{ \ctx, \tm \} \times \mathbb{N}$ as the set of sorts, function symbols given below, and axioms listed in \cite[Section~3.1]{alg-tt} (also, see the section~\ref{sec:contexts}).
\begin{align*}
\emptyCtx      & : (\ctx,0) \\
\ft_n          & : (\ty,n) \to (\ctx,n) \\
\ty_n          & : (\tm,n) \to (\ty,n) \\
v_{n,i}        & : (\ctx,n) \to (\tm,n) \text{, } 0 \leq i < n \\
\subst_{p,n,k} & : (\ctx,n) \times (p,k) \times (\tm,n)^k \to (p,n) \text{, } p \in \{ \tm, \ty \}
\end{align*}

We let $\ft^i_n : (\ctx,n+i) \to (\ctx,n)$ and $\ctx_{p,n} : (p,n) \to (\ctx,n)$ be the following derived operations:
\begin{align*}
\ft^0_n(A)      & = A \\
\ft^{i+1}_n(A)  & = \ft^i_n(\ft_{n+i}(A)) \\
\ctx_{\ty,n}(t) & = \ft_n(t) \\
\ctx_{\tm,n}(t) & = \ft_n(\ty_n(t)) \\
\ctx^i_{p,n}(t) & = \ft^i_n(\ctx_{p,n+i}(t))
\end{align*}
We write $(\ty,n)$ for $(\ctx,n+1)$.
We also define the following notations: $d_\ty = \ctx$, $d_\tm = \ty$, $e_\ty(a) = \ft(a)$, $e_\tm(a) = \ty(a)$,

Let $\mathcal{F}_0$ be a set of function symbols and let $\mathcal{P}_0$ be a set of predicate symbols.
We call elements of these sets basic function symbols and basic predicate symbols, respectively.
Then we define the full sets of function and predicate symbols:
\begin{align*}
\mathcal{F} = \{ & \sigma_m : (\ctx,m) \times (p_1,m+n_1) \times \ldots \times (p_k,m+n_k) \to (p,m+n) \mid \\
                 & m \in \mathbb{N}, \sigma \in \mathcal{F}_0, \sigma : (p_1,n_1) \times \ldots \times (p_k,n_k) \to (p,n) \} \\
\mathcal{P} = \{ & R_m : (\ctx,m) \times (p_1,m+n_1) \times \ldots \times (p_k,m+n_k) \mid \\
                 & m \in \mathbb{N}, R \in \mathcal{P}_0, R : (p_1,n_1) \times \ldots \times (p_k,n_k) \}
\end{align*}

An \emph{algebraic dependent type theory} is a theory of the form $(\mathcal{S}, \mathcal{F}_s \cup \mathcal{F}, \mathcal{P}, \mathcal{A}_s \cup \mathcal{A})$, where $\mathcal{S}$, $\mathcal{F}$, and $\mathcal{P}$ are defined above,
$\mathcal{F}_s$ is the set of function symbols of the theory of substitutions, $\mathcal{A}_s$ is the set of its axioms, and $\mathcal{A}$ is an arbitrary set of axioms such that the following sequents are derivable for every $\sigma_m \in \mathcal{F}$ and $R_m \in \mathcal{P}$
\begin{align*}
\sigma_m(\Gamma, x_1, \ldots x_k)\!\downarrow\ & \sststile{}{\Gamma, x_1, \ldots x_k} \ctx^n_{p,m}(\sigma_m(\Gamma, x_1, \ldots x_k)) = \Gamma \\
\sigma_m(\Gamma, x_1, \ldots x_k)\!\downarrow\ & \sststile{}{\Gamma, x_1, \ldots x_k} \bigwedge_{1 \leq i \leq k} \ctx^{n_i}_{p_i,m}(x_i) = \Gamma \\
R_m(\Gamma, x_1, \ldots x_k) & \sststile{}{\Gamma, x_1, \ldots x_k} \bigwedge_{1 \leq i \leq k} \ctx^{n_i}_{p_i,m}(x_i) = \Gamma
\end{align*}
and $\subst$ commutes with every function symbol (for a precise definition, see \cite[Definition~4.5]{alg-tt}).

Let $T$ be an algebraic dependent type theory.
We define $P_M$ as the set of pairs $V,\varphi$ such that $V = \{ x_1, \ldots x_k \}$ and $\varphi = \varphi_1 \land \ldots \land \varphi_k$, where $\varphi_i$ equals to $e_p(x_i) = t_i$,
where $t_i$ is a term of $T$ with free variables in $\{ x_1, \ldots x_{i-1} \}$ such that for every $1 \leq i \leq k$,
sequent $\varphi_1 \land \ldots \land \varphi_{i-1} \sststile{}{x_1, \ldots x_{i-1}} t_i\!\downarrow$ is derivable in $T$.
We will be mostly interested in theorems of the form $\varphi \sststile{}{V} \psi$ where $(\varphi,V) \in P_M$ for reasons explained in \cite{morita-equiv}.

\begin{defn}
We will say that a partial Horn theory has \emph{separated axioms} if the set of axioms of this theory consists of three disjoint subsets $\mathcal{A}_d$, $\mathcal{A}'_d$, and $\mathcal{A}_e$ such that the following conditions hold:
\begin{enumerate}
\item The set $\mathcal{A}_d$ consists of axioms of the form $\varphi \sststile{}{x_1, \ldots x_k} \sigma(x_1, \ldots x_k)\!\downarrow$ and $\varphi \sststile{}{x_1, \ldots x_k} R(x_1, \ldots x_k)$ and, for every function symbol $\sigma$ and every predicate symbol $R$, there is exactly one axiom of this form.
We will denote the left hand side of these axioms by $\varphi_\sigma$ and $\varphi_R$.
\item The set $\mathcal{A}'_d$ consists of (not necessary all) sequents of the form $\sigma(x_1, \ldots x_k)\!\downarrow\ \sststile{}{x_1, \ldots x_k} \varphi_\sigma$ and $R(x_1, \ldots x_k) \sststile{}{x_1, \ldots x_k} \varphi_R$.
\item For every axiom $\varphi \sststile{}{V} \psi$ in $\mathcal{A}_e$ and every subterm $\sigma(t_1, \ldots t_k)$ of $\psi$,
the sequent $\varphi \sststile{}{V} \varphi_\sigma[t_1/x_1, \ldots t_k/x_k]$ is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$.
Also, for every subformula $R(t_1, \ldots t_k)$ of $\psi$, the sequent $\varphi \sststile{}{V} \varphi_R[t_1/x_1, \ldots t_k/x_k]$ is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$.
\end{enumerate}
We will say that a theory with separated axioms is \emph{minimal} (resp., \emph{maximal}) if $\mathcal{A}'_d$ is empty (resp., consists of all sequents of the specified form).
\end{defn}

\begin{remark}
Theories with separated axioms were defined in \cite[Section~5.1]{morita-equiv}.
There we do not allow axioms of the form $\varphi \sststile{}{x_1, \ldots x_k} R(x_1, \ldots x_k)$ in $\mathcal{A}_d$, but the main property of such theories (\rprop{sep-main}) still holds for this generalization.
\end{remark}

\begin{remark}
Every theory is isomorphic to a theory with a separated axioms.
We can take $\mathcal{A}_d$ to be the set of axioms of the form
\[ \sigma(x_1, \ldots x_k)\!\downarrow\ \sststile{}{x_1, \ldots x_k} \sigma(x_1, \ldots x_k)\!\downarrow \]
and $\mathcal{A}_e$ to be the set of axioms of the original theory (if some axiom $\varphi \sststile{}{V} \psi$ clashes with an axiom in $\mathcal{A}_d$, we can replace it with $\varphi \sststile{}{V} \psi \land \psi$).
\end{remark}

The main property of theories with separated axioms is that axioms in $\mathcal{A}_d'$ are redundant in a certain sense:

\begin{prop}[sep-main]
Let $T$ be an algebraic dependent type theory with separated axioms and let $(\varphi,V)$ be a pair in $P_M$.
Then a sequent $\varphi \sststile{}{V} \psi$ is derivable in $T$ if and only if it is derivable from $\mathcal{A}_d \cup \mathcal{A}_e$.
\end{prop}
\begin{proof}
It is easy to see that the proof of \cite[Proposition~5.3]{morita-equiv} holds for the generalized definition of theories with separated axioms.
\end{proof}

\subsection{The $\ft$-free syntax}
\label{sec:contexts}

The syntax we described in the previous subection is too verbose.
We can make it closer to the usual presentation of type theories by removing some redundant information.
We define another $\mathcal{S}$-set of terms $\Term_\mathcal{F}(V)$ inductively as follows:
\begin{itemize}
\item Every element of $V_s$ is a term of sort $s$.
\item If $t$ is a term of sort $(\tm,n)$, then $\ty(t)$ is a term of sort $(\ty,n)$.
\item $v_i$ is a term of sort $(\tm,n)$ for every $0 \leq i < n$.
\item If $A_1$, \ldots $A_k$ are terms of sorts $(\ty,0)$, \ldots $(\ty,k-1)$, respectively, $t$ is a term of sort $(p,k)$, where $p \in \{ \ty, \tm \}$, and $t_1, \ldots t_k$ are terms of sort $(\tm,n)$, then $\subst(A_1, \ldots A_k, t, t_1, \ldots t_k)$ is a term of sort $(p,n)$.
\item If $\sigma : (p_1,n_1) \times \ldots \times (p_k,n_k) \to (p,n)$ is a function symbol of $T$ and $t_i$ is a term of sort $(p_i,m+n_i)$, then $\sigma(t_1, \ldots t_k)$ is a term of sort $(p,m+n)$.
\end{itemize}
These terms will be called \emph{$\ft$-free} terms.
They define a syntax, called the \emph{$\ft$-free syntax}, which has metavariables (elements of $V$), de Bruijn indices ($v_i$), explicit substitutions ($\subst$), and constructions depending on the theory (basic function symbols).
We also have an explicit typing operation ($\ty$).
We will see in section~\ref{sec:types} that it is possible to get rid of it too, but this makes the theory more awkward to work with.

A \emph{context} of length $n$ a sequence of terms of sorts $(\ty,0)$, \ldots $(\ty,n-1)$.
An ($\ft$-free) \emph{judgement} is an expression of one of the following forms:
\[ \Gamma \vdash t \qquad \Gamma \vdash t \equiv t' \qquad \Gamma \vdash R(t_1, \ldots t_k) \]
where $\Gamma$ is a context of length $m$, $t$ and $t'$ are terms of sort $(p,m)$ (where $p \in \{ \ty, \tm \}$), $R : (p_1,n_1) \times \ldots \times (p_k,n_k)$ is a predicate symbol, and $t_1$, \ldots $t_k$ are terms of sorts $(p_1,m+n_1)$, \ldots $(p_k,m+n_k)$, respectively.
All terms above are written in the $\ft$-free syntax.
We will use judgements of the form $\Gamma \vdash$.
If $\Gamma$ is the empty context, this judgement denotes $\top$.
If $\Gamma = (\Gamma', A)$, this judgement denotes $\Gamma' \vdash A$.

Jusgements play the role of atomic formulas in the $\ft$-free syntax.
An ($\ft$-free) \emph{formula} is a finite conjunction of judgements.
Sequents are defined as before.
We will often write sequents in the form of derivation rules.
Thus, $\varphi_1 \land \ldots \land \varphi_n \sststile{}{V} \psi$ can be written as
\begin{center}
\AxiomC{$\varphi_1$}
\AxiomC{\ldots}
\AxiomC{$\varphi_n$}
\TrinaryInfC{$\psi$}
\DisplayProof
\end{center}
The set of variables $V$ is implicit in this notation and we let it to be the union of all variables that appear in the premise and in the conclusion.
Also, $\varphi_1 \land \ldots \land \varphi_n \ssststile{}{V} \psi$ will be represented by the following rule:
\begin{center}
\AxiomC{$\varphi_1$}
\AxiomC{\ldots}
\AxiomC{$\varphi_n$}
\doubleLine
\TrinaryInfC{$\psi$}
\DisplayProof
\end{center}

Let $\Gamma$ be a context of length $n$ and let $\Delta_1 = (A_1, \ldots A_k)$, $\Delta_2 = (B_1, \ldots B_k)$ be a pair of sequences of terms of sorts $(\ty,n)$, \ldots $(\ty,n+k)$.
Then we define $\Gamma \vdash \Delta_1 \equiv \Delta_2$ as $\Gamma \vdash A_1 \equiv B_1 \land \ldots \land \Gamma, A_1, \ldots A_{k-1} \vdash A_k \equiv B_k$.
If $\Gamma$ and $\Delta$ are two contexts of the same length, we define $\Gamma \equiv \Delta$ as $\vdash \Gamma \equiv \Delta$.

An ($\ft$-free) \emph{theory} $(\mathcal{F},\mathcal{P},\mathcal{A})$ consits of a set of function symbols $\mathcal{F}$ such that every function symbol has a signature of the form $s_1 \times \ldots \times s_k \to (p,0)$, a set of predicate symbols $\mathcal{P}$, and a set of axioms $\mathcal{A}$.
These sets must satisfy conditions listed in \rdefn{ft-free}.
Each symbol $S$ with $k$ parameters of sorts $(p_1,n_1)$, \ldots $(p_k,n_k)$ is equipped with a collection $\{ \Gamma^S_i(x_1, \ldots x_{i-1}) \}_{1 \leq i \leq k}$ of contexts,
where $\Gamma^S_i(x_1, \ldots x_{i-1})$ is a context of length $n_i$ with free variables in $\{ x_1 : (p_1,n_1), \ldots x_{i-1} : (p_{i-1},n_{i-1}) \}$.
We will write $\Gamma^S_i$ for $\Gamma^S_i(x_1, \ldots x_k)$.
We will also write $\Gamma^S_i(t_1, \ldots t_k)$ for $\Gamma^S_i[t_1/x_1, \ldots t_k/x_k]$.

A \emph{contexted term} is a pair $(\Gamma,t)$, where $\Gamma$ is a context of length $n$ and $t$ is a term of sort $(p,n)$ for some $p \in \{ \ty, \tm \}$.
For every contexted term $(\Gamma,t)$, we can define the set $\sub(\Gamma,t)$ of its contxeted subterms:
\begin{align*}
\sub(\Gamma,t) = & \{ (\Gamma,t) \} \text{ if $t$ is a variable or $v_i$} \\
\sub(\Gamma,\ty(t')) = & \{ (\Gamma,t) \} \cup \sub(\Gamma,t') \\
\sub(\Gamma,\subst(A_1, \ldots A_k, t', t_1, \ldots t_k)) = & \{ (\Gamma,t) \} \cup \sub((A_1, \ldots A_k), t')\ \cup \\
    & \bigcup_{1 \leq i \leq k} \sub(\Gamma,t_i) \cup \sub((A_1, \ldots A_{i-1}), A_i) \\
\sub(\Gamma,\sigma(t_1, \ldots t_k)) = & \{ (\Gamma,t) \} \cup \bigcup_{1 \leq i \leq k} \sub((\Gamma,\Gamma^\sigma_i(t_1, \ldots t_{i-1})), t_i)
\end{align*}
In each of the cases, $(\Gamma,t)$ is the contexted term itself.
So, every contexted term is always a contexted subterm of itself.
Note that the definition of $\sub$ depends on the choice of contexts $\Gamma^\sigma_i$.

\begin{remark}[ctx-begin]
The context of every contexted subterm of $(\Gamma,t)$ begins with $\Gamma$.
\end{remark}

We can also define the set of contexted subterms of contexts and formulas:
\begin{align*}
\sub(\cdot) & = \varnothing \\
\sub((\Gamma, A)) & = \sub(\Gamma) \cup \sub(\Gamma,A) \\
\sub(\Gamma \vdash t) & = \sub(\Gamma) \cup \sub(\Gamma, t) \\
\sub(\Gamma \vdash t \equiv t') & = \sub(\Gamma) \cup \sub(\Gamma,t) \cup \sub(\Gamma,t') \\
\sub(\Gamma, R(t_1, \ldots t_k)) & = \sub(\Gamma) \cup \bigcup_{1 \leq i \leq k} \sub((\Gamma,\Gamma^R_i(t_1, \ldots t_{i-1})),t_i) \\
\sub(\varphi_1 \land \ldots \land \varphi_n) & = \bigcup_{1 \leq i \leq n} \sub(\varphi_i)
\end{align*}

Now, we can describe the derivation system for the $\ft$-free syntax:
\medskip
\begin{center}
\AxiomC{}
\RightLabel{\axlabel{ch}}
\UnaryInfC{$\varphi_1 \land \ldots \land \varphi_n \sststile{}{V} \varphi_i$}
\DisplayProof
\qquad
\AxiomC{}
\RightLabel{, $(\Gamma,t) \in \sub(\varphi)$ \axlabel{cd}}
\UnaryInfC{$\varphi \sststile{}{V} \Gamma \vdash t$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma, A, \Delta \vdash \psi$}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash A \equiv B$}
\RightLabel{\axlabel{cx}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma, B, \Delta \vdash \psi$}
\DisplayProof
\end{center}
where $\psi$ is either a term, an equality, or a predicate symbol applied to some terms.

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash t$}
\RightLabel{\axlabel{cr}}
\UnaryInfC{$\varphi \sststile{}{V} \Gamma \vdash t \equiv t$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash a \equiv b$}
\RightLabel{\axlabel{cs}}
\UnaryInfC{$\varphi \sststile{}{V} \Gamma \vdash b \equiv a$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash a \equiv b$}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash b \equiv c$}
\RightLabel{\axlabel{ct}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma \vdash a \equiv c$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash R(t_1, \ldots t_k)$}
\AxiomC{$\varphi \sststile{}{V} \Gamma, \Gamma^R_i(t_1, \ldots t_{i-1}) \vdash t_i \equiv t_i'$}
\RightLabel{\axlabel{cp}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma \vdash R(t_1, \ldots t_{i-1}, t_i', t_{i+1}, \ldots t_k)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash \sigma(t_1, \ldots t_k)$}
\AxiomC{$\varphi \sststile{}{V} \Gamma, \Gamma^\sigma_i(t_1, \ldots t_{i-1}) \vdash t_i \equiv t_i'$}
\RightLabel{\axlabel{cf}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \sigma(t_1, \ldots t_k) \equiv \sigma (t_1, \ldots t_{i-1}, t_i', t_{i+1}, \ldots t_k)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash \sigma(t_1, \ldots t_k)$}
\AxiomC{$\varphi \sststile{}{V} \Gamma, \Gamma^\sigma_i(t_1, \ldots t_{i-1}) \vdash t_i \equiv t_i'$}
\RightLabel{\axlabel{cf'}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \sigma (t_1, \ldots t_{i-1}, t_i', t_{i+1}, \ldots t_k)$}
\DisplayProof
\end{center}
where $\sigma$ is either a function symbol, $\ty$, or $\subst$.
We define $\Gamma^\ty_1$ as the empty context and $\Gamma^\subst_i(x_1, \ldots x_{2k+1})$ as $x_1, \ldots x_{i-1}$ if $i \leq k+1$ and as the empty context otherwise.

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \psi_i[t_1/x_1, \ldots t_k/x_k]$, $1 \leq i \leq n$}
\RightLabel{\axlabel{ca}}
\UnaryInfC{$\varphi \sststile{}{V} \chi_j[t_1/x_1, \ldots t_k/x_k]$}
\DisplayProof
\end{center}
where $\psi_1 \land \ldots \land \psi_n \sststile{}{x_1 : s_1, \ldots x_k : s_k} \chi_1 \land \ldots \land \chi_m$ is an axiom and $t_1$, \ldots $t_k$ are arbitrary terms.

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash t$}
\RightLabel{\axlabel{et}}
\UnaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \ty(t)$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash$}
\RightLabel{\axlabel{ev}}
\UnaryInfC{$\varphi \sststile{}{V} \Gamma \vdash v_i$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} A_1, \ldots A_m \vdash$}
\RightLabel{\axlabel{evt}}
\UnaryInfC{$\varphi \sststile{}{V} A_1, \ldots A_m \vdash \ty(v_i) \equiv \subst(A_1, \ldots A_{m-i}, v_{m-1}, \ldots v_{i+1})$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \varphi \sststile{}{V} \Gamma \vdash$
\noLine
\UnaryInf$\fCenter \varphi \sststile{}{V} \Gamma \vdash a_i$
\Axiom$\fCenter \varphi \sststile{}{V} A_1, \ldots A_k \vdash b$
\noLine
\UnaryInf$\fCenter \varphi \sststile{}{V} \Gamma \vdash \ty(a_i) \equiv \subst(A_1, \ldots A_i, a_1, \ldots a_{i-1})$
\def\extraVskip{2pt}
\RightLabel{\axlabel{es}}
\doubleLine
\BinaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \subst(A_1, \ldots A_k, b, a_1, \ldots a_k)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \varphi \sststile{}{V} \Gamma \vdash$
\noLine
\UnaryInf$\fCenter \varphi \sststile{}{V} A_1, \ldots A_k \vdash b$
\Axiom$\fCenter \varphi \sststile{}{V} \Gamma \vdash a_i$
\noLine
\UnaryInf$\fCenter \varphi \sststile{}{V} \Gamma \vdash \ty(a_i) \equiv \subst(A_1, \ldots A_i, a_1, \ldots a_{i-1})$
\def\extraVskip{2pt}
\RightLabel{\axlabel{est}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \ty(\subst(\overline{A}, b, a_1, \ldots a_k)) \equiv \subst(\overline{A}, \ty(b), a_1, \ldots a_k)$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash a_i$}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash \ty(a_i) \equiv \subst(A_1, \ldots A_i, a_1, \ldots a_{i-1})$}
\RightLabel{\axlabel{esl}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \subst(A_1, \ldots A_k, v_i, a_1, \ldots a_k) \equiv a_{k-i}$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash b$}
\RightLabel{\axlabel{esr}}
\UnaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \subst(\Gamma, b, v_{k-1}, \ldots v_0) \equiv b$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\def\extraVskip{1pt}
\Axiom$\fCenter \varphi \sststile{}{V} A_1, \ldots A_k \vdash c$
\noLine
\UnaryInf$\fCenter \varphi \sststile{}{V} B_1, \ldots B_n \vdash \ty(a_i) \equiv \subst(A_1, \ldots A_i, a_1, \ldots a_{i-1})$
\noLine
\UnaryInf$\fCenter \varphi \sststile{}{V} \Gamma \vdash \ty(b_i) \equiv \subst(B_1, \ldots B_i, b_1, \ldots b_{i-1})$
\Axiom$\fCenter \varphi \sststile{}{V} \Gamma \vdash$
\noLine
\UnaryInf$\fCenter \varphi \sststile{}{V} \overline{B} \vdash a_i$
\noLine
\UnaryInf$\fCenter \varphi \sststile{}{V} \Gamma \vdash b_i$
\def\extraVskip{2pt}
\RightLabel{\axlabel{esa}}
\BinaryInf$\fCenter \varphi \sststile{}{V} \Gamma \vdash \subst(\overline{B}, \subst(\overline{A}, c, \overline{a}), \overline{b}) \equiv \subst(\overline{A}, c, a_1' \ldots a_k')$
\DisplayProof
\end{center}
where $a_i' = \subst(B_1, \ldots B_n, a_i, b_1, \ldots b_n)$.
If $\psi = \psi_1 \land \ldots \land \psi_n$, then we will say that $\psi \sststile{}{V} \psi$ is derivable if $\psi \sststile{}{V} \psi_i$ is derivable for every $1 \leq i \leq n$.

We will say that a term or a formula $E$ is \emph{valid} with respect to $(\varphi,V)$ if, for every pair $(\Gamma,x)$ and $(\Delta,x)$ of contexted subterms of $E$ (where $x$ is any variable), the sequent $\varphi \sststile{}{V} \Gamma \equiv \Delta$ is derivable.
A sequent $\varphi \sststile{}{V} \psi$ is \emph{valid} if $\varphi$ and $\psi$ are valid with respect to $(\varphi,V)$.

\begin{defn}[ft-free]
An $\ft$-free \emph{theory} $(\mathcal{F},\mathcal{P},\mathcal{A})$ consits of a set of function symbols $\mathcal{F}$, a set of predicate symbols $\mathcal{P}$, and a set of axioms $\mathcal{A}$
together with a context $\Gamma^S_i(x_1, \ldots x_k)$ for every symbol $S$ with $n$ parameters and every $1 \leq i \leq n$ such that the following conditions hold:
\begin{enumerate}
\item \label{it:ax-consist} For every symbol $S$ with $n$ parameters, all $1 \leq i < j \leq n$, and every $(\Delta,x_i) \in \sub(\Gamma_j^S(x_1, \ldots x_{j-1}))$, the following sequent is derivable:
\[ \Gamma \vdash S(x_1, \ldots x_k) \sststile{}{\Gamma, x_1, \ldots x_k} \Gamma \vdash \Gamma_i^S(x_1, \ldots x_{i-1}) \equiv \Delta \]
\item \label{it:ax-wf} The following relation on the set of function symbols is well-founded: $\tau \prec \sigma$ if and only if $\tau$ appears in $\Gamma^\sigma_i$ for some $i$.
\item \label{it:ax-valid} All axioms are valid and the set of free variables of the conclusion of every axiom is contained in the set of free variables of its premise.
\item \label{it:ax-cond} For every axiom $\varphi \sststile{}{V} \psi$ and every contexted subterm $(\Gamma,t)$ of $\psi$, the sequent $\varphi \sststile{}{V} \Gamma \vdash t$ is derivable.
\end{enumerate}
A \emph{theorem} is a valid derivable sequent.
\end{defn}

We do not usually explicitly specify context $\Gamma^S_i$.
Instead, we assume that every symbol $S$ has a unique axiom of the form
\[ \varphi \sststile{}{x_1, \ldots x_k}\ \vdash S(x_1, \ldots x_k) \]
such that there is a unique contexted subterm of $\varphi$ of the form $(\Gamma,x_i)$ for every $i$.
Then we let $\Gamma^S_i$ to be equal to $\Gamma$.

\begin{example}
The theory of $\Pi$-types is defined as follows:
\begin{center}
\AxiomC{$\Gamma, A \vdash B$}
\UnaryInfC{$\Gamma \vdash \Pi(A,B)$}
\DisplayProof
\qquad
\AxiomC{$\Gamma, A \vdash b$}
\UnaryInfC{$\Gamma \vdash \lambda(A,b)$}
\DisplayProof
\qquad
\AxiomC{$\Gamma, A \vdash b$}
\UnaryInfC{$\Gamma \vdash \ty(\lambda(A,b)) \equiv \Pi(A,\ty(b))$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma, A \vdash B$}
\AxiomC{$\Gamma \vdash \ty(f) \equiv \Pi(A,B)$}
\AxiomC{$\Gamma \vdash \ty(a) \equiv A$}
\doubleLine
\TrinaryInfC{$\Gamma \vdash \fs{app}(A,B,f,a)$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma, A \vdash B$}
\AxiomC{$\Gamma \vdash \ty(f) \equiv \Pi(A,B)$}
\AxiomC{$\Gamma \vdash \ty(a) \equiv A$}
\TrinaryInfC{$\Gamma \vdash \ty(\fs{app}(A, B,f,a)) \equiv \subst(\Gamma, A, B, v_{n-1}, \ldots v_0, a)$}
\DisplayProof
\end{center}
\medskip

\begin{center}
\AxiomC{$\Gamma, \ty(a) \vdash b$}
\AxiomC{$\Gamma \vdash a$}
\BinaryInfC{$\Gamma \vdash \fs{app}(\ty(a), \ty(b),\lambda(\ty(a),b),a) \equiv \subst(\Gamma, \ty(a), b, v_{n-1}, \ldots v_0, a)$}
\DisplayProof
\end{center}
\medskip
\end{example}

% A well-founded relation $\prec$ on function symbols can be extended to a well-founded relation $\prec$ on the set of terms (called \emph{recursive path ordering} \cite{mrpo}) such that $t[t_1/x_1, \ldots t_k/x_k] \prec \sigma(t_1, \ldots t_k)$ if $\tau \prec \sigma$ for every function symbol $\tau$ in $t$.
% We always have a recursive path ordering on terms by \eqref{it:ax-wf}.

\begin{lem}[derived-cong-lem]
Let $t$ and $t'$ be terms, let $\Gamma$ be a context of length $n$, and let $A$ be a term of sort $(p,n)$.
Suppose that $\varphi \sststile{}{V} \Delta[t/x] \vdash t \equiv t'$ is derivable for every $\Delta$ such that $(\Delta,x) \in \sub(\Gamma,A)$.
If the sequent $\varphi \sststile{}{V} \Delta \vdash s$ is derivable for every $(\Delta,s) \in \sub(\Gamma,A[t/x])$, then so is the sequent $\varphi \sststile{}{V} \Gamma \vdash A[t/x] \equiv A[t'/x]$.
\end{lem}
\begin{proof}
The proof is by induction on $A$.
If $A = x$, it is obvious.
If $A = \sigma(t_1, \ldots t_k)$, let
\[ T_i = \sigma(t_1[t/x], \ldots t_{i-1}[t/x], t_i[t'/x], \ldots t_k[t'/x]). \]
Since $T_{k+1} = A[t/x]$ and $T_1 = A[t'/x]$, it is enough to show that, for every $1 \leq i \leq k$, sequents $\varphi \sststile{}{V} \Gamma \vdash T_{i+1} \equiv T_i$ and $\varphi \sststile{}{V} \Gamma \vdash T_i$ are derivable whenever $\varphi \sststile{}{V} \Gamma \vdash T_{i+1}$ is.
By \axref{cf} and \axref{cf'}, it is enough to show that $\varphi \sststile{}{V} \Gamma, \Gamma^\sigma_i(t_1[t/x], \ldots t_{i-1}[t/x]) \vdash t_i[t/x] \equiv t_i[t'/x]$ is derivable, which follows by induction hypothesis.
To apply it, we need to check that the condition of the lemma holds.
Let $(\Delta,x)$ be a contexted subterm of $((\Gamma, \Gamma^\sigma_i(t_1[t/x], \ldots t_{i-1}[t/x])), t_i)$.
Then there exists $\Delta'$ such that $\Delta[t/x] = \Delta'[t/x]$ and $(\Delta',x) \in \sub(\Gamma, \sigma(t_1, \ldots t_k))$, which implies that $\varphi \sststile{}{V} \Delta[t/x] \vdash t \equiv t'$ is derivable.
\end{proof}

\begin{lem}[derived-cong-ctx]
Let $t$ and $t'$ be terms, let $\Gamma$ be a context of length $n$, and let $\Theta$ be a sequence of terms of sorts $(\ty,n)$, \ldots $(\ty,n+m)$.
Suppose that $\varphi \sststile{}{V} \Delta[t/x] \vdash t \equiv t'$ is derivable for every $\Delta$ such that $(\Delta,x) \in \sub(\Gamma,\Theta)$.
If the sequent $\varphi \sststile{}{V} \Delta \vdash s$ is derivable for every $(\Delta,s) \in \sub(\Gamma,\Theta[t/x])$, then so is the sequent $\varphi \sststile{}{V} \Gamma \vdash \Theta[t/x] \equiv \Theta[t'/x]$.
\end{lem}
\begin{proof}
This follows from \rlem{derived-cong-lem} by induction on the length of $\Theta$.
\end{proof}

A rule is \emph{admissible} if its conclusion is derivable whenever its premises are.

\begin{lem}
The following rules are admissible:
\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma, \Delta \vdash \psi$}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash \Delta \equiv \Delta'$}
\RightLabel{\axlabel{cx'}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma, \Delta' \vdash \psi$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash \Delta \equiv \Delta'$}
\RightLabel{\axlabel{cs'}}
\UnaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \Delta' \equiv \Delta$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash \Delta \equiv \Delta'$}
\AxiomC{$\varphi \sststile{}{V} \Gamma \vdash \Delta' \equiv \Delta''$}
\RightLabel{\axlabel{ct'}}
\BinaryInfC{$\varphi \sststile{}{V} \Gamma \vdash \Delta \equiv \Delta''$}
\DisplayProof
\end{center}
\end{lem}
\begin{proof}
The proof is by easy induction on the length of $\Delta$.
\end{proof}

\begin{prop}
The following rules are admissible:
\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \psi$}
\RightLabel{$\mathrm{\axlabel{cu}}$}
\UnaryInfC{$\varphi[\rho] \sststile{}{V'} \psi[\rho]$}
\DisplayProof
\qquad
\AxiomC{$\varphi \sststile{}{V} \psi$}
\AxiomC{$\psi \sststile{}{V} \chi$}
\RightLabel{$\mathrm{\axlabel{cc}}$}
\BinaryInfC{$\varphi \sststile{}{V} \chi$}
\DisplayProof
\end{center}

\medskip
\begin{center}
\AxiomC{$\varphi \sststile{}{V} \psi$}
\RightLabel{, $(\Gamma,t) \in \sub(\psi)\ \mathrm{\axlabel{ce}}$}
\UnaryInfC{$\varphi \sststile{}{V} \Gamma \vdash t$}
\DisplayProof
\end{center}
\end{prop}
\begin{proof}
The rule \axref{cu} is proved by a straightforward induction on the derivation of $\varphi \sststile{}{V} \psi$.
It is harder to prove the admissibility of the other two rules because they depend on each other.
To solve this problem, we show that \axref{cc} holds only for certain sequents first.

We will say that a sequent $\varphi \sststile{}{V} \psi$ is \emph{good} if $\varphi \sststile{}{V} \Gamma \vdash t$ is derivable for every $(\Gamma,t) \in \sub(\psi)$.
Now, we can prove that $\varphi \sststile{}{V} \chi$ is derivable whenever $\varphi \sststile{}{V} \psi$ is good and derivable and $\psi \sststile{}{V} \chi$ is derivable by induction on the derivation of the latter sequent.
Most of the cases are obvious.
The rule \axref{cd} follows from the assumption that $\varphi \sststile{}{V} \psi$ is good and the rule \axref{ch} follows from the assumption that $\varphi \sststile{}{V} \psi$ is derivable.

Now, we can prove that every derivable sequent is good, which implies both \axref{cc} and \axref{ce}.
We proceed by induction on the derivation.
Most of the cases are trivial since the set of contexted subterms of the conclusion is a subset of the set of contexted subterms of the premise.
We consider only non-trivial cases.
First, let us consider \axref{ca}.
Let $\psi \sststile{}{V'} \chi$ be an axiom, let $\rho$ be a substitution, and let $(\Gamma,t)$ be a contexted subterm of $\chi[\rho]$.
Suppose that $\varphi \sststile{}{V} \psi[\rho]$ is derivable and good.
We need to show that $\varphi \sststile{}{V} \Gamma \vdash t$ is derivable.
It is easy to see that there exists a contexted subterm $(\Gamma',t')$ of $\chi$ such that $(\Gamma,t) = (\Gamma'[\rho],t'[\rho])$.
By \eqref{it:ax-cond}, the sequent $\psi \sststile{}{V'} \Gamma' \vdash t'$ is derivable.
By \axref{cu}, the sequent $\psi[\rho] \sststile{}{V} \Gamma \vdash t$ is also derivable.
Since $\varphi \sststile{}{V} \psi[\rho]$ is derivable and good, this implies that $\varphi \sststile{}{V} \Gamma \vdash t$ is derivable.

Now, we consider \axref{cp}, \axref{cf}, and \axref{cf'}.
Assume that $\varphi \sststile{}{V} \Gamma \vdash S(t_1, \ldots t_k)$ is derivable and good and that $\varphi \sststile{}{V} \Gamma, \Gamma_i^S(t_1, \ldots t_{i-1}) \vdash t_i \equiv t_i'$ is derivable.
We need to show that $\varphi \sststile{}{V} \Gamma, \Gamma_j^S(t_1, \ldots t_i', \ldots t_{j-1}) \vdash t_j$ is derivable.
By \axref{cx'}, we just need to show that $\varphi \sststile{}{V} \Gamma \vdash \Gamma_j^S(t_1, \ldots t_{j-1}) \equiv \Gamma_j^S(t_1, \ldots t_i', \ldots t_{j-1})$ is derivable.
This follows from \rlem{derived-cong-ctx}.
Since $\Gamma, \Gamma_j^S(t_1, \ldots t_{j-1})$ is a contexted subterm of $(\Gamma, S(t_1, \ldots t_k))$, one of the conidtions of \rlem{derived-cong-ctx} follows from the fact that $\varphi \sststile{}{V} \Gamma \vdash S(t_1, \ldots t_k)$ is good.
We also need to to show that $\varphi \sststile{}{V} \Gamma, \Delta[t_i/x_i] \vdash t_i \equiv t_i'$ is derivable for every $(\Delta,x_i) \in \sub(\Gamma_j^S(t_1, \ldots x_i, \ldots t_{j-1}))$.
By \axref{cx'}, we just need to show that $\varphi \sststile{}{V} \Gamma \vdash \Gamma_i^S(t_1, \ldots t_{i-1}) \equiv \Delta[t_i/x_i]$ is derivable.
Since $\varphi \sststile{}{V} \Gamma \vdash S(t_1, \ldots t_k)$ is derivable and good, this follows from \axref{cc} and \eqref{it:ax-consist}.
\end{proof}

\begin{cor}[theorem-ext]
Any theorem can be added to the set of axioms.
This does not change the set of theorems.
\end{cor}
\begin{proof}
Every theorem is valid by the definition.
It is easy to prove by induction on the derivation that the second condition of \eqref{it:ax-valid} holds.
Condition~\eqref{it:ax-cond} is exactly the admissibility of \axref{ce}.
Finally, we need to show that \axref{ca} holds for theorems.
This follows from \axref{cu} and \axref{cc}.
\end{proof}

The following lemma generalizes \rlem{derived-cong-lem}:

\begin{lem}[derived-cong]
Let $t$ and $t'$ be terms, let $\Gamma$ be a context, and let $\psi$ be either a term, an equality, or a predicate symbol applied to some terms.
Suppose that $\varphi \sststile{}{V} \Delta[t/x] \vdash t \equiv t'$ is derivable for every $\Delta[t/x]$ such that $(\Delta,x) \in \sub(\Gamma,\psi)$.
If the sequent $\varphi \sststile{}{V} \Gamma \vdash \psi[t/x]$ is derivable, then so is the sequent $\varphi \sststile{}{V} \Gamma \vdash \psi[t'/x]$.
\end{lem}
\begin{proof}
If $\psi$ is an equality, then this follows from \rlem{derived-cong} and \axref{ce}.
If $\psi$ is a term, then this follows from the previous case by \axref{ce} since $(\Gamma,b) \in \sub(\Gamma \vdash a \equiv b)$.
If $\psi = R(t_1, \ldots t_k)$, then \axref{cp} and \rlem{derived-cong-lem} imply that the following sequent is derivable for every $1 \leq i \leq k$:
\[ \varphi \sststile{}{V} \Gamma \vdash R(t_1[t/x], \ldots t_{i-1}[t/x], t_i[t'/x], \ldots t_k[t'/x]). \]
\end{proof}

\subsection{The category of $\ft$-free theories}
\label{sec:types}

Let us recall the definition of the category of algebraic type theories from \cite{alg-tt}.
A \emph{restricted term} is a term $t$ together with a formula $\varphi$.
We denote such a restricted term by $t|_\varphi$.
Let $T$ and $T'$ be two theories with the same set of sorts.
An \emph{interpretation} of $T$ in $T'$ is a function $f$ such that the following conditions hold:
\begin{itemize}
\item For every basic function symbol $\sigma : s_1 \times \ldots \times s_k \to s$ of $T$,
the function $f$ defines a restricted term $f(\sigma(x_1, \ldots x_k))$ of $T'$ of sort $s$ such that $\FV(f(\sigma(x_1, \ldots x_k)))$ equals to $\{ x_1 : s_1, \ldots x_k : s_k \}$.
\item For every basic predicate symbol $P : s_1 \times \ldots \times s_k$,
the function $f$ defines a formula $f(P(x_1, \ldots x_k))$ of $T'$ such that $\FV(f(P(x_1, \ldots x_k)))$ equals to $\{ x_1 : s_1, \ldots x_k : s_k \}$.
\item For every axiom $\varphi \sststile{}{V} \psi$ of $T$, the sequent $f(\varphi) \sststile{}{V} f(\psi)$ is derivable in $T'$.
Formulas $f(\varphi)$ and $f(\psi)$ are defined inductively using $f(\sigma(x_1, \ldots x_k))$ and $f(P(x_1, \ldots x_k))$ in the obvious way.
\end{itemize}

We will say that formulas $\varphi$ and $\psi$ are \emph{equivalent} if the sequents $\varphi \ssststile{}{\FV(\varphi) \cup \FV(\psi)} \psi$ are derivable.
Two restricted terms $t|_\varphi$ and $t'|_\psi$ are equivalent if the following sequents are derivable:
\begin{align*}
\varphi \land t\!\downarrow\ & \sststile{}{\FV(t|_\varphi) \cup \FV(t'|_\psi)} \psi \land t = t' \\
\psi \land t'\!\downarrow\ & \sststile{}{\FV(t|_\varphi) \cup \FV(t'|_\psi)} \varphi \land t = t'
\end{align*}

Two interpretations $f$ and $f'$ are equivalent if $f(S(x_1, \ldots x_k))$ and $f'(S(x_1, \ldots x_k))$ are equivalent for every function or predicate symbol $S$.
A \emph{morphism} of theories $T$ and $T'$ is an equivalence class of interpretations of $T$ in $T'$.
The identity morphism is defined in the obvious way: $\id(\sigma(x_1, \ldots x_k)) = \sigma(x_1, \ldots x_k)|_\top$ and $\id(R(x_1, \ldots x_k)) = R(x_1, \ldots x_k)$.
The composition of morphisms is defined as follows: $(g \circ f)(S(x_1, \ldots x_k))$ = $g(f(S(x_1, \ldots x_k)))$.
It is easy to see that this defines the structure of a category on algebraic dependent type theories.

Now, let us describe the category of $\ft$-free theories.
First, an $\ft$-free \emph{restricted term} is just a pair consisting of an $\ft$-free term $t$ and an $\ft$-free formula $\varphi$, written $t|_\varphi$.
A \emph{contexted restricted term} is a pair $(\Gamma,t|_\varphi)$ such that $(\Gamma,t)$ is a contexted term and $\varphi$ is a formula.
We will say that a free variable $x$ of a contexted restricted term or a formula $E$ \emph{has context} $\Gamma$ in $E$ if $(\Gamma,x)$ is a contexted subterm of $E$.

Let $f$ be a function that defines a restricted term $f(\sigma(x_1, \ldots x_k))$ and a formula $f(R(x_1, \ldots x_k))$ for every function symbol $\sigma$ and every predicate symbol $R$ such that $\FV(f(\sigma(x_1, \ldots x_k))) = \{ x_1, \ldots x_k \}$ and $\FV(R(x_1, \ldots x_k)) = \{ x_1, \ldots x_k \}$.
Then we can extend its definition to all terms, formulas, and restricted terms recursively.
The restriction formulas are just lifted to the top.
That is, $\sigma(t_1|_{\varphi_1}, \ldots t_k|_{\varphi_k}) = \sigma(t_1, \ldots t_k)|_{\varphi_1 \land \ldots \land \varphi_k}$ and $R(t_1|_{\varphi_1}, \ldots t_k|_{\varphi_k}) = R(t_1, \ldots t_k) \land \varphi_1 \land \ldots \land \varphi_k$.
We will say that such a function is an \emph{interpretation} of $T$ in $T'$ if the following conditions hold:
\begin{enumerate}
\item \label{it:interp-symb} For every symbol $S$ of $T$, if $x_i$ has context $\Delta$ in $f(S(x_1, \ldots x_k))$, then $\Gamma \vdash f(S(x_1, \ldots x_k)) \sststile{}{\Gamma, x_1, \ldots x_k} \Gamma \vdash \Delta \equiv f(\Gamma^S_i)$ is derivable in $T'$.
\item \label{it:interp-axiom} For every axiom $\varphi \sststile{}{V} \psi$ of $T$, the sequent $f(\varphi) \sststile{}{V} f(\psi)$ is derivable.
\end{enumerate}

Two $\ft$-free formulas are \emph{equivalent} if the sequents $\varphi \ssststile{}{\FV(\varphi) \cup \FV(\psi)} \psi$ are derivable.
Two $\ft$-free restricted terms $t|_\varphi$ and $t'|_\psi$ are \emph{equivalent} in a context $\Gamma$ if the following sequents are derivable:
\begin{align*}
\varphi \land (\Gamma \vdash t) & \sststile{}{\FV(t|_\varphi) \cup \FV(t'|_\psi)} \psi \land (\Gamma \vdash t \equiv t') \\
\psi \land (\Gamma \vdash t') & \sststile{}{\FV(t|_\varphi) \cup \FV(t'|_\psi)} \varphi \land (\Gamma \vdash t \equiv t')
\end{align*}

Interpretations $f$ and $f'$ are \emph{equivalent} if $f(S(x_1, \ldots x_k))$ and $f'(S(x_1, \ldots x_k))$ are equivalent (in the empty context for function symbols) for every symbol $S$.
A \emph{morphism} of $\ft$-free theories $T$ and $T'$ is an equivalence class of interpretations of $T$ in $T'$.
The identity morphism is defined in the obvious way: $\id(\sigma(x_1, \ldots x_k)) = \sigma(x_1, \ldots x_k)|_\top$ and $\id(R(x_1, \ldots x_k)) = R(x_1, \ldots x_k)$.
The composition of morphisms is defined as follows:
\[ (g \circ f)(S(x_1, \ldots x_k)) = g(f(S(x_1, \ldots x_k))) \]
It is easy to see that this defines the structure of a category on $\ft$-free theories.

\begin{lem}
The identity map is an interpretation and the composition of interpretations is an interpretation.
\end{lem}
\begin{proof}
It is easy to see that the identity function is an interpretation.
The second property is obvious and the first property follows from \axref{cd}.
Let $f : T_1 \to T_2$ and $g : T_2 \to T_3$ be a pair of interpretations.
We need to show that $g \circ f$ is also an interpretation.
To prove that it satisfies \eqref{it:interp-axiom}, it is enough to show that interpretations preserve theorems.
This follows from the fact that interpretations preserve inference rules.
This is obvious for most of them.
Rule \axref{ca} follows from \rcor{theorem-ext}.
Let us consider rules \axref{cp}, \axref{cf}, and \axref{cf'}.
Let $f$ be an interpretation.
Then we know that the following sequents are derivable: $f(\varphi) \sststile{}{V} f(\Gamma) \vdash f(S(t_1, \ldots t_k))$ and $f(\varphi) \sststile{}{V} f(\Gamma), f(\Gamma_i^S(t_1, \ldots t_{i-1})) \vdash f(t_i) \equiv f(t_i')$.
By \rlem{derived-cong} and \axref{cx'}, it is enough to show that the sequent $f(\varphi) \sststile{}{V} f(\Gamma) \vdash \Delta[t_i/x_i] \equiv f(\Gamma_i^S(t_1, \ldots t_{i-1}))$ is derivable for every $\Delta$ such that $((f(\Gamma),\Delta),x_i) \in \sub(f(\Gamma), f(S(t_1, \ldots x_i, \ldots t_k)))$.
It is easy to see that there exists $\Delta'$ such that $((f(\Gamma),\Delta'),x_i) \in \sub(f(\Gamma), f(S(x_1, \ldots x_k)))$ and $\Delta = \Delta'[t_1/x_1, \ldots t_{i-1}/x_{i-1}, t_{i+1}/x_{i+1}, \ldots t_k/x_k]$.
Now, the derivability of $f(\varphi) \sststile{}{V} f(\Gamma) \vdash \Delta[t_i/x_i] \equiv f(\Gamma_i^S(t_1, \ldots t_{i-1}))$ follows from \eqref{it:interp-symb}.

Now, let us prove that $g \circ f$ satisfies \eqref{it:interp-symb}.
Since $g$ preserves theorems, it is enough to show that, for every $(\Delta,x_i) \in \sub(\cdot, g(f(S(x_1, \ldots x_k))))$, there exists $\Delta'$ such that $(\Delta',x_i) \in \sub(\cdot, f(S(x_1, \ldots x_k)))$ and $\Gamma \vdash g(f(S(x_1, \ldots x_k))) \sststile{}{\Gamma, x_1, \ldots x_k} \Gamma \vdash g(\Delta') \equiv \Delta$ is derivable.
We will prove a more general property: for every contexted term $(\Theta,t)$ and every $(\Delta,x) \in \sub(g(\Theta), g(t))$, there exists $\Delta'$ such that $(\Delta',x) \in \sub(\Theta, t)$ and the sequent $\Gamma, g(\Theta) \vdash g(t) \sststile{}{\Gamma, \FV(\Theta,t)} \Gamma \vdash g(\Delta') \equiv \Delta$ is derivable.
The proof is by induction on $t$.
If $t$ is a variable, this is obvious.
Suppose $t = \sigma(t_1, \ldots t_k)$.
Then there exists $\Delta_1$ such that $(\Delta_1,x_i) \in \sub(\cdot, g(\sigma(x_1, \ldots x_k)))$ and $(\Delta,x) \in \sub((g(\Theta),\Delta_1[t_1/x_1, \ldots t_k/x_k]), g(t_i))$.
By \rremark{ctx-begin}, there exists $\Delta_2$ such that $\Delta = (g(\Theta), \Delta_1[t_1/x_1, \ldots t_k/x_k], \Delta_2)$.
By induction hypothesis, there exists $\Delta_2'$ such that the following sequent is derivable:
\[ \Gamma, g(\Theta') \vdash g(t_i) \sststile{}{\Gamma, \FV(\Theta',t_i)} \Gamma \vdash g(\Delta_2') \equiv (g(\Theta'),\Delta_2) \]
where $\Theta' = (\Theta, \Gamma^\sigma_i(t_1, \ldots t_{i-1}))$.
The required equality $g(\Delta_2') \equiv \Delta$ follows from this sequent and the following ones:
\begin{align*}
\Gamma, g(\Theta) \vdash g(t) & \sststile{}{\Gamma, \FV(\Theta,t)} \Gamma, g(\Theta) \vdash \Delta_1[t_1/x_1, \ldots t_k/x_k] \equiv g(\Gamma^\sigma_i(t_1, \ldots t_{i-1})) \\
\Gamma, g(\Theta) \vdash g(t) & \sststile{}{\Gamma, \FV(\Theta,t)} \Gamma, g(\Theta') \vdash g(t_i)
\end{align*}
The first one follows from \eqref{it:interp-symb} and the second one is \axref{cd}.
\end{proof}

\subsection{The $\ty$-free syntax}
\label{sec:types}

\section{Examples}

\section{Strong normalization}

\section{Confluence}

\bibliographystyle{amsplain}
\bibliography{ref}

\end{document}
